<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Devis - FA GENESIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap');
        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }
        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, .nav-link { font-family: 'Unbounded', cursive; }
        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }
        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
            cursor: pointer;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }
        .neo-btn-yellow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .neo-btn-white {
            background: white;
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
            cursor: pointer;
        }
        .neo-btn-white:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }
        .quote-table {
            width: 100%;
            border-collapse: collapse;
            border: 3px solid black;
        }
        .quote-table th {
            background: var(--genesis-yellow);
            color: black;
            padding: 12px 16px;
            border: 2px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 12px;
            text-align: left;
        }
        .quote-table td {
            padding: 12px 16px;
            border: 2px solid black;
            font-weight: bold;
        }
        .quote-table .text-right { text-align: right; }
        .quote-table .text-center { text-align: center; }
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 12px;
        }
        .status-accepted { background: #FFF3CD; color: #856404; }
        .status-deposit-paid { background: #d3f9d8; color: #2b8a3e; }
        .status-pending { background: #ffe8cc; color: #e8590c; }
    </style>
</head>
<body>

    <!-- NAVIGATION -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-4 md:px-6 py-3 md:py-4 flex justify-between items-center text-white text-xs font-black uppercase">
        <div class="flex items-center">
            <a href="index.html" class="text-lg md:text-2xl font-black tracking-wider text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">FA GENESIS</a>
        </div>
        <div class="hidden md:flex gap-12 text-white font-black">
            <a href="dashboard.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Espace Client</a>
            <a href="livrables.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Livrables</a>
            <a href="contact.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Contact</a>
        </div>
        <a href="dashboard.html" class="hidden md:block neo-btn-yellow px-6 py-3 text-[12px] tracking-widest text-black font-black">Mon Espace</a>
    </nav>

    <!-- CONTENU PRINCIPAL -->
    <section class="min-h-screen flex flex-col items-center justify-center p-4 md:p-6 bg-black pt-28 md:pt-32 pb-20 relative overflow-hidden">
        <div class="absolute top-20 left-[-10%] w-96 h-96 bg-[var(--genesis-yellow)] rounded-full blur-[120px] opacity-20 z-0"></div>

        <!-- LOADING -->
        <div id="loadingState" class="w-full max-w-3xl z-10 text-center py-20">
            <div class="text-4xl text-[var(--genesis-yellow)] mb-4"><i class="fas fa-spinner fa-spin"></i></div>
            <p class="font-bold opacity-70">Chargement de votre devis...</p>
        </div>

        <!-- ERROR STATE -->
        <div id="errorState" class="w-full max-w-3xl z-10" style="display:none;">
            <div class="bg-white text-black p-10 neo-border neo-shadow text-center">
                <i class="fas fa-exclamation-triangle text-5xl text-[#ff6b6b] mb-4"></i>
                <h2 id="errorTitle" class="text-3xl font-black italic uppercase mb-4">ERREUR</h2>
                <p id="errorMsg" class="font-bold text-lg opacity-70 mb-8"></p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="dashboard.html" class="neo-btn-yellow px-8 py-4 text-sm tracking-widest inline-block">
                        <i class="fas fa-home mr-2"></i>ESPACE CLIENT
                    </a>
                    <a href="contact.html" class="neo-btn-white px-8 py-4 text-sm tracking-widest inline-block">
                        <i class="fas fa-envelope mr-2"></i>CONTACTEZ-NOUS
                    </a>
                </div>
            </div>
        </div>

        <!-- QUOTE DISPLAY -->
        <div id="quoteDisplay" class="w-full max-w-3xl z-10" style="display:none;">

            <!-- En-tete devis -->
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-6xl font-black italic uppercase text-[var(--genesis-yellow)] mb-2">VOTRE DEVIS</h1>
                <p id="quoteNumber" class="text-lg font-bold opacity-70"></p>
                <div id="statusBadgeContainer" class="mt-4"></div>
            </div>

            <div class="bg-white text-black p-6 md:p-10 neo-border neo-shadow">

                <!-- Infos client -->
                <div class="mb-8">
                    <p class="text-sm font-bold uppercase opacity-60 mb-1">Devis etabli pour :</p>
                    <p id="clientName" class="font-black text-xl"></p>
                    <p id="clientEmail" class="font-bold opacity-70"></p>
                </div>

                <!-- Tableau des prestations -->
                <table class="quote-table mb-6">
                    <thead>
                        <tr>
                            <th>Prestation</th>
                            <th class="text-center">Qte</th>
                            <th class="text-right">Prix unit.</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="quoteItemsBody">
                    </tbody>
                </table>

                <!-- Totaux -->
                <div class="bg-gray-100 border-4 border-black p-6 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-lg uppercase">Total</span>
                        <span id="quoteTotal" class="font-black text-2xl text-[var(--genesis-yellow)]"></span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold opacity-70">Acompte 30%</span>
                        <span id="quoteDeposit" class="font-black text-lg text-[#51cf66]"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold opacity-70">Solde 70% (a la livraison)</span>
                        <span id="quoteBalance" class="font-black text-lg"></span>
                    </div>
                </div>

                <!-- Notes / conditions -->
                <div id="quoteNotesSection" style="display:none;" class="mb-6">
                    <h4 class="font-black uppercase text-sm mb-2"><i class="fas fa-info-circle mr-1"></i>Conditions</h4>
                    <p id="quoteNotes" class="text-sm font-bold opacity-70" style="white-space:pre-wrap;"></p>
                </div>

                <!-- Validite -->
                <div class="mb-8 p-3 bg-yellow-50 border-2 border-[var(--genesis-yellow)]">
                    <p class="text-sm font-bold">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        <span id="quoteValidity"></span>
                    </p>
                </div>

                <!-- Actions dynamiques -->
                <div id="actionsContainer" class="text-center">
                    <!-- Rempli dynamiquement par JS -->
                </div>
            </div>

            <!-- Telecharger PDF -->
            <div id="pdfSection" class="mt-6 text-center" style="display:none;">
                <a id="pdfLink" href="#" target="_blank" class="neo-btn-white px-8 py-4 text-sm tracking-widest inline-block">
                    <i class="fas fa-file-pdf mr-2"></i>TELECHARGER LE DEVIS (PDF)
                </a>
            </div>
        </div>

    </section>

    <!-- FOOTER -->
    <footer class="bg-white text-black py-16 border-t-8 border-[var(--genesis-yellow)] px-6 font-black uppercase">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center gap-10 text-center md:text-left">
                <div>
                    <h2 class="text-3xl font-black italic tracking-tighter uppercase">FA GENESIS</h2>
                    <p class="text-[11px] text-black uppercase tracking-[8px] mt-2 italic">BUILD. LAUNCH. IMPACT.</p>
                </div>
                <p class="text-[11px] uppercase text-black font-bold italic">&copy; 2024 FINANCIAL ADVICE GENESIS &bull; GROUPE FA INDUSTRIES</p>
            </div>
        </div>
    </footer>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
    // ==============================================
    // PAGE MON DEVIS - FA GENESIS (Authentifiee)
    // ==============================================

    var API_URL = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';
    var currentToken = null;
    var currentQuote = null;

    // Verifier l'authentification
    (function init() {
        try {
            // Verifier l'auth
            var isAuth = (typeof isAuthenticated === 'function') ? isAuthenticated() : false;
            if (!isAuth) {
                // Recuperer le token pour le passer a la page de login
                var params = new URLSearchParams(window.location.search);
                var token = params.get('token');
                if (token) {
                    window.location.href = 'login.html?quote_token=' + encodeURIComponent(token);
                } else {
                    window.location.href = 'login.html';
                }
                return;
            }

            var params = new URLSearchParams(window.location.search);
            currentToken = params.get('token');

            if (!currentToken) {
                showError('LIEN INVALIDE', 'Ce lien ne contient pas de token de devis valide.');
                return;
            }

            loadQuote(currentToken);
        } catch (error) {
            console.error('[QUOTE-VIEW] Erreur init:', error);
            showError('ERREUR', 'Une erreur est survenue. Veuillez recharger la page.');
        }
    })();

    async function loadQuote(token) {
        try {
            var authToken = (typeof getAuthToken === 'function') ? getAuthToken() : localStorage.getItem('fa_genesis_token');

            var response = await fetch(API_URL + '/api/quotes/my-quote/' + encodeURIComponent(token), {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (!response.ok) {
                var errorData = {};
                try { errorData = await response.json(); } catch (e) {}

                if (response.status === 401) {
                    window.location.href = 'login.html?quote_token=' + encodeURIComponent(token);
                    return;
                }
                if (response.status === 404) {
                    showError('DEVIS INTROUVABLE', 'Ce devis n\'existe pas ou le lien est invalide.');
                } else {
                    showError('ERREUR', errorData.error || 'Impossible de charger le devis.');
                }
                return;
            }

            currentQuote = await response.json();
            console.log('[QUOTE-VIEW] Devis charge:', currentQuote);
            renderQuote(currentQuote);

        } catch (error) {
            console.error('[QUOTE-VIEW] Erreur chargement:', error);
            showError('ERREUR DE CONNEXION', 'Le serveur est temporairement indisponible. Veuillez reessayer dans quelques instants.');
        }
    }

    function renderQuote(quote) {
        var loading = document.getElementById('loadingState');
        var display = document.getElementById('quoteDisplay');
        if (loading) loading.style.display = 'none';
        if (display) display.style.display = 'block';

        // Numero
        var numEl = document.getElementById('quoteNumber');
        if (numEl) numEl.textContent = quote.quote_number || '';

        // Badge statut
        var badgeContainer = document.getElementById('statusBadgeContainer');
        if (badgeContainer) {
            var statusLabel = '';
            var statusClass = '';
            if (quote.deposit_paid) {
                statusLabel = 'ACOMPTE PAYE';
                statusClass = 'status-deposit-paid';
            } else if (quote.status === 'ACCEPTED') {
                statusLabel = 'ACCEPTE - ACOMPTE EN ATTENTE';
                statusClass = 'status-pending';
            } else if (quote.status === 'SENT_TO_CLIENT') {
                statusLabel = 'EN ATTENTE D\'ACCEPTATION';
                statusClass = 'status-accepted';
            } else {
                statusLabel = quote.status;
                statusClass = 'status-accepted';
            }
            badgeContainer.innerHTML = '<span class="status-badge ' + statusClass + '">' + statusLabel + '</span>';
        }

        // Client
        var nameEl = document.getElementById('clientName');
        var emailEl = document.getElementById('clientEmail');
        if (nameEl) nameEl.textContent = quote.client_name || '';
        if (emailEl) emailEl.textContent = quote.client_email || '';

        // Items
        var tbody = document.getElementById('quoteItemsBody');
        if (tbody && quote.admin_final && quote.admin_final.items) {
            var html = '';
            quote.admin_final.items.forEach(function(item) {
                var lineTotal = (item.qty || 1) * (item.unit_price || 0);
                html += '<tr>' +
                    '<td>' + (item.label || '') +
                        (item.description ? '<br><span style="font-size:12px;opacity:0.6;">' + item.description + '</span>' : '') +
                    '</td>' +
                    '<td class="text-center">' + (item.qty || 1) + '</td>' +
                    '<td class="text-right">' + (item.unit_price || 0) + ' &euro;</td>' +
                    '<td class="text-right" style="font-weight:900;">' + lineTotal + ' &euro;</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;
        }

        // Totaux
        if (quote.pricing) {
            var totalEl = document.getElementById('quoteTotal');
            var depositEl = document.getElementById('quoteDeposit');
            var balanceEl = document.getElementById('quoteBalance');
            if (totalEl) totalEl.textContent = quote.pricing.total + ' \u20ac';
            if (depositEl) depositEl.textContent = quote.pricing.deposit_amount + ' \u20ac';
            if (balanceEl) balanceEl.textContent = quote.pricing.balance_amount + ' \u20ac';
        }

        // Notes
        if (quote.admin_final && quote.admin_final.notes) {
            var notesSection = document.getElementById('quoteNotesSection');
            var notesEl = document.getElementById('quoteNotes');
            if (notesSection) notesSection.style.display = 'block';
            if (notesEl) notesEl.textContent = quote.admin_final.notes;
        }

        // Validite
        var validityEl = document.getElementById('quoteValidity');
        if (validityEl && quote.expiry_date) {
            var expiryDate = new Date(quote.expiry_date);
            var now = new Date();
            var daysLeft = Math.ceil((expiryDate - now) / (24 * 60 * 60 * 1000));

            if (daysLeft > 0) {
                validityEl.textContent = 'Ce devis est valable jusqu\'au ' + expiryDate.toLocaleDateString('fr-FR') + ' (' + daysLeft + ' jour' + (daysLeft > 1 ? 's' : '') + ' restant' + (daysLeft > 1 ? 's' : '') + ')';
            } else {
                validityEl.textContent = 'Ce devis a expire le ' + expiryDate.toLocaleDateString('fr-FR');
            }
        }

        // Actions dynamiques
        var actionsContainer = document.getElementById('actionsContainer');
        if (actionsContainer) {
            if (quote.deposit_paid) {
                // Acompte deja paye
                actionsContainer.innerHTML = '<div class="p-6 bg-[#d3f9d8] border-4 border-[#2b8a3e]">' +
                    '<i class="fas fa-check-circle text-3xl text-[#2b8a3e] mb-2"></i>' +
                    '<p class="font-black text-lg text-[#2b8a3e] uppercase">ACOMPTE REGLE</p>' +
                    '<p class="font-bold text-sm opacity-70 mt-2">Votre prestation est en cours de preparation.</p>' +
                    '</div>' +
                    '<div class="mt-6">' +
                    '<a href="dashboard.html" class="neo-btn-yellow px-8 py-4 text-lg uppercase inline-block">' +
                    '<i class="fas fa-home mr-2"></i>MON ESPACE CLIENT</a></div>';
            } else if (quote.status === 'ACCEPTED') {
                // Accepte mais acompte pas encore paye
                actionsContainer.innerHTML = '<button id="payBtn" onclick="payDeposit()" class="neo-btn-yellow px-8 md:px-12 py-4 md:py-6 text-lg md:text-2xl font-black italic uppercase tracking-tighter w-full">' +
                    '<i class="fas fa-credit-card mr-2"></i>PAYER L\'ACOMPTE (' + (quote.pricing ? quote.pricing.deposit_amount : '') + '\u20ac)</button>' +
                    '<p class="text-xs font-bold opacity-50 mt-4">Vous serez redirige vers notre plateforme de paiement securise SumUp.</p>';
            } else if (quote.status === 'SENT_TO_CLIENT') {
                // Pas encore accepte
                actionsContainer.innerHTML = '<button id="acceptBtn" onclick="acceptAndPay()" class="neo-btn-yellow px-8 md:px-12 py-4 md:py-6 text-lg md:text-2xl font-black italic uppercase tracking-tighter w-full">' +
                    '<i class="fas fa-check-circle mr-2"></i>ACCEPTER ET PAYER L\'ACOMPTE (' + (quote.pricing ? quote.pricing.deposit_amount : '') + '\u20ac)</button>' +
                    '<p class="text-xs font-bold opacity-50 mt-4">En acceptant, vous serez redirige vers notre plateforme de paiement securise SumUp.</p>';
            }
        }

        // PDF
        if (quote.pdf_url) {
            var pdfSection = document.getElementById('pdfSection');
            var pdfLink = document.getElementById('pdfLink');
            if (pdfSection) pdfSection.style.display = 'block';
            if (pdfLink) pdfLink.href = quote.pdf_url;
        }
    }

    async function acceptAndPay() {
        if (!currentToken) return;
        var btn = document.getElementById('acceptBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>TRAITEMENT EN COURS...';
        }

        try {
            var authToken = (typeof getAuthToken === 'function') ? getAuthToken() : localStorage.getItem('fa_genesis_token');

            var response = await fetch(API_URL + '/api/quotes/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({ token: currentToken })
            });

            var result = await response.json();

            if (result.success && result.checkout_url) {
                window.location.href = result.checkout_url;
            } else if (result.success) {
                // Recharger la page pour afficher le nouveau statut
                window.location.reload();
            } else {
                alert('Erreur : ' + (result.error || 'Impossible d\'accepter le devis'));
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>ACCEPTER ET PAYER L\'ACOMPTE';
                }
            }
        } catch (error) {
            console.error('[QUOTE-VIEW] Erreur acceptation:', error);
            alert('Erreur de connexion au serveur. Veuillez reessayer.');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>ACCEPTER ET PAYER L\'ACOMPTE';
            }
        }
    }

    async function payDeposit() {
        var btn = document.getElementById('payBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>CREATION DU PAIEMENT...';
        }

        try {
            var authToken = (typeof getAuthToken === 'function') ? getAuthToken() : localStorage.getItem('fa_genesis_token');

            // Re-appeler accept (idempotent) pour obtenir un nouveau checkout URL
            var response = await fetch(API_URL + '/api/quotes/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({ token: currentToken })
            });

            var result = await response.json();

            if (result.success && result.checkout_url) {
                window.location.href = result.checkout_url;
            } else if (result.success && result.deposit_paid) {
                window.location.reload();
            } else {
                alert('Erreur : ' + (result.error || 'Impossible de creer le paiement'));
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>PAYER L\'ACOMPTE';
                }
            }
        } catch (error) {
            console.error('[QUOTE-VIEW] Erreur paiement:', error);
            alert('Erreur de connexion. Veuillez reessayer.');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>PAYER L\'ACOMPTE';
            }
        }
    }

    function showError(title, message) {
        var loading = document.getElementById('loadingState');
        var errorState = document.getElementById('errorState');
        var titleEl = document.getElementById('errorTitle');
        var msgEl = document.getElementById('errorMsg');

        if (loading) loading.style.display = 'none';
        if (errorState) errorState.style.display = 'block';
        if (titleEl) titleEl.textContent = title;
        if (msgEl) msgEl.textContent = message;
    }
    </script>
    <script src="chatbot.js"></script>
</body>
</html>
