<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Administration - FA GENESIS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
        }

        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .admin-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
        }

        .stat-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 8px 8px 0px var(--genesis-yellow);
        }

        .client-row {
            background: white;
            color: black;
            border: 3px solid black;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-row:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--genesis-yellow);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border: 2px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .status-registered { background: #ff6b6b; color: white; }
        .status-deposit { background: #51cf66; color: white; }
        .status-pending { background: #ffd43b; color: black; }
        .status-fully { background: #4dabf7; color: white; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            color: black;
            margin: 2% auto;
            padding: 2rem;
            border: 4px solid black;
            width: 90%;
            max-width: 900px;
        }

        .close-modal {
            float: right;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .day-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--genesis-yellow);
            border: 3px solid black;
            font-weight: 900;
            font-size: 1.25rem;
            margin-right: 1rem;
        }

        .document-item {
            background: #f8f9fa;
            border: 2px solid black;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .admin-panel {
            display: none;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 3px solid black;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
            color: black;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--genesis-yellow);
        }
    </style>
</head>
<body>

    <!-- PAGE DE CONNEXION ADMIN -->
    <div id="loginPage" class="login-page">
        <div class="w-full max-width: 500px">
            <div class="admin-card neo-shadow" style="max-width: 500px; margin: 0 auto;">
                <h1 class="text-4xl font-black italic uppercase text-center mb-2 text-[var(--genesis-yellow)]">
                    <i class="fas fa-shield-alt mr-3"></i>ADMINISTRATION
                </h1>
                <p class="text-center font-bold mb-8 uppercase text-sm">FA GENESIS - Espace Administrateur</p>

                <div id="loginError" class="bg-red-500 text-white p-4 mb-4 border-4 border-black font-bold" style="display: none;"></div>

                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase">Email</label>
                        <input type="email" id="adminEmail" required placeholder="admin@fagenesis.com">
                    </div>

                    <div class="mb-6">
                        <label class="block font-black mb-2 uppercase">Mot de passe</label>
                        <input type="password" id="adminPassword" required placeholder="••••••••">
                    </div>

                    <button type="submit" class="w-full neo-btn-yellow py-4 text-xl font-black italic uppercase">
                        <i class="fas fa-sign-in-alt mr-2"></i>Connexion
                    </button>
                </form>

                <div class="mt-8 text-center text-sm font-bold opacity-70">
                    <i class="fas fa-lock mr-2"></i>Accès réservé aux administrateurs FA GENESIS
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL ADMINISTRATEUR -->
    <div id="adminPanel" class="admin-panel">

        <!-- NAVIGATION -->
        <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-black text-[var(--genesis-yellow)]" style="white-space:nowrap;">
                        <i class="fas fa-shield-alt mr-1"></i>ADMIN
                    </h1>
                    <div class="hidden md:flex gap-3 text-xs font-black" style="flex-wrap:nowrap;">
                        <button onclick="showSection('dashboard')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="white-space:nowrap;">
                            <i class="fas fa-chart-line mr-1"></i>Dashboard
                        </button>
                        <button onclick="showSection('clients')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="white-space:nowrap;">
                            <i class="fas fa-users mr-1"></i>Clients
                        </button>
                        <button onclick="showSection('messages')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="position:relative;white-space:nowrap;">
                            <i class="fas fa-envelope mr-1"></i>Messages
                            <span id="unreadBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:20px;height:20px;font-size:11px;line-height:20px;text-align:center;"></span>
                        </button>
                        <button onclick="showSection('commandes')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="white-space:nowrap;">
                            <i class="fas fa-receipt mr-1"></i>Commandes
                        </button>
                        <button onclick="showSection('partenaires')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="white-space:nowrap;">
                            <i class="fas fa-handshake mr-1"></i>Partenaires
                        </button>
                        <button onclick="showSection('devis')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="position:relative;white-space:nowrap;">
                            <i class="fas fa-file-invoice mr-1"></i>Devis
                            <span id="pendingQuotesBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:20px;height:20px;font-size:11px;line-height:20px;text-align:center;"></span>
                        </button>
                        <button onclick="showSection('workflow')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="position:relative;white-space:nowrap;">
                            <i class="fas fa-tasks mr-1"></i>À valider
                            <span id="pendingWorkflowBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:20px;height:20px;font-size:11px;line-height:20px;text-align:center;"></span>
                        </button>
                        <button onclick="showSection('projets')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="white-space:nowrap;">
                            <i class="fas fa-project-diagram mr-1"></i>Projets IA
                        </button>
                        <button onclick="showSection('seances')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="position:relative;white-space:nowrap;">
                            <i class="fas fa-video mr-1"></i>Séances
                            <span id="pendingSeancesBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:20px;height:20px;font-size:11px;line-height:20px;text-align:center;"></span>
                        </button>
                    </div>
                </div>
                <button onclick="handleLogout()" class="border-4 border-white text-white px-4 py-2 text-xs font-black hover:bg-white hover:text-black transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>DÉCONNEXION
                </button>
            </div>
        </nav>

        <div class="pt-28 pb-20 px-6">
            <!-- SECTION DASHBOARD -->
            <div id="dashboardSection" class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-black italic uppercase mb-12 text-[var(--genesis-yellow)]">
                    <i class="fas fa-chart-line mr-4"></i>TABLEAU DE BORD
                </h2>

                <!-- Statistiques -->
                <div class="grid md:grid-cols-4 gap-6 mb-12" id="statsContainer">
                    <!-- Les statistiques seront générées ici -->
                </div>

                <!-- Dates a confirmer -->
                <div class="admin-card neo-shadow mb-12" id="pendingSchedulesCard" style="display: none;">
                    <h3 class="text-2xl font-black italic uppercase mb-6">
                        <i class="fas fa-calendar-check mr-2" style="color: var(--genesis-yellow);"></i>Dates à confirmer
                        <span id="pendingSchedulesBadge" class="ml-3 inline-flex items-center justify-center px-3 py-1 text-sm font-black text-black border-2 border-black" style="background: var(--genesis-yellow);">0</span>
                    </h3>
                    <div id="pendingSchedulesContainer"></div>
                </div>

                <!-- Aperçu récent -->
                <div class="admin-card neo-shadow">
                    <h3 class="text-2xl font-black italic uppercase mb-6">
                        <i class="fas fa-clock mr-2"></i>Derniers clients inscrits
                    </h3>
                    <div id="recentClients"></div>
                </div>
            </div>

            <!-- SECTION MESSAGES -->
            <div id="messagesSection" class="container mx-auto max-w-7xl" style="display: none;">
                <div class="flex justify-between items-center mb-12 flex-wrap gap-4">
                    <h2 class="text-5xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-envelope mr-4"></i>MESSAGES
                    </h2>
                    <div id="messagesStats" class="text-right"></div>
                </div>

                <!-- Filtres -->
                <div class="admin-card neo-shadow mb-8">
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="filterMessages('all')" class="neo-btn-yellow px-4 py-2 text-xs">TOUS</button>
                        <button onclick="filterMessages('unread')" class="border-4 border-[#ff6b6b] bg-[#ff6b6b] text-black px-4 py-2 text-xs font-black">NON LUS</button>
                        <button onclick="filterMessages('read')" class="border-4 border-[#4dabf7] bg-[#4dabf7] text-black px-4 py-2 text-xs font-black">LUS</button>
                        <button onclick="filterMessages('replied')" class="border-4 border-[#51cf66] bg-[#51cf66] text-black px-4 py-2 text-xs font-black">RÉPONDUS</button>
                        <button onclick="filterMessages('archived')" class="border-4 border-gray-400 bg-gray-400 text-black px-4 py-2 text-xs font-black">ARCHIVÉS</button>
                    </div>
                </div>

                <!-- Liste des messages -->
                <div id="messagesList"></div>
            </div>

            <!-- SECTION COMMANDES -->
            <div id="commandesSection" class="container mx-auto max-w-7xl" style="display: none;">
                <h2 class="text-5xl font-black italic uppercase mb-12 text-[var(--genesis-yellow)]">
                    <i class="fas fa-receipt mr-4"></i>COMMANDES
                </h2>
                <div id="ordersLoader" style="display:none;padding:30px;background:#222;border:2px solid var(--genesis-yellow);margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <i class="fas fa-spinner fa-spin" style="color:var(--genesis-yellow);font-size:24px;"></i>
                        <div>
                            <div style="font-weight:900;color:white;font-size:15px;" id="ordersLoaderMsg">Chargement des commandes...</div>
                            <div style="font-size:12px;color:#aaa;margin-top:4px;" id="ordersLoaderSub"></div>
                        </div>
                    </div>
                </div>
                <div id="ordersList"></div>
            </div>

            <!-- SECTION CLIENTS -->
            <div id="clientsSection" class="container mx-auto max-w-7xl" style="display: none;">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-5xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-users mr-4"></i>GESTION CLIENTS
                    </h2>
                </div>

                <!-- Recherche -->
                <div class="admin-card neo-shadow mb-8">
                    <div class="flex gap-4">
                        <input type="text" id="searchInput" placeholder="Rechercher un client (nom, email, offre)..." class="flex-1">
                        <button onclick="handleSearchClients()" class="neo-btn-yellow px-8">
                            <i class="fas fa-search mr-2"></i>Rechercher
                        </button>
                    </div>
                </div>

                <!-- Liste des clients -->
                <div id="clientsList"></div>
            </div>
            <!-- SECTION PARTENAIRES -->
            <div id="partenairesSection" class="container mx-auto max-w-7xl" style="display: none;">
                <div class="flex justify-between items-center mb-12 flex-wrap gap-4">
                    <h2 class="text-5xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-handshake mr-4"></i>PARTENAIRES
                    </h2>
                    <button onclick="showCreatePartnerForm()" class="neo-btn-yellow px-6 py-3 text-sm">
                        <i class="fas fa-user-plus mr-2"></i>CRÉER UN PARTENAIRE
                    </button>
                </div>

                <!-- Formulaire creation partenaire (cache par defaut) -->
                <div id="createPartnerFormContainer" class="admin-card neo-shadow mb-8" style="display: none;">
                    <h3 class="text-2xl font-black italic uppercase mb-6">
                        <i class="fas fa-user-plus mr-2"></i>NOUVEAU PARTENAIRE
                    </h3>
                    <form id="createPartnerForm">
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-black mb-2 uppercase text-sm">Prénom</label>
                                <input type="text" id="partnerPrenom" required placeholder="Prénom">
                            </div>
                            <div>
                                <label class="block font-black mb-2 uppercase text-sm">Nom</label>
                                <input type="text" id="partnerNom" required placeholder="Nom">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-black mb-2 uppercase text-sm">Email</label>
                                <input type="email" id="partnerEmail" required placeholder="email@partenaire.com">
                            </div>
                            <div>
                                <label class="block font-black mb-2 uppercase text-sm">Téléphone</label>
                                <input type="tel" id="partnerTelephone" placeholder="06 12 34 56 78">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-black mb-2 uppercase text-sm">Type de partenaire</label>
                                <select id="partnerType" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="photographer">Photographe</option>
                                    <option value="videographer">Vidéographe</option>
                                    <option value="marketer">Marketeur</option>
                                    <option value="media">Média</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-black mb-2 uppercase text-sm">Spécialité</label>
                                <input type="text" id="partnerSpecialite" placeholder="Ex: Portrait, Corporate...">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block font-black mb-2 uppercase text-sm">Mot de passe temporaire</label>
                            <input type="text" id="partnerPassword" required placeholder="Mot de passe initial" value="">
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="neo-btn-yellow px-8 py-3 text-sm">
                                <i class="fas fa-check mr-2"></i>CRÉER
                            </button>
                            <button type="button" onclick="document.getElementById('createPartnerFormContainer').style.display='none'" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black">
                                ANNULER
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Onglets -->
                <div class="flex gap-3 mb-6 flex-wrap">
                    <button onclick="showPartnerTab('list')" id="partnerTabList" class="neo-btn-yellow px-4 py-2 text-xs">
                        <i class="fas fa-list mr-1"></i>LISTE
                    </button>
                    <button onclick="showPartnerTab('uploads')" id="partnerTabUploads" class="border-4 border-[#ffd43b] bg-[#ffd43b] text-black px-4 py-2 text-xs font-black">
                        <i class="fas fa-cloud-upload-alt mr-1"></i>UPLOADS EN ATTENTE
                        <span id="pendingUploadsBadge" class="ml-1 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs" style="display:none;">0</span>
                    </button>
                </div>

                <!-- Liste des partenaires -->
                <div id="partnersListContainer">
                    <div id="partnersList">
                        <p class="text-center py-8 opacity-50 font-bold">Chargement...</p>
                    </div>
                </div>

                <!-- Uploads en attente -->
                <div id="partnerUploadsContainer" style="display: none;">
                    <div id="pendingUploadsList">
                        <p class="text-center py-8 opacity-50 font-bold">Chargement...</p>
                    </div>
                </div>
            </div>

            <!-- SECTION DEVIS -->
            <div id="devisSection" class="container mx-auto max-w-7xl" style="display: none;">
                <!-- En-tete + stats -->
                <div class="flex justify-between items-center mb-12 flex-wrap gap-4">
                    <h2 class="text-5xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-file-invoice mr-4"></i>DEVIS
                    </h2>
                    <div id="quotesStats" class="text-right"></div>
                </div>

                <!-- Sous-onglets -->
                <div class="admin-card neo-shadow mb-8">
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="filterAdminQuotes('all')" class="neo-btn-yellow px-4 py-2 text-xs" id="quoteFilterAll">TOUS</button>
                        <button onclick="filterAdminQuotes('DRAFT_REQUESTED')" class="border-4 border-[#ff6b6b] bg-[#ff6b6b] text-black px-4 py-2 text-xs font-black" id="quoteFilterDraft">EN ATTENTE</button>
                        <button onclick="filterAdminQuotes('PARTNER_PROPOSED')" class="border-4 border-[#ffd43b] bg-[#ffd43b] text-black px-4 py-2 text-xs font-black" id="quoteFilterProposed">PROPOSÉS</button>
                        <button onclick="filterAdminQuotes('ADMIN_REVIEW')" class="border-4 border-[#4dabf7] bg-[#4dabf7] text-black px-4 py-2 text-xs font-black" id="quoteFilterReview">A FINALISER</button>
                        <button onclick="filterAdminQuotes('SENT_TO_CLIENT')" class="border-4 border-[#845ef7] bg-[#845ef7] text-white px-4 py-2 text-xs font-black" id="quoteFilterSent">ENVOYÉS</button>
                        <button onclick="filterAdminQuotes('ACCEPTED')" class="border-4 border-[#51cf66] bg-[#51cf66] text-black px-4 py-2 text-xs font-black" id="quoteFilterAccepted">ACCEPTÉS</button>
                    </div>
                </div>

                <!-- Liste des devis -->
                <div id="quotesList">
                    <p class="text-center py-8 opacity-50 font-bold">Chargement...</p>
                </div>

                <!-- Detail d'un devis (cache par defaut) -->
                <div id="quoteDetailView" style="display:none;">
                    <button onclick="backToQuotesList()" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black mb-6">
                        <i class="fas fa-arrow-left mr-2"></i>RETOUR A LA LISTE
                    </button>
                    <div id="quoteDetailContent"></div>
                </div>
            </div>

            <!-- ===== SECTION A VALIDER ===== -->
            <div id="workflowSection" class="container mx-auto max-w-7xl" style="display: none;">
                <h2 class="text-3xl font-black mb-6" style="font-family:'Playfair Display',serif;">
                    <i class="fas fa-tasks mr-3" style="color:var(--genesis-yellow);"></i>LIVRABLES A VALIDER
                </h2>

                <!-- Sous-onglets -->
                <div class="flex gap-3 mb-6">
                    <button onclick="showWorkflowTab('pending-ai')" id="tabPendingAi" class="border-4 border-black bg-[var(--genesis-yellow)] text-black px-4 py-2 text-sm font-black">
                        Documents IA en attente
                    </button>
                    <button onclick="showWorkflowTab('pending-partner')" id="tabPendingPartner" class="border-4 border-black bg-gray-300 text-black px-4 py-2 text-sm font-black">
                        Livrables partenaires
                    </button>
                </div>

                <!-- Contenu docs IA -->
                <div id="pendingAiContainer">
                    <div id="pendingAiList" class="space-y-4" style="color:black;">
                        <p style="color:white;opacity:0.5;font-weight:bold;">Chargement...</p>
                    </div>
                </div>

                <!-- Contenu livrables partenaires -->
                <div id="pendingPartnerContainer" style="display:none;">
                    <div id="pendingPartnerList" class="space-y-4" style="color:black;">
                        <p style="color:white;opacity:0.5;font-weight:bold;">Chargement...</p>
                    </div>
                </div>

                <!-- Séance effectuée -->
                <div class="mt-8 p-6 bg-gray-100 border-4 border-black" style="color:black;">
                    <h3 class="text-xl font-black mb-4" style="color:black;"><i class="fas fa-calendar-check mr-2"></i>SÉANCE EFFECTUÉE</h3>
                    <div class="mb-4">
                        <label class="block font-bold mb-1">Projet :</label>
                        <select id="sessionProjectSelect" class="w-full border-2 border-black p-2 text-sm">
                            <option value="">-- Sélectionner un projet --</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-1">Notes de séance :</label>
                        <textarea id="sessionNotesInput" rows="6" class="w-full border-2 border-black p-3 text-sm" placeholder="Entrez vos notes de séance ici..."></textarea>
                    </div>
                    <button onclick="submitSessionCompleted()" class="border-4 border-black bg-green-600 text-white px-6 py-3 text-sm font-black hover:bg-green-700">
                        <i class="fas fa-check mr-2"></i>MARQUER SÉANCE EFFECTUÉE
                    </button>
                    <div id="sessionResult" class="mt-4" style="display:none;"></div>
                </div>
            </div>

            <!-- ===== SECTION PROJETS IA ===== -->
            <div id="projetsSection" class="container mx-auto max-w-7xl" style="display: none;">
                <h2 class="text-3xl font-black mb-6" style="font-family:'Playfair Display',serif;">
                    <i class="fas fa-project-diagram mr-3" style="color:var(--genesis-yellow);"></i>PROJETS IA
                </h2>

                <!-- Bouton creer projet -->
                <div class="mb-6">
                    <button onclick="showCreateProjectForm()" class="border-4 border-black bg-[var(--genesis-yellow)] text-black px-6 py-3 text-sm font-black hover:bg-yellow-400">
                        <i class="fas fa-plus mr-2"></i>CRÉER PROJET POUR UNE COMMANDE
                    </button>
                </div>

                <!-- Formulaire creation (cache) -->
                <div id="createProjectForm" style="display:none;color:black;" class="mb-6 p-4 bg-gray-100 border-4 border-black">
                    <label class="block font-bold mb-2">ID de la commande :</label>
                    <input type="text" id="createProjectOrderId" class="border-2 border-black p-2 w-full mb-3 text-sm" placeholder="ORD-xxxxx">
                    <button onclick="createProjectFromOrder()" class="border-4 border-black bg-green-600 text-white px-6 py-3 text-sm font-black">
                        <i class="fas fa-rocket mr-2"></i>CRÉER LE PROJET
                    </button>
                    <div id="createProjectResult" class="mt-3" style="display:none;"></div>
                </div>

                <!-- Liste des projets -->
                <div id="projectsList" class="space-y-4" style="color:black;">
                    <p style="color:white;opacity:0.5;font-weight:bold;">Chargement...</p>
                </div>

                <!-- Detail projet (cache) -->
                <div id="projectDetailView" style="display:none;">
                    <button onclick="backToProjectsList()" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black mb-6">
                        <i class="fas fa-arrow-left mr-2"></i>RETOUR AUX PROJETS
                    </button>
                    <div id="projectDetailContent"></div>
                </div>
            </div>

            <!-- ===== SECTION SÉANCES ===== -->
            <div id="seancesSection" class="container mx-auto max-w-7xl" style="display: none;">
                <h2 class="text-3xl font-black mb-6" style="font-family:'Playfair Display',serif;">
                    <i class="fas fa-video mr-3" style="color:var(--genesis-yellow);"></i>SÉANCES
                </h2>

                <!-- Filtres -->
                <div class="mb-6 p-4 bg-gray-100 border-4 border-black" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
                    <div>
                        <label class="block font-bold text-sm mb-1 text-black">Statut</label>
                        <select id="adminSeancesFilterStatus" onchange="renderAdminSessions()" style="padding:0.5rem;border:3px solid black;font-weight:bold;min-width:160px;">
                            <option value="">Tous</option>
                            <option value="REQUESTED">Demandées</option>
                            <option value="PROPOSED">Proposées</option>
                            <option value="CONFIRMED">Confirmées</option>
                            <option value="RESCHEDULE_REQUESTED">Reprogrammation</option>
                            <option value="COMPLETED">Terminées</option>
                            <option value="CANCELLED">Annulées</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-bold text-sm mb-1 text-black">Partenaire</label>
                        <select id="adminSeancesFilterPartner" onchange="renderAdminSessions()" style="padding:0.5rem;border:3px solid black;font-weight:bold;min-width:160px;">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-bold text-sm mb-1 text-black">Recherche client</label>
                        <input type="text" id="adminSeancesSearch" oninput="renderAdminSessions()" placeholder="Nom ou email..." style="padding:0.5rem;border:3px solid black;font-weight:bold;min-width:200px;">
                    </div>
                </div>

                <div id="adminSeancesTable" style="overflow-x:auto;">
                    <p style="color:white;opacity:0.5;font-weight:bold;">Chargement...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL PARTENAIRE DETAIL -->
    <div id="partnerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePartnerModal()">&times;</span>
            <div id="partnerModalContent"></div>
        </div>
    </div>

    <!-- MODAL GESTION CLIENT -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeClientModal()">&times;</span>
            <div id="clientModalContent"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="offers-config.js"></script>
    <script src="payment-system.js"></script>
    <script src="admin-system.js"></script>
    <script>
        // API_BASE_URL est défini dans auth.js
    </script>
    <script>
        // Vérifier si admin est déjà connecté
        if (isAdminAuthenticated()) {
            showAdminPanel();
        }

        // Gestion de la connexion
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const result = adminLogin(email, password);

            if (result.success) {
                showAdminPanel();
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = result.message;
                errorDiv.style.display = 'block';
            }
        });

        function showAdminPanel() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboard();
            // Reveil immediat du serveur Render + keep-alive toutes les 10 min
            try { fetch(API_BASE_URL + '/api/ping').catch(function(){}); } catch(e){}
            startKeepAlive();
        }

        function handleLogout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                stopKeepAlive();
                adminLogout();
                location.reload();
            }
        }

        function showSection(section) {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('clientsSection').style.display = 'none';
            document.getElementById('messagesSection').style.display = 'none';
            document.getElementById('commandesSection').style.display = 'none';
            document.getElementById('partenairesSection').style.display = 'none';
            document.getElementById('devisSection').style.display = 'none';
            document.getElementById('workflowSection').style.display = 'none';
            document.getElementById('projetsSection').style.display = 'none';
            var seancesEl = document.getElementById('seancesSection');
            if (seancesEl) seancesEl.style.display = 'none';

            if (section === 'dashboard') {
                document.getElementById('dashboardSection').style.display = 'block';
                loadDashboard();
            } else if (section === 'clients') {
                document.getElementById('clientsSection').style.display = 'block';
                loadClientsList();
            } else if (section === 'messages') {
                document.getElementById('messagesSection').style.display = 'block';
                loadMessages();
            } else if (section === 'commandes') {
                document.getElementById('commandesSection').style.display = 'block';
                loadOrders();
            } else if (section === 'partenaires') {
                document.getElementById('partenairesSection').style.display = 'block';
                loadPartnersList();
                loadPendingUploads();
            } else if (section === 'devis') {
                document.getElementById('devisSection').style.display = 'block';
                loadAdminQuotes();
            } else if (section === 'workflow') {
                document.getElementById('workflowSection').style.display = 'block';
                loadPendingDeliverables();
            } else if (section === 'projets') {
                document.getElementById('projetsSection').style.display = 'block';
                loadProjectsList();
            } else if (section === 'seances') {
                if (seancesEl) seancesEl.style.display = 'block';
                loadAdminSessions();
            }
        }

        async function loadDashboard() {
            try {
                const [statsResponse, usersResponse] = await Promise.all([
                    fetch(API_BASE_URL + '/api/admin/stats'),
                    fetch(API_BASE_URL + '/api/admin/users')
                ]);

                if (!statsResponse.ok || !usersResponse.ok) throw new Error('Erreur chargement');

                const stats = await statsResponse.json();
                const users = await usersResponse.json();

                const statsHTML = `
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[var(--genesis-yellow)] mb-2">${stats.totalClients}</div>
                        <div class="text-sm font-bold uppercase">Total Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[#51cf66] mb-2">${stats.depositPaid}</div>
                        <div class="text-sm font-bold uppercase">Acompte Payé</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[#4dabf7] mb-2">${stats.fullyPaid}</div>
                        <div class="text-sm font-bold uppercase">Payé Complet</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[var(--genesis-yellow)] mb-2">${stats.totalRevenue}€</div>
                        <div class="text-sm font-bold uppercase">Revenu Total</div>
                    </div>
                `;

                document.getElementById('statsContainer').innerHTML = statsHTML;

                // Derniers clients (5 plus recents)
                const recentUsers = users.slice(0, 5);
                let recentHTML = '';

                recentUsers.forEach(function(client) {
                    var statusClass = {
                        'registered': 'status-registered',
                        'deposit_paid': 'status-deposit',
                        'delivery_pending_payment': 'status-pending',
                        'fully_paid': 'status-fully'
                    }[client.paymentStatus] || 'status-registered';

                    var offerName = client.offre || '';
                    var offer = typeof getOfferById === 'function' ? getOfferById(client.offre) : null;
                    if (offer) offerName = offer.nom;

                    recentHTML += '<div class="client-row" onclick="openClientModal(\'' + client.email + '\')">' +
                        '<div class="flex justify-between items-center">' +
                            '<div>' +
                                '<div class="font-black text-lg">' + client.prenom + ' ' + client.nom + '</div>' +
                                '<div class="text-sm font-bold opacity-70">' + client.email + '</div>' +
                            '</div>' +
                            '<div class="text-right">' +
                                '<div class="status-badge ' + statusClass + ' mb-2">' + getStatusLabel(client.paymentStatus) + '</div>' +
                                '<div class="text-sm font-bold">' + offerName + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                });

                document.getElementById('recentClients').innerHTML = recentHTML || '<p class="text-center py-8 opacity-50 font-bold">Aucun client inscrit</p>';

                // Charger les dates a confirmer
                loadPendingSchedules();

            } catch (error) {
                console.error('[ADMIN] Erreur chargement dashboard:', error);
                document.getElementById('statsContainer').innerHTML = '<p class="col-span-4 text-center py-8 font-bold" style="color:white;"><i class="fas fa-spinner fa-spin" style="margin-right:8px;color:var(--genesis-yellow);"></i>Le serveur d\u00e9marre, veuillez patienter...</p>';
                document.getElementById('recentClients').innerHTML = '<p class="text-center py-8 font-bold" style="color:#aaa;">R\u00e9essai automatique...</p>';
                setTimeout(function() { loadDashboard(); }, 3000);
            }
        }

        // ============================================================
        // PLANIFICATION - DATES A CONFIRMER
        // ============================================================

        function formatDateFrAdmin(dateStr) {
            try {
                var jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
                var mois = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
                var d = new Date(dateStr + 'T00:00:00');
                if (isNaN(d.getTime())) return dateStr;
                return jours[d.getDay()] + ' ' + d.getDate() + ' ' + mois[d.getMonth()] + ' ' + d.getFullYear();
            } catch (e) {
                return dateStr;
            }
        }

        async function loadPendingSchedules() {
            try {
                var resp = await fetch(API_BASE_URL + '/api/admin/pending-schedules');
                if (!resp.ok) return;

                var data = await resp.json();
                var orders = data.orders || [];

                var card = document.getElementById('pendingSchedulesCard');
                var container = document.getElementById('pendingSchedulesContainer');
                var badge = document.getElementById('pendingSchedulesBadge');

                if (!card || !container) return;

                if (orders.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';
                if (badge) badge.textContent = orders.length;

                var html = '';
                for (var i = 0; i < orders.length; i++) {
                    var order = orders[i];
                    var clientName = (order.client_prenom || '') + ' ' + (order.client_nom || '');
                    var productName = order.product_name || order.product_id || 'Offre inconnue';
                    var proposedDate = order.proposed_start_date ? formatDateFrAdmin(order.proposed_start_date) : 'Non définie';

                    var adminConfirmed = order.schedule_confirmed_by_admin === true;
                    var partnerConfirmed = order.schedule_confirmed_by_partner === true;

                    var adminBadge = adminConfirmed
                        ? '<span class="inline-block px-2 py-1 text-xs font-black text-white bg-green-600 border-2 border-black mr-2">Admin ✓</span>'
                        : '<span class="inline-block px-2 py-1 text-xs font-black text-gray-600 bg-gray-200 border-2 border-black mr-2">Admin ✗</span>';
                    var partnerBadge = partnerConfirmed
                        ? '<span class="inline-block px-2 py-1 text-xs font-black text-white bg-green-600 border-2 border-black">Partenaire ✓</span>'
                        : '<span class="inline-block px-2 py-1 text-xs font-black text-gray-600 bg-gray-200 border-2 border-black">Partenaire ✗</span>';

                    html += '<div class="client-row mb-4" style="border: 4px solid black; padding: 1.5rem;">' +
                        '<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">' +
                            '<div class="flex-1">' +
                                '<div class="font-black text-lg">' + clientName + '</div>' +
                                '<div class="text-sm font-bold opacity-70 mb-2">' + (order.client_email || '') + '</div>' +
                                '<div class="text-sm font-bold">' +
                                    '<i class="fas fa-box mr-1"></i>' + productName +
                                '</div>' +
                                '<div class="text-base font-black mt-2" style="color: var(--genesis-yellow);">' +
                                    '<i class="fas fa-calendar-day mr-1"></i>Date proposée : ' + proposedDate +
                                '</div>' +
                                '<div class="mt-2">' + adminBadge + partnerBadge + '</div>' +
                            '</div>' +
                            '<div>' +
                                (adminConfirmed
                                    ? '<span class="inline-block px-6 py-3 font-black uppercase text-sm bg-green-100 text-green-800 border-4 border-black">Confirmé ✓</span>'
                                    : '<button onclick="confirmScheduleAdmin(\'' + order.id + '\')" class="neo-btn-yellow px-6 py-3 text-sm uppercase" id="confirmBtn_' + order.id + '"><i class="fas fa-check mr-2"></i>Confirmer</button>'
                                ) +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }

                container.innerHTML = html;
            } catch (err) {
                console.error('[ADMIN] Erreur chargement dates a confirmer:', err);
            }
        }

        async function confirmScheduleAdmin(orderId) {
            var btn = document.getElementById('confirmBtn_' + orderId);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Confirmation...';
            }

            try {
                var resp = await fetch(API_BASE_URL + '/api/admin/confirm-schedule/' + orderId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                var data = await resp.json();

                if (resp.ok && data.success) {
                    if (data.finalized) {
                        alert('Date confirmée et parcours lancé ! Le projet a été créé.');
                    } else {
                        alert('Confirmation admin enregistrée. En attente de la confirmation du partenaire.');
                    }
                    // Recharger la liste
                    loadPendingSchedules();
                } else {
                    alert('Erreur : ' + (data.error || 'Impossible de confirmer.'));
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Confirmer';
                    }
                }
            } catch (err) {
                alert('Erreur réseau : ' + err.message);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>Confirmer';
                }
            }
        }

        let allBackendClients = [];

        async function loadClientsList(searchQuery) {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/users');
                if (!response.ok) throw new Error('Erreur chargement');
                allBackendClients = await response.json();
            } catch (error) {
                console.error('[ADMIN] Erreur chargement clients:', error);
                document.getElementById('clientsList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadClientsList(); }, 5000);
                return;
            }

            var clients = allBackendClients;

            // Filtrer si recherche
            if (searchQuery) {
                var q = searchQuery.toLowerCase();
                clients = clients.filter(function(c) {
                    return (c.prenom && c.prenom.toLowerCase().includes(q)) ||
                           (c.nom && c.nom.toLowerCase().includes(q)) ||
                           (c.email && c.email.toLowerCase().includes(q)) ||
                           (c.offre && c.offre.toLowerCase().includes(q));
                });
            }

            var html = '';
            clients.forEach(function(client) {
                var statusClass = {
                    'registered': 'status-registered',
                    'deposit_paid': 'status-deposit',
                    'delivery_pending_payment': 'status-pending',
                    'fully_paid': 'status-fully'
                }[client.paymentStatus] || 'status-registered';

                var offerName = client.offre || 'N/A';
                var offer = typeof getOfferById === 'function' ? getOfferById(client.offre) : null;
                if (offer) offerName = offer.nom;

                html += '<div class="client-row" onclick="openClientModal(\'' + client.email + '\')">' +
                    '<div class="flex justify-between items-center flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[250px]">' +
                            '<div class="font-black text-lg">' + (client.prenom || '') + ' ' + (client.nom || '') + '</div>' +
                            '<div class="text-sm font-bold opacity-70">' + client.email + '</div>' +
                            '<div class="text-xs font-bold opacity-50 mt-1">Inscrit le ' + new Date(client.createdAt || Date.now()).toLocaleDateString('fr-FR') + '</div>' +
                        '</div>' +
                        '<div>' +
                            '<div class="status-badge ' + statusClass + '">' + getStatusLabel(client.paymentStatus) + '</div>' +
                        '</div>' +
                        '<div class="text-right min-w-[200px]">' +
                            '<div class="font-black">' + offerName + '</div>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<button class="neo-btn-yellow px-4 py-2 text-sm">' +
                                '<i class="fas fa-folder-open mr-2"></i>Gérer' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            document.getElementById('clientsList').innerHTML = html || '<p class="text-center py-8 opacity-50 font-bold">Aucun client</p>';
        }

        function handleSearchClients() {
            var query = document.getElementById('searchInput').value;
            if (!query) {
                loadClientsList();
                return;
            }
            loadClientsList(query);
        }

        async function deleteClient(email) {
            if (!confirm('Voulez-vous vraiment supprimer le compte de ' + email + ' ?\n\nCette action est irréversible.')) return;
            try {
                var resp = await fetch(API_BASE_URL + '/api/admin/users/' + encodeURIComponent(email), { method: 'DELETE' });
                var data = await resp.json();
                if (resp.ok && data.success) {
                    alert('Compte supprimé : ' + email);
                    closeClientModal();
                    loadClientsList();
                    loadDashboard();
                } else {
                    alert('Erreur : ' + (data.error || 'Impossible de supprimer'));
                }
            } catch (err) {
                alert('Erreur réseau : ' + err.message);
            }
        }

        function closeClientModal() {
            var m = document.getElementById('clientModal');
            if (m) m.style.display = 'none';
        }

        async function openClientModal(clientEmail) {
            // Chercher d'abord dans les donnees deja chargees, sinon appeler le backend
            var client = allBackendClients.find(function(c) { return c.email === clientEmail; });

            if (!client) {
                try {
                    var resp = await fetch(API_BASE_URL + '/api/admin/users/' + encodeURIComponent(clientEmail));
                    if (resp.ok) client = await resp.json();
                } catch (e) {
                    console.error('[ADMIN] Erreur chargement client:', e);
                }
            }

            if (!client) {
                alert('Client non trouvé');
                return;
            }

            var offer = typeof getOfferById === 'function' ? getOfferById(client.offre) : null;

            // Charger les documents depuis le backend API
            var documents = {};
            var clientOrderId = null;
            var currentDay = 0;
            var totalDays = 0;

            try {
                // Récupérer la commande du client
                var ordersResp = await fetch(API_BASE_URL + '/api/client/orders?email=' + encodeURIComponent(clientEmail));
                if (ordersResp.ok) {
                    var clientOrders = await ordersResp.json();
                    var activeOrder = clientOrders.find(function(o) { return o.deposit_paid; }) || clientOrders[0];
                    if (activeOrder) {
                        clientOrderId = activeOrder.id;
                        // Récupérer le jour courant
                        var dashResp = await fetch(API_BASE_URL + '/api/client/dashboard/' + activeOrder.id);
                        if (dashResp.ok) {
                            var dashData = await dashResp.json();
                            currentDay = dashData.currentDay || 0;
                            totalDays = dashData.totalDays || 0;
                        }
                    }
                }
                // Récupérer les livrables depuis le backend
                var livResp = await fetch(API_BASE_URL + '/api/livrables/by-email/' + encodeURIComponent(clientEmail));
                if (livResp.ok) {
                    var livData = await livResp.json();
                    documents = livData.byDay || {};
                }
            } catch (e) {
                console.error('[ADMIN] Erreur chargement données client:', e);
            }

            let modalHTML = `
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-3xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-user-circle mr-3"></i>${client.prenom} ${client.nom}
                    </h2>
                    <button onclick="deleteClient('${client.email}')" class="border-4 border-red-600 bg-red-600 text-white px-4 py-2 text-xs font-black hover:bg-red-700" title="Supprimer ce client">
                        <i class="fas fa-trash mr-1"></i>SUPPRIMER
                    </button>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Email</p>
                        <p class="font-black">${client.email}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Téléphone</p>
                        <p class="font-black">${client.telephone || 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Offre</p>
                        <p class="font-black">${offer ? offer.nom : 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Statut paiement</p>
                        <p class="font-black">${getStatusLabel(client.paymentStatus)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Jour actuel</p>
                        <p class="font-black">Jour ${currentDay}${totalDays ? ' / ' + totalDays : ''}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Documents ajoutés</p>
                        <p class="font-black" id="docsCount">0 documents</p>
                    </div>
                </div>

                <hr class="border-2 border-black my-8">

                <h3 class="text-2xl font-black italic uppercase mb-6">
                    <i class="fas fa-file-upload mr-3"></i>AJOUTER UN DOCUMENT
                </h3>

                <form id="uploadDocumentForm" class="mb-8">
                    <input type="hidden" id="currentClientEmail" value="${clientEmail}">
                    <input type="hidden" id="currentClientOrderId" value="${clientOrderId || ''}">

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Jour</label>
                            <input type="number" id="docDay" min="1" value="${currentDay > 0 ? currentDay : 1}" required>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Titre du document</label>
                            <input type="text" id="docTitle" placeholder="Ex: Plan d'action Jour 5" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase text-sm">Description (optionnelle)</label>
                        <textarea id="docDescription" rows="2" placeholder="Description du document..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase text-sm">Fichier</label>
                        <input type="file" id="docFile" required class="text-sm">
                        <p class="text-xs font-bold opacity-50 mt-2">Formats acceptés: PDF, DOCX, XLSX, PNG, JPG, ZIP</p>
                    </div>

                    <button type="submit" class="neo-btn-yellow px-8 py-3 text-lg">
                        <i class="fas fa-upload mr-2"></i>Ajouter le document
                    </button>
                </form>

                <hr class="border-2 border-black my-8">

                <h3 class="text-2xl font-black italic uppercase mb-6">
                    <i class="fas fa-folder-open mr-3"></i>DOCUMENTS DU CLIENT
                </h3>

                <div id="clientDocumentsList">
                    ${renderClientDocuments(documents, clientEmail)}
                </div>

                <hr class="border-2 border-black my-8">

                <h3 class="text-2xl font-black italic uppercase mb-6">
                    <i class="fas fa-video mr-3"></i>GESTION DES SÉANCES
                </h3>

                <form id="addSessionForm" class="mb-8">
                    <input type="hidden" id="sessionClientEmail" value="${clientEmail}">

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Date</label>
                            <input type="date" id="sessionDate" required>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Heure</label>
                            <input type="time" id="sessionHeure" required>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Durée</label>
                            <input type="text" id="sessionDuree" placeholder="Ex: 1h00" required>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Type de séance</label>
                            <select id="sessionType" required>
                                <option value="">Sélectionner...</option>
                                <option value="Séance stratégique">Séance stratégique</option>
                                <option value="Point de suivi">Point de suivi</option>
                                <option value="Briefing tournage">Briefing tournage</option>
                                <option value="Shooting photo">Shooting photo</option>
                                <option value="Tournage vidéo">Tournage vidéo</option>
                                <option value="Bilan final">Bilan final</option>
                                <option value="Consultation">Consultation</option>
                                <option value="Formation">Formation</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Icône</label>
                            <select id="sessionIcon">
                                <option value="fa-video">📹 Visio</option>
                                <option value="fa-comments">💬 Discussion</option>
                                <option value="fa-lightbulb">💡 Stratégie</option>
                                <option value="fa-camera">📷 Photo</option>
                                <option value="fa-film">🎬 Vidéo</option>
                                <option value="fa-rocket">🚀 Lancement</option>
                                <option value="fa-check-circle">✅ Bilan</option>
                                <option value="fa-calendar">📅 Rendez-vous</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase text-sm">Description</label>
                        <textarea id="sessionDescription" rows="2" placeholder="Description de la séance..."></textarea>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">
                                <i class="fas fa-link mr-1"></i>Lien visio (Google Meet, Zoom...)
                            </label>
                            <input type="url" id="sessionVisioLink" placeholder="https://meet.google.com/xxx-xxxx-xxx">
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">
                                <i class="fas fa-map-marker-alt mr-1"></i>Ou lieu physique (optionnel)
                            </label>
                            <input type="text" id="sessionLieu" placeholder="Ex: Studio FA Genesis, Paris">
                        </div>
                    </div>

                    <button type="submit" class="neo-btn-yellow px-8 py-3 text-lg">
                        <i class="fas fa-plus mr-2"></i>Ajouter la séance
                    </button>
                </form>

                <h4 class="text-xl font-black italic uppercase mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>Séances planifiées
                </h4>
                <div id="clientSessionsList">
                    <p class="text-center py-4 opacity-50 font-bold">Chargement...</p>
                </div>

                <hr class="border-2 border-black my-8">

                <div id="partnerAssignmentSection">
                    <p class="text-center py-4 opacity-50 font-bold">Chargement partenaires...</p>
                </div>
            `;

            document.getElementById('clientModalContent').innerHTML = modalHTML;
            document.getElementById('clientModal').style.display = 'block';

            // Mettre à jour le compteur de documents
            var totalDocs = Object.values(documents).reduce(function(sum, arr) { return sum + arr.length; }, 0);
            var docsCountEl = document.getElementById('docsCount');
            if (docsCountEl) docsCountEl.textContent = totalDocs + ' document' + (totalDocs > 1 ? 's' : '');

            // Gestionnaire du formulaire d'upload de documents
            document.getElementById('uploadDocumentForm').addEventListener('submit', handleDocumentUpload);

            // Gestionnaire du formulaire d'ajout de séance
            document.getElementById('addSessionForm').addEventListener('submit', handleAddSession);

            // Charger les séances du client
            loadClientSessions(clientEmail);

            // Charger les partenaires assignes si commande existante
            if (clientOrderId) {
                loadPartnerAssignment(clientOrderId, 'partnerAssignmentSection');
            } else {
                var pas = document.getElementById('partnerAssignmentSection');
                if (pas) pas.innerHTML = '<p class="text-sm opacity-50 font-bold">Pas de commande active - impossible d\'assigner des partenaires</p>';
            }
        }

        function renderClientDocuments(documentsByDay, clientEmail) {
            if (Object.keys(documentsByDay).length === 0) {
                return '<p class="text-center py-8 opacity-50 font-bold">Aucun document ajouté</p>';
            }

            let html = '';
            const days = Object.keys(documentsByDay).sort((a, b) => Number(b) - Number(a));

            days.forEach(day => {
                const dayLabel = day === '0' || day === 'null' ? 'Sans jour' : 'JOUR ' + day;
                html += `
                    <div class="mb-6">
                        <div class="day-badge">${dayLabel}</div>
                        <div class="mt-4">
                `;

                documentsByDay[day].forEach(doc => {
                    const docName = doc.name || doc.title || 'Document';
                    const docDesc = doc.description || '';
                    const docDate = doc.created_at || doc.uploadedAt || '';
                    const docId = doc.id || '';

                    html += `
                        <div class="document-item">
                            <div>
                                <div class="font-black">${docName}</div>
                                ${docDesc ? '<div class="text-sm opacity-70">' + docDesc + '</div>' : ''}
                                <div class="text-xs font-bold opacity-50 mt-1">
                                    ${doc.type || 'document'} \u2022 ${docDate ? new Date(docDate).toLocaleDateString('fr-FR') : ''}
                                </div>
                            </div>
                            <button onclick="deleteDocument('${clientEmail}', '${docId}')" class="text-red-600 font-black hover:opacity-70">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            return html;
        }

        async function handleDocumentUpload(e) {
            e.preventDefault();

            const clientEmail = document.getElementById('currentClientEmail').value;
            const clientOrderId = document.getElementById('currentClientOrderId').value;
            const day = parseInt(document.getElementById('docDay').value);
            const title = document.getElementById('docTitle').value;
            const description = document.getElementById('docDescription').value;
            const fileInput = document.getElementById('docFile');

            if (!fileInput.files[0]) {
                alert('Veuillez sélectionner un fichier');
                return;
            }

            try {
                // Upload du fichier (conversion en base64)
                const fileData = await uploadFile(fileInput.files[0]);

                // Envoyer au backend API
                const response = await fetch(API_BASE_URL + '/api/admin/livrables/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: clientOrderId || null,
                        clientEmail: clientEmail,
                        dayNumber: day,
                        name: title,
                        type: fileData.fileType && fileData.fileType.startsWith('image/') ? 'photo' :
                              fileData.fileType && fileData.fileType.startsWith('video/') ? 'video' : 'document',
                        description: description,
                        download_url: fileData.fileUrl
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('\u2705 Document ajout\u00e9 avec succ\u00e8s !');
                    openClientModal(clientEmail); // Recharger le modal
                } else {
                    alert('\u274c Erreur : ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error(error);
                alert('\u274c Erreur lors de l\'envoi du fichier au serveur');
            }
        }

        async function deleteDocument(clientEmail, documentId) {
            if (!confirm('Voulez-vous vraiment supprimer ce document ?')) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/admin/livrables/' + documentId, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    alert('\u2705 Document supprim\u00e9');
                    openClientModal(clientEmail);
                } else {
                    alert('\u274c Erreur : ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error(error);
                alert('\u274c Erreur lors de la suppression');
            }
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        // ============================================
        // GESTION DES SÉANCES
        // ============================================

        async function loadClientSessions(clientEmail) {
            const container = document.getElementById('clientSessionsList');

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/sessions/user/${encodeURIComponent(clientEmail)}`);
                const sessions = await response.json();

                if (sessions.length === 0) {
                    container.innerHTML = '<p class="text-center py-4 opacity-50 font-bold">Aucune séance planifiée</p>';
                    return;
                }

                // Trier par date (plus récentes en premier)
                sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

                container.innerHTML = sessions.map(session => {
                    const sessionDate = new Date(session.date);
                    const formattedDate = sessionDate.toLocaleDateString('fr-FR', {
                        weekday: 'short',
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });

                    const isPast = sessionDate < new Date();
                    const statusClass = isPast ? 'bg-gray-100' : 'bg-yellow-50';
                    const statusBadge = isPast
                        ? '<span class="px-2 py-1 bg-gray-400 text-white text-xs font-black uppercase">Passée</span>'
                        : '<span class="px-2 py-1 bg-green-500 text-white text-xs font-black uppercase">À venir</span>';

                    return `
                        <div class="document-item ${statusClass}">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas ${session.icon} text-xl"></i>
                                    <span class="font-black text-lg">${session.type}</span>
                                    ${statusBadge}
                                </div>
                                <div class="text-sm font-bold">
                                    <i class="fas fa-calendar mr-1"></i>${formattedDate} à ${session.heure}
                                    <span class="ml-3"><i class="fas fa-clock mr-1"></i>${session.duree}</span>
                                </div>
                                ${session.description ? `<p class="text-sm opacity-70 mt-1">${session.description}</p>` : ''}
                                ${session.visioLink ? `
                                    <a href="${session.visioLink}" target="_blank" class="inline-block mt-2 px-3 py-1 bg-blue-500 text-white text-xs font-black uppercase hover:bg-blue-600">
                                        <i class="fas fa-video mr-1"></i>Lien visio
                                    </a>
                                ` : ''}
                                ${session.lieu ? `
                                    <p class="text-sm mt-2"><i class="fas fa-map-marker-alt mr-1"></i>${session.lieu}</p>
                                ` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editSession('${session.id}')" class="text-blue-600 font-black hover:opacity-70" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSession('${session.id}', '${clientEmail}')" class="text-red-600 font-black hover:opacity-70" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erreur chargement séances:', error);
                container.innerHTML = '<p class="text-center py-4 text-red-500 font-bold">Erreur de chargement</p>';
            }
        }

        async function handleAddSession(e) {
            e.preventDefault();

            const clientEmail = document.getElementById('sessionClientEmail').value;
            const sessionData = {
                userEmail: clientEmail,
                date: document.getElementById('sessionDate').value,
                heure: document.getElementById('sessionHeure').value,
                type: document.getElementById('sessionType').value,
                duree: document.getElementById('sessionDuree').value,
                description: document.getElementById('sessionDescription').value,
                visioLink: document.getElementById('sessionVisioLink').value || null,
                lieu: document.getElementById('sessionLieu').value || null,
                icon: document.getElementById('sessionIcon').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('✅ Séance ajoutée avec succès !');
                    // Réinitialiser le formulaire
                    document.getElementById('addSessionForm').reset();
                    // Recharger la liste des séances
                    loadClientSessions(clientEmail);
                } else {
                    alert('❌ Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur ajout séance:', error);
                alert('❌ Erreur lors de l\'ajout de la séance');
            }
        }

        async function deleteSession(sessionId, clientEmail) {
            if (!confirm('Voulez-vous vraiment supprimer cette séance ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('✅ Séance supprimée');
                    loadClientSessions(clientEmail);
                } else {
                    alert('❌ Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur suppression séance:', error);
                alert('❌ Erreur lors de la suppression');
            }
        }

        function editSession(sessionId) {
            // Pour une version simple, on redirige vers la modification
            alert('Fonctionnalité de modification à venir. Pour modifier, supprimez et recréez la séance.');
        }

        // ============================================================
        // SECTION MESSAGES
        // ============================================================

        let allMessages = [];
        let currentFilter = 'all';

        async function loadMessages(filter) {
            if (filter) currentFilter = filter;

            try {
                const response = await fetch(API_BASE_URL + '/api/admin/messages');
                if (!response.ok) throw new Error('Erreur chargement messages');
                allMessages = await response.json();
            } catch (error) {
                console.error('[ADMIN] Erreur chargement messages:', error);
                document.getElementById('messagesList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadMessages(); }, 5000);
                return;
            }

            // Stats
            const unread = allMessages.filter(function(m) { return m.status === 'unread'; }).length;
            const total = allMessages.length;
            document.getElementById('messagesStats').innerHTML =
                '<span class="text-[#ff6b6b] font-black text-2xl">' + unread + '</span>' +
                '<span class="text-sm font-bold opacity-70"> non lu' + (unread > 1 ? 's' : '') + ' / ' + total + ' total</span>';

            // Badge navbar
            var badge = document.getElementById('unreadBadge');
            if (unread > 0) {
                badge.style.display = 'block';
                badge.textContent = unread;
            } else {
                badge.style.display = 'none';
            }

            renderMessages();
        }

        function filterMessages(filter) {
            currentFilter = filter;
            renderMessages();
        }

        function renderMessages() {
            var filtered = allMessages;
            if (currentFilter !== 'all') {
                filtered = allMessages.filter(function(m) { return m.status === currentFilter; });
            }

            if (filtered.length === 0) {
                document.getElementById('messagesList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Aucun message</p>';
                return;
            }

            var html = '';
            filtered.forEach(function(msg) {
                var date = new Date(msg.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                var isUnread = msg.status === 'unread';
                var statusColors = { unread: '#ff6b6b', read: '#4dabf7', replied: '#51cf66', archived: '#999' };
                var statusLabels = { unread: 'NON LU', read: 'LU', replied: 'RÉPONDU', archived: 'ARCHIVÉ' };
                var subjectLabels = {
                    information: "DEMANDE D'INFO",
                    devis: 'DEVIS',
                    offre: 'QUESTION OFFRE',
                    technique: 'TECHNIQUE',
                    support: 'SUPPORT',
                    partenariat: 'PARTENARIAT',
                    autre: 'AUTRE'
                };
                var subjectLabel = subjectLabels[msg.subject] || msg.subject;

                html += '<div class="admin-card neo-shadow mb-4" style="cursor:pointer;' + (isUnread ? 'border-left:6px solid #ff6b6b;' : '') + '" onclick="openMessage(\'' + msg.id + '\')">' +
                    '<div class="flex justify-between items-start flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[250px]">' +
                            '<div class="font-black text-lg' + (isUnread ? ' text-[var(--genesis-yellow)]' : '') + '">' + msg.name + '</div>' +
                            '<div class="text-sm font-bold opacity-70">' + msg.email + '</div>' +
                            (msg.profil ? '<div class="text-xs font-bold opacity-50 mt-1">Profil: ' + msg.profil.toUpperCase() + '</div>' : '') +
                            '<div class="mt-2"><span style="background:#FFD700;color:black;padding:2px 8px;border:2px solid black;font-size:11px;font-weight:900;">' + subjectLabel + '</span></div>' +
                        '</div>' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<p class="text-sm font-bold opacity-80" style="max-height:40px;overflow:hidden;">' + msg.message.substring(0, 100) + (msg.message.length > 100 ? '...' : '') + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<div style="background:' + (statusColors[msg.status] || '#999') + ';color:black;padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;display:inline-block;">' + (statusLabels[msg.status] || msg.status) + '</div>' +
                            '<div class="text-xs font-bold opacity-60 mt-2">' + date + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            document.getElementById('messagesList').innerHTML = html;
        }

        async function openMessage(messageId) {
            // Marquer comme lu
            try {
                await fetch(API_BASE_URL + '/api/admin/messages/' + messageId);
            } catch (e) {}

            var msg = allMessages.find(function(m) { return m.id === messageId; });
            if (!msg) return;

            var date = new Date(msg.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            var modalHTML =
                '<h2 class="text-2xl font-black italic uppercase mb-6 text-[var(--genesis-yellow)]">' +
                    '<i class="fas fa-envelope-open mr-2"></i>MESSAGE' +
                '</h2>' +
                '<div class="grid md:grid-cols-3 gap-4 mb-6">' +
                    '<div><span class="text-sm font-bold opacity-60">DE :</span><br><span class="font-black text-lg">' + msg.name + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">EMAIL :</span><br><span class="font-black">' + msg.email + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">PROFIL :</span><br><span class="font-black">' + (msg.profil ? msg.profil.charAt(0).toUpperCase() + msg.profil.slice(1) : 'Non renseigné') + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">OBJET :</span><br><span class="font-black">' + msg.subject + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">DATE :</span><br><span class="font-black">' + date + '</span></div>' +
                '</div>' +
                '<div style="background:#FFF9E6;border-left:4px solid #FFD700;padding:20px;margin:20px 0;">' +
                    '<p style="white-space:pre-wrap;font-size:15px;line-height:1.6;">' + msg.message + '</p>' +
                '</div>' +
                '<div id="replyFormContainer" style="display:none;margin:20px 0;">' +
                    '<label class="text-sm font-black uppercase opacity-60 block mb-2"><i class="fas fa-pen mr-1"></i>Votre r\u00e9ponse :</label>' +
                    '<textarea id="replyTextarea" rows="6" style="width:100%;padding:15px;border:4px solid black;font-size:14px;font-family:inherit;resize:vertical;background:#fff;" placeholder="\u00c9crivez votre r\u00e9ponse ici..."></textarea>' +
                    '<div class="flex gap-3 mt-3">' +
                        '<button onclick="sendReply(\'' + msg.id + '\')" class="neo-btn-yellow px-6 py-3 text-sm" id="sendReplyBtn">' +
                            '<i class="fas fa-paper-plane mr-2"></i>ENVOYER' +
                        '</button>' +
                        '<button onclick="document.getElementById(\'replyFormContainer\').style.display=\'none\';document.getElementById(\'replyToggleBtn\').style.display=\'inline-block\';" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black">' +
                            '<i class="fas fa-times mr-2"></i>ANNULER' +
                        '</button>' +
                    '</div>' +
                '</div>' +
                '<div class="flex gap-3 flex-wrap mt-6">' +
                    '<button id="replyToggleBtn" onclick="document.getElementById(\'replyFormContainer\').style.display=\'block\';this.style.display=\'none\';document.getElementById(\'replyTextarea\').focus();" class="neo-btn-yellow px-6 py-3 text-sm">' +
                        '<i class="fas fa-reply mr-2"></i>RÉPONDRE PAR EMAIL' +
                    '</button>' +
                    '<button onclick="updateMessageStatus(\'' + msg.id + '\', \'archived\');closeClientModal()" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black">' +
                        '<i class="fas fa-archive mr-2"></i>ARCHIVER' +
                    '</button>' +
                    '<button onclick="deleteMessage(\'' + msg.id + '\')" class="border-4 border-black bg-[#ff6b6b] text-black px-6 py-3 text-sm font-black">' +
                        '<i class="fas fa-trash mr-2"></i>SUPPRIMER' +
                    '</button>' +
                '</div>';

            document.getElementById('clientModalContent').innerHTML = modalHTML;
            document.getElementById('clientModal').style.display = 'flex';

            // Mettre a jour le statut local
            msg.status = 'read';
            renderMessages();
            var unread = allMessages.filter(function(m) { return m.status === 'unread'; }).length;
            var badge = document.getElementById('unreadBadge');
            if (unread > 0) { badge.style.display = 'block'; badge.textContent = unread; } else { badge.style.display = 'none'; }
        }

        async function updateMessageStatus(messageId, status) {
            try {
                await fetch(API_BASE_URL + '/api/admin/messages/' + messageId + '/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                var msg = allMessages.find(function(m) { return m.id === messageId; });
                if (msg) msg.status = status;
                renderMessages();
            } catch (e) {
                console.error('[ADMIN] Erreur maj statut:', e);
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Supprimer ce message ?')) return;
            try {
                await fetch(API_BASE_URL + '/api/admin/messages/' + messageId, { method: 'DELETE' });
                allMessages = allMessages.filter(function(m) { return m.id !== messageId; });
                closeClientModal();
                renderMessages();
            } catch (e) {
                console.error('[ADMIN] Erreur suppression:', e);
            }
        }

        async function sendReply(messageId) {
            var textarea = document.getElementById('replyTextarea');
            var replyMessage = textarea.value.trim();

            if (!replyMessage) {
                alert('Veuillez \u00e9crire une r\u00e9ponse avant d\'envoyer.');
                textarea.focus();
                return;
            }

            var btn = document.getElementById('sendReplyBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ENVOI EN COURS...';

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/messages/' + messageId + '/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ replyMessage: replyMessage })
                });

                var responseText = await response.text();
                var data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseErr) {
                    console.error('[ADMIN] Reponse non-JSON du serveur:', responseText.substring(0, 500));
                    alert('Le serveur est en cours de red\u00e9marrage. Veuillez patienter 30 secondes et r\u00e9essayer.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>ENVOYER';
                    return;
                }

                if (response.ok && data.success) {
                    // Mettre a jour le statut local
                    var msg = allMessages.find(function(m) { return m.id === messageId; });
                    if (msg) msg.status = 'replied';
                    renderMessages();

                    // Afficher confirmation dans le formulaire
                    document.getElementById('replyFormContainer').innerHTML =
                        '<div style="background:#e8f5e9;border:4px solid #4caf50;padding:20px;text-align:center;">' +
                            '<i class="fas fa-check-circle" style="font-size:32px;color:#4caf50;"></i>' +
                            '<p class="font-black mt-2" style="color:#2e7d32;">R\u00e9ponse envoy\u00e9e avec succ\u00e8s !</p>' +
                        '</div>';
                } else {
                    console.error('[ADMIN] Erreur reponse:', data);
                    alert('Erreur : ' + (data.error || 'Impossible d\'envoyer la r\u00e9ponse'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>ENVOYER';
                }
            } catch (e) {
                console.error('[ADMIN] Erreur envoi reponse:', e);
                alert('Erreur de connexion au serveur. Veuillez r\u00e9essayer.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>ENVOYER';
            }
        }

        // ============================================================
        // SECTION COMMANDES — chargement rapide avec cache + keep-alive
        // ============================================================

        var _ORDERS_CACHE_KEY = 'fa_genesis_admin_orders_v1';
        var _keepAliveTimer = null;
        var _pingAbortCtrl = null;

        // --- Keep-alive : pinger /api/ping toutes les 10 min pour eviter le cold start ---
        function startKeepAlive() {
            if (_keepAliveTimer) return;
            _keepAliveTimer = setInterval(function() {
                try { fetch(API_BASE_URL + '/api/ping').catch(function(){}); } catch(e){}
            }, 10 * 60 * 1000);
        }
        function stopKeepAlive() {
            if (_keepAliveTimer) { clearInterval(_keepAliveTimer); _keepAliveTimer = null; }
        }

        // --- Cache localStorage ---
        function getCachedOrders() {
            try { return JSON.parse(localStorage.getItem(_ORDERS_CACHE_KEY) || 'null'); } catch(e) { return null; }
        }
        function setCachedOrders(orders) {
            try {
                localStorage.setItem(_ORDERS_CACHE_KEY, JSON.stringify({
                    orders: orders,
                    savedAt: new Date().toLocaleString('fr-FR')
                }));
            } catch(e) {}
        }

        // --- Construire le HTML des commandes ---
        function buildOrdersHtml(orders) {
            if (!orders || orders.length === 0) {
                return '<p class="text-center py-8 font-bold" style="color:white;">Aucune commande</p>';
            }
            var html = '';
            var statusColors = {
                pending_deposit: '#ff6b6b', active: '#51cf66', in_progress: '#ffd43b',
                delivered: '#4dabf7', completed: '#51cf66', pending_balance: '#ffd43b',
                paid_in_full: '#4dabf7', cancelled: '#999'
            };
            var statusLabels = {
                pending_deposit: 'ACOMPTE EN ATTENTE', active: 'ACTIF', in_progress: 'EN COURS',
                delivered: 'LIVR\u00c9', completed: 'TERMIN\u00c9', pending_balance: 'SOLDE EN ATTENTE',
                paid_in_full: 'PAY\u00c9 COMPLET', cancelled: 'ANNUL\u00c9'
            };
            orders.forEach(function(order) {
                var date = order.created_at ? new Date(order.created_at).toLocaleDateString('fr-FR') : '';
                var bgColor = statusColors[order.status] || '#999';
                var label = statusLabels[order.status] || order.status;
                var clientName = order.client_info ? ((order.client_info.first_name || order.client_info.firstName || '') + ' ' + (order.client_info.last_name || order.client_info.lastName || '')) : 'N/A';
                var clientEmail = order.client_info ? order.client_info.email : '';
                var scheduleBtn = '';
                if ((order.schedule_status || '') === 'confirmed' && order.start_date) {
                    var confirmedDateStr = new Date(order.start_date).toLocaleDateString('fr-FR');
                    scheduleBtn = '<button onclick="adminCancelStartDate(\'' + order.id + '\')" class="text-xs font-bold uppercase border-2 border-black px-3 py-1 hover:bg-red-100 mt-1">' +
                        '<i class="fas fa-calendar-times mr-1"></i>R\u00e9initialiser date (' + confirmedDateStr + ')</button>';
                }
                html += '<div class="admin-card neo-shadow mb-4">' +
                    '<div class="flex justify-between items-start flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<div class="text-xs font-bold">' + order.id + '</div>' +
                            '<div class="font-black text-lg">' + clientName + '</div>' +
                            '<div class="text-sm font-bold">' + clientEmail + '</div>' +
                        '</div>' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<div class="font-black">' + (order.product_name || 'N/A') + '</div>' +
                            '<div class="text-sm font-bold">' + date + '</div>' +
                            scheduleBtn +
                        '</div>' +
                        '<div class="text-center">' +
                            '<div class="text-2xl font-black text-[var(--genesis-yellow)]">' + (order.total_amount || 0) + '\u20ac</div>' +
                            '<div class="text-xs font-bold">Acompte: ' + (order.deposit_amount || 0) + '\u20ac | Solde: ' + (order.balance_amount || 0) + '\u20ac</div>' +
                            '<div class="text-xs mt-1">' +
                                (order.deposit_paid ? '<span style="color:#51cf66;">Acompte \u2713</span>' : '<span style="color:#ff6b6b;">Acompte \u2717</span>') + ' | ' +
                                (order.balance_paid ? '<span style="color:#51cf66;">Solde \u2713</span>' : '<span style="color:#ff6b6b;">Solde \u2717</span>') +
                            '</div>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<div style="background:' + bgColor + ';color:black;padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;display:inline-block;">' + label + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });
            return html;
        }

        // --- Ping /api/ping jusqu'au reveil du serveur, puis appel callback ---
        function pingUntilAlive(onSuccess, onGiveUp, loaderMsg, loaderSub) {
            var attempt = 0;
            var maxAttempts = 45; // 90s max a 2s d'intervalle
            var startTs = Date.now();
            function tryPing() {
                attempt++;
                if (attempt > maxAttempts) { onGiveUp(); return; }
                var elapsed = Math.round((Date.now() - startTs) / 1000);
                if (loaderMsg) loaderMsg.textContent = 'R\u00e9veil du serveur en cours...';
                if (loaderSub) loaderSub.textContent = 'Tentative ' + attempt + '/' + maxAttempts + ' \u2014 ' + elapsed + 's \u00e9coul\u00e9es';
                fetch(API_BASE_URL + '/api/ping')
                    .then(function(r) { if (r.ok) { onSuccess(); } else { setTimeout(tryPing, 2000); } })
                    .catch(function() { setTimeout(tryPing, 2000); });
            }
            tryPing();
        }

        // --- Charger les commandes : cache immediat + reveil serveur + refresh ---
        function loadOrders() {
            var loader = document.getElementById('ordersLoader');
            var loaderMsg = document.getElementById('ordersLoaderMsg');
            var loaderSub = document.getElementById('ordersLoaderSub');
            var listEl = document.getElementById('ordersList');

            // 1. Afficher le cache immediatement (donnees instantanees)
            var cache = getCachedOrders();
            if (cache && cache.orders) {
                if (listEl) listEl.innerHTML = buildOrdersHtml(cache.orders);
                if (loader) loader.style.display = '';
                if (loaderMsg) loaderMsg.textContent = 'Actualisation en cours...';
                if (loaderSub) loaderSub.textContent = cache.savedAt ? 'Donn\u00e9es du ' + cache.savedAt : '';
            } else {
                if (listEl) listEl.innerHTML = '';
                if (loader) loader.style.display = '';
                if (loaderMsg) loaderMsg.textContent = 'Chargement des commandes...';
                if (loaderSub) loaderSub.textContent = 'R\u00e9veil du serveur en cours...';
            }

            // 2. Pinger jusqu'au reveil, puis charger les commandes fraiches
            pingUntilAlive(
                function() {
                    // Serveur reveille : fetch des commandes
                    fetch(API_BASE_URL + '/api/orders/all')
                        .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                        .then(function(orders) {
                            if (loader) loader.style.display = 'none';
                            if (listEl) listEl.innerHTML = buildOrdersHtml(orders);
                            setCachedOrders(orders);
                            console.log('[ADMIN] Commandes chargees : ' + orders.length);
                        })
                        .catch(function(err) {
                            console.error('[ADMIN] Erreur fetch commandes:', err);
                            if (loader) loader.style.display = 'none';
                            if (!cache) {
                                if (listEl) listEl.innerHTML = '<div style="padding:20px;background:#ffd43b;border:2px solid black;color:black;text-align:center;">' +
                                    '<p style="font-weight:900;font-size:15px;margin-bottom:8px;"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>Erreur de chargement</p>' +
                                    '<button onclick="loadOrders();" style="background:black;color:white;border:2px solid black;padding:10px 24px;font-weight:900;cursor:pointer;font-size:13px;">' +
                                    '<i class="fas fa-redo" style="margin-right:6px;"></i>R\u00e9essayer</button></div>';
                            }
                        });
                },
                function() {
                    // Abandon apres 90s
                    if (loader) loader.style.display = 'none';
                    if (!cache) {
                        if (listEl) listEl.innerHTML = '<div style="padding:20px;background:#ffd43b;border:2px solid black;color:black;text-align:center;">' +
                            '<p style="font-weight:900;font-size:15px;margin-bottom:8px;"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>Serveur temporairement indisponible</p>' +
                            '<p style="font-size:13px;margin-bottom:12px;">Le serveur Render (gratuit) est en veille. Cliquez pour r\u00e9essayer.</p>' +
                            '<button onclick="loadOrders();" style="background:black;color:white;border:2px solid black;padding:10px 24px;font-weight:900;cursor:pointer;font-size:13px;">' +
                            '<i class="fas fa-redo" style="margin-right:6px;"></i>R\u00e9essayer</button></div>';
                    }
                },
                loaderMsg, loaderSub
            );
        }

        // Annuler date de demarrage confirmee (admin)
        async function adminCancelStartDate(orderId) {
            if (!confirm('Réinitialiser la date de démarrage confirmée pour cette commande ? Le client pourra proposer une nouvelle date.')) return;
            try {
                var resp = await fetch(API_BASE_URL + '/api/orders/' + encodeURIComponent(orderId) + '/cancel-start-date', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                var data = await resp.json();
                if (data.success) {
                    loadOrders();
                } else {
                    alert(data.error || 'Erreur lors de la réinitialisation.');
                }
            } catch (err) {
                alert('Erreur réseau : ' + err.message);
            }
        }

        // Charger le badge messages non lus au demarrage
        (async function() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/messages');
                if (response.ok) {
                    var msgs = await response.json();
                    var unread = msgs.filter(function(m) { return m.status === 'unread'; }).length;
                    var badge = document.getElementById('unreadBadge');
                    if (badge && unread > 0) { badge.style.display = 'block'; badge.textContent = unread; }
                }
            } catch (e) {}
        })();

        // Fermer le modal en cliquant en dehors
        window.onclick = function(event) {
            var clientModal = document.getElementById('clientModal');
            var partnerModal = document.getElementById('partnerModal');
            if (event.target === clientModal) {
                closeClientModal();
            }
            if (event.target === partnerModal) {
                closePartnerModal();
            }
        }

        // ============================================================
        // SECTION PARTENAIRES
        // ============================================================

        var PARTNER_TYPE_LABELS = {
            photographer: 'Photographe',
            videographer: 'Vidéographe',
            marketer: 'Marketeur',
            media: 'Média'
        };

        var allPartners = [];

        function showCreatePartnerForm() {
            document.getElementById('createPartnerFormContainer').style.display = 'block';
            // Generer un mot de passe temporaire
            var tempPass = 'FA' + Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('partnerPassword').value = tempPass;
        }

        function showPartnerTab(tab) {
            var listC = document.getElementById('partnersListContainer');
            var uploadsC = document.getElementById('partnerUploadsContainer');
            if (tab === 'list') {
                if (listC) listC.style.display = 'block';
                if (uploadsC) uploadsC.style.display = 'none';
            } else if (tab === 'uploads') {
                if (listC) listC.style.display = 'none';
                if (uploadsC) uploadsC.style.display = 'block';
                loadPendingUploads();
            }
        }

        // Creer un partenaire
        var createPartnerFormEl = document.getElementById('createPartnerForm');
        if (createPartnerFormEl) {
            createPartnerFormEl.addEventListener('submit', async function(e) {
                e.preventDefault();

                var data = {
                    prenom: document.getElementById('partnerPrenom').value,
                    nom: document.getElementById('partnerNom').value,
                    email: document.getElementById('partnerEmail').value,
                    telephone: document.getElementById('partnerTelephone').value,
                    partner_type: document.getElementById('partnerType').value,
                    specialite: document.getElementById('partnerSpecialite').value,
                    password: document.getElementById('partnerPassword').value
                };

                try {
                    var response = await fetch(API_BASE_URL + '/api/admin/partners/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    var result = await response.json();

                    if (result.success) {
                        alert('Partenaire créé avec succès !\n\nEmail : ' + data.email + '\nMot de passe : ' + data.password + '\n\nCommuniquez ces identifiants au partenaire.');
                        createPartnerFormEl.reset();
                        document.getElementById('createPartnerFormContainer').style.display = 'none';
                        loadPartnersList();
                    } else {
                        alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                    }
                } catch (error) {
                    console.error('[ADMIN] Erreur creation partenaire:', error);
                    alert('Erreur de connexion au serveur');
                }
            });
        }

        // Charger la liste des partenaires
        async function loadPartnersList() {
            var container = document.getElementById('partnersList');
            if (!container) return;

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partners');
                if (!response.ok) throw new Error('Erreur chargement');
                allPartners = await response.json();
            } catch (error) {
                console.error('[ADMIN] Erreur chargement partenaires:', error);
                container.innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadPartnersList(); }, 5000);
                return;
            }

            if (allPartners.length === 0) {
                container.innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Aucun partenaire</p>';
                return;
            }

            var html = '';
            allPartners.forEach(function(partner) {
                var typeLabel = PARTNER_TYPE_LABELS[partner.partner_type] || partner.partner_type;
                var statusColor = partner.accountStatus === 'deactivated' ? '#999' : '#51cf66';
                var statusLabel = partner.accountStatus === 'deactivated' ? 'DÉSACTIVÉ' : 'ACTIF';

                html += '<div class="client-row" onclick="openPartnerModal(\'' + partner.id + '\')">' +
                    '<div class="flex justify-between items-center flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<div class="font-black text-lg">' + (partner.prenom || '') + ' ' + (partner.nom || '') + '</div>' +
                            '<div class="text-sm font-bold opacity-70">' + partner.email + '</div>' +
                        '</div>' +
                        '<div>' +
                            '<span style="background:var(--genesis-yellow);color:black;padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;">' + typeLabel.toUpperCase() + '</span>' +
                        '</div>' +
                        '<div>' +
                            '<span style="background:' + statusColor + ';color:white;padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;">' + statusLabel + '</span>' +
                        '</div>' +
                        '<div>' +
                            '<button class="neo-btn-yellow px-4 py-2 text-sm"><i class="fas fa-folder-open mr-1"></i>Gerer</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            container.innerHTML = html;
        }

        // Modal detail partenaire
        async function openPartnerModal(partnerId) {
            var partner = allPartners.find(function(p) { return p.id === partnerId; });
            if (!partner) {
                try {
                    var resp = await fetch(API_BASE_URL + '/api/admin/partners/' + partnerId);
                    if (resp.ok) partner = await resp.json();
                } catch (e) {}
            }

            if (!partner) {
                alert('Partenaire non trouvé');
                return;
            }

            var typeLabel = PARTNER_TYPE_LABELS[partner.partner_type] || partner.partner_type;

            var modalHTML =
                '<h2 class="text-3xl font-black italic uppercase mb-6 text-[var(--genesis-yellow)]">' +
                    '<i class="fas fa-handshake mr-3"></i>' + (partner.prenom || '') + ' ' + (partner.nom || '') +
                '</h2>' +
                '<div class="grid md:grid-cols-2 gap-6 mb-8">' +
                    '<div>' +
                        '<p class="text-sm font-bold uppercase opacity-70 mb-1">Email</p>' +
                        '<p class="font-black">' + partner.email + '</p>' +
                    '</div>' +
                    '<div>' +
                        '<p class="text-sm font-bold uppercase opacity-70 mb-1">Téléphone</p>' +
                        '<p class="font-black">' + (partner.telephone || 'N/A') + '</p>' +
                    '</div>' +
                    '<div>' +
                        '<p class="text-sm font-bold uppercase opacity-70 mb-1">Type</p>' +
                        '<p class="font-black">' + typeLabel + '</p>' +
                    '</div>' +
                    '<div>' +
                        '<p class="text-sm font-bold uppercase opacity-70 mb-1">Spécialité</p>' +
                        '<p class="font-black">' + (partner.specialite || 'N/A') + '</p>' +
                    '</div>' +
                    '<div>' +
                        '<p class="text-sm font-bold uppercase opacity-70 mb-1">Statut</p>' +
                        '<p class="font-black">' + (partner.accountStatus === 'deactivated' ? 'Désactivé' : 'Actif') + '</p>' +
                    '</div>' +
                    '<div>' +
                        '<p class="text-sm font-bold uppercase opacity-70 mb-1">Créé le</p>' +
                        '<p class="font-black">' + (partner.created_at ? new Date(partner.created_at).toLocaleDateString('fr-FR') : 'N/A') + '</p>' +
                    '</div>' +
                '</div>' +
                '<hr class="border-2 border-black my-6">' +
                '<h3 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-cog mr-2"></i>ACTIONS</h3>' +
                '<div class="flex gap-3 flex-wrap">';

            if (partner.accountStatus === 'deactivated') {
                modalHTML += '<button onclick="togglePartnerStatus(\'' + partner.id + '\', \'active\')" class="neo-btn-yellow px-6 py-3 text-sm">' +
                    '<i class="fas fa-check mr-2"></i>RÉACTIVER' +
                '</button>';
            } else {
                modalHTML += '<button onclick="togglePartnerStatus(\'' + partner.id + '\', \'deactivated\')" class="border-4 border-[#ff6b6b] bg-[#ff6b6b] text-black px-6 py-3 text-sm font-black">' +
                    '<i class="fas fa-ban mr-2"></i>DÉSACTIVER' +
                '</button>';
            }

            modalHTML += '<button onclick="deletePartner(\'' + partner.id + '\')" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black">' +
                '<i class="fas fa-trash mr-2"></i>SUPPRIMER' +
            '</button>' +
            '</div>';

            document.getElementById('partnerModalContent').innerHTML = modalHTML;
            document.getElementById('partnerModal').style.display = 'block';
        }

        function closePartnerModal() {
            document.getElementById('partnerModal').style.display = 'none';
        }

        async function togglePartnerStatus(partnerId, newStatus) {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partners/' + partnerId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountStatus: newStatus })
                });

                var result = await response.json();
                if (result.success) {
                    alert('Statut mis à jour');
                    closePartnerModal();
                    loadPartnersList();
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur toggle status:', error);
                alert('Erreur de connexion');
            }
        }

        async function deletePartner(partnerId) {
            if (!confirm('Voulez-vous vraiment supprimer ce partenaire ? Cette action est irréversible.')) return;

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partners/' + partnerId, {
                    method: 'DELETE'
                });

                var result = await response.json();
                if (result.success) {
                    alert('Partenaire supprimé');
                    closePartnerModal();
                    loadPartnersList();
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur suppression:', error);
                alert('Erreur de connexion');
            }
        }

        // ============================================================
        // UPLOADS EN ATTENTE (VALIDATION)
        // ============================================================

        async function loadPendingUploads() {
            var container = document.getElementById('pendingUploadsList');
            if (!container) return;

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partner-uploads');
                if (!response.ok) throw new Error('Erreur chargement');
                var uploads = await response.json();

                // Filtrer seulement les pending
                var pending = uploads.filter(function(u) { return u.validation_status === 'pending'; });

                // Badge
                var badge = document.getElementById('pendingUploadsBadge');
                if (badge) {
                    if (pending.length > 0) {
                        badge.style.display = 'inline';
                        badge.textContent = pending.length;
                    } else {
                        badge.style.display = 'none';
                    }
                }

                if (pending.length === 0) {
                    container.innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Aucun upload en attente de validation</p>';
                    return;
                }

                var html = '';
                pending.forEach(function(upload) {
                    var date = upload.created_at ? new Date(upload.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                    var typeLabel = PARTNER_TYPE_LABELS[upload.partner_type] || upload.partner_type;

                    html += '<div class="admin-card mb-4" style="border-left:6px solid #ffd43b;">' +
                        '<div class="flex justify-between items-start flex-wrap gap-4">' +
                            '<div class="flex-1 min-w-[250px]">' +
                                '<div class="font-black text-lg">' + (upload.name || 'Fichier') + '</div>' +
                                '<div class="text-sm font-bold opacity-60">' +
                                    '<i class="fas fa-user mr-1"></i>' + (upload.partner_email || '') +
                                    ' <span style="background:var(--genesis-yellow);color:black;padding:1px 6px;border:1px solid black;font-size:10px;font-weight:900;margin-left:4px;">' + typeLabel.toUpperCase() + '</span>' +
                                '</div>' +
                                '<div class="text-xs opacity-50 mt-1">' +
                                    (upload.file_extension || '').toUpperCase() + ' - ' + date +
                                    ' - Commande: ' + (upload.order_id || 'N/A') +
                                '</div>' +
                                (upload.description ? '<div class="text-sm mt-2 opacity-70">' + upload.description + '</div>' : '') +
                                (upload.publication_link ? '<div class="text-xs mt-1"><i class="fas fa-link mr-1"></i><a href="' + upload.publication_link + '" target="_blank" class="text-blue-600 underline">Voir publication</a></div>' : '') +
                                (upload.file_url && upload.file_url.indexOf('data:image') === 0 ? '<div class="mt-2"><img src="' + upload.file_url + '" style="max-width:200px;max-height:150px;border:2px solid black;" alt="Preview"></div>' : '') +
                            '</div>' +
                            '<div class="flex gap-2">' +
                                '<button onclick="validateUpload(\'' + upload.id + '\', \'approve\')" class="border-4 border-[#51cf66] bg-[#51cf66] text-black px-4 py-2 text-xs font-black">' +
                                    '<i class="fas fa-check mr-1"></i>APPROUVER' +
                                '</button>' +
                                '<button onclick="rejectUpload(\'' + upload.id + '\')" class="border-4 border-[#ff6b6b] bg-[#ff6b6b] text-black px-4 py-2 text-xs font-black">' +
                                    '<i class="fas fa-times mr-1"></i>REFUSER' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('[ADMIN] Erreur chargement uploads:', error);
                container.innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement...</p>';
                setTimeout(function() { loadPendingUploads(); }, 5000);
            }
        }

        async function validateUpload(uploadId, action) {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partner-uploads/' + uploadId + '/validate', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });

                var result = await response.json();
                if (result.success) {
                    alert('Upload approuvé et ajouté aux livrables du client !');
                    loadPendingUploads();
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur validation:', error);
                alert('Erreur de connexion');
            }
        }

        async function rejectUpload(uploadId) {
            var reason = prompt('Raison du refus (optionnelle):');
            if (reason === null) return; // Annule

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partner-uploads/' + uploadId + '/validate', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reject', rejection_reason: reason || '' })
                });

                var result = await response.json();
                if (result.success) {
                    alert('Upload refusé');
                    loadPendingUploads();
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur rejet:', error);
                alert('Erreur de connexion');
            }
        }

        // ============================================================
        // ASSIGNATION PARTENAIRE DANS LE MODAL CLIENT
        // ============================================================

        async function loadPartnerAssignment(orderId, containerElId) {
            var container = document.getElementById(containerElId);
            if (!container) return;

            try {
                // Charger les partenaires disponibles et les assignations existantes
                var [partnersResp, assignResp] = await Promise.all([
                    fetch(API_BASE_URL + '/api/admin/partners'),
                    fetch(API_BASE_URL + '/api/admin/partners/assignments/' + orderId)
                ]);

                var partners = partnersResp.ok ? await partnersResp.json() : [];
                var assignments = assignResp.ok ? await assignResp.json() : [];

                // Filtrer les partenaires actifs
                var activePartners = partners.filter(function(p) { return p.accountStatus !== 'deactivated'; });

                var html = '<h4 class="text-lg font-black italic uppercase mb-4"><i class="fas fa-handshake mr-2"></i>PARTENAIRES ASSIGNÉS</h4>';

                // Afficher les assignations existantes
                if (assignments.length > 0) {
                    assignments.forEach(function(a) {
                        var partnerInfo = partners.find(function(p) { return p.id === a.partner_id; });
                        var partnerName = partnerInfo ? (partnerInfo.prenom + ' ' + partnerInfo.nom) : a.partner_email;
                        var typeLabel = partnerInfo ? (PARTNER_TYPE_LABELS[partnerInfo.partner_type] || partnerInfo.partner_type) : '';

                        html += '<div class="document-item">' +
                            '<div>' +
                                '<span class="font-black">' + partnerName + '</span>' +
                                (typeLabel ? ' <span style="background:var(--genesis-yellow);color:black;padding:1px 6px;border:1px solid black;font-size:10px;font-weight:900;">' + typeLabel.toUpperCase() + '</span>' : '') +
                                (a.notes ? '<div class="text-xs opacity-50 mt-1">' + a.notes + '</div>' : '') +
                            '</div>' +
                            '<button onclick="removeAssignment(\'' + a.id + '\', \'' + orderId + '\', \'' + containerElId + '\')" class="text-red-600 font-black hover:opacity-70">' +
                                '<i class="fas fa-times"></i>' +
                            '</button>' +
                        '</div>';
                    });
                } else {
                    html += '<p class="text-sm opacity-50 mb-4">Aucun partenaire assigné</p>';
                }

                // Formulaire d'assignation
                if (activePartners.length > 0) {
                    html += '<div class="mt-4 p-4 bg-gray-100 border-2 border-black">' +
                        '<label class="block font-black mb-2 uppercase text-sm">Assigner un partenaire</label>' +
                        '<div class="flex gap-2 flex-wrap">' +
                            '<select id="assignPartnerSelect_' + orderId + '" class="flex-1 min-w-[200px]">' +
                                '<option value="">Sélectionner...</option>';

                    activePartners.forEach(function(p) {
                        var label = p.prenom + ' ' + p.nom + ' (' + (PARTNER_TYPE_LABELS[p.partner_type] || p.partner_type) + ')';
                        html += '<option value="' + p.id + '">' + label + '</option>';
                    });

                    html += '</select>' +
                            '<input type="text" id="assignNotes_' + orderId + '" placeholder="Notes (optionnel)" class="flex-1 min-w-[150px]">' +
                            '<button onclick="assignPartner(\'' + orderId + '\', \'' + containerElId + '\')" class="neo-btn-yellow px-4 py-2 text-xs">' +
                                '<i class="fas fa-plus mr-1"></i>ASSIGNER' +
                            '</button>' +
                        '</div>' +
                    '</div>';
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('[ADMIN] Erreur chargement assignations:', error);
                container.innerHTML = '<p class="text-sm text-red-600 font-bold">Erreur de chargement des partenaires</p>';
            }
        }

        async function assignPartner(orderId, containerElId) {
            var select = document.getElementById('assignPartnerSelect_' + orderId);
            var notesInput = document.getElementById('assignNotes_' + orderId);

            if (!select || !select.value) {
                alert('Sélectionnez un partenaire');
                return;
            }

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partners/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partner_id: select.value,
                        order_id: orderId,
                        notes: notesInput ? notesInput.value : ''
                    })
                });

                var result = await response.json();
                if (result.success) {
                    loadPartnerAssignment(orderId, containerElId);
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur assignation:', error);
                alert('Erreur de connexion');
            }
        }

        async function removeAssignment(assignmentId, orderId, containerElId) {
            if (!confirm('Retirer ce partenaire du projet ?')) return;

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/partners/assign/' + assignmentId, {
                    method: 'DELETE'
                });

                var result = await response.json();
                if (result.success) {
                    loadPartnerAssignment(orderId, containerElId);
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur retrait assignation:', error);
                alert('Erreur de connexion');
            }
        }

        // ============================================================
        // SECTION DEVIS
        // ============================================================

        var allAdminQuotes = [];
        var currentQuoteFilter = 'all';
        var currentAdminQuote = null;

        var QUOTE_STATUS_LABELS = {
            DRAFT_REQUESTED: 'EN ATTENTE',
            PARTNER_PROPOSED: 'PROPOSÉ',
            ADMIN_REVIEW: 'A FINALISER',
            SENT_TO_CLIENT: 'ENVOYÉ',
            ACCEPTED: 'ACCEPTÉ',
            EXPIRED: 'EXPIRÉ',
            CANCELLED: 'ANNULÉ'
        };

        var QUOTE_STATUS_COLORS = {
            DRAFT_REQUESTED: '#ff6b6b',
            PARTNER_PROPOSED: '#ffd43b',
            ADMIN_REVIEW: '#4dabf7',
            SENT_TO_CLIENT: '#845ef7',
            ACCEPTED: '#51cf66',
            EXPIRED: '#999',
            CANCELLED: '#999'
        };

        var SERVICE_TYPE_LABELS = {
            photo: 'PHOTO',
            video: 'VIDÉO',
            media: 'MÉDIA',
            marketing: 'MARKETING',
            other: 'AUTRE'
        };

        async function loadAdminQuotes() {
            try {
                var url = API_BASE_URL + '/api/admin/quotes';
                var response = await fetch(url);
                if (!response.ok) throw new Error('Erreur chargement devis');
                allAdminQuotes = await response.json();
            } catch (error) {
                console.error('[ADMIN] Erreur chargement devis:', error);
                var listEl = document.getElementById('quotesList');
                if (listEl) listEl.innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadAdminQuotes(); }, 5000);
                return;
            }

            // Stats
            var pending = allAdminQuotes.filter(function(q) { return q.status === 'DRAFT_REQUESTED' || q.status === 'PARTNER_PROPOSED'; }).length;
            var statsEl = document.getElementById('quotesStats');
            if (statsEl) {
                statsEl.innerHTML = '<span class="text-[var(--genesis-yellow)] font-black text-2xl">' + allAdminQuotes.length + '</span>' +
                    '<span class="text-sm font-bold opacity-70"> devis total</span>' +
                    (pending > 0 ? '<br><span class="text-[#ff6b6b] font-black text-lg">' + pending + '</span><span class="text-sm font-bold opacity-70"> en attente</span>' : '');
            }

            // Badge nav
            var badge = document.getElementById('pendingQuotesBadge');
            if (badge) {
                if (pending > 0) { badge.style.display = 'block'; badge.textContent = pending; }
                else { badge.style.display = 'none'; }
            }

            renderAdminQuotes();
        }

        function filterAdminQuotes(status) {
            currentQuoteFilter = status;
            renderAdminQuotes();
        }

        function renderAdminQuotes() {
            var filtered = allAdminQuotes;
            if (currentQuoteFilter !== 'all') {
                filtered = allAdminQuotes.filter(function(q) { return q.status === currentQuoteFilter; });
            }

            // Assurer que la liste est visible et le detail cache
            var listEl = document.getElementById('quotesList');
            var detailEl = document.getElementById('quoteDetailView');
            if (listEl) listEl.style.display = 'block';
            if (detailEl) detailEl.style.display = 'none';

            if (filtered.length === 0) {
                if (listEl) listEl.innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Aucun devis</p>';
                return;
            }

            var html = '';
            filtered.forEach(function(quote) {
                var date = quote.created_at ? new Date(quote.created_at).toLocaleDateString('fr-FR') : '';
                var statusColor = QUOTE_STATUS_COLORS[quote.status] || '#999';
                var statusLabel = QUOTE_STATUS_LABELS[quote.status] || quote.status;
                var serviceLabel = SERVICE_TYPE_LABELS[quote.service_type] || quote.service_type || '';
                var partnerInfo = quote.partner_email ? ('<i class="fas fa-handshake mr-1"></i>' + quote.partner_email) : '<span class="text-[#ff6b6b]"><i class="fas fa-exclamation-triangle mr-1"></i>Non assigné</span>';
                var totalDisplay = quote.pricing ? (quote.pricing.total + '€') : '-';

                html += '<div class="admin-card neo-shadow mb-4" style="cursor:pointer;' +
                    (quote.status === 'DRAFT_REQUESTED' ? 'border-left:6px solid #ff6b6b;' : '') +
                    (quote.status === 'PARTNER_PROPOSED' ? 'border-left:6px solid #ffd43b;' : '') +
                    '" onclick="openQuoteDetail(\'' + quote.id + '\')">' +
                    '<div class="flex justify-between items-start flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<div class="text-xs font-bold opacity-50">' + (quote.quote_number || quote.id) + '</div>' +
                            '<div class="font-black text-lg">' + (quote.client_name || 'N/A') + '</div>' +
                            '<div class="text-sm font-bold opacity-70">' + (quote.client_email || '') + '</div>' +
                        '</div>' +
                        '<div class="flex-1 min-w-[150px]">' +
                            '<span style="background:var(--genesis-yellow);color:black;padding:2px 8px;border:2px solid black;font-size:11px;font-weight:900;">' + serviceLabel + '</span>' +
                            '<div class="text-sm font-bold opacity-60 mt-2">' + partnerInfo + '</div>' +
                        '</div>' +
                        '<div class="text-center">' +
                            '<div class="text-xl font-black text-[var(--genesis-yellow)]">' + totalDisplay + '</div>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<div style="background:' + statusColor + ';color:' + (quote.status === 'SENT_TO_CLIENT' ? 'white' : 'black') + ';padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;display:inline-block;">' + statusLabel + '</div>' +
                            '<div class="text-xs font-bold opacity-60 mt-2">' + date + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            if (listEl) listEl.innerHTML = html;
        }

        function backToQuotesList() {
            var listEl = document.getElementById('quotesList');
            var detailEl = document.getElementById('quoteDetailView');
            if (listEl) listEl.style.display = 'block';
            if (detailEl) detailEl.style.display = 'none';
        }

        async function openQuoteDetail(quoteId) {
            var quote = null;
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/quotes/' + quoteId);
                if (!response.ok) throw new Error('Erreur chargement devis');
                quote = await response.json();
                currentAdminQuote = quote;
            } catch (error) {
                console.error('[ADMIN] Erreur chargement detail devis:', error);
                alert('Erreur de chargement du devis');
                return;
            }

            // Cacher la liste, afficher le detail
            var listEl = document.getElementById('quotesList');
            var detailEl = document.getElementById('quoteDetailView');
            if (listEl) listEl.style.display = 'none';
            if (detailEl) detailEl.style.display = 'block';

            var statusColor = QUOTE_STATUS_COLORS[quote.status] || '#999';
            var statusLabel = QUOTE_STATUS_LABELS[quote.status] || quote.status;
            var serviceLabel = SERVICE_TYPE_LABELS[quote.service_type] || quote.service_type || '';

            var html = '';

            // En-tete
            html += '<div class="admin-card neo-shadow mb-6">' +
                '<div class="flex justify-between items-start flex-wrap gap-4 mb-6">' +
                    '<div>' +
                        '<h3 class="text-3xl font-black italic uppercase text-[var(--genesis-yellow)]">' +
                            '<i class="fas fa-file-invoice mr-3"></i>DEVIS ' + (quote.quote_number || quote.id) +
                        '</h3>' +
                        '<div class="mt-2">' +
                            '<span style="background:' + statusColor + ';color:' + (quote.status === 'SENT_TO_CLIENT' ? 'white' : 'black') + ';padding:4px 12px;border:2px solid black;font-size:12px;font-weight:900;">' + statusLabel + '</span>' +
                            ' <span style="background:var(--genesis-yellow);color:black;padding:4px 12px;border:2px solid black;font-size:12px;font-weight:900;margin-left:4px;">' + serviceLabel + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="text-right text-sm font-bold opacity-60">' +
                        '<div>Créé le ' + (quote.created_at ? new Date(quote.created_at).toLocaleDateString('fr-FR') : 'N/A') + '</div>' +
                        (quote.sent_at ? '<div>Envoyé le ' + new Date(quote.sent_at).toLocaleDateString('fr-FR') + '</div>' : '') +
                        (quote.accepted_at ? '<div class="text-[#51cf66]">Accepté le ' + new Date(quote.accepted_at).toLocaleDateString('fr-FR') + '</div>' : '') +
                    '</div>' +
                '</div>' +

                // Infos client
                '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-user mr-2"></i>CLIENT</h4>' +
                '<div class="grid md:grid-cols-3 gap-4 mb-6">' +
                    '<div><span class="text-sm font-bold opacity-60">Nom</span><br><span class="font-black">' + (quote.client_name || 'N/A') + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">Email</span><br><span class="font-black">' + (quote.client_email || 'N/A') + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">Profil</span><br><span class="font-black">' + (quote.client_profil || 'N/A') + '</span></div>' +
                '</div>' +

                // Brief
                '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-clipboard mr-2"></i>BRIEF</h4>' +
                '<div style="background:#FFF9E6;border-left:4px solid #FFD700;padding:15px;margin-bottom:20px;">' +
                    '<p style="white-space:pre-wrap;">' + (quote.brief || 'Aucun brief') + '</p>' +
                '</div>' +
            '</div>';

            // Partenaire assigne
            html += '<div class="admin-card neo-shadow mb-6">' +
                '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-handshake mr-2"></i>PARTENAIRE</h4>';

            if (quote.partner_id && quote.partner_info) {
                html += '<div class="document-item">' +
                    '<div>' +
                        '<span class="font-black text-lg">' + (quote.partner_info.prenom || '') + ' ' + (quote.partner_info.nom || '') + '</span>' +
                        ' <span style="background:var(--genesis-yellow);color:black;padding:2px 8px;border:1px solid black;font-size:10px;font-weight:900;">' +
                            (PARTNER_TYPE_LABELS[quote.partner_info.partner_type] || '').toUpperCase() + '</span>' +
                        '<div class="text-sm opacity-60">' + (quote.partner_email || '') + '</div>' +
                    '</div>' +
                '</div>';
            } else {
                html += '<p class="text-[#ff6b6b] font-bold mb-4"><i class="fas fa-exclamation-triangle mr-1"></i>Aucun partenaire assigné</p>';
            }

            // Dropdown pour assigner/changer partenaire (si pas encore envoye)
            if (quote.status !== 'SENT_TO_CLIENT' && quote.status !== 'ACCEPTED' && quote.status !== 'CANCELLED') {
                html += '<div class="mt-4 p-4 bg-gray-100 border-2 border-black">' +
                    '<label class="block font-black mb-2 uppercase text-sm">' + (quote.partner_id ? 'Changer le partenaire' : 'Assigner un partenaire') + '</label>' +
                    '<div class="flex gap-2 flex-wrap">' +
                        '<select id="quotePartnerSelect" class="flex-1 min-w-[200px]">' +
                            '<option value="">Sélectionner...</option>';

                // On va remplir les options dynamiquement
                if (allPartners && allPartners.length > 0) {
                    allPartners.forEach(function(p) {
                        if (p.accountStatus !== 'deactivated') {
                            var label = (p.prenom || '') + ' ' + (p.nom || '') + ' (' + (PARTNER_TYPE_LABELS[p.partner_type] || p.partner_type) + ')';
                            html += '<option value="' + p.id + '"' + (p.id === quote.partner_id ? ' selected' : '') + '>' + label + '</option>';
                        }
                    });
                }

                html += '</select>' +
                        '<button onclick="assignPartnerToQuote(\'' + quote.id + '\')" class="neo-btn-yellow px-4 py-2 text-xs">' +
                            '<i class="fas fa-check mr-1"></i>ASSIGNER' +
                        '</button>' +
                    '</div>' +
                '</div>';
            }

            html += '</div>';

            // Proposition du partenaire (si existe)
            if (quote.partner_proposal) {
                html += '<div class="admin-card neo-shadow mb-6">' +
                    '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-lightbulb mr-2"></i>PROPOSITION DU PARTENAIRE</h4>';

                if (quote.partner_proposal.items && quote.partner_proposal.items.length > 0) {
                    html += '<table style="width:100%;border-collapse:collapse;border:2px solid black;">' +
                        '<thead><tr style="background:var(--genesis-yellow);">' +
                            '<th style="padding:8px;border:2px solid black;text-align:left;font-size:12px;">PRESTATION</th>' +
                            '<th style="padding:8px;border:2px solid black;text-align:center;font-size:12px;">QTÉ</th>' +
                            '<th style="padding:8px;border:2px solid black;text-align:right;font-size:12px;">P.U.</th>' +
                            '<th style="padding:8px;border:2px solid black;text-align:right;font-size:12px;">TOTAL</th>' +
                        '</tr></thead><tbody>';

                    var propTotal = 0;
                    quote.partner_proposal.items.forEach(function(item) {
                        var lineTotal = (item.qty || 1) * (item.unit_price || 0);
                        propTotal += lineTotal;
                        html += '<tr>' +
                            '<td style="padding:8px;border:2px solid black;">' + (item.label || '') +
                                (item.description ? '<br><span class="text-xs opacity-60">' + item.description + '</span>' : '') + '</td>' +
                            '<td style="padding:8px;border:2px solid black;text-align:center;">' + (item.qty || 1) + '</td>' +
                            '<td style="padding:8px;border:2px solid black;text-align:right;">' + (item.unit_price || 0) + '€</td>' +
                            '<td style="padding:8px;border:2px solid black;text-align:right;font-weight:900;">' + lineTotal + '€</td>' +
                        '</tr>';
                    });

                    html += '</tbody></table>' +
                        '<div class="text-right mt-2 font-black text-lg">Total proposition : ' + propTotal + '€</div>';
                }

                if (quote.partner_proposal.delay) {
                    html += '<div class="mt-3 text-sm"><strong>Délai estimé :</strong> ' + quote.partner_proposal.delay + '</div>';
                }
                if (quote.partner_proposal.notes) {
                    html += '<div class="mt-2 text-sm"><strong>Notes internes :</strong> ' + quote.partner_proposal.notes + '</div>';
                }

                // Bouton pour pre-remplir depuis proposition
                if (quote.status === 'PARTNER_PROPOSED' || quote.status === 'DRAFT_REQUESTED') {
                    html += '<div class="mt-4">' +
                        '<button onclick="prepareQuoteFromProposal(\'' + quote.id + '\')" class="neo-btn-yellow px-6 py-3 text-sm">' +
                            '<i class="fas fa-copy mr-2"></i>UTILISER COMME BASE POUR LE DEVIS' +
                        '</button>' +
                    '</div>';
                }

                html += '</div>';
            }

            // Formulaire version admin (editable si pas encore envoye ou accepte)
            if (quote.status !== 'ACCEPTED' && quote.status !== 'CANCELLED' && quote.status !== 'EXPIRED') {
                html += '<div class="admin-card neo-shadow mb-6" id="quoteAdminForm">' +
                    '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-edit mr-2"></i>DEVIS FINAL (version FA GENESIS)</h4>';

                // Items editables
                var adminItems = (quote.admin_final && quote.admin_final.items) ? quote.admin_final.items : [];
                var adminNotes = (quote.admin_final && quote.admin_final.notes) ? quote.admin_final.notes : '';

                html += '<div id="quoteItemsContainer">';
                if (adminItems.length > 0) {
                    adminItems.forEach(function(item, index) {
                        html += renderQuoteItemRow(index, item);
                    });
                } else {
                    html += renderQuoteItemRow(0, { label: '', qty: 1, unit_price: 0, description: '' });
                }
                html += '</div>';

                html += '<button onclick="addQuoteItem()" class="border-4 border-black bg-gray-200 text-black px-4 py-2 text-xs font-black mt-2 mb-4">' +
                    '<i class="fas fa-plus mr-1"></i>AJOUTER UNE LIGNE' +
                '</button>';

                // Total calcule
                html += '<div id="quoteTotalDisplay" class="text-right mb-4 p-4 bg-gray-100 border-2 border-black">' +
                    '<div class="text-sm font-bold">Total : <span id="quoteTotalAmount" class="text-2xl font-black text-[var(--genesis-yellow)]">0€</span></div>' +
                    '<div class="text-sm font-bold">Acompte 30% : <span id="quoteDepositAmount" class="font-black">0€</span></div>' +
                    '<div class="text-sm font-bold">Solde 70% : <span id="quoteBalanceAmount" class="font-black">0€</span></div>' +
                '</div>';

                // Notes
                html += '<div class="mb-4">' +
                    '<label class="block font-black mb-2 uppercase text-sm">Notes / Conditions</label>' +
                    '<textarea id="quoteAdminNotes" rows="3" class="w-full p-3 border-4 border-black font-bold" placeholder="Conditions particulières...">' + adminNotes + '</textarea>' +
                '</div>';

                // Boutons action
                html += '<div class="flex gap-3 flex-wrap">' +
                    '<button onclick="reviewQuote(\'' + quote.id + '\')" class="neo-btn-yellow px-6 py-3 text-sm">' +
                        '<i class="fas fa-save mr-2"></i>SAUVEGARDER' +
                    '</button>';

                if (quote.status === 'ADMIN_REVIEW' || quote.status === 'PARTNER_PROPOSED' || quote.status === 'DRAFT_REQUESTED') {
                    html += '<button onclick="sendQuoteToClient(\'' + quote.id + '\')" class="border-4 border-[#845ef7] bg-[#845ef7] text-white px-6 py-3 text-sm font-black">' +
                        '<i class="fas fa-paper-plane mr-2"></i>ENVOYER AU CLIENT' +
                    '</button>';
                }

                html += '</div>';
                html += '</div>';
            }

            // Pricing affiche si devis deja envoye/accepte
            if ((quote.status === 'SENT_TO_CLIENT' || quote.status === 'ACCEPTED') && quote.pricing) {
                html += '<div class="admin-card neo-shadow mb-6">' +
                    '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-money-bill-wave mr-2"></i>TARIFICATION</h4>';

                if (quote.admin_final && quote.admin_final.items) {
                    html += '<table style="width:100%;border-collapse:collapse;border:2px solid black;">' +
                        '<thead><tr style="background:var(--genesis-yellow);">' +
                            '<th style="padding:8px;border:2px solid black;text-align:left;font-size:12px;">PRESTATION</th>' +
                            '<th style="padding:8px;border:2px solid black;text-align:center;font-size:12px;">QTÉ</th>' +
                            '<th style="padding:8px;border:2px solid black;text-align:right;font-size:12px;">P.U.</th>' +
                            '<th style="padding:8px;border:2px solid black;text-align:right;font-size:12px;">TOTAL</th>' +
                        '</tr></thead><tbody>';

                    quote.admin_final.items.forEach(function(item) {
                        var lineTotal = (item.qty || 1) * (item.unit_price || 0);
                        html += '<tr>' +
                            '<td style="padding:8px;border:2px solid black;">' + (item.label || '') + '</td>' +
                            '<td style="padding:8px;border:2px solid black;text-align:center;">' + (item.qty || 1) + '</td>' +
                            '<td style="padding:8px;border:2px solid black;text-align:right;">' + (item.unit_price || 0) + '€</td>' +
                            '<td style="padding:8px;border:2px solid black;text-align:right;font-weight:900;">' + lineTotal + '€</td>' +
                        '</tr>';
                    });

                    html += '</tbody></table>';
                }

                html += '<div class="text-right mt-4 p-4 bg-gray-100 border-2 border-black">' +
                    '<div class="text-lg font-black">Total : ' + quote.pricing.total + '€</div>' +
                    '<div class="text-sm font-bold">Acompte 30% : ' + quote.pricing.deposit_amount + '€</div>' +
                    '<div class="text-sm font-bold">Solde 70% : ' + quote.pricing.balance_amount + '€</div>' +
                '</div>' +
                '</div>';
            }

            // Commande liee
            if (quote.order_id) {
                html += '<div class="admin-card neo-shadow mb-6">' +
                    '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-receipt mr-2"></i>COMMANDE LIÉE</h4>' +
                    '<p class="font-black">Commande : ' + quote.order_id + '</p>' +
                    '<button onclick="showSection(\'commandes\')" class="neo-btn-yellow px-4 py-2 text-sm mt-2">' +
                        '<i class="fas fa-external-link-alt mr-1"></i>VOIR LES COMMANDES' +
                    '</button>' +
                '</div>';
            }

            // Bouton annuler
            if (quote.status !== 'ACCEPTED' && quote.status !== 'CANCELLED' && quote.status !== 'EXPIRED') {
                html += '<div class="mt-6">' +
                    '<button onclick="cancelQuote(\'' + quote.id + '\')" class="border-4 border-[#ff6b6b] bg-[#ff6b6b] text-black px-6 py-3 text-sm font-black">' +
                        '<i class="fas fa-times mr-2"></i>ANNULER CE DEVIS' +
                    '</button>' +
                '</div>';
            }

            var contentEl = document.getElementById('quoteDetailContent');
            if (contentEl) contentEl.innerHTML = html;

            // Charger les partenaires pour le select (si pas encore charges)
            if (!allPartners || allPartners.length === 0) {
                try {
                    var pResp = await fetch(API_BASE_URL + '/api/admin/partners');
                    if (pResp.ok) allPartners = await pResp.json();
                    // Re-ouvrir le detail pour mettre a jour le select
                    openQuoteDetail(quoteId);
                    return;
                } catch (e) {}
            }

            // Calcul initial du total
            recalculateQuoteTotal();
        }

        function renderQuoteItemRow(index, item) {
            return '<div class="quote-item-row grid grid-cols-12 gap-2 mb-2 items-start" data-index="' + index + '">' +
                '<div class="col-span-4">' +
                    '<input type="text" class="quote-item-label w-full p-2 border-2 border-black text-sm font-bold" placeholder="Prestation" value="' + (item.label || '') + '">' +
                '</div>' +
                '<div class="col-span-2">' +
                    '<input type="text" class="quote-item-desc w-full p-2 border-2 border-black text-sm" placeholder="Description" value="' + (item.description || '') + '">' +
                '</div>' +
                '<div class="col-span-2">' +
                    '<input type="number" class="quote-item-qty w-full p-2 border-2 border-black text-sm font-bold text-center" value="' + (item.qty || 1) + '" min="1" onchange="recalculateQuoteTotal()">' +
                '</div>' +
                '<div class="col-span-2">' +
                    '<input type="number" class="quote-item-price w-full p-2 border-2 border-black text-sm font-bold text-right" value="' + (item.unit_price || 0) + '" min="0" step="0.01" onchange="recalculateQuoteTotal()">' +
                '</div>' +
                '<div class="col-span-2 flex items-center gap-1">' +
                    '<span class="quote-item-line-total font-black text-sm">0€</span>' +
                    '<button onclick="removeQuoteItem(' + index + ')" class="text-red-600 font-black hover:opacity-70 ml-2" title="Supprimer">' +
                        '<i class="fas fa-trash text-xs"></i>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        function addQuoteItem() {
            var container = document.getElementById('quoteItemsContainer');
            if (!container) return;
            var rows = container.querySelectorAll('.quote-item-row');
            var newIndex = rows.length;
            var newRow = document.createElement('div');
            newRow.innerHTML = renderQuoteItemRow(newIndex, { label: '', qty: 1, unit_price: 0, description: '' });
            container.appendChild(newRow.firstChild);
        }

        function removeQuoteItem(index) {
            var container = document.getElementById('quoteItemsContainer');
            if (!container) return;
            var rows = container.querySelectorAll('.quote-item-row');
            if (rows.length <= 1) {
                alert('Au moins une ligne est requise');
                return;
            }
            if (rows[index]) rows[index].remove();
            recalculateQuoteTotal();
        }

        function recalculateQuoteTotal() {
            var container = document.getElementById('quoteItemsContainer');
            if (!container) return;

            var rows = container.querySelectorAll('.quote-item-row');
            var total = 0;

            rows.forEach(function(row) {
                var qty = parseFloat(row.querySelector('.quote-item-qty').value) || 0;
                var price = parseFloat(row.querySelector('.quote-item-price').value) || 0;
                var lineTotal = qty * price;
                total += lineTotal;
                var lineTotalEl = row.querySelector('.quote-item-line-total');
                if (lineTotalEl) lineTotalEl.textContent = lineTotal + '€';
            });

            var totalEl = document.getElementById('quoteTotalAmount');
            var depositEl = document.getElementById('quoteDepositAmount');
            var balanceEl = document.getElementById('quoteBalanceAmount');

            if (totalEl) totalEl.textContent = total + '€';
            if (depositEl) depositEl.textContent = Math.round(total * 0.3) + '€';
            if (balanceEl) balanceEl.textContent = Math.round(total * 0.7) + '€';
        }

        function collectQuoteItems() {
            var container = document.getElementById('quoteItemsContainer');
            if (!container) return [];

            var items = [];
            var rows = container.querySelectorAll('.quote-item-row');
            rows.forEach(function(row) {
                var label = row.querySelector('.quote-item-label').value.trim();
                var description = row.querySelector('.quote-item-desc').value.trim();
                var qty = parseInt(row.querySelector('.quote-item-qty').value) || 1;
                var unit_price = parseFloat(row.querySelector('.quote-item-price').value) || 0;

                if (label) {
                    items.push({ label: label, description: description, qty: qty, unit_price: unit_price });
                }
            });

            return items;
        }

        async function assignPartnerToQuote(quoteId) {
            var select = document.getElementById('quotePartnerSelect');
            if (!select || !select.value) {
                alert('Sélectionnez un partenaire');
                return;
            }

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/quotes/' + quoteId + '/assign-partner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner_id: select.value })
                });

                var result = await response.json();
                if (result.success) {
                    alert('Partenaire assigné au devis !');
                    openQuoteDetail(quoteId);
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur assignation partenaire devis:', error);
                alert('Erreur de connexion');
            }
        }

        function prepareQuoteFromProposal(quoteId) {
            // Utiliser le devis actuellement affiche (frais) ou chercher dans la liste
            var quote = (currentAdminQuote && currentAdminQuote.id === quoteId) ? currentAdminQuote : allAdminQuotes.find(function(q) { return q.id === quoteId; });
            if (!quote || !quote.partner_proposal || !quote.partner_proposal.items) {
                alert('Aucune proposition partenaire trouvée');
                return;
            }

            // Remplir les items depuis la proposition
            var container = document.getElementById('quoteItemsContainer');
            if (!container) return;

            container.innerHTML = '';
            quote.partner_proposal.items.forEach(function(item, index) {
                var row = document.createElement('div');
                row.innerHTML = renderQuoteItemRow(index, item);
                container.appendChild(row.firstChild);
            });

            recalculateQuoteTotal();

            // Scroller vers le formulaire
            var formEl = document.getElementById('quoteAdminForm');
            if (formEl) formEl.scrollIntoView({ behavior: 'smooth' });
        }

        async function reviewQuote(quoteId) {
            var items = collectQuoteItems();
            if (items.length === 0) {
                alert('Ajoutez au moins une prestation');
                return;
            }

            var notesEl = document.getElementById('quoteAdminNotes');
            var notes = notesEl ? notesEl.value.trim() : '';

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/quotes/' + quoteId + '/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: items, notes: notes })
                });

                var result = await response.json();
                if (result.success) {
                    alert('Devis sauvegardé !');
                    // Recharger
                    loadAdminQuotes();
                    openQuoteDetail(quoteId);
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur sauvegarde devis:', error);
                alert('Erreur de connexion');
            }
        }

        async function sendQuoteToClient(quoteId) {
            // D'abord sauvegarder les items actuels
            var items = collectQuoteItems();
            if (items.length === 0) {
                alert('Ajoutez au moins une prestation avant d\'envoyer');
                return;
            }

            // Verifier qu'il y a un total > 0
            var total = 0;
            items.forEach(function(item) { total += (item.qty || 1) * (item.unit_price || 0); });
            if (total <= 0) {
                alert('Le total du devis doit être supérieur à 0€');
                return;
            }

            if (!confirm('Envoyer ce devis au client par email ?\n\nTotal : ' + total + '€\nAcompte 30% : ' + Math.round(total * 0.3) + '€')) return;

            // D'abord sauvegarder
            var notesEl = document.getElementById('quoteAdminNotes');
            var notes = notesEl ? notesEl.value.trim() : '';

            try {
                // Sauvegarder d'abord
                var reviewResp = await fetch(API_BASE_URL + '/api/admin/quotes/' + quoteId + '/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: items, notes: notes })
                });

                var reviewResult = await reviewResp.json();
                if (!reviewResult.success) {
                    alert('Erreur sauvegarde: ' + (reviewResult.error || 'Erreur'));
                    return;
                }

                // Puis envoyer
                var sendResp = await fetch(API_BASE_URL + '/api/admin/quotes/' + quoteId + '/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                var sendResult = await sendResp.json();
                if (sendResult.success) {
                    alert('Devis envoyé au client avec succès !');
                    loadAdminQuotes();
                    openQuoteDetail(quoteId);
                } else {
                    alert('Erreur envoi: ' + (sendResult.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur envoi devis:', error);
                alert('Erreur de connexion');
            }
        }

        async function cancelQuote(quoteId) {
            if (!confirm('Voulez-vous vraiment annuler ce devis ? Cette action est irréversible.')) return;

            try {
                var response = await fetch(API_BASE_URL + '/api/admin/quotes/' + quoteId + '/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                var result = await response.json();
                if (result.success) {
                    alert('Devis annulé');
                    loadAdminQuotes();
                    backToQuotesList();
                } else {
                    alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('[ADMIN] Erreur annulation devis:', error);
                alert('Erreur de connexion');
            }
        }

        // Charger le badge devis au demarrage
        (async function() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/quotes');
                if (response.ok) {
                    var quotes = await response.json();
                    var pending = quotes.filter(function(q) { return q.status === 'DRAFT_REQUESTED' || q.status === 'PARTNER_PROPOSED'; }).length;
                    var badge = document.getElementById('pendingQuotesBadge');
                    if (badge && pending > 0) { badge.style.display = 'block'; badge.textContent = pending; }
                }
            } catch (e) {}
        })();

        // ============================================================
        // WORKFLOW - LIVRABLES A VALIDER
        // ============================================================

        function showWorkflowTab(tab) {
            try {
                var aiTab = document.getElementById('tabPendingAi');
                var partnerTab = document.getElementById('tabPendingPartner');
                var aiContainer = document.getElementById('pendingAiContainer');
                var partnerContainer = document.getElementById('pendingPartnerContainer');
                if (!aiTab || !partnerTab || !aiContainer || !partnerContainer) return;

                if (tab === 'pending-ai') {
                    aiTab.style.background = 'var(--genesis-yellow)';
                    partnerTab.style.background = '#d1d5db';
                    aiContainer.style.display = 'block';
                    partnerContainer.style.display = 'none';
                } else {
                    aiTab.style.background = '#d1d5db';
                    partnerTab.style.background = 'var(--genesis-yellow)';
                    aiContainer.style.display = 'none';
                    partnerContainer.style.display = 'block';
                }
            } catch (e) { console.error('showWorkflowTab:', e); }
        }

        async function loadPendingDeliverables() {
            try {
                var token = localStorage.getItem('fa_genesis_token');
                var response = await fetch(API_BASE_URL + '/api/admin/deliverables/pending', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!response.ok) throw new Error('Erreur chargement');
                var data = await response.json();
                var deliverables = data.deliverables || [];

                // Mettre a jour le badge
                var badge = document.getElementById('pendingWorkflowBadge');
                if (badge) {
                    if (deliverables.length > 0) {
                        badge.style.display = 'block';
                        badge.textContent = deliverables.length;
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // Separer IA et partenaires
                var aiDocs = [];
                var partnerDocs = [];
                for (var i = 0; i < deliverables.length; i++) {
                    if (deliverables[i].owner_role === 'ai' || deliverables[i].workflow_status === 'DRAFT_AI') {
                        aiDocs.push(deliverables[i]);
                    } else {
                        partnerDocs.push(deliverables[i]);
                    }
                }

                // Afficher docs IA
                var aiList = document.getElementById('pendingAiList');
                if (aiList) {
                    if (aiDocs.length === 0) {
                        aiList.innerHTML = '<p class="text-gray-500">Aucun document IA en attente.</p>';
                    } else {
                        var html = '';
                        for (var a = 0; a < aiDocs.length; a++) {
                            html += renderPendingCard(aiDocs[a]);
                        }
                        aiList.innerHTML = html;
                    }
                }

                // Afficher docs partenaires
                var partnerList = document.getElementById('pendingPartnerList');
                if (partnerList) {
                    if (partnerDocs.length === 0) {
                        partnerList.innerHTML = '<p class="text-gray-500">Aucun livrable partenaire en attente.</p>';
                    } else {
                        var html2 = '';
                        for (var p = 0; p < partnerDocs.length; p++) {
                            html2 += renderPendingCard(partnerDocs[p]);
                        }
                        partnerList.innerHTML = html2;
                    }
                }

                // Charger les projets pour le select seance
                loadProjectsForSession();
            } catch (e) {
                console.error('loadPendingDeliverables:', e);
            }
        }

        function renderPendingCard(liv) {
            var statusBadge = '';
            if (liv.workflow_status === 'DRAFT_AI') statusBadge = '<span style="background:#3b82f6;color:white;padding:2px 8px;font-size:11px;font-weight:bold;">BROUILLON IA</span>';
            else if (liv.workflow_status === 'PENDING_ADMIN') statusBadge = '<span style="background:#f59e0b;color:black;padding:2px 8px;font-size:11px;font-weight:bold;">EN ATTENTE VALIDATION</span>';

            var versionsInfo = '';
            if (liv.versions && liv.versions.length > 0) {
                versionsInfo = '<span class="text-gray-500 text-xs ml-2">v' + liv.versions.length + '</span>';
            }

            var contentPreview = '';
            if (liv.content_text) {
                var preview = liv.content_text.substring(0, 200).replace(/</g, '&lt;');
                contentPreview = '<div class="mt-2 p-3 bg-white border text-xs" style="max-height:150px;overflow-y:auto;white-space:pre-wrap;">' + preview + '...</div>';
            }

            return '<div class="p-4 bg-white border-4 border-black">' +
                '<div class="flex justify-between items-start mb-2">' +
                '<div><strong>' + (liv.name || 'Sans nom') + '</strong>' + versionsInfo + '</div>' +
                statusBadge +
                '</div>' +
                '<div class="text-sm text-gray-600 mb-2">' +
                'Type: ' + (liv.type || '-') + ' | Domaine: ' + (liv.domain || '-') + ' | Commande: ' + (liv.order_id || '-') +
                '</div>' +
                contentPreview +
                '<div class="mt-3 flex gap-2 flex-wrap">' +
                '<button onclick="approveDeliverable(\'' + liv.id + '\')" class="border-2 border-black bg-green-500 text-white px-3 py-1 text-xs font-bold hover:bg-green-600"><i class="fas fa-check mr-1"></i>APPROUVER</button>' +
                '<button onclick="publishDeliverable(\'' + liv.id + '\')" class="border-2 border-black bg-blue-500 text-white px-3 py-1 text-xs font-bold hover:bg-blue-600"><i class="fas fa-eye mr-1"></i>PUBLIER</button>' +
                '<button onclick="requestRevision(\'' + liv.id + '\')" class="border-2 border-black bg-orange-500 text-white px-3 py-1 text-xs font-bold hover:bg-orange-600"><i class="fas fa-redo mr-1"></i>REVISION</button>' +
                '</div>' +
                '</div>';
        }

        async function approveDeliverable(id) {
            try {
                var token = localStorage.getItem('fa_genesis_token');
                var response = await fetch(API_BASE_URL + '/api/admin/deliverables/' + id + '/approve', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    alert('Livrable approuvé !');
                    loadPendingDeliverables();
                } else {
                    var err = await response.json();
                    alert('Erreur: ' + (err.error || 'Erreur inconnue'));
                }
            } catch (e) { alert('Erreur: ' + e.message); }
        }

        async function publishDeliverable(id) {
            try {
                var token = localStorage.getItem('fa_genesis_token');
                var response = await fetch(API_BASE_URL + '/api/admin/deliverables/' + id + '/publish', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    alert('Livrable publié ! Le client peut maintenant le voir.');
                    loadPendingDeliverables();
                } else {
                    var err = await response.json();
                    alert('Erreur: ' + (err.error || 'Erreur inconnue'));
                }
            } catch (e) { alert('Erreur: ' + e.message); }
        }

        async function requestRevision(id) {
            var note = prompt('Raison de la demande de revision :');
            if (!note) return;
            try {
                var token = localStorage.getItem('fa_genesis_token');
                var response = await fetch(API_BASE_URL + '/api/admin/deliverables/' + id + '/request-revision', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note: note })
                });
                if (response.ok) {
                    alert('Révision demandée au partenaire.');
                    loadPendingDeliverables();
                } else {
                    var err = await response.json();
                    alert('Erreur: ' + (err.error || 'Erreur inconnue'));
                }
            } catch (e) { alert('Erreur: ' + e.message); }
        }

        async function loadProjectsForSession() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/projects');
                if (!response.ok) return;
                var data = await response.json();
                var projects = data.projects || [];
                var select = document.getElementById('sessionProjectSelect');
                if (!select) return;
                var optionsHtml = '<option value="">-- Sélectionner un projet --</option>';
                for (var i = 0; i < projects.length; i++) {
                    var p = projects[i];
                    optionsHtml += '<option value="' + p.id + '">' + p.id + ' - ' + (p.client_name || '') + ' (' + (p.offer_name || '') + ')</option>';
                }
                select.innerHTML = optionsHtml;
            } catch (e) { console.error('loadProjectsForSession:', e); }
        }

        async function submitSessionCompleted() {
            try {
                var projectId = document.getElementById('sessionProjectSelect').value;
                var notes = document.getElementById('sessionNotesInput').value;
                if (!projectId) { alert('Veuillez sélectionner un projet'); return; }
                if (!notes.trim()) { alert('Veuillez entrer des notes de séance'); return; }

                var token = localStorage.getItem('fa_genesis_token');
                var response = await fetch(API_BASE_URL + '/api/admin/session-completed', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: projectId, session_notes: notes })
                });
                var data = await response.json();
                var resultDiv = document.getElementById('sessionResult');
                if (resultDiv) {
                    resultDiv.style.display = 'block';
                    if (data.success) {
                        resultDiv.innerHTML = '<div class="p-3 bg-green-100 border-2 border-green-500 text-green-800 font-bold">' +
                            '<i class="fas fa-check mr-2"></i>Séance marquée ! ' + (data.generated ? data.generated.length : 0) + ' documents générés.' +
                            '</div>';
                        document.getElementById('sessionNotesInput').value = '';
                        loadPendingDeliverables();
                    } else {
                        resultDiv.innerHTML = '<div class="p-3 bg-red-100 border-2 border-red-500 text-red-800 font-bold">Erreur: ' + (data.error || 'Erreur inconnue') + '</div>';
                    }
                }
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        // ============================================================
        // PROJETS IA
        // ============================================================

        async function loadProjectsList() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/projects');
                if (!response.ok) throw new Error('Erreur chargement');
                var data = await response.json();
                var projects = data.projects || [];

                var container = document.getElementById('projectsList');
                if (!container) return;

                if (projects.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Aucun projet IA pour le moment.</p>';
                    return;
                }

                var html = '';
                for (var i = 0; i < projects.length; i++) {
                    var p = projects[i];
                    var statusColor = p.status === 'active' ? 'green' : (p.status === 'completed' ? 'blue' : 'gray');
                    var progressCount = 0;
                    for (var t = 0; t < (p.timeline_progress || []).length; t++) {
                        if (p.timeline_progress[t].status === 'completed') progressCount++;
                    }
                    var totalSteps = (p.timeline_progress || []).length;

                    html += '<div class="p-4 bg-white border-4 border-black cursor-pointer hover:bg-gray-50" onclick="viewProjectDetail(\'' + p.id + '\')">' +
                        '<div class="flex justify-between items-start">' +
                        '<div>' +
                        '<div class="font-black text-lg">' + p.id + '</div>' +
                        '<div class="text-sm">' + (p.client_name || '') + ' - ' + (p.offer_name || '') + '</div>' +
                        '</div>' +
                        '<span style="background:' + statusColor + ';color:white;padding:2px 10px;font-size:12px;font-weight:bold;">' + (p.status || '').toUpperCase() + '</span>' +
                        '</div>' +
                        '<div class="mt-2 text-sm text-gray-600">' +
                        'Étape ' + p.current_step + '/' + totalSteps + ' | ' + progressCount + ' complétée(s) | Jour ' + p.current_day + '/' + p.duration_days +
                        '</div>' +
                        '<div class="mt-2 bg-gray-200 h-3 border border-black">' +
                        '<div style="width:' + (totalSteps > 0 ? Math.round(progressCount / totalSteps * 100) : 0) + '%;height:100%;background:var(--genesis-yellow);"></div>' +
                        '</div>' +
                        '</div>';
                }
                container.innerHTML = html;
            } catch (e) {
                console.error('loadProjectsList:', e);
                var container = document.getElementById('projectsList');
                if (container) container.innerHTML = '<p class="text-red-500">Erreur chargement des projets.</p>';
            }
        }

        function showCreateProjectForm() {
            var form = document.getElementById('createProjectForm');
            if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function createProjectFromOrder() {
            try {
                var orderId = document.getElementById('createProjectOrderId').value.trim();
                if (!orderId) { alert('Veuillez entrer un ID de commande'); return; }

                var response = await fetch(API_BASE_URL + '/api/admin/projects/create-from-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                var data = await response.json();
                var resultDiv = document.getElementById('createProjectResult');
                if (resultDiv) {
                    resultDiv.style.display = 'block';
                    if (data.success) {
                        resultDiv.innerHTML = '<div class="p-3 bg-green-100 border-2 border-green-500 text-green-800 font-bold">' +
                            '<i class="fas fa-check mr-2"></i>Projet ' + data.project.id + ' créé avec ' + data.deliverables_count + ' livrables !' +
                            '</div>';
                        document.getElementById('createProjectOrderId').value = '';
                        loadProjectsList();
                    } else {
                        resultDiv.innerHTML = '<div class="p-3 bg-red-100 border-2 border-red-500 text-red-800 font-bold">Erreur: ' + (data.error || 'Erreur inconnue') + '</div>';
                    }
                }
            } catch (e) { alert('Erreur: ' + e.message); }
        }

        async function viewProjectDetail(projectId) {
            try {
                var response = await fetch(API_BASE_URL + '/api/projects/' + projectId + '/timeline');
                if (!response.ok) throw new Error('Erreur chargement');
                var data = await response.json();

                document.getElementById('projectsList').style.display = 'none';
                document.getElementById('createProjectForm').style.display = 'none';
                document.getElementById('projectDetailView').style.display = 'block';

                var project = data.project;
                var timeline = data.timeline || [];
                var html = '<h3 class="text-2xl font-black mb-2">' + project.id + '</h3>' +
                    '<div class="mb-4 text-sm">' +
                    '<strong>Client:</strong> ' + (project.client_name || '') + ' | ' +
                    '<strong>Offre:</strong> ' + (project.offer_name || '') + ' | ' +
                    '<strong>Statut:</strong> ' + (project.status || '') +
                    '</div>';

                // Timeline
                html += '<h4 class="text-xl font-black mb-3 mt-6">TIMELINE</h4>';
                for (var t = 0; t < timeline.length; t++) {
                    var entry = timeline[t];
                    var step = entry.step || {};
                    var stepStatus = entry.status || 'pending';
                    var statusIcon = stepStatus === 'completed' ? 'fa-check-circle text-green-600' : (stepStatus === 'in_progress' ? 'fa-spinner fa-spin text-yellow-500' : 'fa-circle text-gray-300');
                    var borderColor = stepStatus === 'completed' ? 'border-green-500' : (stepStatus === 'in_progress' ? 'border-yellow-400' : 'border-gray-300');

                    html += '<div class="p-4 mb-3 bg-white border-4 ' + borderColor + '">' +
                        '<div class="flex items-center gap-3 mb-2">' +
                        '<i class="fas ' + statusIcon + ' text-xl"></i>' +
                        '<div>' +
                        '<div class="font-bold">Jour ' + step.day_number + ' - ' + (step.step_name || '') + '</div>' +
                        '<div class="text-xs text-gray-500">' + (step.actor || '') + ' | ' + (step.domain || '') + '</div>' +
                        '</div>' +
                        '</div>';

                    // Livrables de cette etape
                    if (entry.deliverables && entry.deliverables.length > 0) {
                        html += '<div class="ml-8 mt-2 space-y-2">';
                        for (var dl = 0; dl < entry.deliverables.length; dl++) {
                            var liv = entry.deliverables[dl];
                            var wfColor = 'gray';
                            if (liv.workflow_status === 'PUBLISHED') wfColor = 'green';
                            else if (liv.workflow_status === 'APPROVED') wfColor = 'blue';
                            else if (liv.workflow_status === 'PENDING_ADMIN') wfColor = 'orange';
                            else if (liv.workflow_status === 'DRAFT_AI') wfColor = 'purple';

                            html += '<div class="p-2 bg-gray-50 border text-sm flex justify-between items-center">' +
                                '<span>' + (liv.name || '') + '</span>' +
                                '<span style="background:' + wfColor + ';color:white;padding:1px 6px;font-size:10px;font-weight:bold;">' + (liv.workflow_status || '') + '</span>' +
                                '</div>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                }

                document.getElementById('projectDetailContent').innerHTML = html;
            } catch (e) {
                console.error('viewProjectDetail:', e);
                alert('Erreur chargement du projet');
            }
        }

        function backToProjectsList() {
            document.getElementById('projectDetailView').style.display = 'none';
            document.getElementById('projectsList').style.display = 'block';
        }

        // Charger le badge "a valider" au demarrage
        (async function() {
            try {
                var token = localStorage.getItem('fa_genesis_token');
                if (!token) return;
                var response = await fetch(API_BASE_URL + '/api/admin/deliverables/pending', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    var data = await response.json();
                    var badge = document.getElementById('pendingWorkflowBadge');
                    if (badge && data.count > 0) {
                        badge.style.display = 'block';
                        badge.textContent = data.count;
                    }
                }
            } catch (e) {}
        })();

        // ==============================================
        // SECTION SÉANCES ADMIN
        // ==============================================

        var adminSessionsData = [];

        var ADMIN_SESSION_STATUS_MAP = {
            'REQUESTED': { label: 'Demande', color: '#f59f00', bg: '#fff3cd' },
            'PROPOSED': { label: 'Proposée', color: '#1c7ed6', bg: '#d0ebff' },
            'CONFIRMED': { label: 'Confirmée', color: '#2f9e44', bg: '#d3f9d8' },
            'RESCHEDULE_REQUESTED': { label: 'Reprogrammation', color: '#e67700', bg: '#fff3cd' },
            'COMPLETED': { label: 'Terminée', color: '#868e96', bg: '#e9ecef' },
            'CANCELLED': { label: 'Annulée', color: '#e03131', bg: '#ffe3e3' }
        };

        var ADMIN_SESSION_TYPE_LABELS = {
            'call': 'Appel',
            'shooting': 'Shooting',
            'meeting': 'Réunion'
        };

        async function loadAdminSessions() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/sessions');
                if (!response.ok) throw new Error('Erreur serveur');
                var data = await response.json();
                adminSessionsData = data.sessions || data || [];
                // Populate partner filter
                populatePartnerFilter();
                renderAdminSessions();
            } catch (e) {
                console.error('[ADMIN-SESSIONS] Erreur:', e);
                var table = document.getElementById('adminSeancesTable');
                if (table) table.innerHTML = '<p style="color:red;font-weight:bold;">Erreur: ' + e.message + '</p>';
            }
        }

        function populatePartnerFilter() {
            var select = document.getElementById('adminSeancesFilterPartner');
            if (!select) return;
            var partners = {};
            for (var i = 0; i < adminSessionsData.length; i++) {
                var s = adminSessionsData[i];
                if (s.partner_name && s.partner_id) {
                    partners[s.partner_id] = s.partner_name;
                }
            }
            var html = '<option value="">Tous</option>';
            for (var pid in partners) {
                html += '<option value="' + pid + '">' + partners[pid] + '</option>';
            }
            select.innerHTML = html;
        }

        function renderAdminSessions() {
            var table = document.getElementById('adminSeancesTable');
            if (!table) return;

            var statusFilter = '';
            var partnerFilter = '';
            var searchFilter = '';
            var statusEl = document.getElementById('adminSeancesFilterStatus');
            var partnerEl = document.getElementById('adminSeancesFilterPartner');
            var searchEl = document.getElementById('adminSeancesSearch');
            if (statusEl) statusFilter = statusEl.value;
            if (partnerEl) partnerFilter = partnerEl.value;
            if (searchEl) searchFilter = searchEl.value.toLowerCase();

            var filtered = [];
            for (var i = 0; i < adminSessionsData.length; i++) {
                var s = adminSessionsData[i];
                if (statusFilter && s.status !== statusFilter) continue;
                if (partnerFilter && s.partner_id !== partnerFilter) continue;
                if (searchFilter) {
                    var clientText = ((s.client_name || '') + ' ' + (s.client_id || '')).toLowerCase();
                    if (clientText.indexOf(searchFilter) === -1) continue;
                }
                filtered.push(s);
            }

            if (filtered.length === 0) {
                table.innerHTML = '<p class="text-gray-500 py-4">Aucune séance trouvée.</p>';
                return;
            }

            // Sort by date descending
            filtered.sort(function(a, b) {
                var da = a.datetime_start ? new Date(a.datetime_start).getTime() : 0;
                var db = b.datetime_start ? new Date(b.datetime_start).getTime() : 0;
                return db - da;
            });

            var html = '<table style="width:100%;border-collapse:collapse;background:white;color:black;border:4px solid black;">';
            html += '<thead><tr style="background:var(--genesis-yellow);font-weight:900;font-size:0.8rem;text-transform:uppercase;">';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:left;">Client</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:left;">Partenaire</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:left;">Type</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:left;">Date</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:left;">Durée</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:center;">Statut</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:left;">Meet</th>';
            html += '<th style="padding:0.75rem;border:2px solid black;text-align:center;">Actions</th>';
            html += '</tr></thead><tbody>';

            for (var j = 0; j < filtered.length; j++) {
                var session = filtered[j];
                var statusInfo = ADMIN_SESSION_STATUS_MAP[session.status] || { label: session.status, color: '#666', bg: '#eee' };
                var typeLabel = ADMIN_SESSION_TYPE_LABELS[session.session_type] || session.session_type || session.type || '—';

                var dateStr = '—';
                if (session.datetime_start) {
                    try {
                        var d = new Date(session.datetime_start);
                        dateStr = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    } catch (e) { dateStr = session.datetime_start; }
                } else if (session.date) {
                    dateStr = session.date + (session.heure ? ' ' + session.heure : '');
                }

                var durationStr = session.duration_minutes ? session.duration_minutes + 'min' : (session.duree || '—');
                var clientName = session.client_name || session.userName || session.client_id || session.userEmail || '—';
                var partnerName = session.partner_name || '—';
                var meetLink = session.meet_url || session.visioLink || '';

                html += '<tr style="border-bottom:2px solid #eee;">';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;font-size:0.85rem;">' + clientName + '</td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;font-size:0.85rem;">' + partnerName + '</td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;font-size:0.85rem;">' + typeLabel + '</td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;font-size:0.85rem;">' + dateStr + '</td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;font-size:0.85rem;">' + durationStr + '</td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;text-align:center;"><span style="display:inline-block;padding:2px 8px;font-weight:900;font-size:0.7rem;text-transform:uppercase;border:2px solid black;background:' + statusInfo.bg + ';color:' + statusInfo.color + ';">' + statusInfo.label + '</span></td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;font-size:0.85rem;">';
                if (meetLink) {
                    html += '<a href="' + meetLink + '" target="_blank" style="color:#1c7ed6;text-decoration:underline;font-size:0.8rem;"><i class="fas fa-video mr-1"></i>Lien</a>';
                } else {
                    html += '<span style="color:#aaa;">—</span>';
                }
                html += '</td>';
                html += '<td style="padding:0.6rem;border:1px solid #dee2e6;text-align:center;">';
                html += '<button onclick="deleteAdminSession(\'' + session.id + '\')" style="background:#ff6b6b;color:white;border:2px solid black;padding:4px 10px;font-size:0.75rem;font-weight:900;cursor:pointer;" title="Supprimer"><i class="fas fa-trash"></i></button>';
                html += '</td>';
                html += '</tr>';
            }

            html += '</tbody></table>';
            html += '<p style="color:#666;font-size:0.8rem;margin-top:0.5rem;">' + filtered.length + ' séance(s)</p>';
            table.innerHTML = html;
        }

        async function deleteAdminSession(sessionId) {
            if (!confirm('Voulez-vous vraiment supprimer cette séance ?\n\nCette action est irréversible.')) return;
            try {
                var resp = await fetch(API_BASE_URL + '/api/admin/sessions/' + sessionId, { method: 'DELETE' });
                var data = await resp.json();
                if (resp.ok && data.success) {
                    alert('Séance supprimée.');
                    loadAdminSessions();
                } else {
                    alert('Erreur : ' + (data.error || 'Impossible de supprimer'));
                }
            } catch (err) {
                alert('Erreur réseau : ' + err.message);
            }
        }

        // Charger le badge séances admin au démarrage
        (async function() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/sessions');
                if (response.ok) {
                    var data = await response.json();
                    var sessions = data.sessions || data || [];
                    var requestedCount = 0;
                    for (var i = 0; i < sessions.length; i++) {
                        if (sessions[i].status === 'REQUESTED' || sessions[i].status === 'RESCHEDULE_REQUESTED') {
                            requestedCount++;
                        }
                    }
                    var badge = document.getElementById('pendingSeancesBadge');
                    if (badge && requestedCount > 0) {
                        badge.style.display = 'block';
                        badge.textContent = requestedCount;
                    }
                }
            } catch (e) {}
        })();

    </script>
</body>
</html>
