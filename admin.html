<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - FA GENESIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap');

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
        }

        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .admin-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
        }

        .stat-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 8px 8px 0px var(--genesis-yellow);
        }

        .client-row {
            background: white;
            border: 3px solid black;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-row:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--genesis-yellow);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border: 2px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .status-registered { background: #ff6b6b; color: white; }
        .status-deposit { background: #51cf66; color: white; }
        .status-pending { background: #ffd43b; color: black; }
        .status-fully { background: #4dabf7; color: white; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            color: black;
            margin: 2% auto;
            padding: 2rem;
            border: 4px solid black;
            width: 90%;
            max-width: 900px;
        }

        .close-modal {
            float: right;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .day-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--genesis-yellow);
            border: 3px solid black;
            font-weight: 900;
            font-size: 1.25rem;
            margin-right: 1rem;
        }

        .document-item {
            background: #f8f9fa;
            border: 2px solid black;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .admin-panel {
            display: none;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 3px solid black;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--genesis-yellow);
        }
    </style>
</head>
<body>

    <!-- PAGE DE CONNEXION ADMIN -->
    <div id="loginPage" class="login-page">
        <div class="w-full max-width: 500px">
            <div class="admin-card neo-shadow" style="max-width: 500px; margin: 0 auto;">
                <h1 class="text-4xl font-black italic uppercase text-center mb-2 text-[var(--genesis-yellow)]">
                    <i class="fas fa-shield-alt mr-3"></i>ADMINISTRATION
                </h1>
                <p class="text-center font-bold mb-8 uppercase text-sm">FA GENESIS - Espace Administrateur</p>

                <div id="loginError" class="bg-red-500 text-white p-4 mb-4 border-4 border-black font-bold" style="display: none;"></div>

                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase">Email</label>
                        <input type="email" id="adminEmail" required placeholder="admin@fagenesis.com">
                    </div>

                    <div class="mb-6">
                        <label class="block font-black mb-2 uppercase">Mot de passe</label>
                        <input type="password" id="adminPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <button type="submit" class="w-full neo-btn-yellow py-4 text-xl font-black italic uppercase">
                        <i class="fas fa-sign-in-alt mr-2"></i>Connexion
                    </button>
                </form>

                <div class="mt-8 text-center text-sm font-bold opacity-70">
                    <i class="fas fa-lock mr-2"></i>Acc√®s r√©serv√© aux administrateurs FA GENESIS
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL ADMINISTRATEUR -->
    <div id="adminPanel" class="admin-panel">

        <!-- NAVIGATION -->
        <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-8">
                    <h1 class="text-2xl font-black text-[var(--genesis-yellow)]">
                        <i class="fas fa-shield-alt mr-2"></i>ADMIN FA GENESIS
                    </h1>
                    <div class="hidden md:flex gap-6 text-sm font-black">
                        <button onclick="showSection('dashboard')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]">
                            <i class="fas fa-chart-line mr-2"></i>Dashboard
                        </button>
                        <button onclick="showSection('clients')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]">
                            <i class="fas fa-users mr-2"></i>Clients
                        </button>
                        <button onclick="showSection('messages')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]" style="position:relative;">
                            <i class="fas fa-envelope mr-2"></i>Messages
                            <span id="unreadBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:20px;height:20px;font-size:11px;line-height:20px;text-align:center;"></span>
                        </button>
                        <button onclick="showSection('commandes')" class="nav-btn text-white hover:text-[var(--genesis-yellow)]">
                            <i class="fas fa-receipt mr-2"></i>Commandes
                        </button>
                    </div>
                </div>
                <button onclick="handleLogout()" class="border-4 border-white text-white px-4 py-2 text-xs font-black hover:bg-white hover:text-black transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>D√âCONNEXION
                </button>
            </div>
        </nav>

        <div class="pt-28 pb-20 px-6">
            <!-- SECTION DASHBOARD -->
            <div id="dashboardSection" class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-black italic uppercase mb-12 text-[var(--genesis-yellow)]">
                    <i class="fas fa-chart-line mr-4"></i>TABLEAU DE BORD
                </h2>

                <!-- Statistiques -->
                <div class="grid md:grid-cols-4 gap-6 mb-12" id="statsContainer">
                    <!-- Les statistiques seront g√©n√©r√©es ici -->
                </div>

                <!-- Aper√ßu r√©cent -->
                <div class="admin-card neo-shadow">
                    <h3 class="text-2xl font-black italic uppercase mb-6">
                        <i class="fas fa-clock mr-2"></i>Derniers clients inscrits
                    </h3>
                    <div id="recentClients"></div>
                </div>
            </div>

            <!-- SECTION MESSAGES -->
            <div id="messagesSection" class="container mx-auto max-w-7xl" style="display: none;">
                <div class="flex justify-between items-center mb-12 flex-wrap gap-4">
                    <h2 class="text-5xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-envelope mr-4"></i>MESSAGES
                    </h2>
                    <div id="messagesStats" class="text-right"></div>
                </div>

                <!-- Filtres -->
                <div class="admin-card neo-shadow mb-8">
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="filterMessages('all')" class="neo-btn-yellow px-4 py-2 text-xs">TOUS</button>
                        <button onclick="filterMessages('unread')" class="border-4 border-[#ff6b6b] bg-[#ff6b6b] text-black px-4 py-2 text-xs font-black">NON LUS</button>
                        <button onclick="filterMessages('read')" class="border-4 border-[#4dabf7] bg-[#4dabf7] text-black px-4 py-2 text-xs font-black">LUS</button>
                        <button onclick="filterMessages('replied')" class="border-4 border-[#51cf66] bg-[#51cf66] text-black px-4 py-2 text-xs font-black">R√âPONDUS</button>
                        <button onclick="filterMessages('archived')" class="border-4 border-gray-400 bg-gray-400 text-black px-4 py-2 text-xs font-black">ARCHIV√âS</button>
                    </div>
                </div>

                <!-- Liste des messages -->
                <div id="messagesList"></div>
            </div>

            <!-- SECTION COMMANDES -->
            <div id="commandesSection" class="container mx-auto max-w-7xl" style="display: none;">
                <h2 class="text-5xl font-black italic uppercase mb-12 text-[var(--genesis-yellow)]">
                    <i class="fas fa-receipt mr-4"></i>COMMANDES
                </h2>
                <div id="ordersList"></div>
            </div>

            <!-- SECTION CLIENTS -->
            <div id="clientsSection" class="container mx-auto max-w-7xl" style="display: none;">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-5xl font-black italic uppercase text-[var(--genesis-yellow)]">
                        <i class="fas fa-users mr-4"></i>GESTION CLIENTS
                    </h2>
                </div>

                <!-- Recherche -->
                <div class="admin-card neo-shadow mb-8">
                    <div class="flex gap-4">
                        <input type="text" id="searchInput" placeholder="Rechercher un client (nom, email, offre)..." class="flex-1">
                        <button onclick="handleSearchClients()" class="neo-btn-yellow px-8">
                            <i class="fas fa-search mr-2"></i>Rechercher
                        </button>
                    </div>
                </div>

                <!-- Liste des clients -->
                <div id="clientsList"></div>
            </div>
        </div>
    </div>

    <!-- MODAL GESTION CLIENT -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeClientModal()">&times;</span>
            <div id="clientModalContent"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="offers-config.js"></script>
    <script src="payment-system.js"></script>
    <script src="admin-system.js"></script>
    <script>
        // API_BASE_URL est d√©fini dans auth.js
    </script>
    <script>
        // V√©rifier si admin est d√©j√† connect√©
        if (isAdminAuthenticated()) {
            showAdminPanel();
        }

        // Gestion de la connexion
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const result = adminLogin(email, password);

            if (result.success) {
                showAdminPanel();
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = result.message;
                errorDiv.style.display = 'block';
            }
        });

        function showAdminPanel() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboard();
        }

        function handleLogout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                adminLogout();
                location.reload();
            }
        }

        function showSection(section) {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('clientsSection').style.display = 'none';
            document.getElementById('messagesSection').style.display = 'none';
            document.getElementById('commandesSection').style.display = 'none';

            if (section === 'dashboard') {
                document.getElementById('dashboardSection').style.display = 'block';
                loadDashboard();
            } else if (section === 'clients') {
                document.getElementById('clientsSection').style.display = 'block';
                loadClientsList();
            } else if (section === 'messages') {
                document.getElementById('messagesSection').style.display = 'block';
                loadMessages();
            } else if (section === 'commandes') {
                document.getElementById('commandesSection').style.display = 'block';
                loadOrders();
            }
        }

        async function loadDashboard() {
            try {
                const [statsResponse, usersResponse] = await Promise.all([
                    fetch(API_BASE_URL + '/api/admin/stats'),
                    fetch(API_BASE_URL + '/api/admin/users')
                ]);

                if (!statsResponse.ok || !usersResponse.ok) throw new Error('Erreur chargement');

                const stats = await statsResponse.json();
                const users = await usersResponse.json();

                const statsHTML = `
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[var(--genesis-yellow)] mb-2">${stats.totalClients}</div>
                        <div class="text-sm font-bold uppercase">Total Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[#51cf66] mb-2">${stats.depositPaid}</div>
                        <div class="text-sm font-bold uppercase">Acompte Pay√©</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[#4dabf7] mb-2">${stats.fullyPaid}</div>
                        <div class="text-sm font-bold uppercase">Pay√© Complet</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-4xl font-black text-[var(--genesis-yellow)] mb-2">${stats.totalRevenue}‚Ç¨</div>
                        <div class="text-sm font-bold uppercase">Revenu Total</div>
                    </div>
                `;

                document.getElementById('statsContainer').innerHTML = statsHTML;

                // Derniers clients (5 plus recents)
                const recentUsers = users.slice(0, 5);
                let recentHTML = '';

                recentUsers.forEach(function(client) {
                    var statusClass = {
                        'registered': 'status-registered',
                        'deposit_paid': 'status-deposit',
                        'delivery_pending_payment': 'status-pending',
                        'fully_paid': 'status-fully'
                    }[client.paymentStatus] || 'status-registered';

                    var offerName = client.offre || '';
                    var offer = typeof getOfferById === 'function' ? getOfferById(client.offre) : null;
                    if (offer) offerName = offer.nom;

                    recentHTML += '<div class="client-row" onclick="openClientModal(\'' + client.email + '\')">' +
                        '<div class="flex justify-between items-center">' +
                            '<div>' +
                                '<div class="font-black text-lg">' + client.prenom + ' ' + client.nom + '</div>' +
                                '<div class="text-sm font-bold opacity-70">' + client.email + '</div>' +
                            '</div>' +
                            '<div class="text-right">' +
                                '<div class="status-badge ' + statusClass + ' mb-2">' + getStatusLabel(client.paymentStatus) + '</div>' +
                                '<div class="text-sm font-bold">' + offerName + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                });

                document.getElementById('recentClients').innerHTML = recentHTML || '<p class="text-center py-8 opacity-50 font-bold">Aucun client inscrit</p>';

            } catch (error) {
                console.error('[ADMIN] Erreur chargement dashboard:', error);
                document.getElementById('statsContainer').innerHTML = '<p class="col-span-4 text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                document.getElementById('recentClients').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement...</p>';
                // Reessayer apres 5 secondes (cold start Render)
                setTimeout(function() { loadDashboard(); }, 5000);
            }
        }

        let allBackendClients = [];

        async function loadClientsList(searchQuery) {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/users');
                if (!response.ok) throw new Error('Erreur chargement');
                allBackendClients = await response.json();
            } catch (error) {
                console.error('[ADMIN] Erreur chargement clients:', error);
                document.getElementById('clientsList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadClientsList(); }, 5000);
                return;
            }

            var clients = allBackendClients;

            // Filtrer si recherche
            if (searchQuery) {
                var q = searchQuery.toLowerCase();
                clients = clients.filter(function(c) {
                    return (c.prenom && c.prenom.toLowerCase().includes(q)) ||
                           (c.nom && c.nom.toLowerCase().includes(q)) ||
                           (c.email && c.email.toLowerCase().includes(q)) ||
                           (c.offre && c.offre.toLowerCase().includes(q));
                });
            }

            var html = '';
            clients.forEach(function(client) {
                var statusClass = {
                    'registered': 'status-registered',
                    'deposit_paid': 'status-deposit',
                    'delivery_pending_payment': 'status-pending',
                    'fully_paid': 'status-fully'
                }[client.paymentStatus] || 'status-registered';

                var offerName = client.offre || 'N/A';
                var offer = typeof getOfferById === 'function' ? getOfferById(client.offre) : null;
                if (offer) offerName = offer.nom;

                html += '<div class="client-row" onclick="openClientModal(\'' + client.email + '\')">' +
                    '<div class="flex justify-between items-center flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[250px]">' +
                            '<div class="font-black text-lg">' + (client.prenom || '') + ' ' + (client.nom || '') + '</div>' +
                            '<div class="text-sm font-bold opacity-70">' + client.email + '</div>' +
                            '<div class="text-xs font-bold opacity-50 mt-1">Inscrit le ' + new Date(client.createdAt || Date.now()).toLocaleDateString('fr-FR') + '</div>' +
                        '</div>' +
                        '<div>' +
                            '<div class="status-badge ' + statusClass + '">' + getStatusLabel(client.paymentStatus) + '</div>' +
                        '</div>' +
                        '<div class="text-right min-w-[200px]">' +
                            '<div class="font-black">' + offerName + '</div>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<button class="neo-btn-yellow px-4 py-2 text-sm">' +
                                '<i class="fas fa-folder-open mr-2"></i>G√©rer' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            document.getElementById('clientsList').innerHTML = html || '<p class="text-center py-8 opacity-50 font-bold">Aucun client</p>';
        }

        function handleSearchClients() {
            var query = document.getElementById('searchInput').value;
            if (!query) {
                loadClientsList();
                return;
            }
            loadClientsList(query);
        }

        async function openClientModal(clientEmail) {
            // Chercher d'abord dans les donnees deja chargees, sinon appeler le backend
            var client = allBackendClients.find(function(c) { return c.email === clientEmail; });

            if (!client) {
                try {
                    var resp = await fetch(API_BASE_URL + '/api/admin/users/' + encodeURIComponent(clientEmail));
                    if (resp.ok) client = await resp.json();
                } catch (e) {
                    console.error('[ADMIN] Erreur chargement client:', e);
                }
            }

            if (!client) {
                alert('Client non trouve');
                return;
            }

            var offer = typeof getOfferById === 'function' ? getOfferById(client.offre) : null;
            var documents = typeof getClientDocumentsByDay === 'function' ? getClientDocumentsByDay(clientEmail) : {};
            var currentDay = client.currentDay || 0;

            let modalHTML = `
                <h2 class="text-3xl font-black italic uppercase mb-6 text-[var(--genesis-yellow)]">
                    <i class="fas fa-user-circle mr-3"></i>${client.prenom} ${client.nom}
                </h2>

                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Email</p>
                        <p class="font-black">${client.email}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">T√©l√©phone</p>
                        <p class="font-black">${client.telephone || 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Offre</p>
                        <p class="font-black">${offer ? offer.nom : 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Statut paiement</p>
                        <p class="font-black">${getStatusLabel(client.paymentStatus)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Jour actuel</p>
                        <p class="font-black">Jour ${currentDay}</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold uppercase opacity-70 mb-1">Documents ajout√©s</p>
                        <p class="font-black">${client.documentsCount || 0} documents</p>
                    </div>
                </div>

                <hr class="border-2 border-black my-8">

                <h3 class="text-2xl font-black italic uppercase mb-6">
                    <i class="fas fa-file-upload mr-3"></i>AJOUTER UN DOCUMENT
                </h3>

                <form id="uploadDocumentForm" class="mb-8">
                    <input type="hidden" id="currentClientEmail" value="${clientEmail}">

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Jour</label>
                            <input type="number" id="docDay" min="1" value="${currentDay + 1}" required>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Titre du document</label>
                            <input type="text" id="docTitle" placeholder="Ex: Plan d'action Jour 5" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase text-sm">Description (optionnelle)</label>
                        <textarea id="docDescription" rows="2" placeholder="Description du document..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase text-sm">Fichier</label>
                        <input type="file" id="docFile" required class="text-sm">
                        <p class="text-xs font-bold opacity-50 mt-2">Formats accept√©s: PDF, DOCX, XLSX, PNG, JPG, ZIP</p>
                    </div>

                    <button type="submit" class="neo-btn-yellow px-8 py-3 text-lg">
                        <i class="fas fa-upload mr-2"></i>Ajouter le document
                    </button>
                </form>

                <hr class="border-2 border-black my-8">

                <h3 class="text-2xl font-black italic uppercase mb-6">
                    <i class="fas fa-folder-open mr-3"></i>DOCUMENTS DU CLIENT
                </h3>

                <div id="clientDocumentsList">
                    ${renderClientDocuments(documents, clientEmail)}
                </div>

                <hr class="border-2 border-black my-8">

                <h3 class="text-2xl font-black italic uppercase mb-6">
                    <i class="fas fa-video mr-3"></i>GESTION DES S√âANCES
                </h3>

                <form id="addSessionForm" class="mb-8">
                    <input type="hidden" id="sessionClientEmail" value="${clientEmail}">

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Date</label>
                            <input type="date" id="sessionDate" required>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Heure</label>
                            <input type="time" id="sessionHeure" required>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Dur√©e</label>
                            <input type="text" id="sessionDuree" placeholder="Ex: 1h00" required>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Type de s√©ance</label>
                            <select id="sessionType" required>
                                <option value="">S√©lectionner...</option>
                                <option value="S√©ance strat√©gique">S√©ance strat√©gique</option>
                                <option value="Point de suivi">Point de suivi</option>
                                <option value="Briefing tournage">Briefing tournage</option>
                                <option value="Shooting photo">Shooting photo</option>
                                <option value="Tournage vid√©o">Tournage vid√©o</option>
                                <option value="Bilan final">Bilan final</option>
                                <option value="Consultation">Consultation</option>
                                <option value="Formation">Formation</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">Ic√¥ne</label>
                            <select id="sessionIcon">
                                <option value="fa-video">üìπ Visio</option>
                                <option value="fa-comments">üí¨ Discussion</option>
                                <option value="fa-lightbulb">üí° Strat√©gie</option>
                                <option value="fa-camera">üì∑ Photo</option>
                                <option value="fa-film">üé¨ Vid√©o</option>
                                <option value="fa-rocket">üöÄ Lancement</option>
                                <option value="fa-check-circle">‚úÖ Bilan</option>
                                <option value="fa-calendar">üìÖ Rendez-vous</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-black mb-2 uppercase text-sm">Description</label>
                        <textarea id="sessionDescription" rows="2" placeholder="Description de la s√©ance..."></textarea>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">
                                <i class="fas fa-link mr-1"></i>Lien visio (Google Meet, Zoom...)
                            </label>
                            <input type="url" id="sessionVisioLink" placeholder="https://meet.google.com/xxx-xxxx-xxx">
                        </div>
                        <div>
                            <label class="block font-black mb-2 uppercase text-sm">
                                <i class="fas fa-map-marker-alt mr-1"></i>Ou lieu physique
                            </label>
                            <input type="text" id="sessionLieu" placeholder="Ex: Studio FA Genesis, Paris">
                        </div>
                    </div>

                    <button type="submit" class="neo-btn-yellow px-8 py-3 text-lg">
                        <i class="fas fa-plus mr-2"></i>Ajouter la s√©ance
                    </button>
                </form>

                <h4 class="text-xl font-black italic uppercase mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>S√©ances planifi√©es
                </h4>
                <div id="clientSessionsList">
                    <p class="text-center py-4 opacity-50 font-bold">Chargement...</p>
                </div>
            `;

            document.getElementById('clientModalContent').innerHTML = modalHTML;
            document.getElementById('clientModal').style.display = 'block';

            // Gestionnaire du formulaire d'upload de documents
            document.getElementById('uploadDocumentForm').addEventListener('submit', handleDocumentUpload);

            // Gestionnaire du formulaire d'ajout de s√©ance
            document.getElementById('addSessionForm').addEventListener('submit', handleAddSession);

            // Charger les s√©ances du client
            loadClientSessions(clientEmail);
        }

        function renderClientDocuments(documentsByDay, clientEmail) {
            if (Object.keys(documentsByDay).length === 0) {
                return '<p class="text-center py-8 opacity-50 font-bold">Aucun document ajout√©</p>';
            }

            let html = '';
            const days = Object.keys(documentsByDay).sort((a, b) => Number(b) - Number(a));

            days.forEach(day => {
                html += `
                    <div class="mb-6">
                        <div class="day-badge">JOUR ${day}</div>
                        <div class="mt-4">
                `;

                documentsByDay[day].forEach(doc => {
                    html += `
                        <div class="document-item">
                            <div>
                                <div class="font-black">${doc.title}</div>
                                ${doc.description ? `<div class="text-sm opacity-70">${doc.description}</div>` : ''}
                                <div class="text-xs font-bold opacity-50 mt-1">
                                    ${doc.fileName} ‚Ä¢ ${new Date(doc.uploadedAt).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                            <button onclick="deleteDocument('${clientEmail}', '${doc.id}')" class="text-red-600 font-black hover:opacity-70">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            return html;
        }

        async function handleDocumentUpload(e) {
            e.preventDefault();

            const clientEmail = document.getElementById('currentClientEmail').value;
            const day = parseInt(document.getElementById('docDay').value);
            const title = document.getElementById('docTitle').value;
            const description = document.getElementById('docDescription').value;
            const fileInput = document.getElementById('docFile');

            if (!fileInput.files[0]) {
                alert('Veuillez s√©lectionner un fichier');
                return;
            }

            try {
                // Upload du fichier (simulation avec base64)
                const fileData = await uploadFile(fileInput.files[0]);

                const document = {
                    title: title,
                    description: description,
                    day: day,
                    fileUrl: fileData.fileUrl,
                    fileName: fileData.fileName,
                    fileType: fileData.fileType,
                    fileSize: fileData.fileSize
                };

                const success = addDailyDocumentToClient(clientEmail, document);

                if (success) {
                    alert('‚úÖ Document ajout√© avec succ√®s !');
                    openClientModal(clientEmail); // Recharger le modal
                } else {
                    alert('‚ùå Erreur lors de l\'ajout du document');
                }
            } catch (error) {
                console.error(error);
                alert('‚ùå Erreur lors du traitement du fichier');
            }
        }

        function deleteDocument(clientEmail, documentId) {
            if (confirm('Voulez-vous vraiment supprimer ce document ?')) {
                const success = deleteDailyDocument(clientEmail, documentId);
                if (success) {
                    alert('‚úÖ Document supprim√©');
                    openClientModal(clientEmail);
                } else {
                    alert('‚ùå Erreur lors de la suppression');
                }
            }
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        // ============================================
        // GESTION DES S√âANCES
        // ============================================

        async function loadClientSessions(clientEmail) {
            const container = document.getElementById('clientSessionsList');

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/sessions/user/${encodeURIComponent(clientEmail)}`);
                const sessions = await response.json();

                if (sessions.length === 0) {
                    container.innerHTML = '<p class="text-center py-4 opacity-50 font-bold">Aucune s√©ance planifi√©e</p>';
                    return;
                }

                // Trier par date (plus r√©centes en premier)
                sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

                container.innerHTML = sessions.map(session => {
                    const sessionDate = new Date(session.date);
                    const formattedDate = sessionDate.toLocaleDateString('fr-FR', {
                        weekday: 'short',
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });

                    const isPast = sessionDate < new Date();
                    const statusClass = isPast ? 'bg-gray-100' : 'bg-yellow-50';
                    const statusBadge = isPast
                        ? '<span class="px-2 py-1 bg-gray-400 text-white text-xs font-black uppercase">Pass√©e</span>'
                        : '<span class="px-2 py-1 bg-green-500 text-white text-xs font-black uppercase">√Ä venir</span>';

                    return `
                        <div class="document-item ${statusClass}">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas ${session.icon} text-xl"></i>
                                    <span class="font-black text-lg">${session.type}</span>
                                    ${statusBadge}
                                </div>
                                <div class="text-sm font-bold">
                                    <i class="fas fa-calendar mr-1"></i>${formattedDate} √† ${session.heure}
                                    <span class="ml-3"><i class="fas fa-clock mr-1"></i>${session.duree}</span>
                                </div>
                                ${session.description ? `<p class="text-sm opacity-70 mt-1">${session.description}</p>` : ''}
                                ${session.visioLink ? `
                                    <a href="${session.visioLink}" target="_blank" class="inline-block mt-2 px-3 py-1 bg-blue-500 text-white text-xs font-black uppercase hover:bg-blue-600">
                                        <i class="fas fa-video mr-1"></i>Lien visio
                                    </a>
                                ` : ''}
                                ${session.lieu ? `
                                    <p class="text-sm mt-2"><i class="fas fa-map-marker-alt mr-1"></i>${session.lieu}</p>
                                ` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editSession('${session.id}')" class="text-blue-600 font-black hover:opacity-70" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSession('${session.id}', '${clientEmail}')" class="text-red-600 font-black hover:opacity-70" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erreur chargement s√©ances:', error);
                container.innerHTML = '<p class="text-center py-4 text-red-500 font-bold">Erreur de chargement</p>';
            }
        }

        async function handleAddSession(e) {
            e.preventDefault();

            const clientEmail = document.getElementById('sessionClientEmail').value;
            const sessionData = {
                userEmail: clientEmail,
                date: document.getElementById('sessionDate').value,
                heure: document.getElementById('sessionHeure').value,
                type: document.getElementById('sessionType').value,
                duree: document.getElementById('sessionDuree').value,
                description: document.getElementById('sessionDescription').value,
                visioLink: document.getElementById('sessionVisioLink').value || null,
                lieu: document.getElementById('sessionLieu').value || null,
                icon: document.getElementById('sessionIcon').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ S√©ance ajout√©e avec succ√®s !');
                    // R√©initialiser le formulaire
                    document.getElementById('addSessionForm').reset();
                    // Recharger la liste des s√©ances
                    loadClientSessions(clientEmail);
                } else {
                    alert('‚ùå Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur ajout s√©ance:', error);
                alert('‚ùå Erreur lors de l\'ajout de la s√©ance');
            }
        }

        async function deleteSession(sessionId, clientEmail) {
            if (!confirm('Voulez-vous vraiment supprimer cette s√©ance ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ S√©ance supprim√©e');
                    loadClientSessions(clientEmail);
                } else {
                    alert('‚ùå Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur suppression s√©ance:', error);
                alert('‚ùå Erreur lors de la suppression');
            }
        }

        function editSession(sessionId) {
            // Pour une version simple, on redirige vers la modification
            alert('Fonctionnalit√© de modification √† venir. Pour modifier, supprimez et recr√©ez la s√©ance.');
        }

        // ============================================================
        // SECTION MESSAGES
        // ============================================================

        let allMessages = [];
        let currentFilter = 'all';

        async function loadMessages(filter) {
            if (filter) currentFilter = filter;

            try {
                const response = await fetch(API_BASE_URL + '/api/admin/messages');
                if (!response.ok) throw new Error('Erreur chargement messages');
                allMessages = await response.json();
            } catch (error) {
                console.error('[ADMIN] Erreur chargement messages:', error);
                document.getElementById('messagesList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadMessages(); }, 5000);
                return;
            }

            // Stats
            const unread = allMessages.filter(function(m) { return m.status === 'unread'; }).length;
            const total = allMessages.length;
            document.getElementById('messagesStats').innerHTML =
                '<span class="text-[#ff6b6b] font-black text-2xl">' + unread + '</span>' +
                '<span class="text-sm font-bold opacity-70"> non lu' + (unread > 1 ? 's' : '') + ' / ' + total + ' total</span>';

            // Badge navbar
            var badge = document.getElementById('unreadBadge');
            if (unread > 0) {
                badge.style.display = 'block';
                badge.textContent = unread;
            } else {
                badge.style.display = 'none';
            }

            renderMessages();
        }

        function filterMessages(filter) {
            currentFilter = filter;
            renderMessages();
        }

        function renderMessages() {
            var filtered = allMessages;
            if (currentFilter !== 'all') {
                filtered = allMessages.filter(function(m) { return m.status === currentFilter; });
            }

            if (filtered.length === 0) {
                document.getElementById('messagesList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Aucun message</p>';
                return;
            }

            var html = '';
            filtered.forEach(function(msg) {
                var date = new Date(msg.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                var isUnread = msg.status === 'unread';
                var statusColors = { unread: '#ff6b6b', read: '#4dabf7', replied: '#51cf66', archived: '#999' };
                var statusLabels = { unread: 'NON LU', read: 'LU', replied: 'R√âPONDU', archived: 'ARCHIV√â' };
                var subjectLabels = {
                    information: "DEMANDE D'INFO",
                    devis: 'DEVIS',
                    offre: 'QUESTION OFFRE',
                    technique: 'TECHNIQUE',
                    support: 'SUPPORT',
                    partenariat: 'PARTENARIAT',
                    autre: 'AUTRE'
                };
                var subjectLabel = subjectLabels[msg.subject] || msg.subject;

                html += '<div class="admin-card neo-shadow mb-4" style="cursor:pointer;' + (isUnread ? 'border-left:6px solid #ff6b6b;' : '') + '" onclick="openMessage(\'' + msg.id + '\')">' +
                    '<div class="flex justify-between items-start flex-wrap gap-4">' +
                        '<div class="flex-1 min-w-[250px]">' +
                            '<div class="font-black text-lg' + (isUnread ? ' text-[var(--genesis-yellow)]' : '') + '">' + msg.name + '</div>' +
                            '<div class="text-sm font-bold opacity-70">' + msg.email + '</div>' +
                            (msg.profil ? '<div class="text-xs font-bold opacity-50 mt-1">Profil: ' + msg.profil.toUpperCase() + '</div>' : '') +
                            '<div class="mt-2"><span style="background:#FFD700;color:black;padding:2px 8px;border:2px solid black;font-size:11px;font-weight:900;">' + subjectLabel + '</span></div>' +
                        '</div>' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<p class="text-sm font-bold opacity-80" style="max-height:40px;overflow:hidden;">' + msg.message.substring(0, 100) + (msg.message.length > 100 ? '...' : '') + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<div style="background:' + (statusColors[msg.status] || '#999') + ';color:black;padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;display:inline-block;">' + (statusLabels[msg.status] || msg.status) + '</div>' +
                            '<div class="text-xs font-bold opacity-60 mt-2">' + date + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            document.getElementById('messagesList').innerHTML = html;
        }

        async function openMessage(messageId) {
            // Marquer comme lu
            try {
                await fetch(API_BASE_URL + '/api/admin/messages/' + messageId);
            } catch (e) {}

            var msg = allMessages.find(function(m) { return m.id === messageId; });
            if (!msg) return;

            var date = new Date(msg.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            var modalHTML =
                '<h2 class="text-2xl font-black italic uppercase mb-6 text-[var(--genesis-yellow)]">' +
                    '<i class="fas fa-envelope-open mr-2"></i>MESSAGE' +
                '</h2>' +
                '<div class="grid md:grid-cols-3 gap-4 mb-6">' +
                    '<div><span class="text-sm font-bold opacity-60">DE :</span><br><span class="font-black text-lg">' + msg.name + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">EMAIL :</span><br><span class="font-black">' + msg.email + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">PROFIL :</span><br><span class="font-black">' + (msg.profil ? msg.profil.charAt(0).toUpperCase() + msg.profil.slice(1) : 'Non renseign√©') + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">OBJET :</span><br><span class="font-black">' + msg.subject + '</span></div>' +
                    '<div><span class="text-sm font-bold opacity-60">DATE :</span><br><span class="font-black">' + date + '</span></div>' +
                '</div>' +
                '<div style="background:#FFF9E6;border-left:4px solid #FFD700;padding:20px;margin:20px 0;">' +
                    '<p style="white-space:pre-wrap;font-size:15px;line-height:1.6;">' + msg.message + '</p>' +
                '</div>' +
                '<div class="flex gap-3 flex-wrap mt-6">' +
                    '<a href="mailto:' + msg.email + '?subject=Re: ' + encodeURIComponent(msg.subject) + '" class="neo-btn-yellow px-6 py-3 text-sm" onclick="updateMessageStatus(\'' + msg.id + '\', \'replied\')">' +
                        '<i class="fas fa-reply mr-2"></i>R√âPONDRE PAR EMAIL' +
                    '</a>' +
                    '<button onclick="updateMessageStatus(\'' + msg.id + '\', \'archived\');closeClientModal()" class="border-4 border-black bg-gray-300 text-black px-6 py-3 text-sm font-black">' +
                        '<i class="fas fa-archive mr-2"></i>ARCHIVER' +
                    '</button>' +
                    '<button onclick="deleteMessage(\'' + msg.id + '\')" class="border-4 border-black bg-[#ff6b6b] text-black px-6 py-3 text-sm font-black">' +
                        '<i class="fas fa-trash mr-2"></i>SUPPRIMER' +
                    '</button>' +
                '</div>';

            document.getElementById('clientModalContent').innerHTML = modalHTML;
            document.getElementById('clientModal').style.display = 'flex';

            // Mettre a jour le statut local
            msg.status = 'read';
            renderMessages();
            var unread = allMessages.filter(function(m) { return m.status === 'unread'; }).length;
            var badge = document.getElementById('unreadBadge');
            if (unread > 0) { badge.style.display = 'block'; badge.textContent = unread; } else { badge.style.display = 'none'; }
        }

        async function updateMessageStatus(messageId, status) {
            try {
                await fetch(API_BASE_URL + '/api/admin/messages/' + messageId + '/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                var msg = allMessages.find(function(m) { return m.id === messageId; });
                if (msg) msg.status = status;
                renderMessages();
            } catch (e) {
                console.error('[ADMIN] Erreur maj statut:', e);
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Supprimer ce message ?')) return;
            try {
                await fetch(API_BASE_URL + '/api/admin/messages/' + messageId, { method: 'DELETE' });
                allMessages = allMessages.filter(function(m) { return m.id !== messageId; });
                closeClientModal();
                renderMessages();
            } catch (e) {
                console.error('[ADMIN] Erreur suppression:', e);
            }
        }

        // ============================================================
        // SECTION COMMANDES
        // ============================================================

        async function loadOrders() {
            try {
                var response = await fetch(API_BASE_URL + '/api/orders/all');
                if (!response.ok) throw new Error('Erreur chargement commandes');
                var orders = await response.json();

                if (!orders || orders.length === 0) {
                    document.getElementById('ordersList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Aucune commande</p>';
                    return;
                }

                var html = '';
                orders.forEach(function(order) {
                    var date = new Date(order.created_at).toLocaleDateString('fr-FR');
                    var statusColors = {
                        pending_deposit: '#ff6b6b', active: '#51cf66', in_progress: '#ffd43b',
                        delivered: '#4dabf7', completed: '#51cf66', pending_balance: '#ffd43b',
                        paid_in_full: '#4dabf7', cancelled: '#999'
                    };
                    var statusLabels = {
                        pending_deposit: 'ACOMPTE EN ATTENTE', active: 'ACTIF', in_progress: 'EN COURS',
                        delivered: 'LIVR√â', completed: 'TERMIN√â', pending_balance: 'SOLDE EN ATTENTE',
                        paid_in_full: 'PAY√â COMPLET', cancelled: 'ANNUL√â'
                    };
                    var bgColor = statusColors[order.status] || '#999';
                    var label = statusLabels[order.status] || order.status;
                    var clientName = order.client_info ? ((order.client_info.first_name || order.client_info.firstName || '') + ' ' + (order.client_info.last_name || order.client_info.lastName || '')) : 'N/A';
                    var clientEmail = order.client_info ? order.client_info.email : '';

                    html += '<div class="admin-card neo-shadow mb-4">' +
                        '<div class="flex justify-between items-start flex-wrap gap-4">' +
                            '<div class="flex-1 min-w-[200px]">' +
                                '<div class="text-xs font-bold opacity-50">' + order.id + '</div>' +
                                '<div class="font-black text-lg">' + clientName + '</div>' +
                                '<div class="text-sm font-bold opacity-70">' + clientEmail + '</div>' +
                            '</div>' +
                            '<div class="flex-1 min-w-[200px]">' +
                                '<div class="font-black">' + (order.product_name || 'N/A') + '</div>' +
                                '<div class="text-sm font-bold opacity-70">' + date + '</div>' +
                            '</div>' +
                            '<div class="text-center">' +
                                '<div class="text-2xl font-black text-[var(--genesis-yellow)]">' + (order.total_amount || 0) + '\u20ac</div>' +
                                '<div class="text-xs font-bold opacity-60">Acompte: ' + (order.deposit_amount || 0) + '\u20ac | Solde: ' + (order.balance_amount || 0) + '\u20ac</div>' +
                                '<div class="text-xs mt-1">' +
                                    (order.deposit_paid ? '<span style="color:#51cf66;">Acompte \u2713</span>' : '<span style="color:#ff6b6b;">Acompte \u2717</span>') + ' | ' +
                                    (order.balance_paid ? '<span style="color:#51cf66;">Solde \u2713</span>' : '<span style="color:#ff6b6b;">Solde \u2717</span>') +
                                '</div>' +
                            '</div>' +
                            '<div class="text-right">' +
                                '<div style="background:' + bgColor + ';color:black;padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;display:inline-block;">' + label + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                });

                document.getElementById('ordersList').innerHTML = html;

            } catch (error) {
                console.error('[ADMIN] Erreur chargement commandes:', error);
                document.getElementById('ordersList').innerHTML = '<p class="text-center py-8 opacity-50 font-bold">Chargement... (le serveur demarre)</p>';
                setTimeout(function() { loadOrders(); }, 5000);
            }
        }

        // Charger le badge messages non lus au demarrage
        (async function() {
            try {
                var response = await fetch(API_BASE_URL + '/api/admin/messages');
                if (response.ok) {
                    var msgs = await response.json();
                    var unread = msgs.filter(function(m) { return m.status === 'unread'; }).length;
                    var badge = document.getElementById('unreadBadge');
                    if (badge && unread > 0) { badge.style.display = 'block'; badge.textContent = unread; }
                }
            } catch (e) {}
        })();

        // Fermer le modal en cliquant en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('clientModal');
            if (event.target === modal) {
                closeClientModal();
            }
        }
    </script>
</body>
</html>
