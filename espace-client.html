<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Client - FA GENESIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap');

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: #f5f5f5;
            color: var(--genesis-black);
            font-family: 'Space Grotesk', sans-serif;
        }

        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 8px 8px 0px 0px var(--genesis-black); }
        .neo-shadow-yellow { box-shadow: 8px 8px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:hover {
            transform: translate(2px, 2px);
            box-shadow: 4px 4px 0px black;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .sidebar {
            background: var(--genesis-black);
            min-height: 100vh;
        }

        .sidebar-link {
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .sidebar-link:hover {
            background: rgba(255, 215, 0, 0.1);
            border-left-color: var(--genesis-yellow);
        }

        .sidebar-link.active {
            background: rgba(255, 215, 0, 0.2);
            border-left-color: var(--genesis-yellow);
            color: var(--genesis-yellow);
        }

        .status-badge {
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 0;
            border: 2px solid black;
        }

        .status-active { background: #4CAF50; color: white; }
        .status-pending { background: #FF9800; color: white; }
        .status-completed { background: #2196F3; color: white; }
        .status-delivered { background: #9C27B0; color: white; }
        .status-paid { background: #4CAF50; color: white; }

        .card {
            background: white;
            border: 4px solid black;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 10px 10px 0px black;
        }

        .balance-alert {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 4px solid black;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .progress-bar {
            height: 20px;
            background: #e0e0e0;
            border: 2px solid black;
        }

        .progress-fill {
            height: 100%;
            background: var(--genesis-yellow);
            transition: width 0.5s ease;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ddd;
            border-top-color: var(--genesis-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="flex">
        <aside class="sidebar w-64 fixed left-0 top-0 h-full z-40">
            <div class="p-6 border-b border-gray-800">
                <a href="index.html" class="text-2xl font-black text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">
                    FA GENESIS
                </a>
                <p class="text-gray-400 text-sm mt-1">Espace Client</p>
            </div>

            <nav class="mt-6">
                <a href="#dashboard" class="sidebar-link active" data-section="dashboard">
                    <i class="fas fa-home w-5"></i>
                    <span>Tableau de bord</span>
                </a>
                <a href="#livrables" class="sidebar-link" data-section="livrables" id="navLivrables">
                    <i class="fas fa-folder-open w-5"></i>
                    <span>Mes Livrables</span>
                </a>
                <a href="#paiements" class="sidebar-link" data-section="paiements">
                    <i class="fas fa-credit-card w-5"></i>
                    <span>Paiements</span>
                </a>
                <a href="#compte" class="sidebar-link" data-section="compte">
                    <i class="fas fa-user w-5"></i>
                    <span>Mon Compte</span>
                </a>
            </nav>

            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-800">
                <button onclick="logout()" class="text-gray-400 hover:text-white text-sm flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i>
                    Déconnexion
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="ml-64 flex-1 p-8">
            <!-- Loading State -->
            <div id="loadingState" class="flex items-center justify-center min-h-[60vh]">
                <div class="text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="font-bold">Chargement de votre espace...</p>
                </div>
            </div>

            <!-- No Access State -->
            <div id="noAccessState" class="hidden">
                <div class="bg-white p-8 neo-border neo-shadow max-w-2xl mx-auto mt-20 text-center">
                    <i class="fas fa-lock text-6xl text-gray-400 mb-6"></i>
                    <h1 class="text-3xl font-black mb-4">ACCÈS RESTREINT</h1>
                    <p class="text-lg mb-6" id="noAccessMessage">
                        Veuillez payer l'acompte de 30% pour accéder à votre espace client.
                    </p>
                    <a href="checkout.html" class="neo-btn-yellow px-8 py-4 text-lg uppercase inline-flex items-center gap-3">
                        <i class="fas fa-credit-card"></i>
                        Payer l'acompte
                    </a>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="hidden">
                <!-- Header -->
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h1 class="text-4xl font-black italic uppercase mb-2">MON ESPACE</h1>
                        <p class="text-gray-600">Bienvenue, <span id="clientName" class="font-bold">Client</span></p>
                    </div>
                    <div class="text-right">
                        <span class="status-badge" id="orderStatus">-</span>
                        <p class="text-sm text-gray-500 mt-2">Commande <span id="orderId">-</span></p>
                    </div>
                </div>

                <!-- Balance Alert (shown when balance is required) -->
                <div id="balanceAlert" class="balance-alert p-6 mb-8 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-exclamation-circle text-4xl text-black"></i>
                            <div>
                                <h3 class="text-xl font-black uppercase" id="balanceAlertTitle">Paiement du solde requis</h3>
                                <p class="font-bold" id="balanceAlertMessage">Payez le solde pour finaliser.</p>
                            </div>
                        </div>
                        <button onclick="payBalance()" class="bg-black text-white px-6 py-3 font-black uppercase hover:bg-gray-800 transition">
                            <i class="fas fa-credit-card mr-2"></i>
                            Payer <span id="balanceAmountBtn">0</span>EUR
                        </button>
                    </div>
                </div>

                <!-- Section: Dashboard -->
                <section id="sectionDashboard" class="section-content">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="card p-6 neo-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <i class="fas fa-box text-3xl text-[var(--genesis-yellow)]"></i>
                                <span class="text-3xl font-black" id="statProduct">-</span>
                            </div>
                            <p class="font-bold uppercase text-sm text-gray-600">Votre Offre</p>
                        </div>
                        <div class="card p-6 neo-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <i class="fas fa-euro-sign text-3xl text-green-500"></i>
                                <span class="text-3xl font-black" id="statPaid">0EUR</span>
                            </div>
                            <p class="font-bold uppercase text-sm text-gray-600">Montant Payé</p>
                        </div>
                        <div class="card p-6 neo-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <i class="fas fa-hourglass-half text-3xl text-orange-500"></i>
                                <span class="text-3xl font-black" id="statRemaining">0EUR</span>
                            </div>
                            <p class="font-bold uppercase text-sm text-gray-600">Reste à Payer</p>
                        </div>
                    </div>

                    <!-- Progress (for accompaniments) -->
                    <div id="progressSection" class="card p-6 neo-shadow mb-8 hidden">
                        <h3 class="text-xl font-black uppercase mb-4">
                            <i class="fas fa-chart-line mr-2 text-[var(--genesis-yellow)]"></i>
                            Progression de votre accompagnement
                        </h3>
                        <div class="progress-bar mb-2">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600"><span id="progressPercent">0</span>% complete</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-6 neo-shadow">
                            <h3 class="text-xl font-black uppercase mb-4">
                                <i class="fas fa-folder-open mr-2 text-[var(--genesis-yellow)]"></i>
                                Vos Livrables
                            </h3>
                            <p class="text-gray-600 mb-4">Consultez et téléchargez vos documents, photos et vidéos.</p>
                            <button onclick="showSection('livrables')" class="neo-btn-yellow px-6 py-3 uppercase text-sm">
                                Voir les livrables
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Section: Livrables -->
                <section id="sectionLivrables" class="section-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black uppercase">
                            <i class="fas fa-folder-open mr-3 text-[var(--genesis-yellow)]"></i>
                            Mes Livrables
                        </h2>
                        <button onclick="showSection('dashboard')" class="text-gray-600 hover:text-black font-bold">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                    </div>

                    <!-- Download restriction message -->
                    <div id="downloadRestriction" class="bg-orange-100 border-4 border-orange-500 p-4 mb-6 hidden">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-info-circle text-orange-500 text-xl"></i>
                            <div>
                                <p class="font-bold">Mode Preview uniquement</p>
                                <p class="text-sm" id="downloadRestrictionMsg">Payez le solde de 70% pour télécharger les fichiers originaux.</p>
                            </div>
                        </div>
                    </div>

                    <div id="livrablesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Livrables loaded dynamically -->
                    </div>

                    <div id="noLivrables" class="text-center py-12 hidden">
                        <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl font-bold text-gray-500">Aucun livrable disponible pour le moment</p>
                        <p class="text-gray-400">Vos livrables apparaîtront ici une fois prêts.</p>
                    </div>
                </section>


                <!-- Section: Paiements -->
                <section id="sectionPaiements" class="section-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black uppercase">
                            <i class="fas fa-credit-card mr-3 text-[var(--genesis-yellow)]"></i>
                            Mes Paiements
                        </h2>
                        <button onclick="showSection('dashboard')" class="text-gray-600 hover:text-black font-bold">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                    </div>

                    <div class="card p-6 neo-shadow mb-6">
                        <h3 class="text-xl font-black uppercase mb-4">Résumé des paiements</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b-2">
                                <span class="font-bold">Montant total</span>
                                <span class="text-2xl font-black" id="paymentTotal">0EUR</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b-2">
                                <div>
                                    <span class="font-bold">Acompte (30%)</span>
                                    <span class="status-badge ml-2" id="depositStatus">En attente</span>
                                </div>
                                <span class="font-black" id="paymentDeposit">0EUR</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <div>
                                    <span class="font-bold">Solde (70%)</span>
                                    <span class="status-badge ml-2" id="balanceStatus">En attente</span>
                                </div>
                                <span class="font-black" id="paymentBalance">0EUR</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pay Balance Button -->
                    <div id="payBalanceSection" class="card p-6 neo-shadow-yellow hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-black uppercase">Payer le solde</h3>
                                <p class="text-gray-600" id="payBalanceMessage">Finalisez votre paiement</p>
                            </div>
                            <button onclick="payBalance()" class="neo-btn-yellow px-8 py-4 text-lg uppercase">
                                Payer <span id="payBalanceAmount">0</span>EUR
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Section: Compte -->
                <section id="sectionCompte" class="section-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black uppercase">
                            <i class="fas fa-user mr-3 text-[var(--genesis-yellow)]"></i>
                            Mon Compte
                        </h2>
                        <button onclick="showSection('dashboard')" class="text-gray-600 hover:text-black font-bold">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                    </div>

                    <div class="card p-6 neo-shadow">
                        <h3 class="text-xl font-black uppercase mb-4">Informations personnelles</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500 uppercase">Prénom</p>
                                <p class="font-bold text-lg" id="accountFirstName">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 uppercase">Nom</p>
                                <p class="font-bold text-lg" id="accountLastName">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 uppercase">Email</p>
                                <p class="font-bold text-lg" id="accountEmail">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 uppercase">Téléphone</p>
                                <p class="font-bold text-lg" id="accountPhone">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Zone de danger : Suppression du compte -->
                    <div class="card p-6 border-4 border-red-500 mt-8">
                        <h3 class="text-xl font-black uppercase mb-4 text-red-600">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Zone de danger
                        </h3>
                        <p class="font-bold text-gray-700 mb-4">
                            La suppression de votre compte est définitive et irréversible. Toutes vos données seront supprimées.
                        </p>
                        <ul class="text-sm text-gray-600 mb-6 space-y-2">
                            <li><i class="fas fa-times text-red-500 mr-2"></i>Vos informations personnelles seront supprimées</li>
                            <li><i class="fas fa-times text-red-500 mr-2"></i>Votre historique de commandes sera effacé</li>
                            <li><i class="fas fa-times text-red-500 mr-2"></i>Vous perdrez l'accès à vos livrables</li>
                            <li><i class="fas fa-times text-red-500 mr-2"></i>Cette action est irréversible</li>
                        </ul>
                        <button onclick="openDeleteModal()" class="bg-red-600 text-white border-4 border-red-800 px-6 py-3 font-black uppercase hover:bg-red-700 transition inline-flex items-center gap-2">
                            <i class="fas fa-trash-alt"></i>
                            Supprimer définitivement mon compte
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal de confirmation de suppression de compte -->
    <div id="deleteAccountModal" class="fixed inset-0 z-50 hidden">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black/80" onclick="closeDeleteModal()"></div>

        <!-- Modal content -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg">
            <div class="bg-white border-4 border-black p-8 mx-4">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-red-500 rounded-full border-4 border-black mb-4">
                        <i class="fas fa-exclamation-triangle text-4xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-black uppercase text-red-600">Confirmer la suppression</h3>
                </div>

                <p class="font-bold text-center mb-6">
                    Êtes-vous sûr de vouloir supprimer définitivement votre compte ?
                    <br><span class="text-red-600">Cette action est irréversible.</span>
                </p>

                <div class="mb-6">
                    <label class="block font-black uppercase text-sm mb-2">
                        Pour confirmer, tapez <span class="text-red-600">SUPPRIMER</span> ci-dessous :
                    </label>
                    <input type="text" id="deleteConfirmInput" class="w-full border-4 border-black p-3 font-bold uppercase text-center" placeholder="SUPPRIMER">
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <button onclick="closeDeleteModal()" class="flex-1 bg-gray-200 text-black border-4 border-black px-6 py-3 font-black uppercase hover:bg-gray-300 transition">
                        <i class="fas fa-times mr-2"></i>
                        Annuler
                    </button>
                    <button onclick="confirmDeleteAccount()" id="confirmDeleteBtn" class="flex-1 bg-red-600 text-white border-4 border-red-800 px-6 py-3 font-black uppercase hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-trash-alt mr-2"></i>
                        Supprimer
                    </button>
                </div>

                <p class="text-xs text-gray-500 text-center mt-4">
                    <i class="fas fa-info-circle mr-1"></i>
                    Si vous avez des questions, contactez-nous à Financialadvicegenesis@gmail.com
                </p>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const API_BASE_URL = 'http://localhost:3001';

        // Récupérer l'ID de commande depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order') || sessionStorage.getItem('currentOrderId');

        let currentOrder = null;
        let accessRights = null;

        // ============================================================
        // INITIALISATION
        // ============================================================
        window.addEventListener('DOMContentLoaded', async function() {
            if (!orderId) {
                showNoAccess('Aucune commande trouvée. Veuillez vous connecter.');
                return;
            }

            try {
                // Charger les données du dashboard
                const response = await fetch(`${API_BASE_URL}/api/client/dashboard/${orderId}`);

                if (!response.ok) {
                    throw new Error('Commande non trouvée');
                }

                const data = await response.json();
                currentOrder = data.order;
                accessRights = data.access;

                console.log('[DASHBOARD] Données chargées:', data);

                // Vérifier l'accès
                if (!accessRights.can_access_dashboard) {
                    showNoAccess(accessRights.balance_message || 'Accès non autorisé');
                    return;
                }

                // Sauvegarder l'orderId
                sessionStorage.setItem('currentOrderId', orderId);

                // Afficher le dashboard
                displayDashboard();

            } catch (error) {
                console.error('[DASHBOARD] Erreur:', error);
                showNoAccess('Erreur lors du chargement. Vérifiez que le backend est démarré.');
            }
        });

        // ============================================================
        // AFFICHAGE
        // ============================================================
        function showNoAccess(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('noAccessState').classList.remove('hidden');
            document.getElementById('noAccessMessage').textContent = message;
        }

        function displayDashboard() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');

            // Infos client
            document.getElementById('clientName').textContent =
                `${currentOrder.client_info.first_name} ${currentOrder.client_info.last_name}`;
            document.getElementById('orderId').textContent = currentOrder.id;

            // Statut
            const statusEl = document.getElementById('orderStatus');
            statusEl.textContent = getStatusLabel(currentOrder.status);
            statusEl.className = 'status-badge ' + getStatusClass(currentOrder.status);

            // Stats
            document.getElementById('statProduct').textContent = currentOrder.product_name;

            const amountPaid = currentOrder.deposit_paid ?
                (currentOrder.balance_paid ? currentOrder.total_amount : currentOrder.deposit_amount) : 0;
            const remaining = currentOrder.total_amount - amountPaid;

            document.getElementById('statPaid').textContent = formatPrice(amountPaid);
            document.getElementById('statRemaining').textContent = formatPrice(remaining);

            // Paiements
            document.getElementById('paymentTotal').textContent = formatPrice(currentOrder.total_amount);
            document.getElementById('paymentDeposit').textContent = formatPrice(currentOrder.deposit_amount);
            document.getElementById('paymentBalance').textContent = formatPrice(currentOrder.balance_amount);

            document.getElementById('depositStatus').textContent = currentOrder.deposit_paid ? 'Payé' : 'En attente';
            document.getElementById('depositStatus').className = 'status-badge ml-2 ' +
                (currentOrder.deposit_paid ? 'status-paid' : 'status-pending');

            document.getElementById('balanceStatus').textContent = currentOrder.balance_paid ? 'Payé' : 'En attente';
            document.getElementById('balanceStatus').className = 'status-badge ml-2 ' +
                (currentOrder.balance_paid ? 'status-paid' : 'status-pending');

            // Compte
            document.getElementById('accountFirstName').textContent = currentOrder.client_info.first_name;
            document.getElementById('accountLastName').textContent = currentOrder.client_info.last_name;
            document.getElementById('accountEmail').textContent = currentOrder.client_info.email;
            document.getElementById('accountPhone').textContent = currentOrder.client_info.phone || '-';


            // Balance alert si nécessaire
            if (accessRights.balance_required) {
                document.getElementById('balanceAlert').classList.remove('hidden');
                document.getElementById('balanceAlertMessage').textContent = accessRights.balance_message;
                document.getElementById('balanceAmountBtn').textContent = currentOrder.balance_amount;

                document.getElementById('payBalanceSection').classList.remove('hidden');
                document.getElementById('payBalanceAmount').textContent = currentOrder.balance_amount;
                document.getElementById('payBalanceMessage').textContent = accessRights.balance_message;
            }

            // Navigation sidebar
            setupNavigation();

            // Charger les livrables
            loadLivrables();
        }

        function setupNavigation() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                });
            });
        }

        function showSection(sectionName) {
            // Masquer toutes les sections
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));

            // Afficher la section demandée
            const section = document.getElementById('section' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1));
            if (section) {
                section.classList.remove('hidden');
            }

            // Mettre à jour la navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionName) {
                    link.classList.add('active');
                }
            });
        }

        // ============================================================
        // LIVRABLES
        // ============================================================
        async function loadLivrables() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/livrables/${orderId}`);

                if (!response.ok) {
                    throw new Error('Erreur chargement livrables');
                }

                const data = await response.json();
                displayLivrables(data);

            } catch (error) {
                console.error('[LIVRABLES] Erreur:', error);
            }
        }

        function displayLivrables(data) {
            const grid = document.getElementById('livrablesGrid');
            const noLivrables = document.getElementById('noLivrables');
            const restriction = document.getElementById('downloadRestriction');

            if (!data.livrables || data.livrables.length === 0) {
                grid.classList.add('hidden');
                noLivrables.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            noLivrables.classList.add('hidden');

            // Afficher la restriction si nécessaire
            if (!data.can_download && data.balance_required) {
                restriction.classList.remove('hidden');
                document.getElementById('downloadRestrictionMsg').textContent = data.message;
            }

            // Afficher les livrables
            grid.innerHTML = data.livrables.map(liv => `
                <div class="card p-4 neo-shadow">
                    <div class="aspect-video bg-gray-100 mb-4 flex items-center justify-center border-2 border-black">
                        ${getLivrablePreview(liv)}
                    </div>
                    <h4 class="font-black text-lg mb-2">${liv.name}</h4>
                    <p class="text-sm text-gray-600 mb-4">${liv.description || getTypeLabel(liv.type)}</p>
                    <div class="flex gap-2">
                        ${liv.preview_url ? `
                            <button onclick="previewLivrable('${liv.preview_url}', '${liv.type}')"
                                class="flex-1 bg-gray-200 text-black px-4 py-2 font-bold text-sm hover:bg-gray-300 transition">
                                <i class="fas fa-eye mr-1"></i> Preview
                            </button>
                        ` : ''}
                        ${data.can_download ? `
                            <button onclick="downloadLivrable('${liv.id}')"
                                class="flex-1 neo-btn-yellow px-4 py-2 text-sm">
                                <i class="fas fa-download mr-1"></i> Télécharger
                            </button>
                        ` : `
                            <button disabled
                                class="flex-1 bg-gray-300 text-gray-500 px-4 py-2 font-bold text-sm cursor-not-allowed"
                                title="Payez le solde pour télécharger">
                                <i class="fas fa-lock mr-1"></i> Verrouillé
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        function getLivrablePreview(liv) {
            const icons = {
                photo: 'fa-image',
                video: 'fa-video',
                document: 'fa-file-pdf',
                audio: 'fa-music'
            };
            const icon = icons[liv.type] || 'fa-file';
            return `<i class="fas ${icon} text-5xl text-gray-400"></i>`;
        }

        function getTypeLabel(type) {
            const labels = {
                photo: 'Photo',
                video: 'Vidéo',
                document: 'Document',
                audio: 'Audio'
            };
            return labels[type] || 'Fichier';
        }

        function previewLivrable(url, type) {
            // Ouvrir la preview dans une nouvelle fenêtre
            window.open(url, '_blank');
        }

        async function downloadLivrable(livrableId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/download/${orderId}/${livrableId}`);

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.message || 'Téléchargement non autorisé');
                    return;
                }

                const data = await response.json();
                if (data.download_url) {
                    window.open(data.download_url, '_blank');
                }

            } catch (error) {
                console.error('[DOWNLOAD] Erreur:', error);
                alert('Erreur lors du téléchargement');
            }
        }

        // ============================================================
        // PAIEMENT SOLDE
        // ============================================================
        async function payBalance() {
            try {
                // Créer le checkout pour le solde
                const response = await fetch(`${API_BASE_URL}/api/payments/sumup/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        stage: 'balance'
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.error || 'Erreur lors de la création du paiement');
                    return;
                }

                const data = await response.json();
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                }

            } catch (error) {
                console.error('[PAYMENT] Erreur:', error);
                alert('Erreur lors de l\'initiation du paiement');
            }
        }

        // ============================================================
        // UTILITAIRES
        // ============================================================
        function formatPrice(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function getStatusLabel(status) {
            const labels = {
                'pending_deposit': 'En attente acompte',
                'active': 'Actif',
                'in_progress': 'En cours',
                'delivered': 'Livré',
                'completed': 'Terminé',
                'pending_balance': 'En attente solde',
                'paid_in_full': 'Paiement complet',
                'cancelled': 'Annulé'
            };
            return labels[status] || status;
        }

        function getStatusClass(status) {
            const classes = {
                'pending_deposit': 'status-pending',
                'active': 'status-active',
                'in_progress': 'status-active',
                'delivered': 'status-delivered',
                'completed': 'status-completed',
                'pending_balance': 'status-pending',
                'paid_in_full': 'status-paid',
                'cancelled': ''
            };
            return classes[status] || '';
        }

        function logout() {
            sessionStorage.removeItem('currentOrderId');
            window.location.href = 'index.html';
        }

        // ============================================================
        // SUPPRESSION DE COMPTE
        // ============================================================
        function openDeleteModal() {
            document.getElementById('deleteAccountModal').classList.remove('hidden');
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;

            // Écouter les changements dans le champ de confirmation
            document.getElementById('deleteConfirmInput').addEventListener('input', function() {
                const isValid = this.value.toUpperCase() === 'SUPPRIMER';
                document.getElementById('confirmDeleteBtn').disabled = !isValid;
            });
        }

        function closeDeleteModal() {
            document.getElementById('deleteAccountModal').classList.add('hidden');
        }

        async function confirmDeleteAccount() {
            const confirmInput = document.getElementById('deleteConfirmInput');
            if (confirmInput.value.toUpperCase() !== 'SUPPRIMER') {
                alert('Veuillez taper SUPPRIMER pour confirmer.');
                return;
            }

            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Suppression...';

            try {
                // Appel API pour supprimer le compte
                const response = await fetch(`${API_BASE_URL}/api/accounts/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Erreur lors de la suppression');
                }

                // Succès - nettoyer les données locales
                sessionStorage.removeItem('currentOrderId');
                localStorage.removeItem('selectedProductId');
                localStorage.removeItem('selectedOfferName');

                // Afficher un message de confirmation et rediriger
                closeDeleteModal();
                alert('Votre compte a été supprimé avec succès. Vous allez être redirigé vers la page d\'accueil.');
                window.location.href = 'index.html';

            } catch (error) {
                console.error('[DELETE ACCOUNT] Erreur:', error);

                // Réactiver le bouton
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Supprimer';

                // Si le backend n'est pas disponible, simuler la suppression côté client
                if (error.message.includes('fetch') || error.message.includes('NetworkError')) {
                    // Mode hors-ligne : supprimer les données locales uniquement
                    sessionStorage.removeItem('currentOrderId');
                    localStorage.removeItem('selectedProductId');
                    localStorage.removeItem('selectedOfferName');

                    closeDeleteModal();
                    alert('Votre session a été supprimée. Pour une suppression complète, veuillez contacter Financialadvicegenesis@gmail.com');
                    window.location.href = 'index.html';
                } else {
                    alert('Erreur : ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
