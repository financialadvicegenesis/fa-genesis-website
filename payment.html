<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Paiement - FA GENESIS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <!-- AOS removed - functional page -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
        }

        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .payment-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .status-registered { background: #ff6b6b; }
        .status-deposit { background: #51cf66; }
        .status-pending { background: #ffd43b; }
        .status-fully { background: #4dabf7; }

        /* SumUp Payment Modal */
        .sumup-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .sumup-modal-overlay.active {
            display: flex;
        }
        .sumup-modal-content {
            background: white;
            color: black;
            border: 4px solid black;
            box-shadow: 10px 10px 0px var(--genesis-yellow);
            max-width: 500px;
            width: 90%;
            padding: 2rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .sumup-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 900;
            color: black;
        }
        .sumup-modal-close:hover {
            color: #ff6b6b;
        }
        .sumup-modal-amount {
            background: var(--genesis-yellow);
            border: 3px solid black;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-6 py-4 flex justify-between items-center">
        <a href="dashboard.html" class="text-2xl font-black tracking-wider text-[var(--genesis-yellow)]">FA GENESIS</a>
        <a href="dashboard.html" class="text-white font-black hover:text-[var(--genesis-yellow)]">
            <i class="fas fa-arrow-left mr-2"></i>Retour au Dashboard
        </a>
    </nav>

    <section class="min-h-screen pt-32 pb-20 px-6">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-5xl md:text-6xl font-black italic uppercase text-center mb-4 text-[var(--genesis-yellow)]">
                PAIEMENT
            </h1>
            <p class="text-center text-xl font-bold mb-12 uppercase" id="statusMessage"></p>

            <!-- Résumé du statut -->
            <div id="statusSummary" class="payment-card neo-shadow mb-8"></div>

            <!-- Section Acompte -->
            <div id="depositSection" class="payment-card neo-shadow" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-4">
                    <i class="fas fa-hand-holding-usd text-[var(--genesis-yellow)] mr-3"></i>
                    ACOMPTE - 30%
                </h2>
                <p id="depositIntroMessage" class="font-bold mb-6"></p>
                <div id="depositDetails" class="mb-6"></div>
                <div id="depositAction"></div>
            </div>

            <!-- Section Solde -->
            <div id="balanceSection" class="payment-card neo-shadow" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-4">
                    <i class="fas fa-check-circle text-[var(--genesis-yellow)] mr-3"></i>
                    SOLDE - 70%
                </h2>
                <p id="balanceIntroMessage" class="font-bold mb-6"></p>
                <div id="balanceDetails" class="mb-6"></div>

                <!-- Options de paiement -->
                <div class="grid md:grid-cols-2 gap-6 mb-6" id="paymentOptions">
                    <!-- Options générées dynamiquement -->
                </div>

                <!-- Section paiement échelonné -->
                <div id="installmentSection" style="display: none;">
                    <h3 class="text-2xl font-black italic uppercase mb-4">
                        <i class="fas fa-calendar-alt mr-2"></i>VOS MENSUALITÉS
                    </h3>
                    <div id="installmentsList"></div>
                </div>
            </div>

            <!-- Historique des paiements -->
            <div class="payment-card neo-shadow">
                <h2 class="text-3xl font-black italic uppercase mb-6">
                    <i class="fas fa-history text-[var(--genesis-yellow)] mr-3"></i>
                    HISTORIQUE DES PAIEMENTS
                </h2>
                <div id="paymentHistory"></div>
            </div>
        </div>
    </section>

    <!-- SumUp Payment Modal -->
    <div id="sumupModal" class="sumup-modal-overlay">
        <div class="sumup-modal-content">
            <button onclick="closeSumUpModal()" class="sumup-modal-close">&times;</button>
            <h3 style="font-family: 'Unbounded', cursive; font-size: 1.25rem; font-weight: 900; text-transform: uppercase; margin-bottom: 1rem;">
                <i class="fas fa-lock" style="color: var(--genesis-yellow); margin-right: 8px;"></i>Paiement Sécurisé
            </h3>
            <div class="sumup-modal-amount">
                <p style="font-size: 0.875rem; font-weight: 700; opacity: 0.7; text-transform: uppercase;">Montant à payer</p>
                <p id="sumupModalAmount" style="font-size: 2rem; font-weight: 900;"></p>
            </div>
            <div id="sumup-card"></div>
            <p style="text-align: center; font-size: 0.75rem; margin-top: 1rem; opacity: 0.6;">
                <i class="fas fa-shield-alt"></i> Paiement sécurisé par SumUp
            </p>
        </div>
    </div>

    <!-- AOS script removed - functional page -->
    <script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="offers-config.js"></script>
    <script>
    (function() {
        try {
            var PAY_API = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';

            // === SumUp Card Widget ===
            window.showSumUpWidget = function(checkoutId, amount, orderId, stage) {
                var modal = document.getElementById('sumupModal');
                if (modal) modal.classList.add('active');
                var amountEl = document.getElementById('sumupModalAmount');
                if (amountEl) amountEl.textContent = amount + '\u20AC';

                var container = document.getElementById('sumup-card');
                if (container) container.innerHTML = '';

                SumUpCard.mount({
                    id: 'sumup-card',
                    checkoutId: checkoutId,
                    locale: 'fr-FR',
                    onResponse: function(type, body) {
                        console.log('[SUMUP WIDGET] Response:', type, body);
                        if (type === 'success') {
                            closeSumUpModal();
                            try {
                                fetch(PAY_API + '/api/payments/verify', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ orderId: orderId, stage: stage })
                                }).catch(function() {});
                            } catch (e) {}
                            window.location.href = 'payment-success.html?order=' + orderId + '&stage=' + stage;
                        } else if (type === 'error') {
                            console.error('[SUMUP WIDGET] Erreur:', body);
                            closeSumUpModal();
                            alert('Le paiement a \u00E9chou\u00E9.\n\nRaison : ' + (body.message || body.error_message || 'Erreur inconnue') + '\n\nVeuillez r\u00E9essayer.');
                        }
                    }
                });
            };

            window.closeSumUpModal = function() {
                var modal = document.getElementById('sumupModal');
                if (modal) modal.classList.remove('active');
                var container = document.getElementById('sumup-card');
                if (container) container.innerHTML = '';
            };

            // Protection de la page
            if (typeof requireAuth === 'function') { requireAuth(); }

            var currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // === Helpers ===
            function getToken() {
                return localStorage.getItem('fa_genesis_token') || localStorage.getItem('fa_genesis_session') || '';
            }

            function getStatusLabel(status) {
                var labels = {
                    'registered': 'Inscrit',
                    'deposit_paid': 'Acompte r\u00E9gl\u00E9',
                    'delivery_pending_payment': 'En attente du solde',
                    'pending_balance': 'En attente du solde',
                    'fully_paid': 'Pay\u00E9 int\u00E9gralement',
                    'paid_in_full': 'Pay\u00E9 int\u00E9gralement',
                    'delivered': 'Livr\u00E9'
                };
                return labels[status] || status || 'Inconnu';
            }

            function getStatusClass(status) {
                var classes = {
                    'registered': 'status-registered',
                    'deposit_paid': 'status-deposit',
                    'delivery_pending_payment': 'status-pending',
                    'pending_balance': 'status-pending',
                    'fully_paid': 'status-fully',
                    'paid_in_full': 'status-fully'
                };
                return classes[status] || 'status-registered';
            }

            // ===============================
            // LOAD PAYMENT STATUS FROM BACKEND
            // ===============================
            function loadPaymentStatus() {
                console.log('[PAYMENT PAGE] Chargement depuis le backend...');

                var statusMsg = document.getElementById('statusMessage');
                if (statusMsg) statusMsg.textContent = 'Chargement...';

                var token = getToken();
                if (!token) {
                    if (statusMsg) statusMsg.textContent = 'Session expir\u00E9e. Veuillez vous reconnecter.';
                    return;
                }

                fetch(PAY_API + '/api/payments/history', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(function(resp) {
                    if (!resp.ok) throw new Error('Erreur serveur: ' + resp.status);
                    return resp.json();
                })
                .then(function(data) {
                    console.log('[PAYMENT PAGE] Reponse backend:', data);
                    if (!data.ok) {
                        if (statusMsg) statusMsg.textContent = data.error || 'Erreur de chargement';
                        return;
                    }
                    displayFromBackend(data);
                })
                .catch(function(err) {
                    console.error('[PAYMENT PAGE] Erreur fetch:', err);
                    // Fallback: utiliser les donnees locales de l'utilisateur
                    console.log('[PAYMENT PAGE] Tentative fallback avec donnees locales...');
                    displayFromLocalUser(currentUser);
                });
            }

            // ========================
            // DISPLAY FROM BACKEND DATA
            // ========================
            function displayFromBackend(data) {
                var statusMsg = document.getElementById('statusMessage');
                var totalPaid = 0;

                // Calculer total pay\u00E9 depuis l'historique
                if (data.payments && data.payments.length > 0) {
                    for (var i = 0; i < data.payments.length; i++) {
                        totalPaid += (data.payments[i].amount || 0);
                    }
                }

                // D\u00E9river le statut depuis deposit_paid / balance_paid (payment_status n'est pas retourn\u00E9 par le backend)
                var status = 'registered';
                if (data.balance_paid) {
                    status = 'fully_paid';
                } else if (data.deposit_paid) {
                    status = 'deposit_paid';
                }

                // Message de statut
                if (status === 'registered' && !data.product_name) {
                    if (statusMsg) statusMsg.textContent = 'Aucune offre s\u00E9lectionn\u00E9e. Veuillez choisir une offre.';
                } else if (status === 'registered') {
                    if (statusMsg) statusMsg.textContent = 'Un acompte de 30% est requis pour d\u00E9marrer.';
                } else if (status === 'deposit_paid') {
                    if (statusMsg) statusMsg.textContent = 'Votre acompte a \u00E9t\u00E9 r\u00E9gl\u00E9. Merci !';
                } else if (status === 'fully_paid') {
                    if (statusMsg) statusMsg.textContent = 'Tous les paiements sont r\u00E9gl\u00E9s. Merci !';
                } else {
                    if (statusMsg) statusMsg.textContent = 'Bienvenue dans votre espace paiement.';
                }

                // Afficher le r\u00E9sum\u00E9 du statut
                displayStatusSummary(status, totalPaid, data.product_name, data.total_amount, data.deposit_amount);

                // Section acompte - toujours afficher si offre active
                if (data.product_name) {
                    var depSection = document.getElementById('depositSection');
                    if (depSection) depSection.style.display = 'block';
                    displayDepositDetails(data, status);
                }

                // Section solde (si can_pay_balance)
                if (data.can_pay_balance) {
                    var balSection = document.getElementById('balanceSection');
                    if (balSection) balSection.style.display = 'block';
                    displayBalanceDetails(data);
                }

                // Afficher l'historique
                displayPaymentHistory(data.payments || []);
            }

            // ==========================
            // FALLBACK: LOCAL USER DATA
            // ==========================
            function displayFromLocalUser(user) {
                var statusMsg = document.getElementById('statusMessage');
                var status = user.paymentStatus || user.payment_status || 'registered';
                var offerId = user.activeOfferId || user.active_offer_id || user.offre;
                var offer = null;

                if (offerId && typeof getOfferById === 'function') {
                    try { offer = getOfferById(offerId); } catch (e) {}
                }

                if (status === 'registered') {
                    if (statusMsg) statusMsg.textContent = 'Un acompte de 30% est requis pour d\u00E9marrer.';
                } else {
                    if (statusMsg) statusMsg.textContent = 'Bienvenue dans votre espace paiement.';
                }

                // Resume
                var summaryEl = document.getElementById('statusSummary');
                if (summaryEl) {
                    var html = '<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">';
                    html += '<div><h3 class="text-2xl font-black italic uppercase mb-2">VOTRE STATUT</h3>';
                    html += '<span class="status-badge ' + getStatusClass(status) + '">' + getStatusLabel(status) + '</span></div>';
                    html += '<div class="text-right"><p class="text-sm font-bold opacity-70 uppercase">Total paye</p>';
                    html += '<p class="text-3xl font-black text-[var(--genesis-yellow)]">-- \u20AC</p></div></div>';
                    if (offer) {
                        html += '<div class="border-t-4 border-black pt-6">';
                        html += '<h4 class="text-xl font-black uppercase mb-3">OFFRE ACTIVE</h4>';
                        html += '<div class="grid md:grid-cols-3 gap-4">';
                        html += '<div><p class="text-sm font-bold opacity-70 uppercase">Formule</p>';
                        html += '<p class="font-black text-lg">' + (offer.nom || '') + '</p></div>';
                        html += '<div><p class="text-sm font-bold opacity-70 uppercase">Prix total</p>';
                        html += '<p class="font-black text-lg">' + (offer.prixTotal || '') + '\u20AC</p></div>';
                        html += '<div><p class="text-sm font-bold opacity-70 uppercase">Duree</p>';
                        html += '<p class="font-black text-lg">' + (offer.duree || '') + '</p></div>';
                        html += '</div></div>';
                    }
                    summaryEl.innerHTML = html;
                }

                // Section acompte
                if (status === 'registered' && offer) {
                    var depSection = document.getElementById('depositSection');
                    if (depSection) depSection.style.display = 'block';
                    var introMsg = document.getElementById('depositIntroMessage');
                    if (introMsg) introMsg.textContent = 'Pour d\u00E9marrer votre accompagnement, un acompte de 30% est requis.';
                    var detEl = document.getElementById('depositDetails');
                    if (detEl) {
                        detEl.innerHTML = '<div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">' +
                            '<div class="flex justify-between items-center"><div>' +
                            '<p class="text-2xl font-black uppercase">' + (offer.nom || '') + '</p>' +
                            '<p class="font-bold opacity-70">Acompte requis (30%)</p></div>' +
                            '<p class="text-4xl font-black">' + (offer.acompte || '') + '\u20AC</p></div></div>';
                    }
                    var actionEl = document.getElementById('depositAction');
                    if (actionEl) {
                        actionEl.innerHTML = '<button onclick="payDeposit()" class="neo-btn-yellow px-8 py-4 text-xl font-black uppercase mt-4">' +
                            '<i class="fas fa-credit-card mr-2"></i>Payer l\'acompte</button>';
                    }
                }

                // Historique vide en fallback
                var histEl = document.getElementById('paymentHistory');
                if (histEl) {
                    histEl.innerHTML = '<p class="font-bold opacity-50 text-center py-8">Impossible de charger l\'historique. Veuillez r\u00E9essayer.</p>';
                }
            }

            // ==================
            // DISPLAY FUNCTIONS
            // ==================
            function displayStatusSummary(status, totalPaid, productName, totalAmount, depositAmount) {
                var el = document.getElementById('statusSummary');
                if (!el) return;

                var html = '<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">';
                html += '<div><h3 class="text-2xl font-black italic uppercase mb-2">VOTRE STATUT</h3>';
                html += '<span class="status-badge ' + getStatusClass(status) + '">' + getStatusLabel(status) + '</span></div>';
                html += '<div class="text-right"><p class="text-sm font-bold opacity-70 uppercase">Total pay\u00E9</p>';
                html += '<p class="text-3xl font-black text-[var(--genesis-yellow)]">' + totalPaid + '\u20AC</p></div></div>';

                if (productName) {
                    html += '<div class="border-t-4 border-black pt-6">';
                    html += '<h4 class="text-xl font-black uppercase mb-3">OFFRE ACTIVE</h4>';
                    html += '<div class="grid md:grid-cols-3 gap-4">';
                    html += '<div><p class="text-sm font-bold opacity-70 uppercase">Formule</p>';
                    html += '<p class="font-black text-lg">' + productName + '</p></div>';
                    html += '<div><p class="text-sm font-bold opacity-70 uppercase">Prix total</p>';
                    html += '<p class="font-black text-lg">' + (totalAmount || '--') + '\u20AC</p></div>';
                    html += '<div><p class="text-sm font-bold opacity-70 uppercase">Acompte (30%)</p>';
                    html += '<p class="font-black text-lg">' + (depositAmount || '--') + '\u20AC</p></div>';
                    html += '</div></div>';
                }

                el.innerHTML = html;
            }

            function displayDepositDetails(data, status) {
                var introMsg = document.getElementById('depositIntroMessage');
                var detEl = document.getElementById('depositDetails');
                var actionEl = document.getElementById('depositAction');

                if (status === 'deposit_paid' || status === 'fully_paid') {
                    // Acompte d\u00E9j\u00E0 pay\u00E9 - afficher confirmation
                    if (introMsg) introMsg.textContent = 'Votre acompte a bien \u00E9t\u00E9 r\u00E9gl\u00E9. Merci !';
                    if (detEl) {
                        var html = '<div class="bg-green-100 p-6 border-4 border-green-600 mb-6">';
                        html += '<div class="flex justify-between items-center"><div>';
                        html += '<p class="text-2xl font-black uppercase text-green-800"><i class="fas fa-check-circle mr-2"></i>' + (data.product_name || 'Votre offre') + '</p>';
                        html += '<p class="font-bold text-green-700">Acompte r\u00E9gl\u00E9 (30%)</p></div>';
                        html += '<p class="text-4xl font-black text-green-800">' + (data.deposit_amount || '--') + '\u20AC</p></div></div>';
                        if (status !== 'fully_paid') {
                            html += '<p class="text-sm font-bold opacity-70"><i class="fas fa-info-circle mr-2"></i>';
                            html += 'Il vous reste le solde de ' + (data.balance_amount || '--') + '\u20AC \u00E0 r\u00E9gler \u00E0 la fin de votre accompagnement pour acc\u00E9der \u00E0 vos livrables.</p>';
                        }
                        detEl.innerHTML = html;
                    }
                    if (actionEl) actionEl.innerHTML = '';
                } else {
                    // Acompte pas encore pay\u00E9
                    if (introMsg) introMsg.textContent = 'Pour d\u00E9marrer votre accompagnement, un acompte de 30% est requis.';
                    if (detEl) {
                        var html2 = '<div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">';
                        html2 += '<div class="flex justify-between items-center"><div>';
                        html2 += '<p class="text-2xl font-black uppercase">' + (data.product_name || 'Votre offre') + '</p>';
                        html2 += '<p class="font-bold opacity-70">Acompte requis (30%)</p></div>';
                        html2 += '<p class="text-4xl font-black">' + (data.deposit_amount || '--') + '\u20AC</p></div></div>';
                        html2 += '<p class="text-sm font-bold opacity-70"><i class="fas fa-info-circle mr-2"></i>';
                        html2 += 'Le solde de ' + (data.balance_amount || '--') + '\u20AC sera \u00E0 r\u00E9gler \u00E0 la fin de votre accompagnement.</p>';
                        detEl.innerHTML = html2;
                    }
                    if (actionEl) {
                        actionEl.innerHTML = '<button onclick="payDeposit()" class="neo-btn-yellow px-8 py-4 text-xl font-black uppercase mt-4">' +
                            '<i class="fas fa-credit-card mr-2"></i>Payer l\'acompte</button>';
                    }
                }
            }

            function displayBalanceDetails(data) {
                var introMsg = document.getElementById('balanceIntroMessage');
                if (introMsg) introMsg.textContent = 'R\u00E9glez le solde pour acc\u00E9der \u00E0 vos livrables finaux.';

                var detEl = document.getElementById('balanceDetails');
                if (!detEl) return;

                var html = '<div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">';
                html += '<div class="flex justify-between items-center"><div>';
                html += '<p class="text-2xl font-black uppercase">' + (data.product_name || 'Votre offre') + '</p>';
                html += '<p class="font-bold opacity-70">Solde restant (70%)</p></div>';
                html += '<p class="text-4xl font-black">' + (data.balance_amount || '--') + '\u20AC</p></div></div>';
                html += '<p class="text-sm font-bold opacity-70 mb-6"><i class="fas fa-info-circle mr-2"></i>';
                html += 'Une fois le solde r\u00E9gl\u00E9, vous aurez acc\u00E8s imm\u00E9diat \u00E0 tous vos livrables finaux.</p>';

                detEl.innerHTML = html;

                // Bouton payer le solde en comptant
                var optEl = document.getElementById('paymentOptions');
                if (optEl) {
                    var optHtml = '<div class="border-4 border-black p-6 hover:shadow-lg transition cursor-pointer" onclick="payBalance()">';
                    optHtml += '<div class="text-center">';
                    optHtml += '<i class="fas fa-money-bill-wave text-4xl text-[var(--genesis-yellow)] mb-4"></i>';
                    optHtml += '<h3 class="text-xl font-black uppercase mb-2">Paiement comptant</h3>';
                    optHtml += '<p class="text-3xl font-black mb-2">' + (data.balance_amount || '--') + '\u20AC</p>';
                    optHtml += '<p class="text-sm font-bold opacity-70">En une seule fois</p>';
                    optHtml += '<button class="mt-4 neo-btn-yellow px-6 py-3 text-sm w-full">Payer maintenant</button>';
                    optHtml += '</div></div>';
                    optEl.innerHTML = optHtml;
                }
            }

            function displayPaymentHistory(payments) {
                var el = document.getElementById('paymentHistory');
                if (!el) return;

                if (!payments || payments.length === 0) {
                    el.innerHTML = '<p class="font-bold opacity-50 text-center py-8">Aucun paiement enregistr\u00E9</p>';
                    return;
                }

                var html = '<div class="space-y-4">';
                for (var i = 0; i < payments.length; i++) {
                    var p = payments[i];
                    var dateStr = '';
                    try { dateStr = new Date(p.paid_at || p.date).toLocaleDateString('fr-FR'); } catch (e) { dateStr = p.paid_at || ''; }
                    var typeLabel = (p.type === 'deposit' || p.type === 'acompte') ? 'ACOMPTE' : 'SOLDE';
                    var typeIcon = (p.type === 'deposit' || p.type === 'acompte') ? 'fa-hand-holding-usd' : 'fa-check-circle';

                    html += '<div class="border-4 border-black p-4 bg-[var(--genesis-yellow)]">';
                    html += '<div class="flex justify-between items-center"><div>';
                    html += '<p class="font-black text-lg uppercase"><i class="fas ' + typeIcon + ' mr-2"></i>' + typeLabel + '</p>';
                    html += '<p class="text-sm font-bold opacity-70">' + dateStr + '</p>';
                    if (p.label) html += '<p class="text-xs font-bold opacity-50">' + p.label + '</p>';
                    html += '</div>';
                    html += '<p class="text-2xl font-black">' + (p.amount || 0) + '\u20AC</p>';
                    html += '</div></div>';
                }
                html += '</div>';
                el.innerHTML = html;
            }

            // ==================
            // PAY DEPOSIT
            // ==================
            window.payDeposit = function() {
                var depositBtn = document.querySelector('#depositAction button');
                if (depositBtn) {
                    depositBtn.disabled = true;
                    depositBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement en cours...';
                }

                var token = getToken();

                // D'abord verifier s'il y a deja une commande pendante
                fetch(PAY_API + '/api/payments/history', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(function(resp) { return resp.json(); })
                .then(function(histData) {
                    var existingOrderId = histData.order_id || null;

                    if (existingOrderId && !histData.deposit_paid) {
                        // Commande existante, pas encore payee - utiliser cette commande
                        console.log('[PAYMENT] Commande existante trouvee:', existingOrderId);
                        return createCheckoutForDeposit(existingOrderId);
                    }

                    // Pas de commande existante ou deja payee - creer une nouvelle
                    console.log('[PAYMENT] Creation nouvelle commande pour acompte...');
                    var user = currentUser;
                    var offerId = user.activeOfferId || user.active_offer_id || user.offre || '';

                    return fetch(PAY_API + '/api/orders/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productId: offerId,
                            clientInfo: {
                                firstName: user.prenom || user.firstName || '',
                                lastName: user.nom || user.lastName || '',
                                email: user.email || '',
                                phone: user.telephone || user.phone || '',
                                address: user.adresse || user.address || 'Non renseigne',
                                country: 'FRANCE',
                                city: user.ville || user.city || 'Non renseigne',
                                postalCode: user.codePostal || user.postalCode || '00000',
                                clientType: 'particulier'
                            }
                        })
                    })
                    .then(function(resp) {
                        if (!resp.ok) return resp.json().then(function(d) { throw new Error(d.error || 'Erreur creation commande'); });
                        return resp.json();
                    })
                    .then(function(orderData) {
                        console.log('[PAYMENT] Commande creee:', orderData.orderId);
                        return createCheckoutForDeposit(orderData.orderId);
                    });
                })
                .catch(function(err) {
                    console.error('[PAYMENT] Erreur payDeposit:', err);
                    if (depositBtn) {
                        depositBtn.disabled = false;
                        depositBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Payer l\'acompte';
                    }
                    alert('Erreur lors de la pr\u00E9paration du paiement :\n\n' + err.message);
                });
            };

            function createCheckoutForDeposit(orderId) {
                var depositBtn = document.querySelector('#depositAction button');
                return fetch(PAY_API + '/api/payments/sumup/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId, stage: 'deposit' })
                })
                .then(function(resp) {
                    if (!resp.ok) return resp.json().then(function(d) { throw new Error(d.error || d.details || 'Erreur creation checkout'); });
                    return resp.json();
                })
                .then(function(checkoutData) {
                    console.log('[PAYMENT] Checkout SumUp cree:', checkoutData);
                    if (depositBtn) {
                        depositBtn.disabled = false;
                        depositBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Payer l\'acompte';
                    }
                    if (checkoutData.checkout_id) {
                        showSumUpWidget(checkoutData.checkout_id, checkoutData.amount, orderId, 'deposit');
                    } else {
                        throw new Error('ID de checkout non recu');
                    }
                });
            }

            // ==================
            // PAY BALANCE
            // ==================
            // Store backend data for payBalance to use
            var _backendOrderId = null;

            window.payBalance = function() {
                var token = getToken();

                // Fetch the order_id from backend
                fetch(PAY_API + '/api/payments/history', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(function(resp) { return resp.json(); })
                .then(function(data) {
                    var orderId = data.order_id || _backendOrderId;
                    if (!orderId) {
                        throw new Error('Aucune commande trouvee pour le paiement du solde.');
                    }
                    if (!data.can_pay_balance) {
                        throw new Error('Le paiement du solde n\'est pas encore disponible.');
                    }
                    console.log('[PAYMENT] Paiement du solde pour commande:', orderId);

                    return fetch(PAY_API + '/api/payments/sumup/create-checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId: orderId, stage: 'balance' })
                    })
                    .then(function(resp) {
                        if (!resp.ok) return resp.json().then(function(d) { throw new Error(d.error || d.details || 'Erreur creation checkout'); });
                        return resp.json();
                    })
                    .then(function(checkoutData) {
                        console.log('[PAYMENT] Checkout SumUp cree pour solde:', checkoutData);
                        if (checkoutData.checkout_id) {
                            showSumUpWidget(checkoutData.checkout_id, checkoutData.amount, orderId, 'balance');
                        } else {
                            throw new Error('ID de checkout non recu');
                        }
                    });
                })
                .catch(function(err) {
                    console.error('[PAYMENT] Erreur payBalance:', err);
                    alert('Erreur lors de la pr\u00E9paration du paiement du solde :\n\n' + err.message);
                });
            };

            // Charger le statut au chargement de la page
            loadPaymentStatus();

        } catch (globalErr) {
            console.error('[PAYMENT PAGE] Erreur globale:', globalErr);
            var errMsg = document.getElementById('statusMessage');
            if (errMsg) errMsg.textContent = 'Erreur de chargement. Veuillez rafra\u00EEchir la page.';
            var summaryEl = document.getElementById('statusSummary');
            if (summaryEl) summaryEl.innerHTML = '<p class="text-center font-bold text-red-400 py-8">Une erreur est survenue. Veuillez rafra\u00EEchir la page ou contacter le support.</p>';
        }
    })();
    </script>
    <div id="site-footer"></div>
    <script src="footer.js" defer></script>
    <script src="chatbot.js" defer></script>
</body>
</html>
