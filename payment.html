<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement - FA GENESIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap');

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
        }

        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .payment-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .status-registered { background: #ff6b6b; }
        .status-deposit { background: #51cf66; }
        .status-pending { background: #ffd43b; }
        .status-fully { background: #4dabf7; }
    </style>
</head>
<body>
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-6 py-4 flex justify-between items-center">
        <a href="dashboard.html" class="text-2xl font-black tracking-wider text-[var(--genesis-yellow)]">FA GENESIS</a>
        <a href="dashboard.html" class="text-white font-black hover:text-[var(--genesis-yellow)]">
            <i class="fas fa-arrow-left mr-2"></i>Retour au Dashboard
        </a>
    </nav>

    <section class="min-h-screen pt-32 pb-20 px-6">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-5xl md:text-6xl font-black italic uppercase text-center mb-4 text-[var(--genesis-yellow)]">
                PAIEMENT
            </h1>
            <p class="text-center text-xl font-bold mb-12 uppercase" id="statusMessage"></p>

            <!-- R√©sum√© du statut -->
            <div id="statusSummary" class="payment-card neo-shadow mb-8"></div>

            <!-- Section Acompte -->
            <div id="depositSection" class="payment-card neo-shadow" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-4">
                    <i class="fas fa-hand-holding-usd text-[var(--genesis-yellow)] mr-3"></i>
                    ACOMPTE - 30%
                </h2>
                <p id="depositIntroMessage" class="font-bold mb-6"></p>
                <div id="depositDetails" class="mb-6"></div>
                <button onclick="payDeposit()" class="neo-btn-yellow px-8 py-4 text-xl font-black uppercase">
                    <i class="fas fa-credit-card mr-2"></i>Payer l'acompte
                </button>
            </div>

            <!-- Section Solde -->
            <div id="balanceSection" class="payment-card neo-shadow" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-4">
                    <i class="fas fa-check-circle text-[var(--genesis-yellow)] mr-3"></i>
                    SOLDE - 70%
                </h2>
                <p class="font-bold mb-6">Votre accompagnement est termin√©. Choisissez votre mode de paiement du solde.</p>
                <div id="balanceDetails" class="mb-6"></div>

                <!-- Options de paiement -->
                <div class="grid md:grid-cols-2 gap-6 mb-6" id="paymentOptions">
                    <!-- Options g√©n√©r√©es dynamiquement -->
                </div>

                <!-- Section paiement √©chelonn√© -->
                <div id="installmentSection" style="display: none;">
                    <h3 class="text-2xl font-black italic uppercase mb-4">
                        <i class="fas fa-calendar-alt mr-2"></i>VOS MENSUALIT√âS
                    </h3>
                    <div id="installmentsList"></div>
                </div>
            </div>

            <!-- Historique des paiements -->
            <div class="payment-card neo-shadow">
                <h2 class="text-3xl font-black italic uppercase mb-6">
                    <i class="fas fa-history text-[var(--genesis-yellow)] mr-3"></i>
                    HISTORIQUE DES PAIEMENTS
                </h2>
                <div id="paymentHistory"></div>
            </div>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="auth.js"></script>
    <script src="offers-config.js"></script>
    <script src="payment-system.js"></script>
    <script>
        AOS.init({ duration: 1000 });

        // Protection de la page
        requireAuth();

        const user = getCurrentUser();
        if (!user) {
            window.location.href = 'login.html';
        }

        // Charger et afficher le statut de paiement
        function loadPaymentStatus() {
            const summary = getPaymentSummary(user.email);

            if (!summary) {
                document.getElementById('statusMessage').textContent = 'Erreur de chargement';
                return;
            }

            // Afficher le message de statut
            document.getElementById('statusMessage').textContent = summary.accessRights.message;

            // Afficher le r√©sum√© du statut
            displayStatusSummary(summary);

            // Afficher les sections appropri√©es
            if (summary.status === 'registered' && summary.activeOffer) {
                document.getElementById('depositSection').style.display = 'block';
                displayDepositDetails(summary.activeOffer);
            }

            if (summary.status === 'delivery_pending_payment' && summary.activeOffer) {
                document.getElementById('balanceSection').style.display = 'block';
                displayBalanceDetails(summary.activeOffer);
            }

            // Afficher l'historique des paiements
            displayPaymentHistory(summary.payments);
        }

        function displayStatusSummary(summary) {
            const statusClass = {
                'registered': 'status-registered',
                'deposit_paid': 'status-deposit',
                'delivery_pending_payment': 'status-pending',
                'fully_paid': 'status-fully'
            }[summary.status] || 'status-registered';

            let html = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h3 class="text-2xl font-black italic uppercase mb-2">VOTRE STATUT</h3>
                        <span class="status-badge ${statusClass}">${summary.statusLabel}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold opacity-70 uppercase">Total pay√©</p>
                        <p class="text-3xl font-black text-[var(--genesis-yellow)]">${summary.totalPaid}‚Ç¨</p>
                    </div>
                </div>
            `;

            if (summary.activeOffer) {
                html += `
                    <div class="border-t-4 border-black pt-6">
                        <h4 class="text-xl font-black uppercase mb-3">OFFRE ACTIVE</h4>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm font-bold opacity-70 uppercase">Formule</p>
                                <p class="font-black text-lg">${summary.activeOffer.nom}</p>
                            </div>
                            <div>
                                <p class="text-sm font-bold opacity-70 uppercase">Prix total</p>
                                <p class="font-black text-lg">${summary.activeOffer.prixTotal}‚Ç¨</p>
                            </div>
                            <div>
                                <p class="text-sm font-bold opacity-70 uppercase">Dur√©e</p>
                                <p class="font-black text-lg">${summary.activeOffer.duree}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('statusSummary').innerHTML = html;
        }

        function displayDepositDetails(offer) {
            // Adapter le message selon le type de produit
            const productType = offer.productType || 'accompagnement';

            let introMessage = '';
            let balanceMessage = '';

            if (productType === 'accompagnement') {
                introMessage = 'Pour d√©marrer votre accompagnement, un acompte de 30% est requis.';
                balanceMessage = `Le solde de ${offer.solde}‚Ç¨ sera √† r√©gler √† la fin de votre accompagnement.`;
            } else {
                introMessage = 'Pour confirmer votre commande et lancer votre prestation, un acompte de 30% est requis.';
                balanceMessage = `Le solde de ${offer.solde}‚Ç¨ sera √† r√©gler une fois votre prestation termin√©e.`;
            }

            // Afficher le message d'intro
            document.getElementById('depositIntroMessage').textContent = introMessage;

            const html = `
                <div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-black uppercase">${offer.nom}</p>
                            <p class="font-bold opacity-70">Acompte requis (30%)</p>
                        </div>
                        <p class="text-4xl font-black">${offer.acompte}‚Ç¨</p>
                    </div>
                </div>
                <p class="text-sm font-bold opacity-70">
                    <i class="fas fa-info-circle mr-2"></i>
                    ${balanceMessage}
                </p>
            `;
            document.getElementById('depositDetails').innerHTML = html;
        }

        function displayBalanceDetails(offer) {
            const html = `
                <div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-black uppercase">${offer.nom}</p>
                            <p class="font-bold opacity-70">Solde restant (70%)</p>
                        </div>
                        <p class="text-4xl font-black">${offer.solde}‚Ç¨</p>
                    </div>
                </div>
                <p class="text-sm font-bold opacity-70 mb-6">
                    <i class="fas fa-info-circle mr-2"></i>
                    Une fois le solde r√©gl√©, vous aurez acc√®s imm√©diat √† tous vos livrables finaux.
                </p>
            `;
            document.getElementById('balanceDetails').innerHTML = html;

            // Afficher les options de paiement
            displayPaymentOptions(offer);
        }

        function displayPaymentOptions(offer) {
            const plan = calculateInstallmentPlan(user.activeOfferId);

            let optionsHTML = `
                <!-- Option 1: Paiement comptant -->
                <div class="border-4 border-black p-6 hover:shadow-lg transition cursor-pointer" onclick="selectPaymentOption('full')">
                    <div class="text-center">
                        <i class="fas fa-money-bill-wave text-4xl text-[var(--genesis-yellow)] mb-4"></i>
                        <h3 class="text-xl font-black uppercase mb-2">Paiement comptant</h3>
                        <p class="text-3xl font-black mb-2">${offer.solde}‚Ç¨</p>
                        <p class="text-sm font-bold opacity-70">En une seule fois</p>
                        <button class="mt-4 neo-btn-yellow px-6 py-3 text-sm w-full">
                            Payer maintenant
                        </button>
                    </div>
                </div>

                <!-- Option 2: Paiement √©chelonn√© -->
                <div class="border-4 border-black p-6 hover:shadow-lg transition cursor-pointer" style="background: #e8f5e9;" onclick="selectPaymentOption('installments')">
                    <div class="text-center">
                        <i class="fas fa-calendar-alt text-4xl text-[#51cf66] mb-4"></i>
                        <h3 class="text-xl font-black uppercase mb-2">Paiement √©chelonn√©</h3>
                        <p class="text-3xl font-black mb-2">${plan.monthlyAmount}‚Ç¨<span class="text-base">/mois</span></p>
                        <p class="text-sm font-bold opacity-70">Sur ${plan.numberOfInstallments} mois</p>
                        <button class="mt-4 bg-[#51cf66] text-black border-4 border-black px-6 py-3 text-sm font-black uppercase w-full">
                            Choisir ce mode
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('paymentOptions').innerHTML = optionsHTML;

            // V√©rifier si un plan existe d√©j√†
            const existingPlan = getInstallmentPlan(user.email);
            if (existingPlan) {
                displayInstallments(existingPlan);
            }
        }

        function selectPaymentOption(option) {
            if (option === 'full') {
                payBalance();
            } else if (option === 'installments') {
                initializePaymentPlan();
            }
        }

        function initializePaymentPlan() {
            if (confirm(`Confirmer le paiement √©chelonn√© ?\n\nVous allez payer le solde en plusieurs mensualit√©s selon la dur√©e de votre accompagnement.\n\nCela vous permettra de mieux g√©rer votre budget.`)) {
                const success = initializeInstallmentPlan(user.email);

                if (success) {
                    alert('‚úÖ Plan de paiement √©chelonn√© activ√© !\n\nVous pouvez maintenant payer vos mensualit√©s.');

                    // Recharger l'utilisateur
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const updatedUser = users.find(u => u.email === user.email);
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));

                    // Afficher les mensualit√©s
                    const plan = getInstallmentPlan(user.email);
                    displayInstallments(plan);
                } else {
                    alert('‚ùå Erreur lors de l\'activation du plan de paiement');
                }
            }
        }

        function displayInstallments(plan) {
            document.getElementById('installmentSection').style.display = 'block';

            let html = '';
            plan.installments.forEach(installment => {
                const isPaid = installment.status === 'paid';
                const isCurrent = !isPaid && !plan.installments.slice(0, installment.number - 1).some(i => i.status === 'pending');

                html += `
                    <div class="border-4 border-black p-4 mb-4 ${isPaid ? 'bg-[#e8f5e9]' : isCurrent ? 'bg-[#fff9c4]' : 'bg-white'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg uppercase">
                                    <i class="fas ${isPaid ? 'fa-check-circle text-[#51cf66]' : 'fa-circle'} mr-2"></i>
                                    Mensualit√© ${installment.number} / ${plan.numberOfInstallments}
                                </p>
                                <p class="text-sm font-bold opacity-70">${installment.dueDate}</p>
                                ${isPaid ? `<p class="text-xs font-bold text-[#51cf66] mt-1">Pay√©e le ${new Date(installment.paidDate).toLocaleDateString('fr-FR')}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-black">${installment.amount}‚Ç¨</p>
                                ${!isPaid && isCurrent ?
                                    `<button onclick="payInstallment(${installment.number})" class="mt-2 bg-black text-white px-4 py-2 text-sm font-black uppercase border-2 border-black hover:bg-[var(--genesis-yellow)] hover:text-black transition">
                                        Payer maintenant
                                    </button>` :
                                    isPaid ? '<span class="text-[#51cf66] font-black text-sm">‚úì PAY√âE</span>' :
                                    '<span class="opacity-50 font-black text-sm">EN ATTENTE</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('installmentsList').innerHTML = html;
        }

        function payInstallment(installmentNumber) {
            if (confirm(`Confirmer le paiement de la mensualit√© ${installmentNumber} ?`)) {
                const payment = recordInstallmentPayment(user.email, installmentNumber);

                if (payment) {
                    // Mettre √† jour l'utilisateur connect√©
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const updatedUser = users.find(u => u.email === user.email);
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));

                    const plan = getInstallmentPlan(user.email);
                    const allPaid = plan.installments.every(i => i.status === 'paid');

                    if (allPaid) {
                        alert(`‚úÖ Mensualit√© ${installmentNumber} pay√©e : ${payment.amount}‚Ç¨\n\nüéâ Toutes les mensualit√©s sont pay√©es !\nVous avez maintenant acc√®s √† tous vos livrables finaux !\n\nRedirection vers vos livrables...`);
                        setTimeout(() => {
                            window.location.href = 'livrables.html';
                        }, 500);
                    } else {
                        alert(`‚úÖ Mensualit√© ${installmentNumber} pay√©e : ${payment.amount}‚Ç¨\n\nIl vous reste ${plan.installments.filter(i => i.status === 'pending').length} mensualit√©(s) √† payer.`);
                        location.reload();
                    }
                } else {
                    alert('‚ùå Erreur lors du paiement');
                }
            }
        }

        function displayPaymentHistory(payments) {
            if (!payments || payments.length === 0) {
                document.getElementById('paymentHistory').innerHTML = `
                    <p class="font-bold opacity-50 text-center py-8">Aucun paiement enregistr√©</p>
                `;
                return;
            }

            let html = '<div class="space-y-4">';
            payments.forEach(payment => {
                const date = new Date(payment.date).toLocaleDateString('fr-FR');
                const typeLabel = payment.type === 'acompte' ? 'ACOMPTE' : 'SOLDE';
                const typeIcon = payment.type === 'acompte' ? 'fa-hand-holding-usd' : 'fa-check-circle';

                html += `
                    <div class="border-4 border-black p-4 bg-[var(--genesis-yellow)]">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg uppercase">
                                    <i class="fas ${typeIcon} mr-2"></i>${typeLabel}
                                </p>
                                <p class="text-sm font-bold opacity-70">${date}</p>
                            </div>
                            <p class="text-2xl font-black">${payment.amount}‚Ç¨</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('paymentHistory').innerHTML = html;
        }

        function payDeposit() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentUser = users.find(u => u.email === user.email);

            if (!currentUser || !currentUser.activeOfferId) {
                alert('Erreur: Aucune offre active trouv√©e');
                return;
            }

            if (confirm('Confirmer le paiement de l\'acompte (30%) ?\n\nApr√®s paiement, vous serez redirig√© vers votre espace client.')) {
                const payment = simulateDepositPayment(user.email, currentUser.activeOfferId);

                if (payment) {
                    // Mettre √† jour l'utilisateur connect√©
                    const updatedUser = users.find(u => u.email === user.email);
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));

                    alert(`‚úÖ Paiement de l'acompte confirm√© : ${payment.amount}‚Ç¨\n\nüéâ Votre accompagnement peut maintenant d√©marrer !\n\nRedirection vers votre espace client...`);

                    // Redirection vers le dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);
                } else {
                    alert('‚ùå Erreur lors du paiement');
                }
            }
        }

        function payBalance() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentUser = users.find(u => u.email === user.email);

            if (!currentUser || !currentUser.activeOfferId) {
                alert('Erreur: Aucune offre active trouv√©e');
                return;
            }

            if (confirm('Confirmer le paiement du solde (70%) ?\n\nVos livrables seront imm√©diatement accessibles.')) {
                const payment = simulateBalancePayment(user.email, currentUser.activeOfferId);

                if (payment) {
                    // Mettre √† jour l'utilisateur connect√©
                    const updatedUser = users.find(u => u.email === user.email);
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));

                    alert(`‚úÖ Paiement du solde confirm√© : ${payment.amount}‚Ç¨\n\nüéâ Vous avez maintenant acc√®s √† tous vos livrables !\n\nRedirection vers vos livrables...`);

                    // Redirection vers les livrables
                    setTimeout(() => {
                        window.location.href = 'livrables.html';
                    }, 500);
                } else {
                    alert('‚ùå Erreur lors du paiement');
                }
            }
        }

        // Charger le statut au chargement de la page
        loadPaymentStatus();
    </script>
</body>
</html>
