<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement - FA GENESIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap');

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
        }

        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .payment-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .status-registered { background: #ff6b6b; }
        .status-deposit { background: #51cf66; }
        .status-pending { background: #ffd43b; }
        .status-fully { background: #4dabf7; }

        /* SumUp Payment Modal */
        .sumup-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .sumup-modal-overlay.active {
            display: flex;
        }
        .sumup-modal-content {
            background: white;
            color: black;
            border: 4px solid black;
            box-shadow: 10px 10px 0px var(--genesis-yellow);
            max-width: 500px;
            width: 90%;
            padding: 2rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .sumup-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 900;
            color: black;
        }
        .sumup-modal-close:hover {
            color: #ff6b6b;
        }
        .sumup-modal-amount {
            background: var(--genesis-yellow);
            border: 3px solid black;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-6 py-4 flex justify-between items-center">
        <a href="dashboard.html" class="text-2xl font-black tracking-wider text-[var(--genesis-yellow)]">FA GENESIS</a>
        <a href="dashboard.html" class="text-white font-black hover:text-[var(--genesis-yellow)]">
            <i class="fas fa-arrow-left mr-2"></i>Retour au Dashboard
        </a>
    </nav>

    <section class="min-h-screen pt-32 pb-20 px-6">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-5xl md:text-6xl font-black italic uppercase text-center mb-4 text-[var(--genesis-yellow)]">
                PAIEMENT
            </h1>
            <p class="text-center text-xl font-bold mb-12 uppercase" id="statusMessage"></p>

            <!-- Résumé du statut -->
            <div id="statusSummary" class="payment-card neo-shadow mb-8"></div>

            <!-- Section Acompte -->
            <div id="depositSection" class="payment-card neo-shadow" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-4">
                    <i class="fas fa-hand-holding-usd text-[var(--genesis-yellow)] mr-3"></i>
                    ACOMPTE - 30%
                </h2>
                <p id="depositIntroMessage" class="font-bold mb-6"></p>
                <div id="depositDetails" class="mb-6"></div>
                <button onclick="payDeposit()" class="neo-btn-yellow px-8 py-4 text-xl font-black uppercase">
                    <i class="fas fa-credit-card mr-2"></i>Payer l'acompte
                </button>
            </div>

            <!-- Section Solde -->
            <div id="balanceSection" class="payment-card neo-shadow" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-4">
                    <i class="fas fa-check-circle text-[var(--genesis-yellow)] mr-3"></i>
                    SOLDE - 70%
                </h2>
                <p class="font-bold mb-6">Votre accompagnement est terminé. Choisissez votre mode de paiement du solde.</p>
                <div id="balanceDetails" class="mb-6"></div>

                <!-- Options de paiement -->
                <div class="grid md:grid-cols-2 gap-6 mb-6" id="paymentOptions">
                    <!-- Options générées dynamiquement -->
                </div>

                <!-- Section paiement échelonné -->
                <div id="installmentSection" style="display: none;">
                    <h3 class="text-2xl font-black italic uppercase mb-4">
                        <i class="fas fa-calendar-alt mr-2"></i>VOS MENSUALITÉS
                    </h3>
                    <div id="installmentsList"></div>
                </div>
            </div>

            <!-- Historique des paiements -->
            <div class="payment-card neo-shadow">
                <h2 class="text-3xl font-black italic uppercase mb-6">
                    <i class="fas fa-history text-[var(--genesis-yellow)] mr-3"></i>
                    HISTORIQUE DES PAIEMENTS
                </h2>
                <div id="paymentHistory"></div>
            </div>
        </div>
    </section>

    <!-- SumUp Payment Modal -->
    <div id="sumupModal" class="sumup-modal-overlay">
        <div class="sumup-modal-content">
            <button onclick="closeSumUpModal()" class="sumup-modal-close">&times;</button>
            <h3 style="font-family: 'Unbounded', cursive; font-size: 1.25rem; font-weight: 900; text-transform: uppercase; margin-bottom: 1rem;">
                <i class="fas fa-lock" style="color: var(--genesis-yellow); margin-right: 8px;"></i>Paiement Sécurisé
            </h3>
            <div class="sumup-modal-amount">
                <p style="font-size: 0.875rem; font-weight: 700; opacity: 0.7; text-transform: uppercase;">Montant à payer</p>
                <p id="sumupModalAmount" style="font-size: 2rem; font-weight: 900;"></p>
            </div>
            <div id="sumup-card"></div>
            <p style="text-align: center; font-size: 0.75rem; margin-top: 1rem; opacity: 0.6;">
                <i class="fas fa-shield-alt"></i> Paiement sécurisé par SumUp
            </p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="offers-config.js"></script>
    <script src="payment-system.js"></script>
    <script>
        AOS.init({ duration: 1000 });

        // API_BASE_URL est défini dans auth.js (chargé avant ce script)

        // === SumUp Card Widget ===
        function showSumUpWidget(checkoutId, amount, orderId, stage, installmentNumber) {
            const modal = document.getElementById('sumupModal');
            modal.classList.add('active');
            document.getElementById('sumupModalAmount').textContent = amount + '€';

            // Vider le container précédent
            document.getElementById('sumup-card').innerHTML = '';

            // Monter le widget SumUp
            SumUpCard.mount({
                id: 'sumup-card',
                checkoutId: checkoutId,
                locale: 'fr-FR',
                onResponse: function(type, body) {
                    console.log('[SUMUP WIDGET] Response:', type, body);

                    if (type === 'success') {
                        closeSumUpModal();
                        let successUrl = 'payment-success.html?order=' + orderId + '&stage=' + stage;
                        if (installmentNumber) {
                            successUrl += '&installment=' + installmentNumber;
                        }
                        window.location.href = successUrl;
                    } else if (type === 'error') {
                        console.error('[SUMUP WIDGET] Erreur:', body);
                        closeSumUpModal();
                        alert('Le paiement a échoué.\n\nRaison: ' + (body.message || body.error_message || 'Erreur inconnue') + '\n\nVeuillez réessayer.');
                    }
                }
            });
        }

        function closeSumUpModal() {
            const modal = document.getElementById('sumupModal');
            modal.classList.remove('active');
            document.getElementById('sumup-card').innerHTML = '';
        }

        // Protection de la page
        requireAuth();

        const user = getCurrentUser();
        if (!user) {
            window.location.href = 'login.html';
        }

        // Charger et afficher le statut de paiement
        function loadPaymentStatus() {
            console.log('[PAYMENT PAGE] Chargement du statut de paiement...');
            console.log('[PAYMENT PAGE] User object:', JSON.stringify(user));

            let summary = null;

            try {
                summary = getPaymentSummary(user.email);
                console.log('[PAYMENT PAGE] Summary from getPaymentSummary:', summary);
            } catch (e) {
                console.error('[PAYMENT PAGE] Erreur getPaymentSummary:', e);
            }

            // Fallback: construire le summary directement depuis l'objet user
            if (!summary) {
                console.log('[PAYMENT PAGE] Fallback: construction du summary depuis user object');
                const offerId = user.activeOfferId || user.active_offer_id || user.offre;
                console.log('[PAYMENT PAGE] offerId trouvé:', offerId);
                const activeOffer = offerId ? getOfferById(offerId) : null;
                console.log('[PAYMENT PAGE] activeOffer:', activeOffer);
                const status = user.paymentStatus || user.payment_status || 'registered';

                summary = {
                    status: status,
                    statusLabel: getStatusLabel(status),
                    activeOffer: activeOffer,
                    totalPaid: (user.payments || []).reduce(function(sum, p) { return sum + (p.amount || 0); }, 0),
                    payments: user.payments || [],
                    accessRights: { message: status === 'registered' ? 'Un acompte de 30% est requis pour démarrer.' : 'Bienvenue dans votre espace paiement.' }
                };
            }

            if (!summary) {
                document.getElementById('statusMessage').textContent = 'Erreur de chargement';
                return;
            }

            // Afficher le message de statut
            document.getElementById('statusMessage').textContent = summary.accessRights.message;

            // Afficher le résumé du statut
            displayStatusSummary(summary);

            // Afficher les sections appropriées
            if (summary.status === 'registered' && summary.activeOffer) {
                document.getElementById('depositSection').style.display = 'block';
                displayDepositDetails(summary.activeOffer);
            }

            if (summary.status === 'delivery_pending_payment' && summary.activeOffer) {
                document.getElementById('balanceSection').style.display = 'block';
                displayBalanceDetails(summary.activeOffer);
            }

            // Si registered mais pas d'offre active, afficher un message
            if (summary.status === 'registered' && !summary.activeOffer) {
                const offerId = user.activeOfferId || user.active_offer_id || user.offre;
                if (offerId) {
                    // L'offre existe dans la session mais n'est pas trouvée dans offers-config
                    document.getElementById('statusMessage').textContent = 'Offre non reconnue. Veuillez vous réinscrire ou contacter le support.';
                } else {
                    document.getElementById('statusMessage').textContent = 'Aucune offre sélectionnée. Veuillez choisir une offre.';
                }
            }

            // Afficher l'historique des paiements
            displayPaymentHistory(summary.payments);
        }

        function displayStatusSummary(summary) {
            const statusClass = {
                'registered': 'status-registered',
                'deposit_paid': 'status-deposit',
                'delivery_pending_payment': 'status-pending',
                'fully_paid': 'status-fully'
            }[summary.status] || 'status-registered';

            let html = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h3 class="text-2xl font-black italic uppercase mb-2">VOTRE STATUT</h3>
                        <span class="status-badge ${statusClass}">${summary.statusLabel}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold opacity-70 uppercase">Total payé</p>
                        <p class="text-3xl font-black text-[var(--genesis-yellow)]">${summary.totalPaid}€</p>
                    </div>
                </div>
            `;

            if (summary.activeOffer) {
                html += `
                    <div class="border-t-4 border-black pt-6">
                        <h4 class="text-xl font-black uppercase mb-3">OFFRE ACTIVE</h4>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm font-bold opacity-70 uppercase">Formule</p>
                                <p class="font-black text-lg">${summary.activeOffer.nom}</p>
                            </div>
                            <div>
                                <p class="text-sm font-bold opacity-70 uppercase">Prix total</p>
                                <p class="font-black text-lg">${summary.activeOffer.prixTotal}€</p>
                            </div>
                            <div>
                                <p class="text-sm font-bold opacity-70 uppercase">Durée</p>
                                <p class="font-black text-lg">${summary.activeOffer.duree}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('statusSummary').innerHTML = html;
        }

        function displayDepositDetails(offer) {
            // Adapter le message selon le type de produit
            const productType = offer.productType || 'accompagnement';

            let introMessage = '';
            let balanceMessage = '';

            if (productType === 'accompagnement') {
                introMessage = 'Pour démarrer votre accompagnement, un acompte de 30% est requis.';
                balanceMessage = `Le solde de ${offer.solde}€ sera à régler à la fin de votre accompagnement.`;
            } else {
                introMessage = 'Pour confirmer votre commande et lancer votre prestation, un acompte de 30% est requis.';
                balanceMessage = `Le solde de ${offer.solde}€ sera à régler une fois votre prestation terminée.`;
            }

            // Afficher le message d'intro
            document.getElementById('depositIntroMessage').textContent = introMessage;

            const html = `
                <div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-black uppercase">${offer.nom}</p>
                            <p class="font-bold opacity-70">Acompte requis (30%)</p>
                        </div>
                        <p class="text-4xl font-black">${offer.acompte}€</p>
                    </div>
                </div>
                <p class="text-sm font-bold opacity-70">
                    <i class="fas fa-info-circle mr-2"></i>
                    ${balanceMessage}
                </p>
            `;
            document.getElementById('depositDetails').innerHTML = html;
        }

        function displayBalanceDetails(offer) {
            const html = `
                <div class="bg-[var(--genesis-yellow)] p-6 border-4 border-black mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-black uppercase">${offer.nom}</p>
                            <p class="font-bold opacity-70">Solde restant (70%)</p>
                        </div>
                        <p class="text-4xl font-black">${offer.solde}€</p>
                    </div>
                </div>
                <p class="text-sm font-bold opacity-70 mb-6">
                    <i class="fas fa-info-circle mr-2"></i>
                    Une fois le solde réglé, vous aurez accès immédiat à tous vos livrables finaux.
                </p>
            `;
            document.getElementById('balanceDetails').innerHTML = html;

            // Afficher les options de paiement
            displayPaymentOptions(offer);
        }

        function displayPaymentOptions(offer) {
            const plan = calculateInstallmentPlan(user.activeOfferId);

            let optionsHTML = `
                <!-- Option 1: Paiement comptant -->
                <div class="border-4 border-black p-6 hover:shadow-lg transition cursor-pointer" onclick="selectPaymentOption('full')">
                    <div class="text-center">
                        <i class="fas fa-money-bill-wave text-4xl text-[var(--genesis-yellow)] mb-4"></i>
                        <h3 class="text-xl font-black uppercase mb-2">Paiement comptant</h3>
                        <p class="text-3xl font-black mb-2">${offer.solde}€</p>
                        <p class="text-sm font-bold opacity-70">En une seule fois</p>
                        <button class="mt-4 neo-btn-yellow px-6 py-3 text-sm w-full">
                            Payer maintenant
                        </button>
                    </div>
                </div>

                <!-- Option 2: Paiement échelonné -->
                <div class="border-4 border-black p-6 hover:shadow-lg transition cursor-pointer" style="background: #e8f5e9;" onclick="selectPaymentOption('installments')">
                    <div class="text-center">
                        <i class="fas fa-calendar-alt text-4xl text-[#51cf66] mb-4"></i>
                        <h3 class="text-xl font-black uppercase mb-2">Paiement échelonné</h3>
                        <p class="text-3xl font-black mb-2">${plan.monthlyAmount}€<span class="text-base">/mois</span></p>
                        <p class="text-sm font-bold opacity-70">Sur ${plan.numberOfInstallments} mois</p>
                        <button class="mt-4 bg-[#51cf66] text-black border-4 border-black px-6 py-3 text-sm font-black uppercase w-full">
                            Choisir ce mode
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('paymentOptions').innerHTML = optionsHTML;

            // Vérifier si un plan existe déjà
            const existingPlan = getInstallmentPlan(user.email);
            if (existingPlan) {
                displayInstallments(existingPlan);
            }
        }

        async function selectPaymentOption(option) {
            if (option === 'full') {
                await payBalance();
            } else if (option === 'installments') {
                initializePaymentPlan();
            }
        }

        function initializePaymentPlan() {
            if (confirm(`Confirmer le paiement échelonné ?\n\nVous allez payer le solde en plusieurs mensualités selon la durée de votre accompagnement.\n\nCela vous permettra de mieux gérer votre budget.`)) {
                const success = initializeInstallmentPlan(user.email);

                if (success) {
                    alert('✅ Plan de paiement échelonné activé !\n\nVous pouvez maintenant payer vos mensualités.');

                    // Recharger l'utilisateur
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const updatedUser = users.find(u => u.email === user.email);
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));

                    // Afficher les mensualités
                    const plan = getInstallmentPlan(user.email);
                    displayInstallments(plan);
                } else {
                    alert('❌ Erreur lors de l\'activation du plan de paiement');
                }
            }
        }

        function displayInstallments(plan) {
            document.getElementById('installmentSection').style.display = 'block';

            let html = '';
            plan.installments.forEach(installment => {
                const isPaid = installment.status === 'paid';
                const isCurrent = !isPaid && !plan.installments.slice(0, installment.number - 1).some(i => i.status === 'pending');

                html += `
                    <div class="border-4 border-black p-4 mb-4 ${isPaid ? 'bg-[#e8f5e9]' : isCurrent ? 'bg-[#fff9c4]' : 'bg-white'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg uppercase">
                                    <i class="fas ${isPaid ? 'fa-check-circle text-[#51cf66]' : 'fa-circle'} mr-2"></i>
                                    Mensualité ${installment.number} / ${plan.numberOfInstallments}
                                </p>
                                <p class="text-sm font-bold opacity-70">${installment.dueDate}</p>
                                ${isPaid ? `<p class="text-xs font-bold text-[#51cf66] mt-1">Payée le ${new Date(installment.paidDate).toLocaleDateString('fr-FR')}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-black">${installment.amount}€</p>
                                ${!isPaid && isCurrent ?
                                    `<button onclick="payInstallment(${installment.number})" class="mt-2 bg-black text-white px-4 py-2 text-sm font-black uppercase border-2 border-black hover:bg-[var(--genesis-yellow)] hover:text-black transition">
                                        Payer maintenant
                                    </button>` :
                                    isPaid ? '<span class="text-[#51cf66] font-black text-sm">✓ PAYÉE</span>' :
                                    '<span class="opacity-50 font-black text-sm">EN ATTENTE</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('installmentsList').innerHTML = html;
        }

        async function payInstallment(installmentNumber) {
            // Utiliser la session backend ou l'ancien système
            const currentUser = getUserFromStorage(user.email);

            // Chercher l'offre active
            const offerId = currentUser ? (currentUser.activeOfferId || currentUser.active_offer_id || currentUser.offre) : null;

            if (!currentUser || !offerId) {
                alert('Erreur: Aucune offre active trouvée');
                return;
            }

            // Récupérer le plan de paiement pour obtenir le montant de la mensualité
            const plan = getInstallmentPlan(user.email);
            if (!plan) {
                alert('Erreur: Plan de paiement non trouvé');
                return;
            }

            const installment = plan.installments.find(i => i.number === installmentNumber);
            if (!installment) {
                alert('Erreur: Mensualité non trouvée');
                return;
            }

            try {
                // Créer une commande pour cette mensualité
                console.log(`[PAYMENT] Création du checkout SumUp pour mensualité ${installmentNumber}...`);

                const clientInfo = {
                    firstName: currentUser.prenom || currentUser.firstName || '',
                    lastName: currentUser.nom || currentUser.lastName || '',
                    email: currentUser.email,
                    phone: currentUser.telephone || currentUser.phone || '',
                    address: currentUser.adresse || currentUser.address || 'Non renseigné',
                    country: 'FRANCE',
                    city: currentUser.ville || currentUser.city || 'Non renseigné',
                    postalCode: currentUser.codePostal || currentUser.postalCode || '00000',
                    clientType: 'particulier'
                };

                // Créer une commande pour la mensualité
                const orderResponse = await fetch(`${API_BASE_URL}/api/orders/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: offerId,
                        clientInfo: clientInfo,
                        customAmount: installment.amount,
                        description: `Mensualité ${installmentNumber}/${plan.numberOfInstallments}`
                    })
                });

                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json();
                    throw new Error(errorData.error || 'Erreur création commande');
                }

                const orderData = await orderResponse.json();
                const orderId = orderData.orderId;

                // Stocker pour le suivi
                sessionStorage.setItem('pendingOrderId', orderId);
                sessionStorage.setItem('pendingPaymentType', 'installment');
                sessionStorage.setItem('pendingInstallmentNumber', installmentNumber.toString());

                // Créer le checkout SumUp pour cette mensualité
                const checkoutResponse = await fetch(`${API_BASE_URL}/api/payments/sumup/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        stage: 'installment',
                        installmentNumber: installmentNumber
                    })
                });

                if (!checkoutResponse.ok) {
                    const errorData = await checkoutResponse.json();
                    throw new Error(errorData.error || errorData.details || 'Erreur création checkout SumUp');
                }

                const checkoutData = await checkoutResponse.json();
                console.log('[PAYMENT] Checkout SumUp créé pour mensualité:', checkoutData);

                // Afficher le widget SumUp pour le paiement par carte
                if (checkoutData.checkout_id) {
                    console.log('[PAYMENT] Ouverture du widget SumUp pour mensualité', installmentNumber);
                    showSumUpWidget(checkoutData.checkout_id, checkoutData.amount, orderId, 'installment', installmentNumber);
                } else {
                    throw new Error('ID de checkout non reçu');
                }

            } catch (error) {
                console.error('[PAYMENT] Erreur:', error);

                if (error.message.includes('Configuration SumUp') || error.message.includes('non configuree')) {
                    alert('❌ Le système de paiement n\'est pas encore configuré.\n\nVeuillez contacter l\'administrateur.');
                } else if (error.message.includes('fetch') || error.message.includes('Failed')) {
                    alert('❌ Impossible de contacter le serveur de paiement.\n\nVérifiez votre connexion internet et réessayez.');
                } else {
                    alert('❌ Erreur lors de la préparation du paiement:\n\n' + error.message);
                }
            }
        }

        function displayPaymentHistory(payments) {
            if (!payments || payments.length === 0) {
                document.getElementById('paymentHistory').innerHTML = `
                    <p class="font-bold opacity-50 text-center py-8">Aucun paiement enregistré</p>
                `;
                return;
            }

            let html = '<div class="space-y-4">';
            payments.forEach(payment => {
                const date = new Date(payment.date).toLocaleDateString('fr-FR');
                const typeLabel = payment.type === 'acompte' ? 'ACOMPTE' : 'SOLDE';
                const typeIcon = payment.type === 'acompte' ? 'fa-hand-holding-usd' : 'fa-check-circle';

                html += `
                    <div class="border-4 border-black p-4 bg-[var(--genesis-yellow)]">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-black text-lg uppercase">
                                    <i class="fas ${typeIcon} mr-2"></i>${typeLabel}
                                </p>
                                <p class="text-sm font-bold opacity-70">${date}</p>
                            </div>
                            <p class="text-2xl font-black">${payment.amount}€</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('paymentHistory').innerHTML = html;
        }

        async function payDeposit() {
            // Utiliser la session backend ou l'ancien système
            const currentUser = getUserFromStorage(user.email);

            // Chercher l'offre active - compatible avec différents formats
            const offerId = currentUser ? (currentUser.activeOfferId || currentUser.active_offer_id || currentUser.offre) : null;

            if (!currentUser || !offerId) {
                alert('Erreur: Aucune offre active trouvée');
                return;
            }

            // Récupérer les détails de l'offre
            const offer = getOfferById(offerId);
            if (!offer) {
                alert('Erreur: Offre non trouvée');
                return;
            }

            // Désactiver le bouton pendant le traitement
            const depositBtn = document.querySelector('#depositSection button');
            if (depositBtn) {
                depositBtn.disabled = true;
                depositBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement en cours...';
            }

            try {
                // ÉTAPE 1: Créer la commande sur le backend
                console.log('[PAYMENT] Création de la commande pour acompte...');

                const clientInfo = {
                    firstName: currentUser.prenom || currentUser.firstName || '',
                    lastName: currentUser.nom || currentUser.lastName || '',
                    email: currentUser.email,
                    phone: currentUser.telephone || currentUser.phone || '',
                    address: currentUser.adresse || currentUser.address || 'Non renseigné',
                    country: 'FRANCE',
                    city: currentUser.ville || currentUser.city || 'Non renseigné',
                    postalCode: currentUser.codePostal || currentUser.postalCode || '00000',
                    clientType: 'particulier'
                };

                const orderResponse = await fetch(`${API_BASE_URL}/api/orders/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: offerId,
                        clientInfo: clientInfo
                    })
                });

                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json();
                    throw new Error(errorData.error || 'Erreur création commande');
                }

                const orderData = await orderResponse.json();
                const orderId = orderData.orderId;
                console.log('[PAYMENT] Commande créée:', orderId);

                // Stocker l'ID pour le suivi
                sessionStorage.setItem('pendingOrderId', orderId);
                sessionStorage.setItem('pendingPaymentType', 'deposit');

                // ÉTAPE 2: Créer le checkout SumUp pour l'acompte
                console.log('[PAYMENT] Création du checkout SumUp...');
                const checkoutResponse = await fetch(`${API_BASE_URL}/api/payments/sumup/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        stage: 'deposit'
                    })
                });

                if (!checkoutResponse.ok) {
                    const errorData = await checkoutResponse.json();
                    throw new Error(errorData.error || errorData.details || 'Erreur création checkout SumUp');
                }

                const checkoutData = await checkoutResponse.json();
                console.log('[PAYMENT] Checkout SumUp créé:', checkoutData);

                // ÉTAPE 3: Afficher le widget SumUp pour le paiement par carte
                if (checkoutData.checkout_id) {
                    // Réactiver le bouton
                    if (depositBtn) {
                        depositBtn.disabled = false;
                        depositBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Payer l\'acompte';
                    }
                    console.log('[PAYMENT] Ouverture du widget SumUp, checkout_id:', checkoutData.checkout_id);
                    showSumUpWidget(checkoutData.checkout_id, checkoutData.amount, orderId, 'deposit');
                } else {
                    throw new Error('ID de checkout non reçu');
                }

            } catch (error) {
                console.error('[PAYMENT] Erreur:', error);

                // Réactiver le bouton
                if (depositBtn) {
                    depositBtn.disabled = false;
                    depositBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Payer l\'acompte';
                }

                // Message d'erreur spécifique
                if (error.message.includes('Configuration SumUp') || error.message.includes('non configuree')) {
                    alert('❌ Le système de paiement n\'est pas encore configuré.\n\nVeuillez contacter l\'administrateur.');
                } else if (error.message.includes('fetch') || error.message.includes('Failed')) {
                    alert('❌ Impossible de contacter le serveur de paiement.\n\nVérifiez votre connexion internet et réessayez.');
                } else {
                    alert('❌ Erreur lors de la préparation du paiement:\n\n' + error.message);
                }
            }
        }

        async function payBalance() {
            // Utiliser la session backend ou l'ancien système
            const currentUser = getUserFromStorage(user.email);

            // Chercher l'offre active - compatible avec différents formats
            const offerId = currentUser ? (currentUser.activeOfferId || currentUser.active_offer_id || currentUser.offre) : null;

            if (!currentUser || !offerId) {
                alert('Erreur: Aucune offre active trouvée');
                return;
            }

            // Récupérer les détails de l'offre
            const offer = getOfferById(offerId);
            if (!offer) {
                alert('Erreur: Offre non trouvée');
                return;
            }

            // Récupérer l'ID de commande existant (créé lors du paiement de l'acompte)
            // ou créer une nouvelle commande si nécessaire
            let orderId = sessionStorage.getItem('pendingOrderId');

            try {
                // Si pas d'orderId, on doit d'abord créer une commande
                if (!orderId) {
                    console.log('[PAYMENT] Pas d\'orderId trouvé, création d\'une nouvelle commande...');

                    const clientInfo = {
                        firstName: currentUser.prenom || currentUser.firstName || '',
                        lastName: currentUser.nom || currentUser.lastName || '',
                        email: currentUser.email,
                        phone: currentUser.telephone || currentUser.phone || '',
                        address: currentUser.adresse || currentUser.address || 'Non renseigné',
                        country: 'FRANCE',
                        city: currentUser.ville || currentUser.city || 'Non renseigné',
                        postalCode: currentUser.codePostal || currentUser.postalCode || '00000',
                        clientType: 'particulier'
                    };

                    const orderResponse = await fetch(`${API_BASE_URL}/api/orders/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productId: offerId,
                            clientInfo: clientInfo
                        })
                    });

                    if (!orderResponse.ok) {
                        const errorData = await orderResponse.json();
                        throw new Error(errorData.error || 'Erreur création commande');
                    }

                    const orderData = await orderResponse.json();
                    orderId = orderData.orderId;
                    console.log('[PAYMENT] Commande créée pour solde:', orderId);
                }

                // Stocker pour le suivi
                sessionStorage.setItem('pendingOrderId', orderId);
                sessionStorage.setItem('pendingPaymentType', 'balance');

                // Créer le checkout SumUp pour le solde (70%)
                console.log('[PAYMENT] Création du checkout SumUp pour le solde...');
                const checkoutResponse = await fetch(`${API_BASE_URL}/api/payments/sumup/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        stage: 'balance'
                    })
                });

                if (!checkoutResponse.ok) {
                    const errorData = await checkoutResponse.json();
                    throw new Error(errorData.error || errorData.details || 'Erreur création checkout SumUp');
                }

                const checkoutData = await checkoutResponse.json();
                console.log('[PAYMENT] Checkout SumUp créé pour solde:', checkoutData);

                // Afficher le widget SumUp pour le paiement par carte
                if (checkoutData.checkout_id) {
                    console.log('[PAYMENT] Ouverture du widget SumUp pour solde, checkout_id:', checkoutData.checkout_id);
                    showSumUpWidget(checkoutData.checkout_id, checkoutData.amount, orderId, 'balance');
                } else {
                    throw new Error('ID de checkout non reçu');
                }

            } catch (error) {
                console.error('[PAYMENT] Erreur:', error);

                // Message d'erreur spécifique
                if (error.message.includes('Configuration SumUp') || error.message.includes('non configuree')) {
                    alert('❌ Le système de paiement n\'est pas encore configuré.\n\nVeuillez contacter l\'administrateur.');
                } else if (error.message.includes('fetch') || error.message.includes('Failed')) {
                    alert('❌ Impossible de contacter le serveur de paiement.\n\nVérifiez votre connexion internet et réessayez.');
                } else {
                    alert('❌ Erreur lors de la préparation du paiement:\n\n' + error.message);
                }
            }
        }

        // Charger le statut au chargement de la page
        loadPaymentStatus();
    </script>
    <div id="site-footer"></div>
    <script src="footer.js"></script>
    <script src="chatbot.js"></script>
</body>
</html>
