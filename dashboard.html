<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Dashboard - FA GENESIS | Espace Client</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <!-- AOS retire pour fiabilite -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, .nav-link { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .neo-btn-white {
            background: white;
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px var(--genesis-yellow);
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-white:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px var(--genesis-yellow);
        }

        .progress-bar {
            background: white;
            height: 40px;
            border: 4px solid black;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--genesis-yellow);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: black;
            border-right: 4px solid black;
        }

        .stat-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 14px 14px 0px 0px var(--genesis-yellow);
        }
    </style>
</head>
<body>

    <!-- NAVIGATION PRIVEE -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-4 md:px-6 py-3 md:py-4 flex justify-between items-center text-white text-xs font-black uppercase">
        <div class="flex items-center">
            <a href="dashboard.html" class="text-lg md:text-2xl font-black tracking-wider text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">FA GENESIS</a>
        </div>
        <div id="mainNavigation" class="hidden md:flex gap-8 text-white font-black">
            <a href="dashboard.html" class="nav-link text-[var(--genesis-yellow)]">Dashboard</a>
            <a href="livrables.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Livrables</a>
            <a href="seances.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Séances</a>
            <a href="mon-compte.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Mon compte</a>
        </div>
        <div class="flex gap-4 items-center">
            <span id="userGreeting" class="hidden md:block text-white font-bold"></span>
            <button onclick="logout()" class="border-4 border-white text-white px-3 py-2 text-[10px] tracking-widest font-black hover:bg-white hover:text-black transition">
                <i class="fas fa-sign-out-alt mr-1"></i><span class="hidden md:inline">Déconnexion</span>
            </button>
            <!-- Bouton Menu Mobile -->
            <button id="mobileMenuBtn" class="md:hidden flex flex-col gap-1.5 p-2" aria-label="Menu">
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine1"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine2"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine3"></span>
            </button>
        </div>
    </nav>

    <!-- Menu Mobile Overlay -->
    <div id="mobileMenu" class="fixed inset-0 z-40 bg-black/98 backdrop-blur-lg hidden flex-col items-center justify-center gap-8 text-white font-black uppercase">
        <a href="dashboard.html" class="text-2xl nav-link text-[var(--genesis-yellow)]" onclick="closeMobileMenu()">Dashboard</a>
        <a href="livrables.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition" onclick="closeMobileMenu()">Livrables</a>
        <a href="seances.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition" onclick="closeMobileMenu()">Séances</a>
        <a href="mon-compte.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition" onclick="closeMobileMenu()">Mon compte</a>
        <div class="mt-8">
            <button onclick="logout(); closeMobileMenu();" class="neo-btn-yellow px-8 py-4 text-sm tracking-widest text-black font-black text-center">
                <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
            </button>
        </div>
    </div>

    <!-- DASHBOARD CONTENT -->
    <section class="min-h-screen pt-32 pb-20 px-6 bg-black">
        <div class="container mx-auto max-w-6xl">

            <!-- En-tete de bienvenue -->
            <div class="mb-16">
                <h1 class="text-5xl md:text-7xl font-black italic uppercase mb-4 text-[var(--genesis-yellow)]" id="welcomeTitle">Bienvenue</h1>
                <p class="text-xl font-bold uppercase text-white" id="welcomeSubtitle">Votre espace client</p>
            </div>

            <!-- Loader (TOUJOURS masque par finally) -->
            <div id="dashboardLoader" class="mb-8">
                <div class="flex items-center gap-4 p-6" style="background: #222; border: 2px solid var(--genesis-yellow);">
                    <i class="fas fa-spinner fa-spin text-[var(--genesis-yellow)] text-2xl"></i>
                    <span class="font-bold text-white text-base">Chargement de votre espace...</span>
                </div>
            </div>

            <!-- Zone erreur (cachee par defaut) -->
            <div id="dashboardErrorBlock" class="mb-8" style="display: none;">
                <div class="p-6 border-4 border-black" style="background: #ff6b6b; color: #000;">
                    <div class="flex items-center gap-4 mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                        <div>
                            <h3 class="text-xl font-black uppercase" id="errorTitle">Erreur</h3>
                            <p class="font-bold" id="errorMessage">Impossible de charger votre espace.</p>
                        </div>
                    </div>
                    <button onclick="loadDashboard()" class="bg-black text-white px-6 py-3 font-black text-sm uppercase border-2 border-black mt-2">
                        <i class="fas fa-redo mr-2"></i>Reessayer
                    </button>
                </div>
            </div>

            <!-- Bloc acompte requis (cache par defaut) -->
            <div id="depositRequiredSection" class="mb-16" style="display: none;">
                <div class="bg-white text-black border-4 border-black neo-shadow p-8 md:p-12">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 bg-[var(--genesis-yellow)] border-4 border-black rounded-full mb-6">
                            <i class="fas fa-lock text-black text-4xl"></i>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-black italic uppercase mb-4">Votre espace est presque pret !</h2>
                        <p class="text-lg font-bold text-gray-700 max-w-xl mx-auto">
                            Pour acceder a votre espace client et demarrer votre <span id="depositOfferTypeLabel">accompagnement</span>,
                            il vous suffit de regler l'acompte de 30%.
                        </p>
                    </div>
                    <div class="bg-black text-white p-6 border-4 border-black mb-8 max-w-lg mx-auto">
                        <div class="flex items-center gap-4 mb-4">
                            <i class="fas fa-info-circle text-[var(--genesis-yellow)] text-2xl"></i>
                            <p class="font-bold text-base" id="depositOfferName">Offre selectionnee</p>
                        </div>
                        <ul class="space-y-3 text-sm">
                            <li class="flex items-start gap-2"><i class="fas fa-check text-[var(--genesis-yellow)] mt-1"></i><span>L'acompte confirme votre inscription et declenche le demarrage.</span></li>
                            <li class="flex items-start gap-2"><i class="fas fa-check text-[var(--genesis-yellow)] mt-1"></i><span>Acces a votre tableau de bord, livrables et suivi.</span></li>
                            <li class="flex items-start gap-2"><i class="fas fa-check text-[var(--genesis-yellow)] mt-1"></i><span>Un conseiller vous contactera sous 24 a 48h.</span></li>
                        </ul>
                    </div>
                    <div class="text-center">
                        <a href="payment.html" id="depositPayButton" class="neo-btn-yellow px-10 py-5 text-xl uppercase inline-block mb-4">
                            <i class="fas fa-credit-card mr-3"></i>Payer l'acompte (30%)
                        </a>
                        <p class="text-sm text-gray-500 mt-4" id="depositAmountInfo">
                            <i class="fas fa-shield-alt mr-1"></i> Paiement securise par SumUp
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contenu principal (cache par defaut, montre apres load) -->
            <div id="dashboardMainContent" style="display: none;">

                <!-- Cartes principales -->
                <div class="grid md:grid-cols-2 gap-8 mb-16">

                    <!-- Carte Offre active -->
                    <div class="stat-card">
                        <div class="text-sm font-black uppercase mb-2 opacity-70">Votre offre</div>
                        <div class="text-3xl font-black italic" id="offreLabel">-</div>
                        <div class="text-xs font-bold uppercase mt-1" id="offreCategory">-</div>
                    </div>

                    <!-- Carte Paiement -->
                    <div class="stat-card" id="paymentCard">
                        <div class="text-sm font-black uppercase mb-2 opacity-70">Paiement</div>
                        <div class="text-3xl font-black italic" id="paymentStatus">-</div>
                        <div class="text-xs font-bold uppercase mt-1" id="paymentDetail">-</div>
                    </div>
                </div>

                <!-- Carte Prochaine etape -->
                <div class="mb-16">
                    <div class="p-8 border-4 border-black" style="background: var(--genesis-yellow); color: black;">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-arrow-right text-3xl"></i>
                            <div>
                                <div class="text-sm font-black uppercase opacity-70">Prochaine etape</div>
                                <div class="text-2xl font-black italic" id="nextStepLabel">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Carte Demarrage / Calendrier -->
                <div id="startDateSection" class="mb-16" style="display: none;">
                    <div class="bg-white text-black border-4 border-black p-8 md:p-12" style="box-shadow: 10px 10px 0px 0px var(--genesis-yellow);">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-[var(--genesis-yellow)] border-4 border-black rounded-full flex-shrink-0">
                                <i class="fas fa-calendar-alt text-black text-2xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl md:text-3xl font-black italic uppercase" id="scheduleTitle">Planifiez votre demarrage</h2>
                                <p class="font-bold text-gray-600 text-sm" id="scheduleSubtitle">Choisissez la date de debut</p>
                            </div>
                        </div>

                        <!-- Formulaire de choix de date -->
                        <div id="scheduleFormBlock">
                            <p class="font-bold text-gray-700 mb-4">Selectionnez une date. L'equipe FA GENESIS confirmera la disponibilite.</p>
                            <div class="flex flex-col md:flex-row items-start md:items-end gap-4">
                                <div>
                                    <label class="font-black text-xs uppercase block mb-2 text-gray-600">Date souhaitee (minimum demain)</label>
                                    <input type="date" id="startDatePicker" class="p-3 text-lg font-bold w-full"
                                           style="border: 4px solid black; background: white; color: black; min-width: 220px;" />
                                </div>
                                <button onclick="submitStartDate()" id="submitStartDateBtn"
                                        class="neo-btn-yellow px-8 py-3 text-base uppercase whitespace-nowrap">
                                    <i class="fas fa-check mr-2"></i>CONFIRMER MA DATE
                                </button>
                            </div>
                        </div>

                        <!-- En attente de confirmation -->
                        <div id="schedulePendingBlock" style="display: none;">
                            <div class="flex items-center gap-4 p-6 border-4 border-black" style="background: #FFF9E6;">
                                <i class="fas fa-clock text-4xl" style="color: var(--genesis-yellow);"></i>
                                <div>
                                    <p class="font-black text-xl">Date proposee : <span id="proposedDateDisplay" class="text-[var(--genesis-yellow)]"></span></p>
                                    <p class="text-gray-600 font-bold">En attente de confirmation par l'equipe FA GENESIS.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Date confirmee -->
                        <div id="scheduleConfirmedBlock" style="display: none;">
                            <div class="flex items-center gap-4 p-6 border-4 border-black" style="background: #e8f5e9;">
                                <i class="fas fa-check-circle text-4xl text-green-600"></i>
                                <div>
                                    <p class="font-black text-xl">Date confirmee : <span id="confirmedDateDisplay" class="text-green-700"></span></p>
                                    <p class="text-gray-600 font-bold" id="scheduleConfirmedMsg">Votre parcours est planifie !</p>
                                </div>
                            </div>
                        </div>

                        <!-- Date deja fixee (pas de calendrier) -->
                        <div id="startDateFixedBlock" style="display: none;">
                            <div class="flex items-center gap-4 p-6 border-4 border-black" style="background: #e8f5e9;">
                                <i class="fas fa-calendar-check text-4xl text-green-600"></i>
                                <div>
                                    <p class="font-black text-xl">Demarrage : <span id="fixedDateDisplay" class="text-green-700"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bouton payer solde (si solde restant) -->
                <div id="payBalanceSection" class="mb-16" style="display: none;">
                    <div class="p-8 border-4 border-black text-center" style="background: #ffd43b; color: black;">
                        <h3 class="text-xl font-black italic uppercase mb-2">Solde restant</h3>
                        <p class="font-bold mb-4" id="balanceAmount">-</p>
                        <a href="payment.html" class="inline-block bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition">
                            <i class="fas fa-credit-card mr-2"></i>Payer le solde
                        </a>
                    </div>
                </div>

                <!-- Actions rapides -->
                <div class="mb-16">
                    <h2 class="text-2xl font-black italic uppercase mb-8 text-white">Acces rapide</h2>
                    <div class="grid md:grid-cols-3 gap-6">
                        <a href="livrables.html" class="neo-btn-white p-8 block text-center">
                            <i class="fas fa-file-download text-4xl mb-4"></i>
                            <div class="text-xl font-black italic uppercase">Mes livrables</div>
                            <div class="text-sm font-bold mt-2 opacity-70">Documents, photos, videos</div>
                        </a>
                        <a href="seances.html" class="neo-btn-white p-8 block text-center">
                            <i class="fas fa-calendar-alt text-4xl mb-4"></i>
                            <div class="text-xl font-black italic uppercase">Mes seances</div>
                            <div class="text-sm font-bold mt-2 opacity-70">Planning et rendez-vous</div>
                        </a>
                        <a href="contact.html" class="neo-btn-white p-8 block text-center">
                            <i class="fas fa-envelope text-4xl mb-4"></i>
                            <div class="text-xl font-black italic uppercase">Support</div>
                            <div class="text-sm font-bold mt-2 opacity-70">Contactez notre equipe</div>
                        </a>
                    </div>
                </div>

                <!-- Besoin d'aide -->
                <div class="bg-[var(--genesis-yellow)] text-black p-8 neo-border text-center">
                    <h3 class="text-2xl font-black italic uppercase mb-4">Besoin d'aide ?</h3>
                    <p class="font-bold mb-6">Notre equipe est la pour vous accompagner</p>
                    <a href="contact.html" class="inline-block bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition">
                        Contactez-nous
                    </a>
                </div>

            </div><!-- fin dashboardMainContent -->

        </div>
    </section>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // ============================================================
        // DASHBOARD v7 - SIMPLE, ZERO PROGRESSION, ZERO LOADING INFINI
        // ============================================================
        console.log('[DASHBOARD] v7 - Demarrage');

        var API_BASE_URL = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';

        // ============================================================
        // UI HELPERS
        // ============================================================
        function setLoading(visible) {
            var loader = document.getElementById('dashboardLoader');
            if (loader) loader.style.display = visible ? '' : 'none';
        }

        function showError(title, message) {
            var block = document.getElementById('dashboardErrorBlock');
            if (!block) return;
            block.style.display = '';
            var tEl = document.getElementById('errorTitle');
            if (tEl) tEl.textContent = title;
            var mEl = document.getElementById('errorMessage');
            if (mEl) mEl.textContent = message;
        }

        function hideError() {
            var block = document.getElementById('dashboardErrorBlock');
            if (block) block.style.display = 'none';
        }

        function fetchWithTimeout(url, options, timeoutMs) {
            return new Promise(function(resolve, reject) {
                var controller = new AbortController();
                var timer = setTimeout(function() {
                    controller.abort();
                    reject(new Error('TIMEOUT'));
                }, timeoutMs || 8000);
                var opts = Object.assign({}, options || {}, { signal: controller.signal });
                fetch(url, opts).then(function(resp) {
                    clearTimeout(timer);
                    resolve(resp);
                }).catch(function(err) {
                    clearTimeout(timer);
                    reject(err);
                });
            });
        }

        function formatDateFr(dateStr) {
            try {
                var jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
                var moisNoms = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
                var d = new Date(dateStr + 'T00:00:00');
                if (isNaN(d.getTime())) return dateStr || 'Non definie';
                return jours[d.getDay()] + ' ' + d.getDate() + ' ' + moisNoms[d.getMonth()] + ' ' + d.getFullYear();
            } catch (e) { return dateStr || 'Non definie'; }
        }

        // ============================================================
        // PROTECTION AUTH
        // ============================================================
        try {
            if (typeof requireAuth === 'function') {
                requireAuth();
            } else {
                var hasToken = localStorage.getItem('fa_genesis_token');
                if (!hasToken) { window.location.href = 'login.html'; }
            }
        } catch (authErr) {
            console.error('[DASHBOARD] Auth error:', authErr.message);
        }

        // ============================================================
        // FONCTION PRINCIPALE : loadDashboard()
        // ============================================================
        async function loadDashboard() {
            setLoading(true);
            hideError();
            var mainCont = document.getElementById('dashboardMainContent');
            var depositSec = document.getElementById('depositRequiredSection');
            if (mainCont) mainCont.style.display = 'none';
            if (depositSec) depositSec.style.display = 'none';

            try {
                var token = localStorage.getItem('fa_genesis_token');
                if (!token) { window.location.href = 'login.html'; return; }

                // Affichage immediat du prenom
                try {
                    var raw = localStorage.getItem('fa_genesis_session');
                    if (raw) {
                        var localUser = JSON.parse(raw);
                        var welc = document.getElementById('welcomeTitle');
                        if (welc && localUser.prenom) welc.textContent = 'Bienvenue ' + localUser.prenom;
                        var greet = document.getElementById('userGreeting');
                        if (greet && localUser.prenom) greet.textContent = localUser.prenom;
                    }
                } catch (e) {}

                // APPEL UNIQUE : GET /api/dashboard
                var resp = await fetchWithTimeout(API_BASE_URL + '/api/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }, 8000);

                if (resp.status === 401) {
                    localStorage.removeItem('fa_genesis_token');
                    localStorage.removeItem('fa_genesis_session');
                    window.location.href = 'login.html';
                    return;
                }

                if (!resp.ok) {
                    showError('Erreur serveur (' + resp.status + ')', 'Le serveur a renvoye une erreur. Reessayez.');
                    return;
                }

                var data = await resp.json();
                if (!data.ok) {
                    if (data.error === 'UNAUTHORIZED') {
                        localStorage.removeItem('fa_genesis_token');
                        localStorage.removeItem('fa_genesis_session');
                        window.location.href = 'login.html';
                        return;
                    }
                    showError('Erreur', data.message || 'Erreur inconnue.');
                    return;
                }

                // Mettre a jour localStorage
                if (data.user) {
                    var session = {};
                    try { session = JSON.parse(localStorage.getItem('fa_genesis_session') || '{}'); } catch (e) {}
                    session.email = data.user.email;
                    session.prenom = data.user.prenom;
                    session.nom = data.user.nom;
                    session.telephone = data.user.telephone || '';
                    session.paymentStatus = data.user.paymentStatus;
                    session.activeOfferId = data.user.activeOfferId;
                    session.productType = data.user.productType;
                    if (data.activeSubscription) {
                        session.deposit_paid = data.activeSubscription.deposit_paid;
                    }
                    localStorage.setItem('fa_genesis_session', JSON.stringify(session));

                    var welc2 = document.getElementById('welcomeTitle');
                    if (welc2) welc2.textContent = 'Bienvenue ' + (data.user.prenom || '');
                    var greet2 = document.getElementById('userGreeting');
                    if (greet2) greet2.textContent = data.user.prenom || '';
                }

                // ============================
                // CAS 1 : PAS DE COMMANDE PAYEE
                // ============================
                if (data.status === 'NO_PAID_ORDER') {
                    var subtitleEl = document.getElementById('welcomeSubtitle');
                    if (subtitleEl) subtitleEl.textContent = 'Finalisez votre inscription';

                    if (depositSec) {
                        depositSec.style.display = 'block';
                        if (data.pendingOrder) {
                            var po = data.pendingOrder;
                            var offerNameEl = document.getElementById('depositOfferName');
                            if (offerNameEl && po.product_name) offerNameEl.textContent = po.product_name;
                            var typeLabel = document.getElementById('depositOfferTypeLabel');
                            if (typeLabel) typeLabel.textContent = po.product_type === 'prestation_individuelle' ? 'prestation' : 'accompagnement';
                            var payBtn = document.getElementById('depositPayButton');
                            var amountInfo = document.getElementById('depositAmountInfo');
                            if (amountInfo && po.deposit_amount) {
                                amountInfo.innerHTML = '<i class="fas fa-shield-alt mr-1"></i> Acompte : <strong>' + po.deposit_amount.toFixed(2) + ' EUR</strong> - Paiement securise par SumUp.';
                            }
                            if (po.source === 'quote' && po.quote_id && payBtn) {
                                try {
                                    var qResp = await fetchWithTimeout(API_BASE_URL + '/api/quotes/by-order/' + encodeURIComponent(po.id), {
                                        headers: { 'Authorization': 'Bearer ' + token }
                                    }, 5000);
                                    if (qResp.ok) {
                                        var quoteData = await qResp.json();
                                        if (quoteData && quoteData.acceptance_token) {
                                            payBtn.href = 'quote-accept.html?token=' + encodeURIComponent(quoteData.acceptance_token);
                                        }
                                    }
                                } catch (qErr) { console.error('[DASHBOARD] Quote error:', qErr.message); }
                            }
                            if (payBtn && po.deposit_amount) {
                                payBtn.innerHTML = '<i class="fas fa-credit-card mr-3"></i>Payer l\'acompte (' + po.deposit_amount.toFixed(2) + ' EUR)';
                            }
                        }
                    }
                    return;
                }

                // ============================
                // CAS 2 : COMMANDE PAYEE
                // ============================
                if (depositSec) depositSec.style.display = 'none';
                if (mainCont) mainCont.style.display = '';

                var sub = data.activeSubscription;
                if (!sub) {
                    showError('Erreur', 'Donnees de souscription manquantes.');
                    return;
                }

                // Carte Offre
                var offreLabelEl = document.getElementById('offreLabel');
                if (offreLabelEl) offreLabelEl.textContent = sub.formula_label || '-';
                var offreCatEl = document.getElementById('offreCategory');
                if (offreCatEl) offreCatEl.textContent = sub.category || '-';

                // Carte Paiement
                var payStatusEl = document.getElementById('paymentStatus');
                var payDetailEl = document.getElementById('paymentDetail');
                if (sub.balance_paid) {
                    if (payStatusEl) payStatusEl.textContent = 'Paye integralement';
                    if (payDetailEl) payDetailEl.textContent = sub.total_amount + ' EUR';
                } else if (sub.deposit_paid) {
                    if (payStatusEl) payStatusEl.textContent = 'Acompte paye';
                    if (payDetailEl) payDetailEl.textContent = 'Solde restant : ' + sub.remaining_due + ' EUR';
                } else {
                    if (payStatusEl) payStatusEl.textContent = 'En attente';
                    if (payDetailEl) payDetailEl.textContent = '-';
                }

                // Prochaine etape
                var nextEl = document.getElementById('nextStepLabel');
                if (nextEl) nextEl.textContent = sub.next_step_label || '-';

                // Section payer solde
                if (sub.deposit_paid && !sub.balance_paid && sub.remaining_due > 0) {
                    var payBalSec = document.getElementById('payBalanceSection');
                    if (payBalSec) payBalSec.style.display = '';
                    var balAmtEl = document.getElementById('balanceAmount');
                    if (balAmtEl) balAmtEl.textContent = sub.remaining_due + ' EUR a regler pour debloquer les telechargements';
                }

                // Section demarrage / calendrier
                renderStartDateSection(sub, data.order);

                console.log('[DASHBOARD] Charge avec succes');

            } catch (err) {
                console.error('[DASHBOARD] Erreur:', err.message);
                if (err.message && err.message.indexOf('TIMEOUT') !== -1) {
                    showError('Connexion impossible', 'Le serveur ne repond pas. Verifiez votre connexion et reessayez.');
                } else if (err.message && (err.message.indexOf('Failed to fetch') !== -1 || err.message.indexOf('NetworkError') !== -1)) {
                    showError('Connexion impossible', 'Impossible de joindre le serveur.');
                } else {
                    showError('Erreur inattendue', err.message || 'Une erreur est survenue.');
                }
            } finally {
                setLoading(false);
            }
        }

        // ============================================================
        // PLANIFICATION DATE DE DEMARRAGE
        // ============================================================
        var _scheduleOrderId = null;

        function renderStartDateSection(sub, order) {
            var section = document.getElementById('startDateSection');
            if (!section) return;

            var schedStatus = sub.schedule_status || '';
            var startDate = sub.startDate;
            var ordObj = order || {};

            // Si date deja fixee sans processus de planification
            if (startDate && !schedStatus) {
                section.style.display = '';
                hideAllScheduleBlocks();
                var fixedBlock = document.getElementById('startDateFixedBlock');
                if (fixedBlock) fixedBlock.style.display = '';
                var fixedDisplay = document.getElementById('fixedDateDisplay');
                if (fixedDisplay) fixedDisplay.textContent = formatDateFr(startDate);
                return;
            }

            // Date confirmee par planification
            if (startDate && schedStatus === 'confirmed') {
                section.style.display = '';
                hideAllScheduleBlocks();
                var confirmedBlock = document.getElementById('scheduleConfirmedBlock');
                if (confirmedBlock) confirmedBlock.style.display = '';
                var confirmedDisplay = document.getElementById('confirmedDateDisplay');
                if (confirmedDisplay) confirmedDisplay.textContent = formatDateFr(startDate);
                var msg = document.getElementById('scheduleConfirmedMsg');
                if (msg) msg.textContent = sub.product_type === 'prestation_individuelle' ? 'Votre prestation est planifiee !' : 'Votre parcours est planifie !';
                return;
            }

            // Pas encore de date et acompte paye -> proposer calendrier
            if (!startDate && sub.deposit_paid) {
                _scheduleOrderId = ordObj.id || (sub.order_id || null);
                section.style.display = '';

                var title = document.getElementById('scheduleTitle');
                var subtitle = document.getElementById('scheduleSubtitle');
                if (sub.product_type === 'prestation_individuelle') {
                    if (title) title.textContent = 'Planifiez votre prestation';
                    if (subtitle) subtitle.textContent = 'Choisissez la date de votre prestation';
                }

                hideAllScheduleBlocks();

                if (schedStatus === 'client_proposed') {
                    var pendingBlock = document.getElementById('schedulePendingBlock');
                    if (pendingBlock) pendingBlock.style.display = '';
                    var proposedDisp = document.getElementById('proposedDateDisplay');
                    if (proposedDisp) proposedDisp.textContent = formatDateFr(sub.proposed_start_date);
                } else {
                    // awaiting_client_choice ou pas de status
                    var formBlock = document.getElementById('scheduleFormBlock');
                    if (formBlock) formBlock.style.display = '';
                    var picker = document.getElementById('startDatePicker');
                    if (picker) {
                        var tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        var y = tomorrow.getFullYear();
                        var m = String(tomorrow.getMonth() + 1);
                        if (m.length < 2) m = '0' + m;
                        var dd = String(tomorrow.getDate());
                        if (dd.length < 2) dd = '0' + dd;
                        picker.min = y + '-' + m + '-' + dd;
                    }
                }
                return;
            }
        }

        function hideAllScheduleBlocks() {
            var ids = ['scheduleFormBlock', 'schedulePendingBlock', 'scheduleConfirmedBlock', 'startDateFixedBlock'];
            for (var i = 0; i < ids.length; i++) {
                var el = document.getElementById(ids[i]);
                if (el) el.style.display = 'none';
            }
        }

        async function submitStartDate() {
            var picker = document.getElementById('startDatePicker');
            var btn = document.getElementById('submitStartDateBtn');
            if (!picker || !picker.value) { alert('Veuillez selectionner une date.'); return; }
            if (!_scheduleOrderId) { alert('Erreur : commande introuvable. Rechargez la page.'); return; }

            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi...'; }

            try {
                var token = localStorage.getItem('fa_genesis_token');
                var resp = await fetch(API_BASE_URL + '/api/orders/' + _scheduleOrderId + '/schedule-start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (token || '') },
                    body: JSON.stringify({ proposed_date: picker.value })
                });
                var rData = await resp.json();
                if (resp.ok && rData.success) {
                    hideAllScheduleBlocks();
                    var pendingBlock = document.getElementById('schedulePendingBlock');
                    if (pendingBlock) pendingBlock.style.display = '';
                    var proposedDisp = document.getElementById('proposedDateDisplay');
                    if (proposedDisp) proposedDisp.textContent = formatDateFr(picker.value);
                    var nextEl = document.getElementById('nextStepLabel');
                    if (nextEl) nextEl.textContent = 'En attente de confirmation de la date';
                } else {
                    alert('Erreur : ' + (rData.error || 'Impossible de soumettre la date.'));
                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check mr-2"></i>CONFIRMER MA DATE'; }
                }
            } catch (err) {
                alert('Erreur reseau : ' + err.message);
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check mr-2"></i>CONFIRMER MA DATE'; }
            }
        }

        // ============================================================
        // MENU MOBILE
        // ============================================================
        var mobileMenuBtn = document.getElementById('mobileMenuBtn');
        var mobileMenu = document.getElementById('mobileMenu');
        var menuLine1 = document.getElementById('menuLine1');
        var menuLine2 = document.getElementById('menuLine2');
        var menuLine3 = document.getElementById('menuLine3');
        var isMenuOpen = false;

        function toggleMobileMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.classList.add('flex');
                menuLine1.style.transform = 'rotate(45deg) translate(5px, 5px)';
                menuLine2.style.opacity = '0';
                menuLine3.style.transform = 'rotate(-45deg) translate(5px, -5px)';
                document.body.style.overflow = 'hidden';
            } else { closeMobileMenu(); }
        }

        function closeMobileMenu() {
            isMenuOpen = false;
            if (mobileMenu) { mobileMenu.classList.add('hidden'); mobileMenu.classList.remove('flex'); }
            if (menuLine1) menuLine1.style.transform = 'none';
            if (menuLine2) menuLine2.style.opacity = '1';
            if (menuLine3) menuLine3.style.transform = 'none';
            document.body.style.overflow = 'auto';
        }

        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);

        // Lancer le chargement
        loadDashboard();
    </script>
    <div id="site-footer"></div>
    <script src="footer.js" defer></script>
    <script src="chatbot.js" defer></script>
</body>
</html>
