<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Dashboard - FA GENESIS | Espace Client</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <!-- AOS retire pour fiabilite -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, .nav-link { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }

        .neo-btn-white {
            background: white;
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px var(--genesis-yellow);
            font-weight: 900;
            transition: 0.1s;
        }
        .neo-btn-white:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px var(--genesis-yellow);
        }

        .progress-bar {
            background: white;
            height: 40px;
            border: 4px solid black;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--genesis-yellow);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: black;
            border-right: 4px solid black;
        }

        .stat-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 14px 14px 0px 0px var(--genesis-yellow);
        }
    </style>
</head>
<body>

    <!-- NAVIGATION PRIVEE -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-4 md:px-6 py-3 md:py-4 flex justify-between items-center text-white text-xs font-black uppercase">
        <div class="flex items-center">
            <a href="dashboard.html" class="text-lg md:text-2xl font-black tracking-wider text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">FA GENESIS</a>
        </div>
        <div id="mainNavigation" class="hidden md:flex gap-8 text-white font-black">
            <a href="dashboard.html" class="nav-link text-[var(--genesis-yellow)]">Dashboard</a>
            <a href="livrables.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Livrables</a>
            <a href="seances.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Séances</a>
            <a href="mon-compte.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Mon compte</a>
        </div>
        <div class="flex gap-4 items-center">
            <span id="userGreeting" class="hidden md:block text-white font-bold"></span>
            <button onclick="logout()" class="border-4 border-white text-white px-3 py-2 text-[10px] tracking-widest font-black hover:bg-white hover:text-black transition">
                <i class="fas fa-sign-out-alt mr-1"></i><span class="hidden md:inline">Déconnexion</span>
            </button>
            <!-- Bouton Menu Mobile -->
            <button id="mobileMenuBtn" class="md:hidden flex flex-col gap-1.5 p-2" aria-label="Menu">
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine1"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine2"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine3"></span>
            </button>
        </div>
    </nav>

    <!-- Menu Mobile Overlay -->
    <div id="mobileMenu" class="fixed inset-0 z-40 bg-black/98 backdrop-blur-lg hidden flex-col items-center justify-center gap-8 text-white font-black uppercase">
        <a href="dashboard.html" class="text-2xl nav-link text-[var(--genesis-yellow)]" onclick="closeMobileMenu()">Dashboard</a>
        <a href="livrables.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition" onclick="closeMobileMenu()">Livrables</a>
        <a href="seances.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition" onclick="closeMobileMenu()">Séances</a>
        <a href="mon-compte.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition" onclick="closeMobileMenu()">Mon compte</a>
        <div class="mt-8">
            <button onclick="logout(); closeMobileMenu();" class="neo-btn-yellow px-8 py-4 text-sm tracking-widest text-black font-black text-center">
                <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
            </button>
        </div>
    </div>

    <!-- DASHBOARD CONTENT -->
    <section class="min-h-screen pt-32 pb-20 px-6 bg-black">
        <div class="container mx-auto max-w-6xl">

            <!-- Bandeau d'erreur (cache par defaut) -->
            <div id="dashboardError" style="display: none; background: #ff0000; color: white; padding: 1rem; border: 4px solid black; margin-bottom: 2rem; font-weight: bold;">
            </div>

            <!-- En-tete de bienvenue -->
            <div class="mb-16">
                <h1 class="text-5xl md:text-7xl font-black italic uppercase mb-4 text-[var(--genesis-yellow)]" id="welcomeTitle">Bienvenue</h1>
                <p class="text-xl font-bold uppercase text-white" id="welcomeSubtitle">Voici un aperçu de votre espace client</p>
            </div>

            <!-- Ecran de chargement (visible par defaut, masque quand les donnees arrivent) -->
            <div id="loadingScreen" class="mb-16">
                <div class="bg-white text-black border-4 border-black p-12 text-center" style="box-shadow: 10px 10px 0px 0px var(--genesis-yellow);">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-[var(--genesis-yellow)] border-4 border-black rounded-full mb-6">
                        <i class="fas fa-spinner fa-spin text-black text-3xl"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-black italic uppercase mb-4" id="loadingTitle">Chargement de votre espace...</h2>
                    <p class="font-bold text-gray-600 text-base mb-2" id="loadingMessage">Connexion au serveur en cours</p>
                    <p class="text-sm text-gray-400" id="loadingHint">Le serveur peut mettre jusqu'à 30 secondes à démarrer lors de la première connexion.</p>
                    <div class="mt-6">
                        <div style="background: #f0f0f0; height: 8px; border: 2px solid black; max-width: 300px; margin: 0 auto; overflow: hidden;">
                            <div id="loadingProgress" style="background: var(--genesis-yellow); height: 100%; width: 0%; transition: width 1s linear;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bloc d'appel a l'action : paiement de l'acompte requis (cache par defaut) -->
            <div id="depositRequiredSection" class="mb-16" style="display: none;">
                <div class="bg-white text-black border-4 border-black neo-shadow p-8 md:p-12">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 bg-[var(--genesis-yellow)] border-4 border-black rounded-full mb-6">
                            <i class="fas fa-lock text-black text-4xl"></i>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-black italic uppercase mb-4">Votre espace est presque prêt !</h2>
                        <p class="text-lg font-bold text-gray-700 max-w-xl mx-auto">
                            Pour accéder à votre espace client et démarrer votre <span id="depositOfferTypeLabel">accompagnement</span>,
                            il vous suffit de régler l'acompte de 30%.
                        </p>
                    </div>

                    <div class="bg-black text-white p-6 border-4 border-black mb-8 max-w-lg mx-auto">
                        <div class="flex items-center gap-4 mb-4">
                            <i class="fas fa-info-circle text-[var(--genesis-yellow)] text-2xl"></i>
                            <p class="font-bold text-base" id="depositOfferName">Offre sélectionnée</p>
                        </div>
                        <ul class="space-y-3 text-sm">
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-[var(--genesis-yellow)] mt-1"></i>
                                <span>L'acompte confirme votre inscription et déclenche le démarrage de votre projet.</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-[var(--genesis-yellow)] mt-1"></i>
                                <span>Vous aurez accès à votre tableau de bord, vos livrables et votre suivi personnalisé.</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-[var(--genesis-yellow)] mt-1"></i>
                                <span>Un conseiller FA Genesis vous contactera sous 24 à 48h après le paiement.</span>
                            </li>
                        </ul>
                    </div>

                    <div class="text-center" id="depositCTAContainer">
                        <a href="payment.html" id="depositPayButton" class="neo-btn-yellow px-10 py-5 text-xl uppercase inline-block mb-4">
                            <i class="fas fa-credit-card mr-3"></i>Payer l'acompte (30%)
                        </a>
                        <p class="text-sm text-gray-500 mt-4" id="depositAmountInfo">
                            <i class="fas fa-shield-alt mr-1"></i> Paiement sécurisé par SumUp — Le solde (70%) sera dû après livraison.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Statut de paiement -->
            <div id="paymentStatusSection" class="mb-16" style="display: none;">
                <!-- Le contenu sera inséré par JavaScript -->
            </div>

            <!-- Contenu principal du dashboard (cache par defaut, affiche par JS apres chargement) -->
            <div id="dashboardMainContent" style="display: none;">

            <!-- Statistiques principales -->
            <div class="grid md:grid-cols-3 gap-8 mb-16">
                <div class="stat-card">
                    <div class="text-sm font-black uppercase mb-2 opacity-70">Votre offre</div>
                    <div class="text-3xl font-black italic" id="offreName">Chargement...</div>
                    <div class="text-xs font-bold uppercase mt-1" id="offreType">-</div>
                </div>

                <div class="stat-card" id="progressCard">
                    <div class="text-sm font-black uppercase mb-2 opacity-70">Étape actuelle</div>
                    <div class="text-3xl font-black italic">En attente</div>
                    <div class="text-xs font-bold uppercase mt-1">Démarrage après paiement</div>
                </div>

                <div class="stat-card">
                    <div class="text-sm font-black uppercase mb-2 opacity-70">Progression</div>
                    <div class="text-3xl font-black italic" id="progressPercent">0%</div>
                    <div class="text-xs font-bold uppercase mt-1">Votre parcours</div>
                </div>
            </div>

            <!-- Section planification date de debut (affichee si acompte paye et start_date null) -->
            <div id="scheduleStartSection" class="mb-16" style="display: none;">
                <div class="bg-white text-black border-4 border-black p-8 md:p-12" style="box-shadow: 10px 10px 0px 0px var(--genesis-yellow);">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-[var(--genesis-yellow)] border-4 border-black rounded-full flex-shrink-0">
                            <i class="fas fa-calendar-alt text-black text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-black italic uppercase" id="scheduleTitle">Planifiez votre d\u00e9marrage</h2>
                            <p class="font-bold text-gray-600 text-sm" id="scheduleSubtitle">Choisissez la date de d\u00e9but de votre accompagnement</p>
                        </div>
                    </div>

                    <!-- Formulaire de choix de date -->
                    <div id="scheduleFormBlock">
                        <p class="font-bold text-gray-700 mb-4">
                            S\u00e9lectionnez une date pour d\u00e9marrer votre parcours. L'\u00e9quipe FA GENESIS et votre partenaire confirmeront leur disponibilit\u00e9.
                        </p>
                        <div class="flex flex-col md:flex-row items-start md:items-end gap-4">
                            <div>
                                <label class="font-black text-xs uppercase block mb-2 text-gray-600">Date souhait\u00e9e (minimum demain)</label>
                                <input type="date" id="startDatePicker" class="p-3 text-lg font-bold w-full"
                                       style="border: 4px solid black; background: white; color: black; min-width: 220px;" />
                            </div>
                            <button onclick="submitStartDate()" id="submitStartDateBtn"
                                    class="neo-btn-yellow px-8 py-3 text-base uppercase whitespace-nowrap">
                                <i class="fas fa-check mr-2"></i>CONFIRMER MA DATE
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            <i class="fas fa-info-circle mr-1"></i> Apr\u00e8s votre choix, l'admin et le partenaire doivent confirmer avant le lancement.
                        </p>
                    </div>

                    <!-- En attente de confirmation -->
                    <div id="schedulePendingBlock" style="display: none;">
                        <div class="flex items-center gap-4 p-6 border-4 border-black" style="background: #FFF9E6;">
                            <i class="fas fa-clock text-4xl" style="color: var(--genesis-yellow);"></i>
                            <div>
                                <p class="font-black text-xl">Date propos\u00e9e : <span id="proposedDateDisplay" class="text-[var(--genesis-yellow)]"></span></p>
                                <p class="text-gray-600 font-bold">En attente de confirmation par l'\u00e9quipe FA GENESIS.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Date confirmee -->
                    <div id="scheduleConfirmedBlock" style="display: none;">
                        <div class="flex items-center gap-4 p-6 border-4 border-black" style="background: #e8f5e9;">
                            <i class="fas fa-check-circle text-4xl text-green-600"></i>
                            <div>
                                <p class="font-black text-xl">Date confirm\u00e9e : <span id="confirmedDateDisplay" class="text-green-700"></span></p>
                                <p class="text-gray-600 font-bold" id="scheduleConfirmedMsg">Votre parcours est planifi\u00e9 !</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barre de progression -->
            <div class="mb-16">
                <h2 class="text-2xl font-black italic uppercase mb-6 text-white">Votre avancement</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%;">
                        <span id="progressBarText">0%</span>
                    </div>
                </div>
                <p class="text-sm font-bold mt-4 text-white" id="progressMessage">Votre accompagnement n'a pas encore démarré.</p>
            </div>

            <!-- Section workflow de livraison (prestation_individuelle uniquement) -->
            <div id="deliveryWorkflowSection" class="mb-16" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-8 text-white">
                    <i class="fas fa-shipping-fast mr-4"></i>Suivi de votre prestation
                </h2>
                <div class="space-y-6" id="deliveryStepsContainer">
                </div>
            </div>

            <!-- Timeline projet IA (affichee uniquement si un projet existe) -->
            <div id="projectTimelineSection" style="display:none;" class="mb-16">
                <h2 class="text-2xl font-black italic uppercase mb-8 text-white">
                    <i class="fas fa-project-diagram mr-3" style="color:var(--genesis-yellow);"></i>Timeline de votre projet
                </h2>
                <div id="projectTimelineContent">
                    <p class="text-white opacity-50">Chargement...</p>
                </div>
            </div>

            <!-- Actions rapides (contenu par defaut en HTML, mis a jour par JS) -->
            <div class="mb-16">
                <h2 class="text-2xl font-black italic uppercase mb-8 text-white">Actions rapides</h2>
                <div id="quickActionsContainer" class="grid md:grid-cols-2 gap-6">
                    <a href="livrables.html" class="neo-btn-white p-8 block text-center">
                        <i class="fas fa-file-download text-4xl mb-4"></i>
                        <div class="text-xl font-black italic uppercase">Mes livrables</div>
                        <div class="text-sm font-bold mt-2 opacity-70">Téléchargez vos documents</div>
                    </a>

                    <a href="seances.html" class="neo-btn-white p-8 block text-center">
                        <i class="fas fa-calendar-alt text-4xl mb-4"></i>
                        <div class="text-xl font-black italic uppercase">Mes séances</div>
                        <div class="text-sm font-bold mt-2 opacity-70">Consultez votre planning</div>
                    </a>

                    <a href="mon-compte.html" class="neo-btn-white p-8 block text-center">
                        <i class="fas fa-user-circle text-4xl mb-4"></i>
                        <div class="text-xl font-black italic uppercase">Mon compte</div>
                        <div class="text-sm font-bold mt-2 opacity-70">Gérez vos informations</div>
                    </a>

                    <a href="contact.html" class="neo-btn-white p-8 block text-center">
                        <i class="fas fa-envelope text-4xl mb-4"></i>
                        <div class="text-xl font-black italic uppercase">Contact</div>
                        <div class="text-sm font-bold mt-2 opacity-70">Contactez notre équipe</div>
                    </a>
                </div>
            </div>

            <!-- Message d'encouragement -->
            <div class="bg-[var(--genesis-yellow)] text-black p-8 neo-border text-center">
                <h3 class="text-2xl font-black italic uppercase mb-4">Besoin d'aide ?</h3>
                <p class="font-bold mb-6">Notre équipe est là pour vous accompagner à chaque étape</p>
                <a href="contact.html" class="inline-block bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition">
                    Contactez-nous
                </a>
            </div>

            </div><!-- fin dashboardMainContent -->

        </div>
    </section>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="offers-config.js"></script>
    <script src="payment-system.js"></script>
    <script>
        // v4 - Dashboard FA GENESIS (async-first, pas de race condition)
        console.log('[DASHBOARD] v4 - Demarrage');

        var API_BASE_URL = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';

        // Fonction utilitaire pour afficher une erreur visible
        function showDashboardError(msg) {
            console.error('[DASHBOARD] ERREUR:', msg);
            var el = document.getElementById('dashboardError');
            if (el) {
                el.style.display = 'block';
                el.textContent = 'Erreur: ' + msg;
            }
        }

        // Protection de la page
        try {
            if (typeof requireAuth === 'function') {
                requireAuth();
            } else {
                var hasSession = localStorage.getItem('fa_genesis_session');
                var hasToken = localStorage.getItem('fa_genesis_token');
                if (!hasSession || !hasToken) {
                    window.location.href = 'login.html';
                }
            }
        } catch (authErr) {
            showDashboardError('Erreur authentification: ' + authErr.message);
        }

        // ============================================================
        // INIT ASYNC - Attend les données backend avant d'afficher
        // ============================================================

        // Helper : masquer l'ecran de chargement
        function hideLoadingScreen() {
            var ls = document.getElementById('loadingScreen');
            if (ls) ls.style.display = 'none';
        }

        // Helper : mettre a jour le message de chargement
        function updateLoadingMessage(msg, hint) {
            var el = document.getElementById('loadingMessage');
            if (el) el.textContent = msg;
            var h = document.getElementById('loadingHint');
            if (h && hint) h.textContent = hint;
        }

        // Helper : animer la barre de progression du chargement
        var _loadingInterval = null;
        function startLoadingProgress() {
            var bar = document.getElementById('loadingProgress');
            if (!bar) return;
            var width = 0;
            _loadingInterval = setInterval(function() {
                width += 1;
                if (width > 90) width = 90; // Plafonner a 90% tant que pas fini
                bar.style.width = width + '%';
            }, 500);
        }
        function stopLoadingProgress() {
            if (_loadingInterval) clearInterval(_loadingInterval);
            var bar = document.getElementById('loadingProgress');
            if (bar) bar.style.width = '100%';
        }

        // Fonction fetch avec timeout + retry automatique (cold start Render)
        function fetchWithTimeout(url, options, timeoutMs) {
            return new Promise(function(resolve, reject) {
                var controller = new AbortController();
                var timer = setTimeout(function() {
                    controller.abort();
                    reject(new Error('Timeout apres ' + timeoutMs + 'ms'));
                }, timeoutMs);

                var fetchOpts = Object.assign({}, options || {}, { signal: controller.signal });
                fetch(url, fetchOpts).then(function(resp) {
                    clearTimeout(timer);
                    resolve(resp);
                }).catch(function(err) {
                    clearTimeout(timer);
                    reject(err);
                });
            });
        }

        async function fetchWithRetry(url, options, maxRetries) {
            var retries = maxRetries || 3;
            var timeoutPerAttempt = 15000; // 15 secondes par tentative

            for (var attempt = 1; attempt <= retries; attempt++) {
                try {
                    updateLoadingMessage(
                        attempt === 1 ? 'Connexion au serveur...' : 'Le serveur démarre... (tentative ' + attempt + '/' + retries + ')',
                        attempt === 1 ? 'Première connexion, veuillez patienter quelques secondes.' : 'Le serveur se réveille, merci de patienter.'
                    );

                    var resp = await fetchWithTimeout(url, options, timeoutPerAttempt);
                    if (resp.ok) return await resp.json();

                    // Si 502/503 (Render en cours de demarrage), on retry
                    if (resp.status >= 500 && attempt < retries) {
                        console.log('[DASHBOARD] Serveur erreur ' + resp.status + ', tentative ' + attempt + '/' + retries);
                        await new Promise(function(r) { setTimeout(r, 3000); });
                        continue;
                    }
                    return null;
                } catch (err) {
                    console.log('[DASHBOARD] Fetch erreur, tentative ' + attempt + '/' + retries + ':', err.message);
                    if (attempt < retries) {
                        await new Promise(function(r) { setTimeout(r, 3000); });
                    } else {
                        return null;
                    }
                }
            }
            return null;
        }

        (async function initDashboard() {
            try {
                // 1. Récupérer l'utilisateur depuis localStorage
                var user = null;
                if (typeof getCurrentUser === 'function') {
                    user = getCurrentUser();
                } else {
                    var rawSession = localStorage.getItem('fa_genesis_session');
                    if (rawSession) user = JSON.parse(rawSession);
                }

                if (!user) {
                    console.warn('[DASHBOARD] Aucun utilisateur dans la session');
                    hideLoadingScreen();
                    var offreEl = document.getElementById('offreName');
                    if (offreEl) offreEl.textContent = 'Non connecté';
                    var mainCont0 = document.getElementById('dashboardMainContent');
                    if (mainCont0) mainCont0.style.display = '';
                    return;
                }

                console.log('[DASHBOARD] Utilisateur:', user.email);

                // 2. Afficher le nom immédiatement
                var welcomeEl = document.getElementById('welcomeTitle');
                if (welcomeEl) welcomeEl.textContent = 'Bienvenue ' + (user.prenom || '');
                var greetEl = document.getElementById('userGreeting');
                if (greetEl) greetEl.textContent = user.prenom || '';

                // ============================================================
                // STRATEGIE : Affichage IMMEDIAT depuis localStorage
                // puis mise a jour en arriere-plan quand le backend repond
                // ============================================================

                var token = localStorage.getItem('fa_genesis_token');
                var localPayStatus = user.paymentStatus || user.payment_status || '';
                var isLocallyPaid = (localPayStatus === 'deposit_paid' || localPayStatus === 'fully_paid' || localPayStatus === 'delivery_pending_payment');

                // 3. AFFICHAGE IMMEDIAT : Si localStorage dit "paye", afficher le dashboard tout de suite
                if (isLocallyPaid) {
                    console.log('[DASHBOARD] localStorage indique paiement (' + localPayStatus + ') - affichage immediat');
                    hideLoadingScreen();

                    var mainContImmediate = document.getElementById('dashboardMainContent');
                    if (mainContImmediate) mainContImmediate.style.display = '';

                    // Determiner l'offre depuis localStorage
                    var offerId = user.activeOfferId || user.offre;
                    var offerDetails = null;
                    var productType = user.productType || user.product_type || 'accompagnement';

                    if (offerId && typeof getOfferById === 'function') {
                        offerDetails = getOfferById(offerId);
                    }
                    if (offerDetails && offerDetails.productType) {
                        productType = offerDetails.productType;
                    }

                    // Mettre a jour les cartes avec les infos locales
                    var offreNameEl = document.getElementById('offreName');
                    var offreTypeEl = document.getElementById('offreType');
                    if (offerDetails) {
                        if (offreNameEl) offreNameEl.textContent = offerDetails.nom;
                        if (offreTypeEl) offreTypeEl.textContent = offerDetails.categorie || (productType === 'prestation_individuelle' ? 'Prestation individuelle' : 'Accompagnement');
                    } else if (offerId) {
                        if (offreNameEl) offreNameEl.textContent = offerId;
                    }

                    // Afficher statut de paiement
                    try { displayPaymentStatus(user.email); } catch (e) {
                        var paySection = document.getElementById('paymentStatusSection');
                        if (paySection) {
                            paySection.style.display = 'block';
                            paySection.innerHTML = '<div class="p-8 neo-border" style="background: #51cf66; color: #000;"><div class="flex items-center gap-4"><i class="fas fa-check-circle text-4xl"></i><div><h3 class="text-2xl font-black italic uppercase">STATUT DE PAIEMENT</h3><p class="font-bold text-lg">Acompte payé</p></div></div></div>';
                        }
                    }

                    renderQuickActions(productType);
                    renderProgressCard(user, productType, 0, 0, null);
                    renderProgressBar(user, productType, 0, 0);

                    // Afficher un bandeau "synchronisation en cours"
                    var syncBanner = document.createElement('div');
                    syncBanner.id = 'syncBanner';
                    syncBanner.innerHTML = '<div class="p-4 mb-8 text-center" style="background: #333; border: 2px solid var(--genesis-yellow); color: white;"><i class="fas fa-sync fa-spin mr-2" style="color: var(--genesis-yellow);"></i><span class="font-bold text-sm">Synchronisation avec le serveur en cours... Le calendrier de planification apparaitra dans quelques instants.</span></div>';
                    var schedSec = document.getElementById('scheduleStartSection');
                    if (schedSec && schedSec.parentNode) {
                        schedSec.parentNode.insertBefore(syncBanner, schedSec);
                    }
                }

                // 4. APPELS BACKEND EN ARRIERE-PLAN (avec retry + timeout)
                startLoadingProgress();
                var orders = [];
                var freshUser = null;

                try {
                    var results = await Promise.all([
                        fetchWithRetry(API_BASE_URL + '/api/auth/me', {
                            headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                        }, 4),
                        fetchWithRetry(API_BASE_URL + '/api/client/orders?email=' + encodeURIComponent(user.email), {}, 4)
                    ]);

                    // Résultat /api/auth/me
                    if (results[0] && results[0].success && results[0].user) {
                        freshUser = results[0].user;
                        if (freshUser.paymentStatus) user.paymentStatus = freshUser.paymentStatus;
                        if (freshUser.payment_status) user.payment_status = freshUser.payment_status;
                        if (freshUser.activeOrderId) user.activeOrderId = freshUser.activeOrderId;
                        if (freshUser.activeOfferId) user.activeOfferId = freshUser.activeOfferId;
                        if (freshUser.offre) user.offre = freshUser.offre;
                        localStorage.setItem('fa_genesis_session', JSON.stringify(user));
                        console.log('[DASHBOARD] Sync /api/auth/me OK - paymentStatus:', user.paymentStatus);
                    }

                    // Résultat /api/client/orders
                    var rawOrders = results[1];
                    if (rawOrders) {
                        orders = Array.isArray(rawOrders) ? rawOrders : (rawOrders.orders || []);
                    }
                    console.log('[DASHBOARD] Orders récupérées:', orders.length);

                } catch (fetchErr) {
                    console.warn('[DASHBOARD] Erreur fetch backend:', fetchErr.message);
                }

                // Retirer le bandeau de synchro et l'ecran de chargement
                stopLoadingProgress();
                hideLoadingScreen();
                var syncEl = document.getElementById('syncBanner');
                if (syncEl) syncEl.remove();

                // 4. Chercher une commande payée
                var paidOrder = orders.find(function(o) { return o.deposit_paid === true; });
                var pendingOrder = orders.find(function(o) { return !o.deposit_paid; });

                // 5. Déterminer l'offre et le type de produit
                var offerId = user.activeOfferId || user.offre;
                var offerDetails = null;
                var productType = 'accompagnement';

                if (offerId && typeof getOfferById === 'function') {
                    offerDetails = getOfferById(offerId);
                }

                // Si on a une commande payée, prioriser ses infos
                if (paidOrder) {
                    if (!offerDetails && paidOrder.product_id && typeof getOfferById === 'function') {
                        offerDetails = getOfferById(paidOrder.product_id);
                    }
                    if (paidOrder.product_type) {
                        productType = paidOrder.product_type;
                    }
                }

                if (!paidOrder && offerDetails) {
                    productType = offerDetails.productType || 'accompagnement';
                }

                productType = user.productType || user.product_type || productType;
                console.log('[DASHBOARD] Offre:', offerId, offerDetails ? offerDetails.nom : 'non trouvée', '| Type:', productType);

                // 6. Mettre à jour les cartes statistiques avec données fraîches
                var offreNameEl = document.getElementById('offreName');
                var offreTypeEl = document.getElementById('offreType');

                if (offerDetails) {
                    if (offreNameEl) offreNameEl.textContent = offerDetails.nom;
                    if (offreTypeEl) offreTypeEl.textContent = offerDetails.categorie || (productType === 'prestation_individuelle' ? 'Prestation individuelle' : 'Accompagnement');
                } else if (paidOrder && paidOrder.product_name) {
                    if (offreNameEl) offreNameEl.textContent = paidOrder.product_name;
                    if (offreTypeEl) offreTypeEl.textContent = productType === 'prestation_individuelle' ? 'Prestation individuelle' : 'Accompagnement';
                } else if (offerId) {
                    if (offreNameEl) offreNameEl.textContent = offerId;
                    if (offreTypeEl) offreTypeEl.textContent = '-';
                } else {
                    if (offreNameEl) offreNameEl.textContent = 'Aucune offre';
                    if (offreTypeEl) offreTypeEl.textContent = '-';
                }

                // 7. Décider : CTA acompte ou dashboard normal
                // Fallback : si le backend n'a pas repondu mais localStorage dit deposit_paid
                var localPayStatus = user.paymentStatus || user.payment_status || '';
                var isLocallyPaid = (localPayStatus === 'deposit_paid' || localPayStatus === 'fully_paid' || localPayStatus === 'delivery_pending_payment');

                if (!paidOrder && isLocallyPaid) {
                    // Le backend n'a pas repondu mais on sait que l'acompte est paye
                    // Afficher le dashboard avec les infos du localStorage
                    console.log('[DASHBOARD] Backend non disponible mais localStorage indique paiement - affichage dashboard');
                    var mainContFallback = document.getElementById('dashboardMainContent');
                    if (mainContFallback) mainContFallback.style.display = '';

                    if (offerDetails) {
                        if (offreNameEl) offreNameEl.textContent = offerDetails.nom;
                        if (offreTypeEl) offreTypeEl.textContent = offerDetails.categorie || 'Accompagnement';
                    } else if (offerId) {
                        if (offreNameEl) offreNameEl.textContent = offerId;
                    }

                    // Afficher un message d'avertissement
                    var paySection = document.getElementById('paymentStatusSection');
                    if (paySection) {
                        paySection.style.display = 'block';
                        paySection.innerHTML = '<div class="p-6 neo-border" style="background: #ffd43b; color: #000;"><div class="flex items-center gap-4"><i class="fas fa-exclamation-triangle text-3xl"></i><div><h3 class="text-xl font-black italic uppercase">CONNEXION SERVEUR LENTE</h3><p class="font-bold">Votre acompte est bien confirmé. Le serveur met du temps à répondre — votre espace se chargera complètement d\'ici quelques instants.</p><button onclick="location.reload()" class="mt-3 bg-black text-white px-6 py-2 font-black text-sm uppercase border-2 border-black">Recharger la page</button></div></div></div>';
                    }

                    renderQuickActions(productType);
                    return;
                }

                if (!paidOrder) {
                    // Pas de commande payée → afficher le bloc CTA acompte
                    console.log('[DASHBOARD] Aucune commande payée - affichage CTA acompte');

                    var depositSection = document.getElementById('depositRequiredSection');
                    var mainContent = document.getElementById('dashboardMainContent');
                    var payStatusSection = document.getElementById('paymentStatusSection');

                    if (depositSection) {
                        depositSection.style.display = 'block';
                        var typeLabel = document.getElementById('depositOfferTypeLabel');
                        var offerNameLabel = document.getElementById('depositOfferName');
                        if (offerDetails) {
                            if (typeLabel) typeLabel.textContent = offerDetails.productType === 'prestation_individuelle' ? 'prestation' : 'accompagnement';
                            if (offerNameLabel) offerNameLabel.textContent = offerDetails.nom;
                        } else if (offerId) {
                            if (offerNameLabel) offerNameLabel.textContent = offerId;
                        }
                    }
                    if (mainContent) mainContent.style.display = 'none';
                    if (payStatusSection) payStatusSection.style.display = 'none';

                    // Personnaliser le CTA si une commande en attente existe
                    if (pendingOrder) {
                        var payBtn = document.getElementById('depositPayButton');
                        var offerNameEl2 = document.getElementById('depositOfferName');
                        var typeLabel2 = document.getElementById('depositOfferTypeLabel');
                        var amountInfo = document.getElementById('depositAmountInfo');

                        if (offerNameEl2 && pendingOrder.product_name) {
                            offerNameEl2.textContent = pendingOrder.product_name;
                        }
                        if (amountInfo && pendingOrder.deposit_amount) {
                            amountInfo.innerHTML = '<i class="fas fa-shield-alt mr-1"></i> Acompte : <strong>' + pendingOrder.deposit_amount.toFixed(2) + ' \u20ac</strong> \u2014 Paiement sécurisé par SumUp.';
                        }
                        if (typeLabel2) {
                            typeLabel2.textContent = pendingOrder.product_type === 'prestation_individuelle' ? 'prestation' : 'accompagnement';
                        }

                        // Commande devis
                        if (pendingOrder.source === 'quote' && pendingOrder.quote_id) {
                            try {
                                var qResp = await fetch(API_BASE_URL + '/api/quotes/by-order/' + encodeURIComponent(pendingOrder.id), {
                                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                                });
                                if (qResp.ok) {
                                    var quoteData = await qResp.json();
                                    if (quoteData && quoteData.acceptance_token && payBtn) {
                                        payBtn.href = 'quote-accept.html?token=' + encodeURIComponent(quoteData.acceptance_token);
                                        payBtn.innerHTML = '<i class="fas fa-credit-card mr-3"></i>Payer l\'acompte du devis (' + pendingOrder.deposit_amount.toFixed(2) + ' \u20ac)';
                                    }
                                }
                            } catch (qErr) {
                                console.error('[DASHBOARD] Erreur récupération token devis:', qErr);
                            }
                        } else if (payBtn && pendingOrder.deposit_amount) {
                            payBtn.innerHTML = '<i class="fas fa-credit-card mr-3"></i>Payer l\'acompte (' + pendingOrder.deposit_amount.toFixed(2) + ' \u20ac)';
                        }
                    }

                    return; // Fin - on ne montre pas le dashboard complet
                }

                // 8. Acompte payé → Mettre à jour localStorage et afficher le dashboard
                console.log('[DASHBOARD] Commande payée trouvée:', paidOrder.id);
                var newPayStatus = paidOrder.balance_paid ? 'fully_paid' : 'deposit_paid';
                user.paymentStatus = newPayStatus;
                user.payment_status = newPayStatus;
                user.activeOrderId = paidOrder.id;
                localStorage.setItem('fa_genesis_session', JSON.stringify(user));

                // Masquer le CTA acompte, afficher le contenu principal
                var depositSec = document.getElementById('depositRequiredSection');
                if (depositSec) depositSec.style.display = 'none';
                var mainCont = document.getElementById('dashboardMainContent');
                if (mainCont) mainCont.style.display = '';

                // 9. Afficher le statut de paiement
                try {
                    displayPaymentStatus(user.email);
                } catch (payErr) {
                    console.error('[DASHBOARD] Erreur statut paiement:', payErr);
                    var paySection = document.getElementById('paymentStatusSection');
                    if (paySection) {
                        paySection.style.display = 'block';
                        paySection.innerHTML = '<div class="p-8 neo-border" style="background: #51cf66; color: #000;"><div class="flex items-center gap-4"><i class="fas fa-check-circle text-4xl"></i><div><h3 class="text-2xl font-black italic uppercase">STATUT DE PAIEMENT</h3><p class="font-bold text-lg">Acompte payé</p></div></div></div>';
                    }
                }

                // 10. Planification date de demarrage + Actions rapides et progression
                showScheduleSection(paidOrder, productType);
                renderQuickActions(productType);
                renderProgressCard(user, productType, 0, 0, paidOrder);
                renderProgressBar(user, productType, 0, 0);

                if (productType === 'accompagnement') {
                    loadDashboardFromBackend(user, productType, paidOrder);
                } else {
                    try { renderDeliveryWorkflow(user); } catch (wfErr) { console.error('[DASHBOARD] Erreur workflow:', wfErr); }
                }

            } catch (globalErr) {
                stopLoadingProgress();
                hideLoadingScreen();
                showDashboardError(globalErr.message);
                // Afficher le contenu principal pour que l'erreur soit visible
                var mainContErr = document.getElementById('dashboardMainContent');
                if (mainContErr) mainContErr.style.display = '';
            }
        })();

        // ============================================================
        // FONCTIONS
        // ============================================================

        // Charger le jour courant depuis le backend
        async function loadDashboardFromBackend(user, productType, order) {
            var currentDay = 0;
            var totalDays = 0;
            var freshOrder = order || null;

            try {
                var ordersResp = await fetch(API_BASE_URL + '/api/client/orders?email=' + encodeURIComponent(user.email));
                if (ordersResp.ok) {
                    var orders = await ordersResp.json();
                    var activeOrder = orders.find(function(o) { return o.deposit_paid; });
                    if (activeOrder) {
                        var dashResp = await fetch(API_BASE_URL + '/api/client/dashboard/' + activeOrder.id);
                        if (dashResp.ok) {
                            var dashData = await dashResp.json();
                            currentDay = dashData.currentDay || 0;
                            totalDays = dashData.totalDays || 0;
                            // Enrichir l'order avec les donnees schedule du dashboard API
                            if (freshOrder) {
                                if (dashData.schedule_status) freshOrder.schedule_status = dashData.schedule_status;
                                if (dashData.proposed_start_date) freshOrder.proposed_start_date = dashData.proposed_start_date;
                                if (dashData.start_date) freshOrder.start_date = dashData.start_date;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('[DASHBOARD] Erreur chargement backend:', error);
            }

            renderProgressCard(user, productType, currentDay, totalDays, freshOrder);
            renderProgressBar(user, productType, currentDay, totalDays);
        }

        // Carte de progression
        function renderProgressCard(user, productType, currentDay, totalDays, order) {
            var card = document.getElementById('progressCard');
            if (!card) return;

            // Verifier si on est dans le flow de planification
            var scheduleStatus = order ? (order.schedule_status || '') : '';

            if (scheduleStatus === 'awaiting_client_choice') {
                card.innerHTML = '<div class="text-sm font-black uppercase mb-2 opacity-70">Étape actuelle</div><div class="text-3xl font-black italic">Planification</div><div class="text-xs font-bold uppercase mt-1">Choisissez votre date de démarrage</div>';
                return;
            }
            if (scheduleStatus === 'client_proposed') {
                card.innerHTML = '<div class="text-sm font-black uppercase mb-2 opacity-70">Étape actuelle</div><div class="text-3xl font-black italic">Planification</div><div class="text-xs font-bold uppercase mt-1">En attente de confirmation</div>';
                return;
            }

            if (productType === 'accompagnement') {
                var day = currentDay || 0;
                var total = totalDays || 0;
                var daysRemaining = Math.max(0, total - day);

                if (day > 0 && total > 0) {
                    card.innerHTML = '<div class="text-sm font-black uppercase mb-2 opacity-70">Étape actuelle</div><div class="text-3xl font-black italic">Jour ' + day + '/' + total + '</div><div class="text-xs font-bold uppercase mt-1">' + daysRemaining + ' jour' + (daysRemaining > 1 ? 's' : '') + ' restant' + (daysRemaining > 1 ? 's' : '') + '</div>';
                } else {
                    card.innerHTML = '<div class="text-sm font-black uppercase mb-2 opacity-70">Étape actuelle</div><div class="text-3xl font-black italic">En attente</div><div class="text-xs font-bold uppercase mt-1">Démarrage après paiement</div>';
                }
            } else {
                var deliveryStatus = typeof getDeliveryStatus === 'function' ? getDeliveryStatus(user.email) : 'confirmed';
                var deliverySteps = typeof getDeliverySteps === 'function' ? getDeliverySteps('prestation_individuelle') : [];
                var currentStep = deliverySteps.find(function(s) { return s.id === deliveryStatus; });
                var stepIndex = typeof getDeliveryStepIndex === 'function' ? getDeliveryStepIndex(user.email) : 0;

                card.innerHTML = '<div class="text-sm font-black uppercase mb-2 opacity-70">Statut de livraison</div><div class="text-3xl font-black italic">' + (currentStep ? currentStep.label : 'En cours') + '</div><div class="text-xs font-bold uppercase mt-1">Étape ' + (stepIndex + 1) + '/4</div>';
            }
        }

        // Actions rapides
        function renderQuickActions(productType) {
            var container = document.getElementById('quickActionsContainer');
            if (!container) return;

            if (productType === 'accompagnement') {
                container.innerHTML = '<a href="livrables.html" class="neo-btn-white p-8 block text-center"><i class="fas fa-file-download text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Mes livrables</div><div class="text-sm font-bold mt-2 opacity-70">Téléchargez vos documents</div></a><a href="seances.html" class="neo-btn-white p-8 block text-center"><i class="fas fa-calendar-alt text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Mes séances</div><div class="text-sm font-bold mt-2 opacity-70">Consultez votre planning</div></a><a href="mon-compte.html" class="neo-btn-white p-8 block text-center"><i class="fas fa-user-circle text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Mon compte</div><div class="text-sm font-bold mt-2 opacity-70">Gérez vos informations</div></a><a href="contact.html" class="neo-btn-white p-8 block text-center"><i class="fas fa-envelope text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Contact</div><div class="text-sm font-bold mt-2 opacity-70">Contactez notre équipe</div></a>';
            } else {
                container.innerHTML = '<a href="#deliveryWorkflowSection" class="neo-btn-white p-8 block text-center"><i class="fas fa-receipt text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Voir ma commande</div><div class="text-sm font-bold mt-2 opacity-70">Détails de votre prestation</div></a><a href="#deliveryWorkflowSection" class="neo-btn-white p-8 block text-center"><i class="fas fa-tasks text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Suivre l\'avancement</div><div class="text-sm font-bold mt-2 opacity-70">Où en est votre projet</div></a><a href="livrables.html" class="neo-btn-white p-8 block text-center"><i class="fas fa-download text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Mes livrables</div><div class="text-sm font-bold mt-2 opacity-70">Téléchargez vos fichiers</div></a><a href="mon-compte.html" class="neo-btn-white p-8 block text-center"><i class="fas fa-user-circle text-4xl mb-4"></i><div class="text-xl font-black italic uppercase">Mon compte</div><div class="text-sm font-bold mt-2 opacity-70">Gérez vos informations</div></a>';
            }
        }

        // Barre de progression
        function renderProgressBar(user, productType, currentDay, totalDays) {
            var progress = 0;
            var progressMessage = '';

            if (productType === 'accompagnement') {
                if (currentDay > 0 && totalDays > 0) {
                    progress = Math.round((currentDay / totalDays) * 100);
                }

                if (progress === 0) {
                    progressMessage = 'Votre accompagnement n\'a pas encore démarré.';
                } else if (progress < 25) {
                    progressMessage = 'Vous venez de commencer, continuez sur cette lancée !';
                } else if (progress < 50) {
                    progressMessage = 'Excellent début ! Vous êtes sur la bonne voie.';
                } else if (progress < 75) {
                    progressMessage = 'Vous avez déjà parcouru plus de la moitié du chemin !';
                } else if (progress < 100) {
                    progressMessage = 'Bravo ! Vous approchez de la fin de votre parcours.';
                } else {
                    progressMessage = 'Félicitations ! Votre accompagnement est terminé.';
                }
            } else {
                var stepIndex = typeof getDeliveryStepIndex === 'function' ? getDeliveryStepIndex(user.email) : 0;
                progress = Math.round(((stepIndex + 1) / 4) * 100);

                if (progress === 25) {
                    progressMessage = 'Votre commande est confirmée ! Nous commençons bientôt.';
                } else if (progress === 50) {
                    progressMessage = 'Notre équipe travaille sur votre prestation.';
                } else if (progress === 75) {
                    progressMessage = 'Votre prestation est prête ! Consultez vos livrables.';
                } else if (progress === 100) {
                    progressMessage = 'Prestation livrée ! Téléchargez vos fichiers.';
                }
            }

            var el;
            el = document.getElementById('progressPercent');
            if (el) el.textContent = progress + '%';
            el = document.getElementById('progressBar');
            if (el) el.style.width = progress + '%';
            el = document.getElementById('progressBarText');
            if (el) el.textContent = progress + '%';
            el = document.getElementById('progressMessage');
            if (el) el.textContent = progressMessage;
        }

        // Workflow de livraison
        function renderDeliveryWorkflow(user) {
            var section = document.getElementById('deliveryWorkflowSection');
            var container = document.getElementById('deliveryStepsContainer');
            if (!section || !container) return;

            section.style.display = 'block';

            var currentStatus = typeof getDeliveryStatus === 'function' ? getDeliveryStatus(user.email) : 'confirmed';
            var steps = typeof getDeliverySteps === 'function' ? getDeliverySteps('prestation_individuelle') : [];
            if (!steps || steps.length === 0) return;

            var currentStepIndex = steps.findIndex(function(s) { return s.id === currentStatus; });

            container.innerHTML = steps.map(function(step, index) {
                var isActive = step.id === currentStatus;
                var isPast = currentStepIndex > index;
                var isFuture = !isActive && !isPast;

                var statusClass = isActive ? 'bg-[var(--genesis-yellow)] text-black border-black' :
                                   isPast ? 'bg-green-500 text-white border-black' :
                                   'bg-gray-300 text-gray-600 border-gray-600';

                var cardClass = isActive ? 'neo-shadow' : '';
                var opacityClass = isFuture ? 'opacity-50' : '';

                return '<div class="flex items-start gap-6 ' + opacityClass + '"><div class="' + statusClass + ' w-16 h-16 rounded-full flex items-center justify-center text-2xl font-black border-4 flex-shrink-0">' + (isPast ? '<i class="fas fa-check"></i>' : (index + 1)) + '</div><div class="flex-1 bg-white text-black p-6 border-4 border-black ' + cardClass + '"><h3 class="text-xl font-black uppercase mb-2">' + step.label + (isActive ? ' <span class="ml-2 text-[var(--genesis-yellow)]">EN COURS</span>' : '') + '</h3><p class="font-bold">' + step.description + '</p></div></div>';
            }).join('');
        }

        // Statut de paiement
        function displayPaymentStatus(email) {
            var summary = null;

            if (typeof getPaymentSummary === 'function') {
                summary = getPaymentSummary(email);
            }

            var section = document.getElementById('paymentStatusSection');
            if (!section) return;

            section.style.display = 'block';

            if (!summary) {
                section.innerHTML = '<div class="p-8 neo-border" style="background: #ff6b6b; color: #000;"><div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6"><div class="flex-1"><div class="flex items-center gap-4 mb-4"><i class="fas fa-exclamation-circle text-4xl"></i><div><h3 class="text-2xl font-black italic uppercase">STATUT DE PAIEMENT</h3><p class="font-bold text-lg">Compte créé - En attente de paiement</p></div></div><p class="font-bold text-base mb-4">Un acompte de 30% est requis pour démarrer l\'accompagnement.</p></div><a href="payment.html" class="bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition whitespace-nowrap">Payer l\'acompte (30%) <i class="fas fa-arrow-right ml-2"></i></a></div></div>';
                return;
            }

            var statusConfig = {
                'registered': { bg: '#ff6b6b', icon: 'fa-exclamation-circle', btnText: 'Payer l\'acompte (30%)', showBtn: true },
                'deposit_paid': { bg: '#51cf66', icon: 'fa-check-circle', btnText: '', showBtn: false },
                'delivery_pending_payment': { bg: '#ffd43b', icon: 'fa-clock', btnText: 'Payer le solde (70%)', showBtn: true },
                'fully_paid': { bg: '#4dabf7', icon: 'fa-star', btnText: '', showBtn: false }
            };

            var config = statusConfig[summary.status] || statusConfig['registered'];

            var html = '<div class="p-8 neo-border" style="background: ' + config.bg + '; color: #000;"><div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6"><div class="flex-1"><div class="flex items-center gap-4 mb-4"><i class="fas ' + config.icon + ' text-4xl"></i><div><h3 class="text-2xl font-black italic uppercase">STATUT DE PAIEMENT</h3><p class="font-bold text-lg">' + summary.statusLabel + '</p></div></div><p class="font-bold text-base mb-4">' + summary.accessRights.message + '</p>';

            if (summary.activeOffer && summary.activeOffer.prixTotal > 0) {
                html += '<div class="grid md:grid-cols-3 gap-4 mt-4 p-4 bg-black/10 border-4 border-black"><div><p class="text-xs font-bold opacity-70 uppercase">Offre</p><p class="font-black">' + summary.activeOffer.nom + '</p></div><div><p class="text-xs font-bold opacity-70 uppercase">Total payé</p><p class="font-black text-xl">' + summary.totalPaid + '\u20ac</p></div><div><p class="text-xs font-bold opacity-70 uppercase">Prix total</p><p class="font-black text-xl">' + summary.activeOffer.prixTotal + '\u20ac</p></div></div>';
            }

            html += '</div>';

            if (config.showBtn) {
                html += '<a href="payment.html" class="bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition whitespace-nowrap">' + config.btnText + ' <i class="fas fa-arrow-right ml-2"></i></a>';
            }

            html += '</div></div>';
            section.innerHTML = html;
        }

        // ============================================================
        // PLANIFICATION DATE DE DEMARRAGE
        // ============================================================

        // Variable globale pour stocker l'orderId actif (utilisee par submitStartDate)
        var _scheduleOrderId = null;

        function formatDateFr(dateStr) {
            try {
                var jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
                var mois = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
                var d = new Date(dateStr + 'T00:00:00');
                if (isNaN(d.getTime())) return dateStr;
                return jours[d.getDay()] + ' ' + d.getDate() + ' ' + mois[d.getMonth()] + ' ' + d.getFullYear();
            } catch (e) {
                return dateStr;
            }
        }

        function showScheduleSection(order, productType) {
            var section = document.getElementById('scheduleStartSection');
            if (!section) return;

            var status = order.schedule_status || '';
            var startDate = order.start_date;

            // Si start_date existe deja et schedule confirmee, pas besoin du calendrier
            if (startDate && status === 'confirmed') {
                section.style.display = 'block';
                var formBlock = document.getElementById('scheduleFormBlock');
                var pendingBlock = document.getElementById('schedulePendingBlock');
                var confirmedBlock = document.getElementById('scheduleConfirmedBlock');
                if (formBlock) formBlock.style.display = 'none';
                if (pendingBlock) pendingBlock.style.display = 'none';
                if (confirmedBlock) confirmedBlock.style.display = 'block';

                var confirmedDisplay = document.getElementById('confirmedDateDisplay');
                if (confirmedDisplay) confirmedDisplay.textContent = formatDateFr(startDate);

                var msg = document.getElementById('scheduleConfirmedMsg');
                if (msg) {
                    msg.textContent = productType === 'prestation_individuelle'
                        ? 'Votre prestation est planifiée !'
                        : 'Votre parcours est planifié !';
                }
                return;
            }

            // Si start_date existe deja sans schedule_status (ancienne commande), ne pas afficher
            if (startDate && !status) return;

            // Si pas de schedule_status du tout et pas de start_date, ne pas afficher
            if (!status && !startDate) return;

            // Stocker l'orderId pour submitStartDate
            _scheduleOrderId = order.id;

            section.style.display = 'block';

            // Adapter titre selon type
            var title = document.getElementById('scheduleTitle');
            var subtitle = document.getElementById('scheduleSubtitle');
            if (productType === 'prestation_individuelle') {
                if (title) title.textContent = 'Planifiez votre prestation';
                if (subtitle) subtitle.textContent = 'Choisissez la date de votre prestation';
            } else {
                if (title) title.textContent = 'Planifiez votre démarrage';
                if (subtitle) subtitle.textContent = 'Choisissez la date de début de votre accompagnement';
            }

            var formBlock = document.getElementById('scheduleFormBlock');
            var pendingBlock = document.getElementById('schedulePendingBlock');
            var confirmedBlock = document.getElementById('scheduleConfirmedBlock');

            if (status === 'awaiting_client_choice') {
                // Afficher le formulaire de choix de date
                if (formBlock) formBlock.style.display = 'block';
                if (pendingBlock) pendingBlock.style.display = 'none';
                if (confirmedBlock) confirmedBlock.style.display = 'none';

                // Mettre le min du date picker a demain
                var picker = document.getElementById('startDatePicker');
                if (picker) {
                    var tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    var y = tomorrow.getFullYear();
                    var m = (tomorrow.getMonth() + 1).toString();
                    if (m.length < 2) m = '0' + m;
                    var dd = tomorrow.getDate().toString();
                    if (dd.length < 2) dd = '0' + dd;
                    picker.min = y + '-' + m + '-' + dd;
                }

            } else if (status === 'client_proposed') {
                // Date proposee, en attente de confirmation
                if (formBlock) formBlock.style.display = 'none';
                if (pendingBlock) pendingBlock.style.display = 'block';
                if (confirmedBlock) confirmedBlock.style.display = 'none';

                var proposedDisplay = document.getElementById('proposedDateDisplay');
                if (proposedDisplay && order.proposed_start_date) {
                    proposedDisplay.textContent = formatDateFr(order.proposed_start_date);
                }

            } else if (status === 'confirmed') {
                // Deja gere plus haut, mais au cas ou
                if (formBlock) formBlock.style.display = 'none';
                if (pendingBlock) pendingBlock.style.display = 'none';
                if (confirmedBlock) confirmedBlock.style.display = 'block';

                var confirmedDisplay2 = document.getElementById('confirmedDateDisplay');
                if (confirmedDisplay2 && order.start_date) {
                    confirmedDisplay2.textContent = formatDateFr(order.start_date);
                }
            }
        }

        async function submitStartDate() {
            var picker = document.getElementById('startDatePicker');
            var btn = document.getElementById('submitStartDateBtn');
            if (!picker || !picker.value) {
                alert('Veuillez sélectionner une date.');
                return;
            }

            if (!_scheduleOrderId) {
                alert('Erreur : commande introuvable. Rechargez la page.');
                return;
            }

            // Desactiver le bouton pendant l'envoi
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi en cours...';
            }

            try {
                var token = localStorage.getItem('fa_genesis_token');
                var resp = await fetch(API_BASE_URL + '/api/orders/' + _scheduleOrderId + '/schedule-start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? ('Bearer ' + token) : ''
                    },
                    body: JSON.stringify({ proposed_date: picker.value })
                });

                var data = await resp.json();

                if (resp.ok && data.success) {
                    // Basculer vers le bloc "en attente"
                    var formBlock = document.getElementById('scheduleFormBlock');
                    var pendingBlock = document.getElementById('schedulePendingBlock');
                    if (formBlock) formBlock.style.display = 'none';
                    if (pendingBlock) pendingBlock.style.display = 'block';

                    var proposedDisplay = document.getElementById('proposedDateDisplay');
                    if (proposedDisplay) proposedDisplay.textContent = formatDateFr(picker.value);

                    // Mettre a jour la carte progression
                    var card = document.getElementById('progressCard');
                    if (card) {
                        card.innerHTML = '<div class="text-sm font-black uppercase mb-2 opacity-70">Étape actuelle</div><div class="text-3xl font-black italic">Planification</div><div class="text-xs font-bold uppercase mt-1">En attente de confirmation</div>';
                    }
                } else {
                    alert('Erreur : ' + (data.error || 'Impossible de soumettre la date.'));
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>CONFIRMER MA DATE';
                    }
                }
            } catch (err) {
                alert('Erreur réseau : ' + err.message);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>CONFIRMER MA DATE';
                }
            }
        }

        // ============================================================
        // MENU MOBILE
        // ============================================================

        var mobileMenuBtn = document.getElementById('mobileMenuBtn');
        var mobileMenu = document.getElementById('mobileMenu');
        var menuLine1 = document.getElementById('menuLine1');
        var menuLine2 = document.getElementById('menuLine2');
        var menuLine3 = document.getElementById('menuLine3');
        var isMenuOpen = false;

        function toggleMobileMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.classList.add('flex');
                menuLine1.style.transform = 'rotate(45deg) translate(5px, 5px)';
                menuLine2.style.opacity = '0';
                menuLine3.style.transform = 'rotate(-45deg) translate(5px, -5px)';
                document.body.style.overflow = 'hidden';
            } else {
                closeMobileMenu();
            }
        }

        function closeMobileMenu() {
            isMenuOpen = false;
            if (mobileMenu) {
                mobileMenu.classList.add('hidden');
                mobileMenu.classList.remove('flex');
            }
            if (menuLine1) menuLine1.style.transform = 'none';
            if (menuLine2) menuLine2.style.opacity = '1';
            if (menuLine3) menuLine3.style.transform = 'none';
            document.body.style.overflow = 'auto';
        }

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', toggleMobileMenu);
        }

        console.log('[DASHBOARD] v3 - Initialisation terminee');

        // ============================================================
        // TIMELINE PROJET IA
        // ============================================================
        (async function loadProjectTimeline() {
            try {
                // Recuperer l'orderId de la commande active
                var orderId = null;
                try {
                    var userData = JSON.parse(localStorage.getItem('fa_genesis_session') || '{}');
                    if (userData.activeOrderId) {
                        orderId = userData.activeOrderId;
                    } else if (userData.email) {
                        var authTk = localStorage.getItem('fa_genesis_token');
                        var ordersResp = await fetch(API_BASE_URL + '/api/client/orders?email=' + encodeURIComponent(userData.email), {
                            headers: authTk ? { 'Authorization': 'Bearer ' + authTk } : {}
                        });
                        if (ordersResp.ok) {
                            var ordersData = await ordersResp.json();
                            var orders = ordersData.orders || ordersData;
                            if (orders && orders.length > 0) {
                                orderId = orders[0].id || orders[0].order_id;
                            }
                        }
                    }
                } catch (e) {}

                if (!orderId) return;

                // Chercher le projet par commande
                var authTk = localStorage.getItem('fa_genesis_token');
                var projResp = await fetch(API_BASE_URL + '/api/projects/by-order/' + orderId, {
                    headers: authTk ? { 'Authorization': 'Bearer ' + authTk } : {}
                });
                if (!projResp.ok) return; // Pas de projet = pas de timeline

                var projData = await projResp.json();
                if (!projData.success || !projData.project) return;
                var project = projData.project;

                // Charger la timeline
                var timeResp = await fetch(API_BASE_URL + '/api/projects/' + project.id + '/timeline', {
                    headers: authTk ? { 'Authorization': 'Bearer ' + authTk } : {}
                });
                if (!timeResp.ok) return;
                var timeData = await timeResp.json();
                var timeline = timeData.timeline || [];
                if (timeline.length === 0) return;

                // Afficher la section
                var section = document.getElementById('projectTimelineSection');
                if (section) section.style.display = 'block';

                var container = document.getElementById('projectTimelineContent');
                if (!container) return;

                var html = '<div class="space-y-4">';
                for (var t = 0; t < timeline.length; t++) {
                    var entry = timeline[t];
                    var step = entry.step || {};
                    var stepStatus = entry.status || 'pending';
                    var bgClass = '';
                    var icon = '';
                    if (stepStatus === 'completed') {
                        bgClass = 'bg-green-500 bg-opacity-20 border-green-400';
                        icon = '<i class="fas fa-check-circle text-green-400 text-2xl"></i>';
                    } else if (stepStatus === 'in_progress') {
                        bgClass = 'bg-yellow-500 bg-opacity-20 border-[var(--genesis-yellow)]';
                        icon = '<i class="fas fa-spinner fa-spin text-[var(--genesis-yellow)] text-2xl"></i>';
                    } else {
                        bgClass = 'bg-white bg-opacity-5 border-white border-opacity-20';
                        icon = '<i class="fas fa-circle text-gray-500 text-2xl"></i>';
                    }

                    html += '<div class="p-4 border-2 ' + bgClass + ' flex items-start gap-4">';
                    html += '<div class="flex-shrink-0 mt-1">' + icon + '</div>';
                    html += '<div class="flex-1">';
                    html += '<div class="font-bold text-white">Jour ' + (step.day_number || '?') + ' - ' + (step.step_name || '') + '</div>';

                    // Livrables publies
                    if (entry.deliverables && entry.deliverables.length > 0) {
                        html += '<div class="mt-2 space-y-1">';
                        for (var dl = 0; dl < entry.deliverables.length; dl++) {
                            var liv = entry.deliverables[dl];
                            var dlIcon = liv.download_url ? '<i class="fas fa-download mr-1"></i>' : '<i class="fas fa-file-alt mr-1"></i>';
                            html += '<div class="text-sm text-white opacity-80">' + dlIcon + (liv.name || '') + '</div>';
                        }
                        html += '</div>';
                    }

                    html += '</div></div>';
                }
                html += '</div>';
                container.innerHTML = html;

            } catch (e) {
                console.error('[DASHBOARD] Erreur timeline:', e);
            }
        })();
    </script>
    <div id="site-footer"></div>
    <script src="footer.js" defer></script>
    <script src="chatbot.js" defer></script>
</body>
</html>
