<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Mes Livrables - FA GENESIS | Espace Client</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }
        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, .nav-link { font-family: 'Unbounded', cursive; }
        .notif-badge { display:inline-block;background:#f44336;color:#fff;font-size:11px;font-weight:900;min-width:18px;height:18px;line-height:18px;text-align:center;border-radius:50%;margin-left:4px;vertical-align:super; }
        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }
        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .livrable-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .livrable-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 14px 14px 0px 0px var(--genesis-yellow);
        }
        .livrable-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--genesis-yellow);
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.7rem;
            margin-bottom: 1rem;
        }
        .download-btn {
            background: black;
            color: white;
            border: 3px solid black;
            padding: 0.75rem 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            margin-top: auto;
        }
        .download-btn:hover { background: var(--genesis-yellow); color: black; }
        .download-btn.disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .download-btn.disabled:hover { background: #999; color: white; }
        .preview-btn {
            background: var(--genesis-yellow);
            color: black;
            border: 3px solid black;
            padding: 0.75rem 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            cursor: pointer;
        }
        .preview-btn:hover { background: #e6c200; }
        .preview-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; padding: 20px;
        }
        .preview-overlay .preview-close {
            position: absolute; top: 20px; right: 30px;
            color: white; font-size: 36px; cursor: pointer;
            font-weight: 900; z-index: 10000;
            background: none; border: none;
        }
        .preview-overlay .preview-close:hover { color: var(--genesis-yellow); }
        .preview-overlay .preview-title {
            color: var(--genesis-yellow); font-weight: 900;
            text-transform: uppercase; font-size: 1rem;
            margin-bottom: 16px; text-align: center;
        }
        .preview-overlay img {
            max-width: 90vw; max-height: 80vh; object-fit: contain;
            border: 4px solid var(--genesis-yellow);
            -webkit-user-select: none; user-select: none;
            -webkit-user-drag: none; pointer-events: auto;
        }
        .preview-overlay video {
            max-width: 90vw; max-height: 80vh;
            border: 4px solid var(--genesis-yellow);
        }
        .preview-overlay iframe {
            width: 90vw; height: 80vh;
            border: 4px solid var(--genesis-yellow); background: white;
        }
        .preview-overlay .preview-no-content {
            color: white; font-size: 1.1rem; text-align: center;
            padding: 40px; border: 4px dashed var(--genesis-yellow);
            max-width: 500px;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: 4px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.75rem;
            cursor: pointer;
            background: white;
            color: black;
            transition: 0.1s;
        }
        .tab-btn.active {
            background: var(--genesis-yellow);
            color: black;
        }
        .empty-state {
            background: white;
            color: black;
            border: 4px dashed black;
            padding: 3rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- NAVIGATION PRIVEE -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-4 md:px-6 py-3 md:py-4 flex justify-between items-center text-white text-xs font-black uppercase">
        <div class="flex items-center">
            <a href="dashboard.html" class="text-lg md:text-2xl font-black tracking-wider text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">FA GENESIS</a>
        </div>
        <div class="hidden md:flex gap-8 text-white font-black">
            <a href="dashboard.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Dashboard</a>
            <a href="livrables.html" class="nav-link text-[var(--genesis-yellow)]">Livrables</a>
            <a href="seances.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Séances</a>
            <a href="mon-compte.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Paramètres</a>
        </div>
        <div class="flex gap-4 items-center">
            <a href="panier.html" class="relative text-white hover:text-[var(--genesis-yellow)] transition px-2 py-2" title="Panier">
                <i class="fas fa-shopping-cart text-lg"></i>
                <span class="panier-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:#f44336;color:#fff;font-size:10px;font-weight:900;min-width:16px;height:16px;line-height:16px;text-align:center;border-radius:50%;"></span>
            </a>
            <span id="userGreeting" class="hidden md:block text-white font-bold"></span>
            <button onclick="logout()" class="border-4 border-white text-white px-3 py-2 text-[10px] tracking-widest font-black hover:bg-white hover:text-black transition">
                <i class="fas fa-sign-out-alt mr-1"></i><span class="hidden md:inline">Déconnexion</span>
            </button>
            <button id="mobileMenuBtn" class="md:hidden flex flex-col gap-1.5 p-2" aria-label="Menu">
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine1"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine2"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine3"></span>
            </button>
        </div>
    </nav>

    <!-- Menu Mobile -->
    <div id="mobileMenu" class="fixed inset-0 z-40 bg-black/98 backdrop-blur-lg hidden flex-col items-center justify-center gap-8 text-white font-black uppercase">
        <a href="dashboard.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)]">Dashboard</a>
        <a href="livrables.html" class="text-2xl nav-link text-[var(--genesis-yellow)]">Livrables</a>
        <a href="seances.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)]">Séances</a>
        <a href="mon-compte.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)]">Paramètres</a>
        <a href="panier.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)] transition flex items-center gap-2"><i class="fas fa-shopping-cart"></i>Panier</a>
        <div class="mt-8">
            <button onclick="logout()" class="neo-btn-yellow px-8 py-4 text-sm tracking-widest text-black font-black">
                <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
            </button>
        </div>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <section class="min-h-screen pt-32 pb-20 px-6 bg-black">
        <div class="container mx-auto max-w-6xl">

            <!-- Titre -->
            <div class="mb-12">
                <h1 class="text-5xl md:text-7xl font-black italic uppercase mb-4 text-[var(--genesis-yellow)]">
                    <i class="fas fa-file-download mr-4"></i>Mes livrables
                </h1>
                <p class="text-xl font-bold uppercase text-white">Documents, photos et videos de votre projet</p>
            </div>

            <!-- Loader -->
            <div id="livrablesLoader" class="mb-8">
                <div class="flex items-center gap-4 p-6" style="background: #222; border: 2px solid var(--genesis-yellow);">
                    <i class="fas fa-spinner fa-spin text-[var(--genesis-yellow)] text-2xl"></i>
                    <span class="font-bold text-white text-base">Chargement des livrables...</span>
                </div>
            </div>

            <!-- Erreur -->
            <div id="livrablesError" class="mb-8" style="display: none;">
                <div class="p-6 border-4 border-black" style="background: #ff6b6b; color: #000;">
                    <div class="flex items-center gap-4 mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                        <div>
                            <h3 class="text-xl font-black uppercase">Erreur</h3>
                            <p class="font-bold" id="livrablesErrorMsg">Impossible de charger les livrables.</p>
                        </div>
                    </div>
                    <button onclick="loadLivrables()" class="bg-black text-white px-6 py-3 font-black text-sm uppercase border-2 border-black mt-2">
                        <i class="fas fa-redo mr-2"></i>Réessayer
                    </button>
                </div>
            </div>

            <!-- Accès limité (pas d'acompte) -->
            <div id="livrablesLocked" class="mb-8" style="display: none;">
                <div class="p-8 border-4 border-black text-center" style="background: #333;">
                    <i class="fas fa-lock text-[var(--genesis-yellow)] text-4xl mb-4"></i>
                    <h2 class="text-2xl font-black italic uppercase text-white mb-4">Accès limité</h2>
                    <p class="text-white font-bold mb-6">Payez l'acompte pour accéder à vos livrables.</p>
                    <a href="dashboard.html" class="neo-btn-yellow px-8 py-4 text-sm uppercase inline-block">
                        <i class="fas fa-arrow-left mr-2"></i>Retour au dashboard
                    </a>
                </div>
            </div>

            <!-- Contenu livrables -->
            <div id="livrablesContent" style="display: none;">

                <!-- Onglets -->
                <div class="flex flex-wrap gap-2 mb-8">
                    <button class="tab-btn active" onclick="filterLivrables('all')" id="tabAll">Tous</button>
                    <button class="tab-btn" onclick="filterLivrables('Documents')" id="tabDocuments">Documents</button>
                    <button class="tab-btn" onclick="filterLivrables('Photos')" id="tabPhotos">Photos</button>
                    <button class="tab-btn" onclick="filterLivrables('Videos')" id="tabVideos">Videos</button>
                </div>

                <!-- Message telechargement bloque -->
                <div id="downloadNotice" class="mb-8" style="display: none;">
                    <div class="p-4 border-4 border-black" style="background: #ffd43b; color: black;">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Téléchargement bloqué</strong> - Payez le solde restant pour débloquer les téléchargements.
                    </div>
                </div>

                <!-- Grille de livrables -->
                <div id="livrablesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

                <!-- Etat vide -->
                <div id="livrablesEmpty" style="display: none;">
                    <div class="empty-state">
                        <i class="fas fa-folder-open text-6xl mb-6 opacity-50"></i>
                        <h3 class="text-2xl font-black italic uppercase mb-4">Aucun livrable pour l'instant</h3>
                        <p class="font-bold opacity-70 mb-6">Vos documents, photos et videos apparaîtront ici au fur et à mesure de votre projet.</p>
                        <a href="dashboard.html" class="download-btn inline-block">
                            <i class="fas fa-arrow-left mr-2"></i>Retour au dashboard
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <script src="config.js"></script>
    <script src="offers-config.js"></script>
    <script src="panier.js"></script>
    <script src="auth.js"></script>
    <script>
        // ============================================================
        // LIVRABLES - FETCH AUTHENTIFIE, ONGLETS, ZERO AOS
        // ============================================================
        var LIV_API = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';
        var _allLivrables = [];
        var _canDownload = false;

        // Auth check
        try {
            if (typeof requireAuth === 'function') { requireAuth(); }
            else {
                var t = localStorage.getItem('fa_genesis_token');
                if (!t) window.location.href = 'login.html';
            }
        } catch (e) {}

        // Greeting
        try {
            var raw = localStorage.getItem('fa_genesis_session');
            if (raw) {
                var u = JSON.parse(raw);
                var greet = document.getElementById('userGreeting');
                if (greet && u.prenom) greet.textContent = u.prenom;
            }
        } catch (e) {}

        function setLoading(v) {
            var el = document.getElementById('livrablesLoader');
            if (el) el.style.display = v ? '' : 'none';
        }

        function showError(msg) {
            var el = document.getElementById('livrablesError');
            if (el) el.style.display = '';
            var msgEl = document.getElementById('livrablesErrorMsg');
            if (msgEl) msgEl.textContent = msg;
        }

        function fetchWithTimeout(url, options, timeoutMs) {
            return new Promise(function(resolve, reject) {
                var controller = new AbortController();
                var timer = setTimeout(function() {
                    controller.abort();
                    reject(new Error('TIMEOUT'));
                }, timeoutMs || 8000);
                var opts = Object.assign({}, options || {}, { signal: controller.signal });
                fetch(url, opts).then(function(resp) {
                    clearTimeout(timer);
                    resolve(resp);
                }).catch(function(err) {
                    clearTimeout(timer);
                    reject(err);
                });
            });
        }

        async function loadLivrables() {
            setLoading(true);
            var errEl = document.getElementById('livrablesError');
            if (errEl) errEl.style.display = 'none';
            var lockedEl = document.getElementById('livrablesLocked');
            if (lockedEl) lockedEl.style.display = 'none';
            var contentEl = document.getElementById('livrablesContent');
            if (contentEl) contentEl.style.display = 'none';

            try {
                var token = localStorage.getItem('fa_genesis_token');
                if (!token) { window.location.href = 'login.html'; return; }

                var resp = await fetchWithTimeout(LIV_API + '/api/deliverables/mine', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }, 8000);

                if (resp.status === 401) {
                    localStorage.removeItem('fa_genesis_token');
                    localStorage.removeItem('fa_genesis_session');
                    window.location.href = 'login.html';
                    return;
                }

                if (!resp.ok) {
                    showError('Erreur serveur (' + resp.status + ')');
                    return;
                }

                var data = await resp.json();
                if (!data.ok) {
                    // Pas de commande payee = acces bloque
                    if (data.message && data.message.indexOf('payee') !== -1) {
                        if (lockedEl) lockedEl.style.display = '';
                        return;
                    }
                    showError(data.error || 'Erreur inconnue');
                    return;
                }

                _allLivrables = data.deliverables || [];
                _canDownload = data.can_download === true;

                // Check deposit status from localStorage
                try {
                    var sess = JSON.parse(localStorage.getItem('fa_genesis_session') || '{}');
                    if (sess.deposit_paid === false || sess.paymentStatus === 'registered') {
                        if (lockedEl) lockedEl.style.display = '';
                        return;
                    }
                } catch (e) {}

                if (contentEl) contentEl.style.display = '';

                // Notice telechargement bloque
                var noticeEl = document.getElementById('downloadNotice');
                if (noticeEl) noticeEl.style.display = _canDownload ? 'none' : '';

                renderLivrables(_allLivrables);

            } catch (err) {
                console.error('[LIVRABLES] Erreur:', err.message);
                if (err.message.indexOf('TIMEOUT') !== -1) {
                    showError('Le serveur ne répond pas. Réessayez.');
                } else {
                    showError(err.message || 'Erreur de connexion');
                }
            } finally {
                setLoading(false);
            }
        }

        function renderLivrables(items) {
            var container = document.getElementById('livrablesList');
            var emptyEl = document.getElementById('livrablesEmpty');
            if (!container) return;

            if (!items || items.length === 0) {
                container.innerHTML = '';
                if (emptyEl) emptyEl.style.display = '';
                return;
            }

            if (emptyEl) emptyEl.style.display = 'none';

            var html = '';
            for (var i = 0; i < items.length; i++) {
                var liv = items[i];
                var icon = 'fa-file-alt';
                if (liv.type === 'photo') icon = 'fa-image';
                else if (liv.type === 'video') icon = 'fa-video';
                else if (liv.type === 'audio') icon = 'fa-music';

                var dateStr = '';
                if (liv.created_at) {
                    try {
                        var d = new Date(liv.created_at);
                        dateStr = d.toLocaleDateString('fr-FR');
                    } catch (e) { dateStr = ''; }
                }

                // Bouton pr\u00e9visualiser (toujours visible)
                var previewHtml = '';
                var previewUrl = liv.preview_url || liv.download_url || '';
                if (previewUrl || liv.content_text) {
                    previewHtml = '<button onclick="openPreview(' + i + ')" class="preview-btn" style="margin-right:8px;"><i class="fas fa-eye mr-2"></i>Pr\u00e9visualiser</button>';
                }

                // Bouton t\u00e9l\u00e9charger (seulement si solde pay\u00e9)
                var downloadHtml = '';
                if (liv.download_url) {
                    if (_canDownload) {
                        downloadHtml = '<a href="' + liv.download_url + '" target="_blank" class="download-btn"><i class="fas fa-download mr-2"></i>T\u00e9l\u00e9charger</a>';
                    } else {
                        downloadHtml = '<span class="download-btn disabled" title="Payez le solde pour t\u00e9l\u00e9charger"><i class="fas fa-lock mr-2"></i>T\u00e9l\u00e9charger</span>';
                    }
                } else if (liv.content_text && !previewUrl) {
                    // Texte sans URL : pas de bouton t\u00e9l\u00e9charger s\u00e9par\u00e9
                    downloadHtml = '';
                }

                html += '<div class="livrable-card" data-category="' + (liv.category || 'Documents') + '">';
                html += '<i class="fas ' + icon + ' text-4xl mb-4 text-[var(--genesis-yellow)]"></i>';
                html += '<span class="livrable-type">' + (liv.category || 'Document') + '</span>';
                html += '<h3 class="text-lg font-black uppercase mb-2">' + escapeHtml(liv.name) + '</h3>';
                if (dateStr) html += '<p class="text-xs font-bold opacity-50 mb-4">' + dateStr + '</p>';
                if (liv.status) html += '<p class="text-xs font-bold uppercase mb-4" style="color: ' + (liv.status === 'ready' || liv.status === 'delivered' ? '#51cf66' : '#ffd43b') + ';">' + escapeHtml(liv.status) + '</p>';
                html += '<div class="mt-auto" style="display:flex;flex-wrap:wrap;gap:8px;">' + previewHtml + downloadHtml + '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function filterLivrables(category) {
            // Update tab buttons
            var tabs = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            var tabId = 'tab' + (category === 'all' ? 'All' : category);
            var activeTab = document.getElementById(tabId);
            if (activeTab) activeTab.classList.add('active');

            if (category === 'all') {
                renderLivrables(_allLivrables);
            } else {
                var filtered = _allLivrables.filter(function(l) {
                    return l.category === category;
                });
                renderLivrables(filtered);
            }
        }

        function openPreview(index) {
            var liv = _allLivrables[index];
            if (!liv) return;

            var previewUrl = liv.preview_url || liv.download_url || '';
            var livType = (liv.type || '').toLowerCase();

            // Cr\u00e9er l'overlay
            var overlay = document.createElement('div');
            overlay.className = 'preview-overlay';
            overlay.id = 'previewOverlay';

            var closeBtn = '<button class="preview-close" onclick="closePreview()">&times;</button>';
            var title = '<div class="preview-title">' + escapeHtml(liv.name) + '</div>';
            var contentHtml = '';

            if (liv.content_text && !previewUrl) {
                // Contenu texte
                contentHtml = '<div style="background:white;color:black;padding:30px;max-width:800px;max-height:80vh;overflow:auto;border:4px solid var(--genesis-yellow);font-size:15px;line-height:1.7;">'
                    + escapeHtml(liv.content_text).replace(/\n/g, '<br>') + '</div>';
            } else if (livType === 'photo' || livType === 'image') {
                contentHtml = '<img src="' + escapeAttr(previewUrl) + '" alt="' + escapeAttr(liv.name) + '" oncontextmenu="return false" draggable="false" style="pointer-events:auto;-webkit-user-select:none;user-select:none;" />';
            } else if (livType === 'video') {
                contentHtml = '<video controls autoplay controlsList="nodownload nofullscreen" disablePictureInPicture oncontextmenu="return false"><source src="' + escapeAttr(previewUrl) + '"></video>';
            } else if (previewUrl) {
                // Document (PDF, etc.)
                // Chrome bloque les data: URLs dans les iframes -> convertir en Blob URL
                if (previewUrl.indexOf('data:') === 0) {
                    try {
                        var parts = previewUrl.split(',');
                        var mimeMatch = parts[0].match(/:(.*?);/);
                        var mime = mimeMatch ? mimeMatch[1] : 'application/pdf';
                        var b64 = parts[1];
                        var byteStr = atob(b64);
                        var byteArr = new Uint8Array(byteStr.length);
                        for (var k = 0; k < byteStr.length; k++) { byteArr[k] = byteStr.charCodeAt(k); }
                        var blob = new Blob([byteArr], { type: mime });
                        var blobUrl = URL.createObjectURL(blob);
                        window._previewBlobUrl = blobUrl;
                        contentHtml = '<iframe src="' + blobUrl + '" title="' + escapeAttr(liv.name) + '" style="width:90vw;height:80vh;border:4px solid var(--genesis-yellow);background:white;pointer-events:auto;"></iframe>';
                    } catch (convErr) {
                        contentHtml = '<div class="preview-no-content"><i class="fas fa-exclamation-triangle" style="font-size:48px;color:var(--genesis-yellow);margin-bottom:16px;display:block;"></i>Impossible d\'afficher l\'aperçu.<br><small>' + convErr.message + '</small></div>';
                    }
                } else {
                    var pdfUrl = previewUrl + (previewUrl.indexOf('?') === -1 ? '?' : '&') + '#toolbar=0&navpanes=0';
                    contentHtml = '<iframe src="' + escapeAttr(pdfUrl) + '" title="' + escapeAttr(liv.name) + '" style="width:90vw;height:80vh;border:4px solid var(--genesis-yellow);background:white;pointer-events:auto;"></iframe>';
                }
            } else {
                contentHtml = '<div class="preview-no-content"><i class="fas fa-file-alt" style="font-size:48px;color:var(--genesis-yellow);margin-bottom:16px;display:block;"></i>Aucun aper\u00e7u disponible pour ce livrable.</div>';
            }

            overlay.innerHTML = closeBtn + title + contentHtml;
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';

            // Fermer en cliquant sur le fond
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) closePreview();
            });
        }

        function closePreview() {
            var overlay = document.getElementById('previewOverlay');
            if (overlay) overlay.remove();
            document.body.style.overflow = 'auto';
            if (window._previewBlobUrl) {
                URL.revokeObjectURL(window._previewBlobUrl);
                window._previewBlobUrl = null;
            }
        }

        // Fermer avec Echap
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closePreview();
        });

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ============================================================
        // MENU MOBILE
        // ============================================================
        var mobileMenuBtn = document.getElementById('mobileMenuBtn');
        var mobileMenu = document.getElementById('mobileMenu');
        var menuLine1 = document.getElementById('menuLine1');
        var menuLine2 = document.getElementById('menuLine2');
        var menuLine3 = document.getElementById('menuLine3');
        var isMenuOpen = false;

        function toggleMobileMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.classList.add('flex');
                menuLine1.style.transform = 'rotate(45deg) translate(5px, 5px)';
                menuLine2.style.opacity = '0';
                menuLine3.style.transform = 'rotate(-45deg) translate(5px, -5px)';
                document.body.style.overflow = 'hidden';
            } else { closeMobileMenu(); }
        }

        function closeMobileMenu() {
            isMenuOpen = false;
            if (mobileMenu) { mobileMenu.classList.add('hidden'); mobileMenu.classList.remove('flex'); }
            if (menuLine1) menuLine1.style.transform = 'none';
            if (menuLine2) menuLine2.style.opacity = '1';
            if (menuLine3) menuLine3.style.transform = 'none';
            document.body.style.overflow = 'auto';
        }

        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);

        // Lancer le chargement
        loadLivrables();

        // Notification badge for sessions PROPOSED
        (function() {
            try {
                var tkn = localStorage.getItem('fa_genesis_token');
                if (!tkn) return;
                fetch(LIV_API + '/api/sessions/me', { headers: { 'Authorization': 'Bearer ' + tkn } })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var sessions = data.sessions || data || [];
                    if (!Array.isArray(sessions)) return;
                    var count = 0;
                    for (var i = 0; i < sessions.length; i++) {
                        if (sessions[i].status === 'PROPOSED') count++;
                    }
                    if (count > 0) {
                        var links = document.querySelectorAll('a[href="seances.html"]');
                        for (var j = 0; j < links.length; j++) {
                            var badge = document.createElement('span');
                            badge.className = 'notif-badge';
                            badge.textContent = count;
                            links[j].appendChild(badge);
                        }
                    }
                })
                .catch(function() {});
            } catch(e) {}
        })();
    </script>
    <div id="site-footer"></div>
    <script src="footer.js" defer></script>
    <script src="chatbot.js" defer></script>
</body>
</html>
