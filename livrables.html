<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Livrables - FA GENESIS | Espace Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap');

        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }

        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, .nav-link { font-family: 'Unbounded', cursive; }

        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }

        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }

        .livrable-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .livrable-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 14px 14px 0px 0px var(--genesis-yellow);
        }

        .livrable-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .livrable-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--genesis-yellow);
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.7rem;
            margin-bottom: 1rem;
        }

        .download-btn {
            background: black;
            color: white;
            border: 3px solid black;
            padding: 0.75rem 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            margin-top: auto;
        }

        .download-btn:hover {
            background: var(--genesis-yellow);
            color: black;
        }

        .empty-state {
            background: white;
            color: black;
            border: 4px dashed black;
            padding: 3rem;
            text-align: center;
        }

        /* Documents communs */
        .common-category {
            margin-bottom: 3rem;
        }

        .category-header {
            background: var(--genesis-yellow);
            color: black;
            padding: 1rem 1.5rem;
            border: 4px solid black;
            margin-bottom: 1.5rem;
        }

        .common-doc-item {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            transition: all 0.2s ease;
        }

        .common-doc-item:hover {
            transform: translate(-3px, -3px);
            box-shadow: 8px 8px 0px 0px var(--genesis-yellow);
        }

        .doc-info {
            flex: 1;
            min-width: 250px;
        }

        .doc-title {
            font-weight: 900;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .doc-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
            font-weight: 700;
            opacity: 0.7;
        }

        .file-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            color: white;
            font-weight: 900;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .doc-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .doc-btn {
            background: black;
            color: white;
            border: 3px solid black;
            padding: 0.75rem 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .doc-btn:hover {
            background: var(--genesis-yellow);
            color: black;
        }

        .doc-btn.view-btn {
            background: white;
            color: black;
            border-color: black;
        }

        .doc-btn.view-btn:hover {
            background: var(--genesis-yellow);
        }

        /* Day tabs */
        .day-tab.active {
            background: var(--genesis-yellow) !important;
            box-shadow: 6px 6px 0px black;
        }
        .day-tab:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--genesis-yellow);
        }

        .day-section {
            margin-bottom: 2rem;
        }
        .day-section-header {
            background: #4dabf7;
            color: black;
            padding: 1rem 1.5rem;
            border: 4px solid black;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .day-section-header.day-1 {
            background: var(--genesis-yellow);
        }
        .day-section-header.current-day {
            box-shadow: 8px 8px 0px black;
        }
    </style>
</head>
<body>

    <!-- NAVIGATION PRIV√âE -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-6 py-4 flex justify-between items-center text-white text-xs font-black uppercase">
        <div class="flex items-center">
            <a href="dashboard.html" class="text-2xl font-black tracking-wider text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">FA GENESIS</a>
        </div>
        <div id="mainNavigation" class="hidden md:flex gap-8 text-white font-black">
            <!-- Navigation dynamique g√©n√©r√©e par JavaScript -->
        </div>
        <div class="flex gap-4 items-center">
            <span id="userGreeting" class="hidden md:block text-white font-bold"></span>
            <button onclick="logout()" class="border-4 border-white text-white px-4 py-2 text-[10px] tracking-widest font-black hover:bg-white hover:text-black transition">
                <i class="fas fa-sign-out-alt mr-2"></i>D√©connexion
            </button>
        </div>
    </nav>

    <!-- LIVRABLES CONTENT -->
    <section class="min-h-screen pt-32 pb-20 px-6 bg-black">
        <div class="container mx-auto max-w-6xl">

            <!-- En-t√™te -->
            <div class="mb-16" data-aos="fade-up">
                <h1 class="text-5xl md:text-6xl font-black italic uppercase mb-4 text-[var(--genesis-yellow)]">Mes Livrables</h1>
                <p class="text-xl font-bold uppercase text-white">Tous vos documents et fichiers en un seul endroit</p>
            </div>

            <!-- Indicateur de jour (accompagnement uniquement) -->
            <div id="dayIndicator" class="mb-12" data-aos="fade-up" style="display: none;">
                <div class="bg-[var(--genesis-yellow)] text-black p-8 border-4 border-black" style="box-shadow: 10px 10px 0px black;">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div>
                            <div class="text-sm font-black uppercase opacity-70 mb-1">Votre accompagnement</div>
                            <div class="text-4xl md:text-5xl font-black italic" id="dayLabel">JOUR 1 / 7</div>
                        </div>
                        <div class="text-right">
                            <div id="dayStatus" class="text-lg font-black uppercase"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglets jour (accompagnement uniquement) -->
            <div id="dayTabs" class="mb-12 flex flex-wrap gap-4" data-aos="fade-up" style="display: none;">
                <button class="day-tab active px-6 py-3 bg-white text-black border-4 border-black font-black uppercase text-sm" data-tab="current">
                    <i class="fas fa-star mr-2"></i>Jour actuel
                </button>
                <button class="day-tab px-6 py-3 bg-white text-black border-4 border-black font-black uppercase text-sm" data-tab="previous">
                    <i class="fas fa-history mr-2"></i>Jours pr√©c√©dents
                </button>
                <button class="day-tab px-6 py-3 bg-white text-black border-4 border-black font-black uppercase text-sm" data-tab="all">
                    <i class="fas fa-list mr-2"></i>Tous les jours
                </button>
            </div>

            <!-- Documents communs -->
            <div id="commonDocumentsSection" class="mb-16">
                <!-- Les documents communs seront g√©n√©r√©s dynamiquement ici -->
            </div>

            <!-- Livrables par jour (backend) -->
            <div id="backendLivrablesSection" style="display: none;">
                <h2 class="text-3xl font-black italic uppercase mb-8 text-[var(--genesis-yellow)]">
                    <i class="fas fa-calendar-day mr-3"></i>Documents de votre accompagnement
                </h2>
                <div id="backendLivrablesContainer">
                    <!-- Les livrables jour par jour seront g√©n√©r√©s ici -->
                </div>
            </div>

            <!-- Livrables personnels (ancien syst√®me, prestations individuelles) -->
            <div id="personalLivrablesSection">
                <h2 id="personalLivrablesTitle" class="text-3xl font-black italic uppercase mb-8 text-white" style="display: none;">Vos documents personnels</h2>
                <div id="livrablesContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Les livrables personnels seront g√©n√©r√©s dynamiquement ici -->
                </div>
            </div>

            <!-- √âtat vide -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-inbox text-6xl mb-6 opacity-30"></i>
                <h3 class="text-2xl font-black italic uppercase mb-4">Aucun livrable pour le moment</h3>
                <p class="font-bold">Vos documents appara√Ætront ici au fur et √† mesure de votre progression</p>
            </div>

        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="common-documents.js"></script>
    <script src="offer-specific-documents.js"></script>
    <script src="offers-config.js"></script>
    <script src="payment-system.js"></script>
    <script src="admin-system.js"></script>
    <script>
        AOS.init({ duration: 1000, once: false, mirror: true, offset: 120 });

        const API_BASE_URL = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';

        // Protection de la page
        requireAuth();

        // Chargement des donn√©es utilisateur
        const user = getCurrentUser();
        let userAccessRights = null;

        if (user) {
            // Rendre la navigation selon productType
            renderNavigation(user.productType || 'accompagnement', 'livrables');

            document.getElementById('userGreeting').textContent = user.prenom;

            // V√©rifier les droits d'acc√®s selon le statut de paiement
            userAccessRights = checkAccessRights(user.email);
            console.log('üí≥ Droits d\'acc√®s:', userAccessRights);

            // Afficher un message si l'acc√®s aux livrables finaux est bloqu√©
            if (!userAccessRights.canDownloadLivrables) {
                const message = `
                    <div class="bg-[#ffd43b] text-black p-8 neo-border mb-8" data-aos="fade-up">
                        <div class="flex items-center gap-4 mb-4">
                            <i class="fas fa-info-circle text-4xl"></i>
                            <h3 class="text-2xl font-black italic uppercase">ACC√àS AUX CONTENUS</h3>
                        </div>
                        <p class="font-bold text-lg mb-4">
                            ${userAccessRights.status === 'deposit_paid' ?
                                'Vous avez acc√®s aux documents communs, documents sp√©cifiques √† votre offre, documents journaliers, photos et vid√©os. Les livrables finaux seront disponibles apr√®s le paiement du solde.' :
                                userAccessRights.status === 'delivery_pending_payment' ?
                                'Accompagnement termin√© ! R√©glez le solde pour acc√©der √† vos livrables finaux.' :
                                userAccessRights.message
                            }
                        </p>
                        ${userAccessRights.status === 'delivery_pending_payment' ?
                            '<a href="payment.html" class="inline-block bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition">R√©gler le solde maintenant</a>' :
                            userAccessRights.status === 'deposit_paid' ?
                            '<p class="font-bold text-sm mt-4"><i class="fas fa-check-circle mr-2"></i>Profitez de vos photos et vid√©os pendant votre accompagnement !</p>' :
                            userAccessRights.status === 'registered' ?
                            '<a href="payment.html" class="inline-block bg-black text-white px-8 py-4 border-4 border-black font-black uppercase text-sm hover:opacity-80 transition">Payer l\'acompte maintenant</a>' :
                            ''}
                    </div>
                `;
                document.querySelector('.container').insertAdjacentHTML('afterbegin', message);
            }

            loadLivrables(user);

            // Charger les livrables depuis le backend (jour par jour)
            loadBackendLivrables(user);
        }

        // Fonction pour rendre la navigation selon le type de produit
        function renderNavigation(productType, currentPage) {
            const nav = document.getElementById('mainNavigation');

            nav.innerHTML = `
                <a href="dashboard.html" class="nav-link ${currentPage === 'dashboard' ? 'text-[var(--genesis-yellow)]' : 'hover:text-[var(--genesis-yellow)] transition'}">Dashboard</a>
                <a href="livrables.html" class="nav-link ${currentPage === 'livrables' ? 'text-[var(--genesis-yellow)]' : 'hover:text-[var(--genesis-yellow)] transition'}">Livrables</a>
                <a href="seances.html" class="nav-link ${currentPage === 'seances' ? 'text-[var(--genesis-yellow)]' : 'hover:text-[var(--genesis-yellow)] transition'}">S√©ances</a>
                <a href="mon-compte.html" class="nav-link ${currentPage === 'mon-compte' ? 'text-[var(--genesis-yellow)]' : 'hover:text-[var(--genesis-yellow)] transition'}">Mon compte</a>
            `;
        }

        // Base de donn√©es des livrables par offre
        const LIVRABLES_DATA = {
            'etudiant-idea': [
                {
                    title: 'Mini Plan d\'Action',
                    type: 'document',
                    date: '2024-01-16',
                    description: 'Plan d\'action structur√© sur 7 jours',
                    icon: 'fa-file-alt',
                    file: '#'
                }
            ],
            'etudiant-starter': [
                {
                    title: 'S√©ance Strat√©gique - Notes',
                    type: 'document',
                    date: '2024-01-21',
                    description: 'R√©sum√© de votre s√©ance strat√©gique',
                    icon: 'fa-file-alt',
                    file: '#'
                },
                {
                    title: 'Plan d\'Action 14 Jours',
                    type: 'document',
                    date: '2024-01-23',
                    description: 'Votre feuille de route compl√®te',
                    icon: 'fa-file-pdf',
                    file: '#'
                },
                {
                    title: 'Guide Visibilit√© Digitale',
                    type: 'document',
                    date: '2024-01-24',
                    description: 'Conseils pour votre pr√©sence en ligne',
                    icon: 'fa-file-alt',
                    file: '#'
                }
            ],
            'etudiant-launch': [
                {
                    title: 'Strat√©gie Compl√®te',
                    type: 'document',
                    date: '2024-01-16',
                    description: 'Document de strat√©gie et positionnement',
                    icon: 'fa-file-pdf',
                    file: '#'
                },
                {
                    title: 'Vid√©o Courte (1 min)',
                    type: 'video',
                    date: '2024-01-20',
                    description: 'Votre vid√©o de pr√©sentation optimis√©e',
                    icon: 'fa-video',
                    file: '#'
                },
                {
                    title: 'Vid√©o Format Carr√©',
                    type: 'video',
                    date: '2024-01-20',
                    description: 'Version adapt√©e pour Instagram',
                    icon: 'fa-video',
                    file: '#'
                },
                {
                    title: 'Plan de Diffusion 30 Jours',
                    type: 'document',
                    date: '2024-01-25',
                    description: 'Calendrier de contenus et strat√©gie',
                    icon: 'fa-calendar-alt',
                    file: '#'
                }
            ],
            'particulier-impact': [
                {
                    title: 'Strat√©gie Positionnement',
                    type: 'document',
                    date: '2024-01-02',
                    description: 'Document complet de positionnement',
                    icon: 'fa-file-pdf',
                    file: '#'
                },
                {
                    title: 'Photos Professionnelles (9)',
                    type: 'photo',
                    date: '2024-01-10',
                    description: 'Archive ZIP avec 9 photos retouch√©es',
                    icon: 'fa-images',
                    file: '#'
                },
                {
                    title: 'Vid√©o Longue (2 min)',
                    type: 'video',
                    date: '2024-01-15',
                    description: 'Vid√©o storytelling professionnelle',
                    icon: 'fa-video',
                    file: '#'
                },
                {
                    title: 'Plan de Communication',
                    type: 'document',
                    date: '2024-01-20',
                    description: 'Strat√©gie de communication sur 30 jours',
                    icon: 'fa-file-alt',
                    file: '#'
                }
            ],
            'entreprise-visibility': [
                {
                    title: 'Photos Entreprise (24)',
                    type: 'photo',
                    date: '2024-01-12',
                    description: 'Archive ZIP avec toutes les photos',
                    icon: 'fa-images',
                    file: '#'
                },
                {
                    title: 'Vid√©o Corporate',
                    type: 'video',
                    date: '2024-01-15',
                    description: 'Vid√©o de pr√©sentation entreprise',
                    icon: 'fa-video',
                    file: '#'
                },
                {
                    title: 'Plan de Diffusion M√©dia',
                    type: 'document',
                    date: '2024-01-18',
                    description: 'Strat√©gie de visibilit√© m√©dia',
                    icon: 'fa-file-pdf',
                    file: '#'
                }
            ]
        };

        let currentFilter = 'all';

        function loadLivrables(user) {
            // Charger les documents communs
            loadCommonDocuments();

            // Charger les livrables personnels
            // Photos/Vid√©os accessibles apr√®s acompte
            // Documents finaux accessibles apr√®s solde complet
            const container = document.getElementById('livrablesContainer');
            const emptyState = document.getElementById('emptyState');
            const personalTitle = document.getElementById('personalLivrablesTitle');
            const personalSection = document.getElementById('personalLivrablesSection');

            const canAccessDuringAccompaniment = userAccessRights && userAccessRights.canAccessDocuments; // Apr√®s acompte
            const canAccessFinalDeliverables = userAccessRights && userAccessRights.canDownloadLivrables; // Apr√®s solde

            // D√©terminer le type de produit
            const productType = user.productType || 'accompagnement';

            const allLivrables = LIVRABLES_DATA[user.offre] || [];

            if (allLivrables.length === 0) {
                personalSection.style.display = 'none';
                container.style.display = 'none';
                personalTitle.style.display = 'none';
            } else {
                // Filtrer les livrables selon les droits d'acc√®s
                let accessibleLivrables = [];

                if (canAccessFinalDeliverables) {
                    // Acc√®s total apr√®s paiement complet
                    accessibleLivrables = allLivrables;
                } else if (canAccessDuringAccompaniment) {
                    // Apr√®s acompte: acc√®s aux photos et vid√©os
                    accessibleLivrables = allLivrables.filter(l => l.type === 'photo' || l.type === 'video');
                }

                if (accessibleLivrables.length === 0) {
                    personalSection.style.display = 'none';
                    container.style.display = 'none';
                    personalTitle.style.display = 'none';
                } else {
                    personalSection.style.display = 'block';
                    personalTitle.style.display = 'block';
                    container.innerHTML = '';

                    // Afficher un bandeau informatif pour les prestations individuelles
                    if (productType === 'prestation_individuelle' && !canAccessFinalDeliverables && canAccessDuringAccompaniment) {
                        const infoBar = document.createElement('div');
                        infoBar.className = 'bg-[var(--genesis-yellow)] text-black p-6 border-4 border-black mb-8 font-bold';
                        infoBar.innerHTML = `
                            <div class="flex items-start gap-4">
                                <i class="fas fa-info-circle text-2xl"></i>
                                <div>
                                    <h4 class="font-black uppercase mb-2">Mode consultation activ√©</h4>
                                    <p class="text-sm">Vous pouvez consulter vos livrables, mais le t√©l√©chargement des fichiers sera disponible apr√®s le r√®glement du solde (70%).</p>
                                </div>
                            </div>
                        `;
                        container.appendChild(infoBar);
                    }

                    accessibleLivrables.forEach((livrable, index) => {
                        const card = createLivrableCard(livrable, index, canAccessFinalDeliverables, productType, canAccessDuringAccompaniment);
                        container.appendChild(card);
                    });
                }
            }

            // L'√©tat vide ne s'affiche que si aucun document (ni commun ni personnel)
            const hasCommonDocs = getCommonDocuments().length > 0;
            const hasAccessibleContent = canAccessDuringAccompaniment;
            if (!hasCommonDocs && !hasAccessibleContent) {
                emptyState.style.display = 'block';
            }
        }

        function loadCommonDocuments() {
            const commonSection = document.getElementById('commonDocumentsSection');
            const documentsByCategory = getDocumentsByCategory();

            console.log('Documents par cat√©gorie:', documentsByCategory);
            console.log('Ordre des cat√©gories:', CATEGORIES_ORDER);

            let html = '<h2 class="text-3xl font-black italic uppercase mb-8 text-white">Documents</h2>';

            // Documents communs
            html += '<h3 class="text-2xl font-black uppercase mb-6 text-[var(--genesis-yellow)]">Documents communs</h3>';

            CATEGORIES_ORDER.forEach(category => {
                const docs = documentsByCategory[category];
                console.log(`Cat√©gorie "${category}":`, docs);

                if (docs && docs.length > 0) {
                    html += `
                        <div class="common-category" data-category="${category}">
                            <div class="category-header">
                                <h3 class="text-xl font-black italic uppercase">${category}</h3>
                            </div>
                            <div class="category-docs">
                    `;

                    docs.forEach(doc => {
                        console.log('Ajout du document:', doc.title);
                        html += createCommonDocumentHTML(doc);
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }
            });

            // Documents sp√©cifiques √† l'offre de l'utilisateur
            const offerDocs = getOfferSpecificDocuments(user.offre);
            console.log('Documents sp√©cifiques √† l\'offre:', offerDocs);

            if (offerDocs && offerDocs.length > 0) {
                html += `
                    <h3 class="text-2xl font-black uppercase mb-6 mt-12 text-[var(--genesis-yellow)]">Documents sp√©cifiques √† votre offre</h3>
                    <div class="common-category" data-category="offer-specific">
                        <div class="category-header" style="background: #51cf66;">
                            <h3 class="text-xl font-black italic uppercase">
                                <i class="fas fa-star mr-2"></i>Documents personnalis√©s pour votre accompagnement
                            </h3>
                        </div>
                        <div class="category-docs">
                `;

                offerDocs.forEach(doc => {
                    console.log('Ajout du document sp√©cifique:', doc.title);
                    html += createCommonDocumentHTML(doc);
                });

                html += `
                        </div>
                    </div>
                `;
            }

            console.log('HTML g√©n√©r√©:', html);
            commonSection.innerHTML = html;
        }

        // ============================================================
        // CHARGEMENT DES LIVRABLES BACKEND (JOUR PAR JOUR)
        // ============================================================

        let backendCurrentDay = 0;
        let backendTotalDays = 0;
        let backendLivrablesByDay = {};
        let currentDayTab = 'current';

        async function loadBackendLivrables(user) {
            const productType = user.productType || 'accompagnement';

            // Ne charger le syst√®me jour par jour que pour les accompagnements
            if (productType !== 'accompagnement') return;

            try {
                // 1. R√©cup√©rer la commande active du client
                const ordersResp = await fetch(API_BASE_URL + '/api/client/orders?email=' + encodeURIComponent(user.email));
                if (!ordersResp.ok) return;

                const clientOrders = await ordersResp.json();
                const activeOrder = clientOrders.find(function(o) { return o.deposit_paid; });
                if (!activeOrder) return;

                // 2. R√©cup√©rer le jour courant
                const dashResp = await fetch(API_BASE_URL + '/api/client/dashboard/' + activeOrder.id);
                if (dashResp.ok) {
                    const dashData = await dashResp.json();
                    backendCurrentDay = dashData.currentDay || 0;
                    backendTotalDays = dashData.totalDays || 0;
                }

                // 3. R√©cup√©rer les livrables
                const livResp = await fetch(API_BASE_URL + '/api/livrables/' + activeOrder.id);
                if (livResp.ok) {
                    const livData = await livResp.json();
                    // Grouper par jour
                    backendLivrablesByDay = {};
                    (livData.livrables || []).forEach(function(l) {
                        const day = l.day_number || 0;
                        if (!backendLivrablesByDay[day]) backendLivrablesByDay[day] = [];
                        backendLivrablesByDay[day].push(l);
                    });
                }

                // 4. Afficher l'indicateur de jour
                if (backendCurrentDay > 0 && backendTotalDays > 0) {
                    document.getElementById('dayIndicator').style.display = 'block';
                    document.getElementById('dayLabel').textContent = 'JOUR ' + backendCurrentDay + ' / ' + backendTotalDays;
                    const statusEl = document.getElementById('dayStatus');
                    if (backendCurrentDay === 1) {
                        statusEl.innerHTML = '<i class="fas fa-star mr-2"></i>Bienvenue !';
                    } else if (backendCurrentDay >= backendTotalDays) {
                        statusEl.innerHTML = '<i class="fas fa-flag-checkered mr-2"></i>Dernier jour !';
                    } else {
                        statusEl.innerHTML = '<i class="fas fa-rocket mr-2"></i>En cours';
                    }
                }

                // 5. Afficher les onglets et les livrables
                const hasBackendDocs = Object.keys(backendLivrablesByDay).length > 0;
                if (hasBackendDocs || backendCurrentDay > 0) {
                    document.getElementById('dayTabs').style.display = 'flex';
                    document.getElementById('backendLivrablesSection').style.display = 'block';
                    renderBackendLivrables();
                    setupDayTabs();
                }

            } catch (error) {
                console.error('Erreur chargement livrables backend:', error);
            }
        }

        function renderBackendLivrables() {
            const container = document.getElementById('backendLivrablesContainer');
            const dayNumbers = Object.keys(backendLivrablesByDay).map(Number).filter(function(d) { return d > 0; }).sort(function(a, b) { return b - a; });

            if (dayNumbers.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox text-4xl mb-4 opacity-30"></i><h3 class="text-xl font-black italic uppercase mb-2">Aucun document pour le moment</h3><p class="font-bold">Votre accompagnateur ajoutera des documents au fur et √† mesure de votre progression</p></div>';
                return;
            }

            let html = '';

            // Filtrer selon l'onglet actif
            let filteredDays = dayNumbers;
            if (currentDayTab === 'current') {
                filteredDays = dayNumbers.filter(function(d) { return d === backendCurrentDay; });
            } else if (currentDayTab === 'previous') {
                filteredDays = dayNumbers.filter(function(d) { return d < backendCurrentDay; });
            }

            if (filteredDays.length === 0) {
                const tabLabel = currentDayTab === 'current' ? 'le jour actuel (Jour ' + backendCurrentDay + ')' : 'les jours pr\u00e9c\u00e9dents';
                container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times text-4xl mb-4 opacity-30"></i><p class="font-bold">Aucun document pour ' + tabLabel + '</p></div>';
                return;
            }

            filteredDays.forEach(function(dayNum) {
                const docs = backendLivrablesByDay[dayNum];
                const isCurrentDay = dayNum === backendCurrentDay;
                const isDay1 = dayNum === 1;
                const headerClass = isDay1 ? 'day-section-header day-1' : isCurrentDay ? 'day-section-header current-day' : 'day-section-header';

                html += '<div class="day-section" data-day="' + dayNum + '">';
                html += '<div class="' + headerClass + '">';
                html += '<h3 class="text-xl font-black italic uppercase">';
                if (isDay1) {
                    html += '<i class="fas fa-star mr-2"></i>JOUR 1 ‚Äî Onboarding';
                } else {
                    html += '<i class="fas fa-calendar-check mr-2"></i>JOUR ' + dayNum;
                }
                html += '</h3>';
                if (isCurrentDay) {
                    html += '<span class="px-3 py-1 bg-black text-white text-xs font-black uppercase">Jour actuel</span>';
                }
                html += '</div>';
                html += '<div class="category-docs">';

                docs.forEach(function(doc) {
                    html += createBackendLivrableHTML(doc);
                });

                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        function createBackendLivrableHTML(doc) {
            const date = doc.created_at ? new Date(doc.created_at) : null;
            const formattedDate = date ? date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '';

            // D√©terminer l'ic√¥ne et le badge selon le type
            let badgeClass = 'bg-gray-600';
            let fileIcon = 'fa-file';
            const docType = (doc.type || 'document').toLowerCase();

            if (docType === 'photo') {
                badgeClass = 'bg-purple-600';
                fileIcon = 'fa-file-image';
            } else if (docType === 'video') {
                badgeClass = 'bg-red-600';
                fileIcon = 'fa-video';
            } else {
                badgeClass = 'bg-blue-600';
                fileIcon = 'fa-file-alt';
            }

            const canAccess = userAccessRights && userAccessRights.canAccessDocuments;
            const downloadButton = canAccess && doc.download_url ?
                '<a href="' + doc.download_url + '" download="' + (doc.name || 'document') + '" class="doc-btn"><i class="fas fa-download"></i>T\u00e9l\u00e9charger</a>' :
                doc.download_url ?
                '<button onclick="alert(\'' + (userAccessRights ? userAccessRights.message : 'Acc\u00e8s restreint') + '\')" class="doc-btn" style="opacity: 0.5; cursor: not-allowed;"><i class="fas fa-lock"></i>Bloqu\u00e9</button>' :
                '<span class="doc-btn" style="opacity: 0.5; cursor: default;"><i class="fas fa-clock"></i>Bient\u00f4t disponible</span>';

            return '<div class="common-doc-item" data-type="' + docType + '">' +
                '<div class="doc-info">' +
                    '<div class="doc-title">' + (doc.name || 'Document') + '</div>' +
                    '<div class="doc-meta">' +
                        '<span class="file-type-badge ' + badgeClass + '"><i class="fas ' + fileIcon + ' mr-1"></i>' + docType.toUpperCase() + '</span>' +
                        (formattedDate ? '<span>Ajout\u00e9 le ' + formattedDate + '</span>' : '') +
                    '</div>' +
                    (doc.description ? '<p class="mt-2 text-sm font-bold opacity-70">' + doc.description + '</p>' : '') +
                '</div>' +
                '<div class="doc-actions">' + downloadButton + '</div>' +
            '</div>';
        }

        function setupDayTabs() {
            document.querySelectorAll('.day-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.day-tab').forEach(function(t) { t.classList.remove('active'); });
                    this.classList.add('active');
                    currentDayTab = this.getAttribute('data-tab');
                    renderBackendLivrables();
                });
            });
        }

        function createDailyDocumentHTML(doc) {
            const date = doc.uploadedAt ? new Date(doc.uploadedAt) : null;
            const formattedDate = date ? date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '';

            // D√©terminer le type de fichier pour l'ic√¥ne et le badge
            const fileExtension = doc.fileName ? doc.fileName.split('.').pop().toUpperCase() : doc.fileType;
            let badgeClass = 'bg-gray-600';
            let fileIcon = 'fa-file';

            if (fileExtension === 'PDF') {
                badgeClass = 'bg-red-600';
                fileIcon = 'fa-file-pdf';
            } else if (['DOC', 'DOCX'].includes(fileExtension)) {
                badgeClass = 'bg-blue-600';
                fileIcon = 'fa-file-word';
            } else if (['XLS', 'XLSX'].includes(fileExtension)) {
                badgeClass = 'bg-green-600';
                fileIcon = 'fa-file-excel';
            } else if (['PNG', 'JPG', 'JPEG'].includes(fileExtension)) {
                badgeClass = 'bg-purple-600';
                fileIcon = 'fa-file-image';
            } else if (fileExtension === 'ZIP') {
                badgeClass = 'bg-yellow-600';
                fileIcon = 'fa-file-archive';
            }

            // V√©rifier si l'utilisateur peut acc√©der aux documents
            const canAccess = userAccessRights && userAccessRights.canAccessDocuments;

            const downloadButton = canAccess ?
                `<a href="${doc.fileUrl}" download="${doc.fileName}" class="doc-btn">
                    <i class="fas fa-download"></i>T√©l√©charger
                </a>` :
                `<button onclick="alert('${userAccessRights.message}')" class="doc-btn" style="opacity: 0.5; cursor: not-allowed;">
                    <i class="fas fa-lock"></i>Bloqu√©
                </button>`;

            return `
                <div class="common-doc-item" data-type="document">
                    <div class="doc-info">
                        <div class="doc-title">${doc.title}</div>
                        <div class="doc-meta">
                            <span class="file-type-badge ${badgeClass}">
                                <i class="fas ${fileIcon} mr-1"></i>${fileExtension}
                            </span>
                            ${formattedDate ? `<span>Ajout√© le ${formattedDate}</span>` : ''}
                            ${doc.fileName ? `<span>${doc.fileName}</span>` : ''}
                        </div>
                        ${doc.description ? `<p class="mt-2 text-sm font-bold opacity-70">${doc.description}</p>` : ''}
                    </div>
                    <div class="doc-actions">
                        ${downloadButton}
                    </div>
                </div>
            `;
        }

        function createCommonDocumentHTML(doc) {
            const date = doc.updatedAt ? new Date(doc.updatedAt) : null;
            const formattedDate = date ? date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '';

            const badgeClass = getFileTypeBadgeClass(doc.fileType);

            // V√©rifier si l'utilisateur peut acc√©der aux documents
            const canAccess = userAccessRights && userAccessRights.canAccessDocuments;

            const viewButton = doc.fileType === 'PDF' && canAccess ?
                `<a href="${doc.fileUrl}" target="_blank" class="doc-btn view-btn">
                    <i class="fas fa-eye"></i>Voir
                </a>` : '';

            // Les documents communs sont toujours t√©l√©chargeables si on a acc√®s
            const downloadButton = canAccess ?
                `<a href="${doc.fileUrl}" download class="doc-btn">
                    <i class="fas fa-download"></i>T√©l√©charger
                </a>` :
                `<button onclick="alert('${userAccessRights.message}')" class="doc-btn" style="opacity: 0.5; cursor: not-allowed;">
                    <i class="fas fa-lock"></i>Bloqu√©
                </button>`;

            return `
                <div class="common-doc-item" data-type="document">
                    <div class="doc-info">
                        <div class="doc-title">${doc.title}</div>
                        <div class="doc-meta">
                            <span class="file-type-badge ${badgeClass}">
                                <i class="fas ${getFileIcon(doc.fileType)} mr-1"></i>${doc.fileType}
                            </span>
                            ${formattedDate ? `<span>Mis √† jour le ${formattedDate}</span>` : ''}
                        </div>
                        ${doc.description ? `<p class="mt-2 text-sm font-bold opacity-70">${doc.description}</p>` : ''}
                    </div>
                    <div class="doc-actions">
                        ${viewButton}
                        ${downloadButton}
                    </div>
                </div>
            `;
        }

        function createLivrableCard(livrable, index, canAccessFinalDeliverables, productType, canAccessDuringAccompaniment) {
            const card = document.createElement('div');
            card.className = 'livrable-card';
            card.setAttribute('data-aos', 'zoom-in');
            card.setAttribute('data-aos-delay', index * 100);
            card.setAttribute('data-type', livrable.type);

            const date = new Date(livrable.date);
            const formattedDate = date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });

            // D√©terminer le mode d'affichage selon le type de produit et le statut de paiement
            let buttonHTML = '';
            const isPhotoOrVideo = livrable.type === 'photo' || livrable.type === 'video';

            if (productType === 'prestation_individuelle') {
                // PRESTATION INDIVIDUELLE
                if (canAccessFinalDeliverables) {
                    // Solde pay√© ‚Üí T√©l√©chargement d√©bloqu√©
                    buttonHTML = `
                        <a href="${livrable.file}" download class="download-btn">
                            <i class="fas fa-download mr-2"></i>T√©l√©charger
                        </a>
                    `;
                } else if (canAccessDuringAccompaniment && isPhotoOrVideo) {
                    // Acompte pay√© ‚Üí Consultation uniquement (pas de t√©l√©chargement)
                    buttonHTML = `
                        <button onclick="previewLivrable('${livrable.type}', '${livrable.title}')" class="download-btn" style="background: #4dabf7;">
                            <i class="fas fa-eye mr-2"></i>Consulter
                        </button>
                        <p class="text-xs text-white mt-2 opacity-70">
                            <i class="fas fa-lock mr-1"></i>T√©l√©chargement disponible apr√®s r√®glement du solde
                        </p>
                    `;
                }
            } else {
                // ACCOMPAGNEMENT (logique normale)
                const canDownload = canAccessFinalDeliverables || isPhotoOrVideo;

                if (canDownload) {
                    buttonHTML = `
                        <a href="${livrable.file}" download class="download-btn">
                            <i class="fas fa-download mr-2"></i>T√©l√©charger
                        </a>
                    `;
                } else {
                    buttonHTML = `
                        <button onclick="alert('Ce livrable sera disponible apr√®s le paiement complet du solde')" class="download-btn" style="opacity: 0.5; cursor: not-allowed; background: #999;">
                            <i class="fas fa-lock mr-2"></i>Solde requis
                        </button>
                    `;
                }
            }

            card.innerHTML = `
                <div class="livrable-icon">
                    <i class="fas ${livrable.icon}"></i>
                </div>
                <div class="livrable-type">${getTypeLabel(livrable.type)}</div>
                <h3 class="text-xl font-black italic uppercase mb-2">${livrable.title}</h3>
                <p class="font-bold text-sm mb-4">${livrable.description}</p>
                <p class="text-xs font-bold opacity-70 mb-4">Ajout√© le ${formattedDate}</p>
                ${buttonHTML}
            `;

            return card;
        }

        function getTypeLabel(type) {
            const labels = {
                'document': 'Document',
                'photo': 'Photo',
                'video': 'Vid√©o'
            };
            return labels[type] || type;
        }

        console.log('Livrables page charg√©e');

        // Fonction de pr√©visualisation des livrables (pour prestations individuelles)
        function previewLivrable(type, title) {
            let message = '';
            let icon = '';

            if (type === 'photo') {
                icon = 'fa-images';
                message = `
                    <div style="text-align: center;">
                        <i class="fas ${icon}" style="font-size: 4rem; color: var(--genesis-yellow); margin-bottom: 1rem;"></i>
                        <h3 style="font-size: 1.5rem; font-weight: 900; text-transform: uppercase; margin-bottom: 1rem;">
                            Pr√©visualisation Photo
                        </h3>
                        <p style="font-weight: bold; margin-bottom: 1rem;">${title}</p>
                        <div style="background: #fffbea; padding: 1rem; border: 3px solid #ffd700; margin-bottom: 1rem;">
                            <p style="color: #000; font-weight: bold;">
                                <i class="fas fa-info-circle"></i> Mode consultation activ√©
                            </p>
                            <p style="color: #000; margin-top: 0.5rem;">
                                Vous visualisez actuellement vos photos en r√©solution limit√©e.
                            </p>
                        </div>
                        <p style="margin-bottom: 1rem;">
                            Le t√©l√©chargement des photos en haute r√©solution sera disponible apr√®s le r√®glement du solde (70%).
                        </p>
                        <p style="font-size: 0.875rem; opacity: 0.7;">
                            üí° Cette pr√©visualisation vous permet de valider les contenus avant le paiement final.
                        </p>
                    </div>
                `;
            } else if (type === 'video') {
                icon = 'fa-video';
                message = `
                    <div style="text-align: center;">
                        <i class="fas ${icon}" style="font-size: 4rem; color: var(--genesis-yellow); margin-bottom: 1rem;"></i>
                        <h3 style="font-size: 1.5rem; font-weight: 900; text-transform: uppercase; margin-bottom: 1rem;">
                            Pr√©visualisation Vid√©o
                        </h3>
                        <p style="font-weight: bold; margin-bottom: 1rem;">${title}</p>
                        <div style="background: #fffbea; padding: 1rem; border: 3px solid #ffd700; margin-bottom: 1rem;">
                            <p style="color: #000; font-weight: bold;">
                                <i class="fas fa-info-circle"></i> Mode consultation activ√©
                            </p>
                            <p style="color: #000; margin-top: 0.5rem;">
                                Vous visualisez actuellement votre vid√©o en streaming.
                            </p>
                        </div>
                        <p style="margin-bottom: 1rem;">
                            Le t√©l√©chargement de la vid√©o en qualit√© finale sera disponible apr√®s le r√®glement du solde (70%).
                        </p>
                        <p style="font-size: 0.875rem; opacity: 0.7;">
                            üí° Cette pr√©visualisation vous permet de valider le contenu avant le paiement final.
                        </p>
                    </div>
                `;
            }

            // Cr√©er une modale simple
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 2rem;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                color: black;
                padding: 2rem;
                max-width: 600px;
                width: 100%;
                border: 4px solid black;
                box-shadow: 10px 10px 0px var(--genesis-yellow);
            `;

            modalContent.innerHTML = message + `
                <button onclick="this.closest('div[style*=\"fixed\"]').remove()"
                        style="
                            width: 100%;
                            background: var(--genesis-yellow);
                            color: black;
                            border: 4px solid black;
                            padding: 1rem;
                            font-weight: 900;
                            text-transform: uppercase;
                            cursor: pointer;
                            margin-top: 1.5rem;
                            box-shadow: 4px 4px 0px black;
                        "
                        onmouseover="this.style.transform='translate(-2px, -2px)'; this.style.boxShadow='6px 6px 0px black'"
                        onmouseout="this.style.transform=''; this.style.boxShadow='4px 4px 0px black'"
                        >
                    Fermer
                </button>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Fermer en cliquant en dehors de la modale
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
    <script src="chatbot.js"></script>
</body>
</html>
