<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Mes Livrables - FA GENESIS | Espace Client</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }
        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, .nav-link { font-family: 'Unbounded', cursive; }
        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }
        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
        }
        .livrable-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .livrable-card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 14px 14px 0px 0px var(--genesis-yellow);
        }
        .livrable-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--genesis-yellow);
            border: 3px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.7rem;
            margin-bottom: 1rem;
        }
        .download-btn {
            background: black;
            color: white;
            border: 3px solid black;
            padding: 0.75rem 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-align: center;
            display: inline-block;
            margin-top: auto;
        }
        .download-btn:hover { background: var(--genesis-yellow); color: black; }
        .download-btn.disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .download-btn.disabled:hover { background: #999; color: white; }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: 4px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.75rem;
            cursor: pointer;
            background: white;
            color: black;
            transition: 0.1s;
        }
        .tab-btn.active {
            background: var(--genesis-yellow);
            color: black;
        }
        .empty-state {
            background: white;
            color: black;
            border: 4px dashed black;
            padding: 3rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- NAVIGATION PRIVEE -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-4 md:px-6 py-3 md:py-4 flex justify-between items-center text-white text-xs font-black uppercase">
        <div class="flex items-center">
            <a href="dashboard.html" class="text-lg md:text-2xl font-black tracking-wider text-[var(--genesis-yellow)]" style="font-family: 'Unbounded', cursive;">FA GENESIS</a>
        </div>
        <div class="hidden md:flex gap-8 text-white font-black">
            <a href="dashboard.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Dashboard</a>
            <a href="livrables.html" class="nav-link text-[var(--genesis-yellow)]">Livrables</a>
            <a href="seances.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Seances</a>
            <a href="mon-compte.html" class="nav-link hover:text-[var(--genesis-yellow)] transition">Mon compte</a>
        </div>
        <div class="flex gap-4 items-center">
            <span id="userGreeting" class="hidden md:block text-white font-bold"></span>
            <button onclick="logout()" class="border-4 border-white text-white px-3 py-2 text-[10px] tracking-widest font-black hover:bg-white hover:text-black transition">
                <i class="fas fa-sign-out-alt mr-1"></i><span class="hidden md:inline">Deconnexion</span>
            </button>
            <button id="mobileMenuBtn" class="md:hidden flex flex-col gap-1.5 p-2" aria-label="Menu">
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine1"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine2"></span>
                <span class="block w-6 h-0.5 bg-[var(--genesis-yellow)] transition-all" id="menuLine3"></span>
            </button>
        </div>
    </nav>

    <!-- Menu Mobile -->
    <div id="mobileMenu" class="fixed inset-0 z-40 bg-black/98 backdrop-blur-lg hidden flex-col items-center justify-center gap-8 text-white font-black uppercase">
        <a href="dashboard.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)]">Dashboard</a>
        <a href="livrables.html" class="text-2xl nav-link text-[var(--genesis-yellow)]">Livrables</a>
        <a href="seances.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)]">Seances</a>
        <a href="mon-compte.html" class="text-2xl nav-link hover:text-[var(--genesis-yellow)]">Mon compte</a>
        <div class="mt-8">
            <button onclick="logout()" class="neo-btn-yellow px-8 py-4 text-sm tracking-widest text-black font-black">
                <i class="fas fa-sign-out-alt mr-2"></i>Deconnexion
            </button>
        </div>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <section class="min-h-screen pt-32 pb-20 px-6 bg-black">
        <div class="container mx-auto max-w-6xl">

            <!-- Titre -->
            <div class="mb-12">
                <h1 class="text-5xl md:text-7xl font-black italic uppercase mb-4 text-[var(--genesis-yellow)]">
                    <i class="fas fa-file-download mr-4"></i>Mes livrables
                </h1>
                <p class="text-xl font-bold uppercase text-white">Documents, photos et videos de votre projet</p>
            </div>

            <!-- Loader -->
            <div id="livrablesLoader" class="mb-8">
                <div class="flex items-center gap-4 p-6" style="background: #222; border: 2px solid var(--genesis-yellow);">
                    <i class="fas fa-spinner fa-spin text-[var(--genesis-yellow)] text-2xl"></i>
                    <span class="font-bold text-white text-base">Chargement des livrables...</span>
                </div>
            </div>

            <!-- Erreur -->
            <div id="livrablesError" class="mb-8" style="display: none;">
                <div class="p-6 border-4 border-black" style="background: #ff6b6b; color: #000;">
                    <div class="flex items-center gap-4 mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                        <div>
                            <h3 class="text-xl font-black uppercase">Erreur</h3>
                            <p class="font-bold" id="livrablesErrorMsg">Impossible de charger les livrables.</p>
                        </div>
                    </div>
                    <button onclick="loadLivrables()" class="bg-black text-white px-6 py-3 font-black text-sm uppercase border-2 border-black mt-2">
                        <i class="fas fa-redo mr-2"></i>Reessayer
                    </button>
                </div>
            </div>

            <!-- Acces limite (pas d'acompte) -->
            <div id="livrablesLocked" class="mb-8" style="display: none;">
                <div class="p-8 border-4 border-black text-center" style="background: #333;">
                    <i class="fas fa-lock text-[var(--genesis-yellow)] text-4xl mb-4"></i>
                    <h2 class="text-2xl font-black italic uppercase text-white mb-4">Acces limite</h2>
                    <p class="text-white font-bold mb-6">Payez l'acompte pour acceder a vos livrables.</p>
                    <a href="dashboard.html" class="neo-btn-yellow px-8 py-4 text-sm uppercase inline-block">
                        <i class="fas fa-arrow-left mr-2"></i>Retour au dashboard
                    </a>
                </div>
            </div>

            <!-- Contenu livrables -->
            <div id="livrablesContent" style="display: none;">

                <!-- Onglets -->
                <div class="flex flex-wrap gap-2 mb-8">
                    <button class="tab-btn active" onclick="filterLivrables('all')" id="tabAll">Tous</button>
                    <button class="tab-btn" onclick="filterLivrables('Documents')" id="tabDocuments">Documents</button>
                    <button class="tab-btn" onclick="filterLivrables('Photos')" id="tabPhotos">Photos</button>
                    <button class="tab-btn" onclick="filterLivrables('Videos')" id="tabVideos">Videos</button>
                </div>

                <!-- Message telechargement bloque -->
                <div id="downloadNotice" class="mb-8" style="display: none;">
                    <div class="p-4 border-4 border-black" style="background: #ffd43b; color: black;">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Telechargement bloque</strong> - Payez le solde restant pour debloquer les telechargements.
                    </div>
                </div>

                <!-- Grille de livrables -->
                <div id="livrablesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

                <!-- Etat vide -->
                <div id="livrablesEmpty" style="display: none;">
                    <div class="empty-state">
                        <i class="fas fa-folder-open text-6xl mb-6 opacity-50"></i>
                        <h3 class="text-2xl font-black italic uppercase mb-4">Aucun livrable pour l'instant</h3>
                        <p class="font-bold opacity-70 mb-6">Vos documents, photos et videos apparaitront ici au fur et a mesure de votre projet.</p>
                        <a href="dashboard.html" class="download-btn inline-block">
                            <i class="fas fa-arrow-left mr-2"></i>Retour au dashboard
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // ============================================================
        // LIVRABLES - FETCH AUTHENTIFIE, ONGLETS, ZERO AOS
        // ============================================================
        var LIV_API = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';
        var _allLivrables = [];
        var _canDownload = false;

        // Auth check
        try {
            if (typeof requireAuth === 'function') { requireAuth(); }
            else {
                var t = localStorage.getItem('fa_genesis_token');
                if (!t) window.location.href = 'login.html';
            }
        } catch (e) {}

        // Greeting
        try {
            var raw = localStorage.getItem('fa_genesis_session');
            if (raw) {
                var u = JSON.parse(raw);
                var greet = document.getElementById('userGreeting');
                if (greet && u.prenom) greet.textContent = u.prenom;
            }
        } catch (e) {}

        function setLoading(v) {
            var el = document.getElementById('livrablesLoader');
            if (el) el.style.display = v ? '' : 'none';
        }

        function showError(msg) {
            var el = document.getElementById('livrablesError');
            if (el) el.style.display = '';
            var msgEl = document.getElementById('livrablesErrorMsg');
            if (msgEl) msgEl.textContent = msg;
        }

        function fetchWithTimeout(url, options, timeoutMs) {
            return new Promise(function(resolve, reject) {
                var controller = new AbortController();
                var timer = setTimeout(function() {
                    controller.abort();
                    reject(new Error('TIMEOUT'));
                }, timeoutMs || 8000);
                var opts = Object.assign({}, options || {}, { signal: controller.signal });
                fetch(url, opts).then(function(resp) {
                    clearTimeout(timer);
                    resolve(resp);
                }).catch(function(err) {
                    clearTimeout(timer);
                    reject(err);
                });
            });
        }

        async function loadLivrables() {
            setLoading(true);
            var errEl = document.getElementById('livrablesError');
            if (errEl) errEl.style.display = 'none';
            var lockedEl = document.getElementById('livrablesLocked');
            if (lockedEl) lockedEl.style.display = 'none';
            var contentEl = document.getElementById('livrablesContent');
            if (contentEl) contentEl.style.display = 'none';

            try {
                var token = localStorage.getItem('fa_genesis_token');
                if (!token) { window.location.href = 'login.html'; return; }

                var resp = await fetchWithTimeout(LIV_API + '/api/deliverables/mine', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }, 8000);

                if (resp.status === 401) {
                    localStorage.removeItem('fa_genesis_token');
                    localStorage.removeItem('fa_genesis_session');
                    window.location.href = 'login.html';
                    return;
                }

                if (!resp.ok) {
                    showError('Erreur serveur (' + resp.status + ')');
                    return;
                }

                var data = await resp.json();
                if (!data.ok) {
                    // Pas de commande payee = acces bloque
                    if (data.message && data.message.indexOf('payee') !== -1) {
                        if (lockedEl) lockedEl.style.display = '';
                        return;
                    }
                    showError(data.error || 'Erreur inconnue');
                    return;
                }

                _allLivrables = data.deliverables || [];
                _canDownload = data.can_download === true;

                // Check deposit status from localStorage
                try {
                    var sess = JSON.parse(localStorage.getItem('fa_genesis_session') || '{}');
                    if (sess.deposit_paid === false || sess.paymentStatus === 'registered') {
                        if (lockedEl) lockedEl.style.display = '';
                        return;
                    }
                } catch (e) {}

                if (contentEl) contentEl.style.display = '';

                // Notice telechargement bloque
                var noticeEl = document.getElementById('downloadNotice');
                if (noticeEl) noticeEl.style.display = _canDownload ? 'none' : '';

                renderLivrables(_allLivrables);

            } catch (err) {
                console.error('[LIVRABLES] Erreur:', err.message);
                if (err.message.indexOf('TIMEOUT') !== -1) {
                    showError('Le serveur ne repond pas. Reessayez.');
                } else {
                    showError(err.message || 'Erreur de connexion');
                }
            } finally {
                setLoading(false);
            }
        }

        function renderLivrables(items) {
            var container = document.getElementById('livrablesList');
            var emptyEl = document.getElementById('livrablesEmpty');
            if (!container) return;

            if (!items || items.length === 0) {
                container.innerHTML = '';
                if (emptyEl) emptyEl.style.display = '';
                return;
            }

            if (emptyEl) emptyEl.style.display = 'none';

            var html = '';
            for (var i = 0; i < items.length; i++) {
                var liv = items[i];
                var icon = 'fa-file-alt';
                if (liv.type === 'photo') icon = 'fa-image';
                else if (liv.type === 'video') icon = 'fa-video';
                else if (liv.type === 'audio') icon = 'fa-music';

                var dateStr = '';
                if (liv.created_at) {
                    try {
                        var d = new Date(liv.created_at);
                        dateStr = d.toLocaleDateString('fr-FR');
                    } catch (e) { dateStr = ''; }
                }

                var downloadHtml = '';
                if (liv.download_url) {
                    if (_canDownload) {
                        downloadHtml = '<a href="' + liv.download_url + '" target="_blank" class="download-btn"><i class="fas fa-download mr-2"></i>Telecharger</a>';
                    } else {
                        downloadHtml = '<span class="download-btn disabled" title="Payez le solde pour telecharger"><i class="fas fa-lock mr-2"></i>Telecharger</span>';
                    }
                } else if (liv.content_text) {
                    downloadHtml = '<button onclick="previewText(this)" class="download-btn" data-content="' + escapeAttr(liv.content_text) + '"><i class="fas fa-eye mr-2"></i>Voir</button>';
                }

                html += '<div class="livrable-card" data-category="' + (liv.category || 'Documents') + '">';
                html += '<i class="fas ' + icon + ' text-4xl mb-4 text-[var(--genesis-yellow)]"></i>';
                html += '<span class="livrable-type">' + (liv.category || 'Document') + '</span>';
                html += '<h3 class="text-lg font-black uppercase mb-2">' + escapeHtml(liv.name) + '</h3>';
                if (dateStr) html += '<p class="text-xs font-bold opacity-50 mb-4">' + dateStr + '</p>';
                if (liv.status) html += '<p class="text-xs font-bold uppercase mb-4" style="color: ' + (liv.status === 'ready' || liv.status === 'delivered' ? '#51cf66' : '#ffd43b') + ';">' + escapeHtml(liv.status) + '</p>';
                html += '<div class="mt-auto">' + downloadHtml + '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function filterLivrables(category) {
            // Update tab buttons
            var tabs = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            var tabId = 'tab' + (category === 'all' ? 'All' : category);
            var activeTab = document.getElementById(tabId);
            if (activeTab) activeTab.classList.add('active');

            if (category === 'all') {
                renderLivrables(_allLivrables);
            } else {
                var filtered = _allLivrables.filter(function(l) {
                    return l.category === category;
                });
                renderLivrables(filtered);
            }
        }

        function previewText(btn) {
            var content = btn.getAttribute('data-content') || '';
            alert(content);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ============================================================
        // MENU MOBILE
        // ============================================================
        var mobileMenuBtn = document.getElementById('mobileMenuBtn');
        var mobileMenu = document.getElementById('mobileMenu');
        var menuLine1 = document.getElementById('menuLine1');
        var menuLine2 = document.getElementById('menuLine2');
        var menuLine3 = document.getElementById('menuLine3');
        var isMenuOpen = false;

        function toggleMobileMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.classList.add('flex');
                menuLine1.style.transform = 'rotate(45deg) translate(5px, 5px)';
                menuLine2.style.opacity = '0';
                menuLine3.style.transform = 'rotate(-45deg) translate(5px, -5px)';
                document.body.style.overflow = 'hidden';
            } else { closeMobileMenu(); }
        }

        function closeMobileMenu() {
            isMenuOpen = false;
            if (mobileMenu) { mobileMenu.classList.add('hidden'); mobileMenu.classList.remove('flex'); }
            if (menuLine1) menuLine1.style.transform = 'none';
            if (menuLine2) menuLine2.style.opacity = '1';
            if (menuLine3) menuLine3.style.transform = 'none';
            document.body.style.overflow = 'auto';
        }

        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);

        // Lancer le chargement
        loadLivrables();
    </script>
    <div id="site-footer"></div>
    <script src="footer.js" defer></script>
    <script src="chatbot.js" defer></script>
</body>
</html>
