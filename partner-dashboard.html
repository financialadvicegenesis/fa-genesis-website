<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>Espace Partenaire - FA GENESIS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Space+Grotesk:wght@300;700&display=swap">
    <link rel="stylesheet" href="tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --genesis-yellow: #FFD700;
            --genesis-black: #000000;
            --genesis-white: #FFFFFF;
        }
        body {
            background-color: var(--genesis-black);
            color: var(--genesis-white);
            font-family: 'Space Grotesk', sans-serif;
        }
        h1, h2, h3, h4, h5 { font-family: 'Unbounded', cursive; }
        .neo-border { border: 4px solid var(--genesis-black); }
        .neo-shadow { box-shadow: 10px 10px 0px 0px var(--genesis-yellow); }
        .neo-btn-yellow {
            background: var(--genesis-yellow);
            color: black;
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            font-weight: 900;
            transition: 0.1s;
            cursor: pointer;
        }
        .neo-btn-yellow:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px black;
        }
        .neo-btn-yellow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .partner-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .partner-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--genesis-yellow);
        }
        .section-card {
            background: white;
            color: black;
            border: 4px solid black;
            padding: 2rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border: 2px solid black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.7rem;
        }
        .status-pending { background: #ffd43b; color: black; }
        .status-approved { background: #51cf66; color: white; }
        .status-rejected { background: #ff6b6b; color: white; }
        .status-active { background: #4dabf7; color: white; }
        .comment-bubble {
            padding: 1rem;
            border: 3px solid black;
            margin-bottom: 0.75rem;
        }
        .comment-partner { background: #FFF9E6; border-left: 6px solid var(--genesis-yellow); }
        .comment-admin { background: #E8F5E9; border-left: 6px solid #51cf66; }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 3px solid black;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
            background: white;
            color: black;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--genesis-yellow);
        }
        .upload-item {
            background: #f8f9fa;
            border: 2px solid black;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        .tab-btn {
            padding: 0.5rem 1.5rem;
            border: 3px solid black;
            font-weight: 900;
            font-size: 0.8rem;
            text-transform: uppercase;
            cursor: pointer;
            background: white;
            color: black;
        }
        .tab-btn.active {
            background: var(--genesis-yellow);
            box-shadow: 4px 4px 0px black;
        }
    </style>
</head>
<body>

    <!-- NAVIGATION PARTENAIRE -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b-4 border-[var(--genesis-yellow)] px-4 md:px-6 py-3 md:py-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-4 md:gap-8">
                <h1 class="text-lg md:text-2xl font-black text-[var(--genesis-yellow)]">
                    <i class="fas fa-handshake mr-2"></i>PARTENAIRE
                </h1>
                <div class="hidden md:flex gap-4 text-sm font-black">
                    <button onclick="showSection('projects')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] transition">
                        <i class="fas fa-briefcase mr-1"></i>Projets
                    </button>
                    <button onclick="showSection('missions')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] transition" style="position:relative;">
                        <i class="fas fa-tasks mr-1"></i>Missions
                        <span id="missionsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:18px;height:18px;font-size:10px;line-height:18px;text-align:center;"></span>
                    </button>
                    <button onclick="showSection('quotes')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] transition" style="position:relative;">
                        <i class="fas fa-file-invoice mr-1"></i>Devis
                        <span id="partnerQuotesBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:18px;height:18px;font-size:10px;line-height:18px;text-align:center;"></span>
                    </button>
                    <button onclick="showSection('seances')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] transition" style="position:relative;">
                        <i class="fas fa-video mr-1"></i>Séances
                        <span id="seancesBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ff6b6b;color:white;border-radius:50%;width:18px;height:18px;font-size:10px;line-height:18px;text-align:center;"></span>
                    </button>
                    <button onclick="showSection('profile')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] transition">
                        <i class="fas fa-user mr-1"></i>Profil
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="partnerName" class="text-white text-xs font-bold hidden md:inline"></span>
                <span id="partnerTypeBadge" class="text-xs px-2 py-1 bg-[var(--genesis-yellow)] text-black font-black border-2 border-black"></span>
                <button onclick="handlePartnerLogout()" class="border-3 border-white text-white px-3 py-1.5 text-xs font-black hover:bg-white hover:text-black transition">
                    <i class="fas fa-sign-out-alt mr-1"></i>
                </button>
            </div>
        </div>
        <!-- Mobile nav -->
        <div class="flex md:hidden gap-2 mt-2">
            <button onclick="showSection('projects')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] text-xs font-black">
                <i class="fas fa-briefcase mr-1"></i>Projets
            </button>
            <button onclick="showSection('missions')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] text-xs font-black" style="position:relative;">
                <i class="fas fa-tasks mr-1"></i>Missions
                <span id="missionsBadgeMobile" style="display:none;position:absolute;top:-6px;right:-6px;background:#ff6b6b;color:white;border-radius:50%;width:16px;height:16px;font-size:9px;line-height:16px;text-align:center;"></span>
            </button>
            <button onclick="showSection('quotes')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] text-xs font-black" style="position:relative;">
                <i class="fas fa-file-invoice mr-1"></i>Devis
                <span id="partnerQuotesBadgeMobile" style="display:none;position:absolute;top:-6px;right:-6px;background:#ff6b6b;color:white;border-radius:50%;width:16px;height:16px;font-size:9px;line-height:16px;text-align:center;"></span>
            </button>
            <button onclick="showSection('seances')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] text-xs font-black" style="position:relative;">
                <i class="fas fa-video mr-1"></i>Séances
                <span id="seancesBadgeMobile" style="display:none;position:absolute;top:-6px;right:-6px;background:#ff6b6b;color:white;border-radius:50%;width:16px;height:16px;font-size:9px;line-height:16px;text-align:center;"></span>
            </button>
            <button onclick="showSection('profile')" class="nav-tab text-white hover:text-[var(--genesis-yellow)] text-xs font-black">
                <i class="fas fa-user mr-1"></i>Profil
            </button>
        </div>
    </nav>

    <div class="pt-28 md:pt-24 pb-20 px-4 md:px-6">

        <!-- LOADING -->
        <div id="loadingState" class="container mx-auto max-w-5xl text-center py-20">
            <div class="text-4xl text-[var(--genesis-yellow)] mb-4"><i class="fas fa-spinner fa-spin"></i></div>
            <p class="font-bold opacity-70">Chargement de votre espace...</p>
        </div>

        <!-- ERROR BANNER -->
        <div id="errorBanner" class="container mx-auto max-w-5xl mb-6" style="display:none;">
            <div class="bg-red-500 text-white p-4 border-4 border-black font-bold">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="errorBannerText"></span>
            </div>
        </div>

        <!-- SECTION PROJETS -->
        <div id="projectsSection" class="container mx-auto max-w-5xl" style="display:none;">
            <h2 class="text-3xl md:text-5xl font-black italic uppercase mb-8 text-[var(--genesis-yellow)]">
                <i class="fas fa-briefcase mr-3"></i>MES PROJETS
            </h2>
            <div id="projectsList">
                <p class="text-center py-8 opacity-50 font-bold">Aucun projet assigné</p>
            </div>
        </div>

        <!-- SECTION DETAIL PROJET -->
        <div id="projectDetailSection" class="container mx-auto max-w-5xl" style="display:none;">
            <button onclick="backToProjects()" class="text-white font-black mb-6 hover:text-[var(--genesis-yellow)] transition">
                <i class="fas fa-arrow-left mr-2"></i>Retour aux projets
            </button>

            <div id="projectHeader" class="section-card neo-shadow mb-8"></div>

            <!-- Onglets -->
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="showProjectTab('uploads')" class="tab-btn active" id="tabUploads">
                    <i class="fas fa-upload mr-1"></i>Uploads
                </button>
                <button onclick="showProjectTab('history')" class="tab-btn" id="tabHistory">
                    <i class="fas fa-history mr-1"></i>Historique
                </button>
                <button onclick="showProjectTab('comments')" class="tab-btn" id="tabComments">
                    <i class="fas fa-comments mr-1"></i>Commentaires
                </button>
            </div>

            <!-- Tab: Upload -->
            <div id="panelUploads" class="section-card mb-8">
                <h3 class="text-xl font-black italic uppercase mb-6">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>SOUMETTRE UN LIVRABLE
                </h3>
                <form id="uploadForm" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-black mb-1 uppercase text-sm">Nom du fichier</label>
                            <input type="text" id="uploadName" placeholder="Ex: Photo portrait client" required>
                        </div>
                        <div>
                            <label class="block font-black mb-1 uppercase text-sm">Fichier</label>
                            <input type="file" id="uploadFile" required class="text-sm">
                            <p class="text-xs font-bold opacity-50 mt-1" id="allowedTypesHint"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block font-black mb-1 uppercase text-sm">Description (optionnelle)</label>
                        <textarea id="uploadDescription" rows="2" placeholder="Détails sur le fichier..."></textarea>
                    </div>
                    <!-- Champs speciaux MEDIA -->
                    <div id="mediaFields" style="display:none;">
                        <h4 class="font-black uppercase text-sm mb-3 mt-4 text-[var(--genesis-yellow)]">
                            <i class="fas fa-bullhorn mr-1"></i>Informations de publication (obligatoires)
                        </h4>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block font-black mb-1 uppercase text-sm">Lien publication</label>
                                <input type="url" id="uploadPublicationLink" placeholder="https://instagram.com/p/...">
                            </div>
                            <div>
                                <label class="block font-black mb-1 uppercase text-sm">Date publication</label>
                                <input type="date" id="uploadPublicationDate">
                            </div>
                            <div>
                                <label class="block font-black mb-1 uppercase text-sm">Type diffusion</label>
                                <select id="uploadDiffusionType">
                                    <option value="">Sélectionner...</option>
                                    <option value="post">Post</option>
                                    <option value="story">Story</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="uploadSubmitBtn" class="neo-btn-yellow px-8 py-3 text-sm">
                        <i class="fas fa-paper-plane mr-2"></i>SOUMETTRE
                    </button>
                </form>
            </div>

            <!-- Tab: Historique -->
            <div id="panelHistory" class="section-card mb-8" style="display:none;">
                <h3 class="text-xl font-black italic uppercase mb-6">
                    <i class="fas fa-history mr-2"></i>MES UPLOADS
                </h3>
                <div id="uploadsHistoryList">
                    <p class="text-center py-4 opacity-50 font-bold">Aucun upload</p>
                </div>
            </div>

            <!-- Tab: Commentaires -->
            <div id="panelComments" class="section-card mb-8" style="display:none;">
                <h3 class="text-xl font-black italic uppercase mb-6">
                    <i class="fas fa-comments mr-2"></i>COMMENTAIRES
                </h3>
                <div id="commentsList" class="mb-6">
                    <p class="text-center py-4 opacity-50 font-bold">Aucun commentaire</p>
                </div>
                <form id="commentForm" class="flex gap-3">
                    <textarea id="commentContent" rows="2" placeholder="Écrire un commentaire..." class="flex-1"></textarea>
                    <button type="submit" class="neo-btn-yellow px-6 self-end">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- SECTION PROFIL -->
        <div id="profileSection" class="container mx-auto max-w-3xl" style="display:none;">
            <h2 class="text-3xl md:text-5xl font-black italic uppercase mb-8 text-[var(--genesis-yellow)]">
                <i class="fas fa-user-circle mr-3"></i>MON PROFIL
            </h2>
            <div class="section-card neo-shadow">
                <div id="profileInfo" class="mb-8"></div>
                <hr class="border-2 border-black my-6">
                <h3 class="text-lg font-black italic uppercase mb-4">
                    <i class="fas fa-lock mr-2"></i>CHANGER MON MOT DE PASSE
                </h3>
                <form id="passwordForm" class="space-y-4">
                    <div>
                        <label class="block font-black mb-1 uppercase text-sm">Nouveau mot de passe</label>
                        <input type="password" id="newPassword" placeholder="Minimum 6 caractères" required minlength="6">
                    </div>
                    <div>
                        <label class="block font-black mb-1 uppercase text-sm">Confirmer</label>
                        <input type="password" id="confirmPassword" placeholder="Confirmer le mot de passe" required>
                    </div>
                    <button type="submit" class="neo-btn-yellow px-6 py-3 text-sm">
                        <i class="fas fa-save mr-2"></i>METTRE À JOUR
                    </button>
                </form>
                <div id="profileMessage" class="mt-4" style="display:none;"></div>
            </div>
        </div>

        <!-- SECTION DEVIS -->
        <div id="quotesSection" class="container mx-auto max-w-5xl" style="display:none;">
            <h2 class="text-3xl md:text-5xl font-black italic uppercase mb-8 text-[var(--genesis-yellow)]">
                <i class="fas fa-file-invoice mr-3"></i>MES DEVIS
            </h2>
            <div id="partnerQuotesList">
                <p class="text-center py-8 opacity-50 font-bold">Chargement...</p>
            </div>
        </div>

        <!-- SECTION DETAIL DEVIS -->
        <div id="quoteDetailSection" class="container mx-auto max-w-5xl" style="display:none;">
            <button onclick="backToQuotes()" class="text-white font-black mb-6 hover:text-[var(--genesis-yellow)] transition">
                <i class="fas fa-arrow-left mr-2"></i>Retour aux devis
            </button>
            <div id="partnerQuoteDetail"></div>
        </div>

        <!-- ===== SECTION MISSIONS ===== -->
        <div id="missionsSection" class="container mx-auto max-w-5xl" style="display:none;">
            <h2 class="text-2xl md:text-3xl font-black text-white mb-6" style="font-family:'Playfair Display',serif;">
                <i class="fas fa-tasks mr-3" style="color:var(--genesis-yellow);"></i>MES MISSIONS
            </h2>
            <p class="text-white text-sm mb-6 opacity-70">Livrables assignes a vos commandes. Vous pouvez modifier, uploader des fichiers et soumettre pour validation.</p>

            <div id="missionsListContainer">
                <p class="text-center py-8 opacity-50 font-bold text-white">Chargement...</p>
            </div>

            <!-- Detail mission (cache) -->
            <div id="missionDetailView" style="display:none;">
                <button onclick="backToMissions()" class="text-white font-black mb-6 hover:text-[var(--genesis-yellow)] transition">
                    <i class="fas fa-arrow-left mr-2"></i>Retour aux missions
                </button>
                <div id="missionDetailContent"></div>
            </div>
        </div>

        <!-- ===== SECTION SÉANCES ===== -->
        <div id="seancesSection" class="container mx-auto max-w-5xl" style="display:none;">
            <h2 class="text-2xl md:text-3xl font-black text-white mb-6" style="font-family:'Playfair Display',serif;">
                <i class="fas fa-video mr-3" style="color:var(--genesis-yellow);"></i>MES SÉANCES
            </h2>
            <p class="text-white text-sm mb-6 opacity-70">Gérez les demandes de séances de vos clients. Proposez des créneaux, confirmez et ajoutez les liens Google Meet.</p>

            <!-- Sous-tabs -->
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="showSeancesTab('demandes')" id="tabSeanceDemandes" class="tab-btn active" style="font-size:0.75rem;">
                    <i class="fas fa-inbox mr-1"></i>Demandes <span id="seancesDemandesCount" style="background:#ff6b6b;color:white;border-radius:50%;padding:0 6px;margin-left:4px;font-size:10px;"></span>
                </button>
                <button onclick="showSeancesTab('confirmees')" id="tabSeanceConfirmees" class="tab-btn" style="font-size:0.75rem;">
                    <i class="fas fa-check-circle mr-1"></i>Confirmées
                </button>
                <button onclick="showSeancesTab('historique')" id="tabSeanceHistorique" class="tab-btn" style="font-size:0.75rem;">
                    <i class="fas fa-history mr-1"></i>Historique
                </button>
            </div>

            <div id="seancesDemandesPanel">
                <p class="text-center py-8 opacity-50 font-bold text-white">Chargement...</p>
            </div>
            <div id="seancesConfirmeesPanel" style="display:none;">
                <p class="text-center py-8 opacity-50 font-bold text-white">Chargement...</p>
            </div>
            <div id="seancesHistoriquePanel" style="display:none;">
                <p class="text-center py-8 opacity-50 font-bold text-white">Chargement...</p>
            </div>
        </div>

        <!-- MODAL : Proposer/Confirmer une séance -->
        <div id="sessionActionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;overflow-y:auto;">
            <div style="max-width:500px;margin:80px auto;background:white;color:black;border:4px solid black;padding:2rem;">
                <h3 id="sessionModalTitle" style="font-family:'Unbounded',cursive;font-size:1.1rem;font-weight:900;margin-bottom:1rem;"></h3>
                <form id="sessionActionForm">
                    <div style="margin-bottom:1rem;">
                        <label style="font-weight:900;font-size:0.85rem;display:block;margin-bottom:4px;">DATE ET HEURE</label>
                        <input type="datetime-local" id="sessionModalDatetime" required style="width:100%;padding:0.75rem;border:3px solid black;font-weight:bold;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="font-weight:900;font-size:0.85rem;display:block;margin-bottom:4px;">DURÉE (MINUTES)</label>
                        <input type="number" id="sessionModalDuration" value="45" min="15" max="180" required style="width:100%;padding:0.75rem;border:3px solid black;font-weight:bold;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="font-weight:900;font-size:0.85rem;display:block;margin-bottom:4px;">LIEN GOOGLE MEET (optionnel)</label>
                        <input type="url" id="sessionModalMeetUrl" placeholder="https://meet.google.com/..." style="width:100%;padding:0.75rem;border:3px solid black;font-weight:bold;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="font-weight:900;font-size:0.85rem;display:block;margin-bottom:4px;">LIEU (optionnel)</label>
                        <input type="text" id="sessionModalLocation" placeholder="Ex: Montpellier, À distance..." style="width:100%;padding:0.75rem;border:3px solid black;font-weight:bold;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="font-weight:900;font-size:0.85rem;display:block;margin-bottom:4px;">NOTES</label>
                        <textarea id="sessionModalNotes" rows="3" placeholder="Notes pour le client..." style="width:100%;padding:0.75rem;border:3px solid black;font-weight:bold;"></textarea>
                    </div>
                    <div style="display:flex;gap:0.5rem;">
                        <button type="submit" class="neo-btn-yellow" style="padding:0.75rem 1.5rem;font-size:0.85rem;" id="sessionModalSubmitBtn">
                            <i class="fas fa-check mr-1"></i>VALIDER
                        </button>
                        <button type="button" onclick="closeSessionModal()" style="padding:0.75rem 1.5rem;border:3px solid black;font-weight:900;font-size:0.85rem;background:#eee;cursor:pointer;">
                            ANNULER
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script src="config.js"></script>
    <script src="partner-auth.js"></script>
    <script>
    // ==============================================
    // PARTENAIRE DASHBOARD - FA GENESIS
    // ==============================================

    var currentPartner = null;
    var currentProjectOrderId = null;
    var currentProjectData = null;

    // Types de fichiers autorises par type de partenaire
    var PARTNER_ALLOWED_TYPES = {
        photographer: { extensions: ['jpg', 'jpeg', 'png'], accept: '.jpg,.jpeg,.png', label: 'JPG, JPEG, PNG' },
        videographer: { extensions: ['mp4', 'mov', '4k'], accept: '.mp4,.mov,.4k', label: 'MP4, MOV, 4K' },
        marketer: { extensions: ['pdf', 'docx'], accept: '.pdf,.docx', label: 'PDF, DOCX' },
        media: { extensions: ['jpg', 'jpeg', 'png', 'pdf'], accept: '.jpg,.jpeg,.png,.pdf', label: 'JPG, JPEG, PNG, PDF' }
    };

    // Labels des types de partenaire
    var PARTNER_TYPE_LABELS = {
        photographer: 'Photographe',
        videographer: 'Vidéographe',
        marketer: 'Marketeur',
        media: 'Média'
    };

    // ==============================================
    // INITIALISATION
    // ==============================================

    (async function init() {
        try {
            // Verifier l'authentification
            if (!isPartnerAuthenticated()) {
                window.location.href = 'partner-login.html';
                return;
            }

            // Verifier la session serveur
            var partner = await verifyPartnerSession();
            if (!partner) {
                window.location.href = 'partner-login.html';
                return;
            }

            currentPartner = partner;
            renderPartnerInfo();
            showSection('projects');

        } catch (error) {
            console.error('[PARTNER-DASH] Erreur init:', error);
            showError('Erreur de chargement. Le serveur est peut-être en cours de démarrage. Rechargez la page dans quelques instants.');
        }
    })();

    // ==============================================
    // NAVIGATION
    // ==============================================

    function showSection(section) {
        var loading = document.getElementById('loadingState');
        var projects = document.getElementById('projectsSection');
        var detail = document.getElementById('projectDetailSection');
        var profile = document.getElementById('profileSection');
        var quotes = document.getElementById('quotesSection');
        var quoteDetail = document.getElementById('quoteDetailSection');
        var missions = document.getElementById('missionsSection');
        var seances = document.getElementById('seancesSection');

        if (loading) loading.style.display = 'none';
        if (projects) projects.style.display = 'none';
        if (detail) detail.style.display = 'none';
        if (profile) profile.style.display = 'none';
        if (quotes) quotes.style.display = 'none';
        if (quoteDetail) quoteDetail.style.display = 'none';
        if (missions) missions.style.display = 'none';
        if (seances) seances.style.display = 'none';

        if (section === 'projects') {
            if (projects) projects.style.display = 'block';
            loadProjects();
        } else if (section === 'profile') {
            if (profile) profile.style.display = 'block';
            renderProfileSection();
        } else if (section === 'quotes') {
            if (quotes) quotes.style.display = 'block';
            loadPartnerQuotes();
        } else if (section === 'missions') {
            if (missions) missions.style.display = 'block';
            loadMissions();
        } else if (section === 'seances') {
            if (seances) seances.style.display = 'block';
            loadPartnerSessions();
        }
    }

    function showProjectTab(tab) {
        // Masquer tous les panels
        var panels = ['panelUploads', 'panelHistory', 'panelComments'];
        for (var i = 0; i < panels.length; i++) {
            var p = document.getElementById(panels[i]);
            if (p) p.style.display = 'none';
        }
        // Desactiver tous les onglets
        var tabs = ['tabUploads', 'tabHistory', 'tabComments'];
        for (var j = 0; j < tabs.length; j++) {
            var t = document.getElementById(tabs[j]);
            if (t) t.classList.remove('active');
        }
        // Activer l'onglet et le panel selectionne
        if (tab === 'uploads') {
            var pu = document.getElementById('panelUploads');
            var tu = document.getElementById('tabUploads');
            if (pu) pu.style.display = 'block';
            if (tu) tu.classList.add('active');
        } else if (tab === 'history') {
            var ph = document.getElementById('panelHistory');
            var th = document.getElementById('tabHistory');
            if (ph) ph.style.display = 'block';
            if (th) th.classList.add('active');
        } else if (tab === 'comments') {
            var pc = document.getElementById('panelComments');
            var tc = document.getElementById('tabComments');
            if (pc) pc.style.display = 'block';
            if (tc) tc.classList.add('active');
        }
    }

    function backToProjects() {
        currentProjectOrderId = null;
        currentProjectData = null;
        showSection('projects');
    }

    // ==============================================
    // PARTNER INFO HEADER
    // ==============================================

    function renderPartnerInfo() {
        if (!currentPartner) return;

        var nameEl = document.getElementById('partnerName');
        var badgeEl = document.getElementById('partnerTypeBadge');

        if (nameEl) nameEl.textContent = currentPartner.prenom + ' ' + currentPartner.nom;
        if (badgeEl) badgeEl.textContent = (PARTNER_TYPE_LABELS[currentPartner.partner_type] || currentPartner.partner_type).toUpperCase();

        // Configurer le type de fichier accepte
        var typeConfig = PARTNER_ALLOWED_TYPES[currentPartner.partner_type];
        var fileInput = document.getElementById('uploadFile');
        var hintEl = document.getElementById('allowedTypesHint');

        if (typeConfig && fileInput) {
            fileInput.setAttribute('accept', typeConfig.accept);
        }
        if (typeConfig && hintEl) {
            hintEl.textContent = 'Formats acceptés :' + typeConfig.label;
        }

        // Afficher les champs media si partenaire media
        var mediaFields = document.getElementById('mediaFields');
        if (mediaFields) {
            mediaFields.style.display = currentPartner.partner_type === 'media' ? 'block' : 'none';
        }
    }

    // ==============================================
    // PROJETS
    // ==============================================

    async function loadProjects() {
        var container = document.getElementById('projectsList');
        if (!container) return;

        container.innerHTML = '<p class="text-center py-4 opacity-50 font-bold"><i class="fas fa-spinner fa-spin mr-2"></i>Chargement...</p>';

        try {
            var response = await partnerAuthenticatedFetch(PARTNER_API_BASE_URL + '/api/partner/projects');

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'partner-login.html';
                    return;
                }
                throw new Error('Erreur ' + response.status);
            }

            var projects = await response.json();

            if (!projects || projects.length === 0) {
                container.innerHTML = '<div class="section-card text-center py-12">' +
                    '<i class="fas fa-inbox text-4xl opacity-30 mb-4"></i>' +
                    '<p class="font-bold opacity-50">Aucun projet assigné pour le moment</p>' +
                    '<p class="text-sm opacity-40 mt-2">Les projets vous seront assignés par l\'administrateur</p>' +
                '</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < projects.length; i++) {
                var proj = projects[i];
                var order = proj.order || {};
                var assignment = proj.assignment || {};

                var statusLabel = {
                    active: 'Actif', in_progress: 'En cours', delivered: 'Livré',
                    completed: 'Terminé', pending_deposit: 'Acompte en attente',
                    pending_balance: 'Solde en attente', paid_in_full: 'Payé'
                }[order.status] || order.status || 'N/A';

                var date = order.created_at ? new Date(order.created_at).toLocaleDateString('fr-FR') : '';

                html += '<div class="partner-card" onclick="openProject(\'' + order.id + '\')">' +
                    '<div class="flex justify-between items-center flex-wrap gap-3">' +
                        '<div class="flex-1 min-w-[200px]">' +
                            '<div class="font-black text-lg">' + (order.product_name || 'Projet') + '</div>' +
                            '<div class="text-sm font-bold opacity-60">' +
                                '<i class="fas fa-user mr-1"></i>' + (order.client_name || 'Client') +
                                (date ? ' <span class="ml-3"><i class="fas fa-calendar mr-1"></i>' + date + '</span>' : '') +
                            '</div>' +
                            (assignment.notes ? '<div class="text-xs opacity-50 mt-1"><i class="fas fa-sticky-note mr-1"></i>' + assignment.notes + '</div>' : '') +
                        '</div>' +
                        '<div class="flex items-center gap-3">' +
                            '<span class="status-badge status-active">' + statusLabel + '</span>' +
                            '<i class="fas fa-chevron-right opacity-30"></i>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }

            container.innerHTML = html;

        } catch (error) {
            console.error('[PARTNER-DASH] Erreur chargement projets:', error);
            container.innerHTML = '<div class="section-card text-center py-8">' +
                '<p class="font-bold text-red-600">Erreur de chargement</p>' +
                '<p class="text-sm opacity-50 mt-2">Le serveur est peut-être en cours de démarrage</p>' +
                '<button onclick="loadProjects()" class="neo-btn-yellow px-6 py-2 mt-4 text-sm">Réessayer</button>' +
            '</div>';
        }
    }

    // ==============================================
    // DETAIL PROJET
    // ==============================================

    async function openProject(orderId) {
        currentProjectOrderId = orderId;

        // Masquer les projets, afficher le detail
        var projects = document.getElementById('projectsSection');
        var detail = document.getElementById('projectDetailSection');
        if (projects) projects.style.display = 'none';
        if (detail) detail.style.display = 'block';

        // Reset aux onglets uploads
        showProjectTab('uploads');

        var header = document.getElementById('projectHeader');
        if (header) header.innerHTML = '<p class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Chargement...</p>';

        try {
            var response = await partnerAuthenticatedFetch(PARTNER_API_BASE_URL + '/api/partner/projects/' + orderId);

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'partner-login.html';
                    return;
                }
                throw new Error('Erreur ' + response.status);
            }

            currentProjectData = await response.json();
            renderProjectDetail();

        } catch (error) {
            console.error('[PARTNER-DASH] Erreur detail projet:', error);
            if (header) {
                header.innerHTML = '<p class="text-center py-4 font-bold text-red-600">Erreur de chargement du projet</p>' +
                    '<button onclick="openProject(\'' + orderId + '\')" class="neo-btn-yellow px-6 py-2 mt-2 text-sm">Réessayer</button>';
            }
        }
    }

    function renderProjectDetail() {
        if (!currentProjectData) return;

        var order = currentProjectData.order || {};
        var assignment = currentProjectData.assignment || {};
        var uploads = currentProjectData.uploads || [];
        var comments = currentProjectData.comments || [];

        // Header du projet
        var header = document.getElementById('projectHeader');
        if (header) {
            var statusLabel = {
                active: 'Actif', in_progress: 'En cours', delivered: 'Livre',
                completed: 'Termine', pending_deposit: 'Acompte en attente',
                pending_balance: 'Solde en attente', paid_in_full: 'Paye'
            }[order.status] || order.status || 'N/A';

            header.innerHTML =
                '<div class="flex justify-between items-start flex-wrap gap-4">' +
                    '<div>' +
                        '<h2 class="text-2xl font-black italic uppercase">' + (order.product_name || 'Projet') + '</h2>' +
                        '<p class="font-bold opacity-60 mt-1"><i class="fas fa-user mr-1"></i>' + (order.client_name || 'Client') + '</p>' +
                        (assignment.notes ? '<p class="text-sm opacity-50 mt-2"><i class="fas fa-sticky-note mr-1"></i>' + assignment.notes + '</p>' : '') +
                    '</div>' +
                    '<div class="text-right">' +
                        '<span class="status-badge status-active">' + statusLabel + '</span>' +
                        '<div class="text-sm font-bold opacity-50 mt-2">' +
                            '<i class="fas fa-upload mr-1"></i>' + uploads.length + ' upload(s)' +
                        '</div>' +
                    '</div>' +
                '</div>';
        }

        // Historique des uploads
        renderUploadsHistory(uploads);

        // Commentaires
        renderComments(comments);
    }

    function renderUploadsHistory(uploads) {
        var container = document.getElementById('uploadsHistoryList');
        if (!container) return;

        if (!uploads || uploads.length === 0) {
            container.innerHTML = '<p class="text-center py-4 opacity-50 font-bold">Aucun upload pour le moment</p>';
            return;
        }

        // Trier par date (plus recent en premier)
        uploads.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); });

        var html = '';
        for (var i = 0; i < uploads.length; i++) {
            var u = uploads[i];
            var statusClass = 'status-pending';
            var statusText = 'En attente';
            if (u.validation_status === 'approved') { statusClass = 'status-approved'; statusText = 'Approuvé'; }
            else if (u.validation_status === 'rejected') { statusClass = 'status-rejected'; statusText = 'Refusé'; }

            var date = u.created_at ? new Date(u.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

            html += '<div class="upload-item">' +
                '<div class="flex justify-between items-start flex-wrap gap-3">' +
                    '<div class="flex-1">' +
                        '<div class="font-black">' + (u.name || 'Fichier') + '</div>' +
                        '<div class="text-xs font-bold opacity-50">' + (u.file_extension || '').toUpperCase() + ' - ' + date + '</div>' +
                        (u.description ? '<div class="text-sm opacity-70 mt-1">' + u.description + '</div>' : '') +
                        (u.rejection_reason ? '<div class="text-sm text-red-600 font-bold mt-1"><i class="fas fa-exclamation-circle mr-1"></i>' + u.rejection_reason + '</div>' : '') +
                        (u.publication_link ? '<div class="text-xs mt-1"><i class="fas fa-link mr-1"></i><a href="' + u.publication_link + '" target="_blank" class="text-blue-600 underline">Voir la publication</a></div>' : '') +
                    '</div>' +
                    '<span class="status-badge ' + statusClass + '">' + statusText + '</span>' +
                '</div>' +
            '</div>';
        }

        container.innerHTML = html;
    }

    function renderComments(comments) {
        var container = document.getElementById('commentsList');
        if (!container) return;

        if (!comments || comments.length === 0) {
            container.innerHTML = '<p class="text-center py-4 opacity-50 font-bold">Aucun commentaire</p>';
            return;
        }

        // Trier par date (plus ancien en premier)
        comments.sort(function(a, b) { return new Date(a.created_at) - new Date(b.created_at); });

        var html = '';
        for (var i = 0; i < comments.length; i++) {
            var c = comments[i];
            var isPartner = c.author_type === 'partner';
            var bubbleClass = isPartner ? 'comment-partner' : 'comment-admin';
            var date = c.created_at ? new Date(c.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

            html += '<div class="comment-bubble ' + bubbleClass + '">' +
                '<div class="flex justify-between items-center mb-2">' +
                    '<span class="font-black text-sm">' +
                        (isPartner ? '<i class="fas fa-user mr-1"></i>' : '<i class="fas fa-shield-alt mr-1"></i>') +
                        (c.author_name || 'Utilisateur') +
                    '</span>' +
                    '<span class="text-xs opacity-50">' + date + '</span>' +
                '</div>' +
                '<p class="text-sm" style="white-space:pre-wrap;">' + escapeHtml(c.content) + '</p>' +
            '</div>';
        }

        container.innerHTML = html;
    }

    // ==============================================
    // UPLOAD
    // ==============================================

    var uploadFormEl = document.getElementById('uploadForm');
    if (uploadFormEl) {
        uploadFormEl.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentProjectOrderId || !currentPartner) {
                alert('Erreur : aucun projet sélectionné');
                return;
            }

            var nameInput = document.getElementById('uploadName');
            var fileInput = document.getElementById('uploadFile');
            var descInput = document.getElementById('uploadDescription');
            var submitBtn = document.getElementById('uploadSubmitBtn');

            if (!fileInput || !fileInput.files[0]) {
                alert('Veuillez sélectionner un fichier');
                return;
            }

            var file = fileInput.files[0];
            var ext = file.name.split('.').pop().toLowerCase();

            // Verifier le type de fichier cote client
            var typeConfig = PARTNER_ALLOWED_TYPES[currentPartner.partner_type];
            if (typeConfig && typeConfig.extensions.indexOf(ext) === -1) {
                alert('Type de fichier non autorisé. Formats acceptés : ' + typeConfig.label);
                return;
            }

            // Champs media obligatoires
            var publicationLink = null;
            var publicationDate = null;
            var diffusionType = null;

            if (currentPartner.partner_type === 'media') {
                publicationLink = document.getElementById('uploadPublicationLink').value;
                publicationDate = document.getElementById('uploadPublicationDate').value;
                diffusionType = document.getElementById('uploadDiffusionType').value;

                if (!publicationLink || !publicationDate || !diffusionType) {
                    alert('Les champs de publication sont obligatoires pour les partenaires média');
                    return;
                }
            }

            // Desactiver le bouton
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi en cours...';
            }

            try {
                // Convertir en base64 pour l'envoi
                var fileUrl = await fileToBase64(file);

                var body = {
                    order_id: currentProjectOrderId,
                    name: nameInput ? nameInput.value : 'Fichier',
                    description: descInput ? descInput.value : '',
                    file_url: fileUrl,
                    file_extension: ext,
                    file_size: file.size
                };

                if (publicationLink) body.publication_link = publicationLink;
                if (publicationDate) body.publication_date = publicationDate;
                if (diffusionType) body.diffusion_type = diffusionType;

                var response = await partnerAuthenticatedFetch(PARTNER_API_BASE_URL + '/api/partner/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                var data = await response.json();

                if (response.ok && data.success) {
                    alert('Upload soumis avec succès ! Il sera validé par l\'administrateur.');
                    // Reset le formulaire
                    uploadFormEl.reset();
                    // Recharger le detail du projet
                    openProject(currentProjectOrderId);
                    showProjectTab('history');
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }

            } catch (error) {
                console.error('[PARTNER-DASH] Erreur upload:', error);
                alert('Erreur de connexion au serveur');
            }

            // Reactiver le bouton
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>SOUMETTRE';
            }
        });
    }

    // ==============================================
    // COMMENTAIRES
    // ==============================================

    var commentFormEl = document.getElementById('commentForm');
    if (commentFormEl) {
        commentFormEl.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentProjectOrderId) return;

            var contentInput = document.getElementById('commentContent');
            var content = contentInput ? contentInput.value.trim() : '';

            if (!content) {
                alert('Veuillez écrire un commentaire');
                return;
            }

            try {
                var response = await partnerAuthenticatedFetch(PARTNER_API_BASE_URL + '/api/partner/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: currentProjectOrderId,
                        content: content
                    })
                });

                var data = await response.json();

                if (response.ok && data.success) {
                    if (contentInput) contentInput.value = '';
                    // Recharger les commentaires
                    loadCommentsOnly();
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }

            } catch (error) {
                console.error('[PARTNER-DASH] Erreur commentaire:', error);
                alert('Erreur de connexion');
            }
        });
    }

    async function loadCommentsOnly() {
        if (!currentProjectOrderId) return;

        try {
            var response = await partnerAuthenticatedFetch(PARTNER_API_BASE_URL + '/api/partner/comments/' + currentProjectOrderId);
            if (response.ok) {
                var comments = await response.json();
                renderComments(comments);
            }
        } catch (error) {
            console.error('[PARTNER-DASH] Erreur reload commentaires:', error);
        }
    }

    // ==============================================
    // PROFIL
    // ==============================================

    function renderProfileSection() {
        if (!currentPartner) return;

        var container = document.getElementById('profileInfo');
        if (!container) return;

        var typeLabel = PARTNER_TYPE_LABELS[currentPartner.partner_type] || currentPartner.partner_type;

        container.innerHTML =
            '<div class="grid md:grid-cols-2 gap-6">' +
                '<div>' +
                    '<p class="text-sm font-bold uppercase opacity-60 mb-1">Nom</p>' +
                    '<p class="font-black text-lg">' + (currentPartner.prenom || '') + ' ' + (currentPartner.nom || '') + '</p>' +
                '</div>' +
                '<div>' +
                    '<p class="text-sm font-bold uppercase opacity-60 mb-1">Email</p>' +
                    '<p class="font-black">' + (currentPartner.email || '') + '</p>' +
                '</div>' +
                '<div>' +
                    '<p class="text-sm font-bold uppercase opacity-60 mb-1">Type de partenaire</p>' +
                    '<p class="font-black">' + typeLabel + '</p>' +
                '</div>' +
                '<div>' +
                    '<p class="text-sm font-bold uppercase opacity-60 mb-1">Telephone</p>' +
                    '<p class="font-black">' + (currentPartner.telephone || 'Non renseigné') + '</p>' +
                '</div>' +
                '<div>' +
                    '<p class="text-sm font-bold uppercase opacity-60 mb-1">Spécialité</p>' +
                    '<p class="font-black">' + (currentPartner.specialite || 'Non renseignée') + '</p>' +
                '</div>' +
                '<div>' +
                    '<p class="text-sm font-bold uppercase opacity-60 mb-1">Statut</p>' +
                    '<span class="status-badge status-active">' + (currentPartner.accountStatus || 'actif').toUpperCase() + '</span>' +
                '</div>' +
            '</div>';
    }

    var passwordFormEl = document.getElementById('passwordForm');
    if (passwordFormEl) {
        passwordFormEl.addEventListener('submit', async function(e) {
            e.preventDefault();

            var newPwd = document.getElementById('newPassword').value;
            var confirmPwd = document.getElementById('confirmPassword').value;
            var msgEl = document.getElementById('profileMessage');

            if (newPwd !== confirmPwd) {
                if (msgEl) {
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = '<div class="bg-red-100 border-2 border-red-500 p-3 font-bold text-red-700">Les mots de passe ne correspondent pas</div>';
                }
                return;
            }

            if (newPwd.length < 6) {
                if (msgEl) {
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = '<div class="bg-red-100 border-2 border-red-500 p-3 font-bold text-red-700">Le mot de passe doit contenir au moins 6 caractères</div>';
                }
                return;
            }

            try {
                var result = await updatePartnerProfile({ password: newPwd });

                if (msgEl) {
                    msgEl.style.display = 'block';
                    if (result.success) {
                        msgEl.innerHTML = '<div class="bg-green-100 border-2 border-green-500 p-3 font-bold text-green-700"><i class="fas fa-check-circle mr-2"></i>Mot de passe mis à jour</div>';
                        passwordFormEl.reset();
                    } else {
                        msgEl.innerHTML = '<div class="bg-red-100 border-2 border-red-500 p-3 font-bold text-red-700">' + (result.message || 'Erreur') + '</div>';
                    }
                }
            } catch (error) {
                console.error('[PARTNER-DASH] Erreur profil:', error);
                if (msgEl) {
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = '<div class="bg-red-100 border-2 border-red-500 p-3 font-bold text-red-700">Erreur de connexion au serveur</div>';
                }
            }
        });
    }

    // ==============================================
    // UTILITAIRES
    // ==============================================

    function handlePartnerLogout() {
        if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
            partnerLogout();
        }
    }

    function showError(message) {
        var banner = document.getElementById('errorBanner');
        var text = document.getElementById('errorBannerText');
        var loading = document.getElementById('loadingState');

        if (loading) loading.style.display = 'none';
        if (banner) banner.style.display = 'block';
        if (text) text.textContent = message;
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function fileToBase64(file) {
        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function() { resolve(reader.result); };
            reader.onerror = function(error) { reject(error); };
            reader.readAsDataURL(file);
        });
    }

    // ==============================================
    // SECTION DEVIS PARTENAIRE
    // ==============================================

    var PARTNER_API_URL = window.FA_GENESIS_API || 'https://fa-genesis-website.onrender.com';

    var QUOTE_STATUS_LABELS = {
        DRAFT_REQUESTED: 'EN ATTENTE DE PROPOSITION',
        PARTNER_PROPOSED: 'PROPOSITION ENVOYÉE',
        ADMIN_REVIEW: 'EN COURS DE VALIDATION',
        SENT_TO_CLIENT: 'ENVOYÉ AU CLIENT',
        ACCEPTED: 'ACCEPTÉ PAR LE CLIENT',
        EXPIRED: 'EXPIRÉ',
        CANCELLED: 'ANNULÉ'
    };

    var QUOTE_STATUS_COLORS = {
        DRAFT_REQUESTED: '#ff6b6b',
        PARTNER_PROPOSED: '#ffd43b',
        ADMIN_REVIEW: '#4dabf7',
        SENT_TO_CLIENT: '#845ef7',
        ACCEPTED: '#51cf66',
        EXPIRED: '#999',
        CANCELLED: '#999'
    };

    var SERVICE_TYPE_LABELS = {
        photo: 'PHOTO',
        video: 'VIDÉO',
        media: 'MÉDIA',
        marketing: 'MARKETING',
        other: 'AUTRE'
    };

    var allPartnerQuotes = [];

    async function loadPartnerQuotes() {
        var container = document.getElementById('partnerQuotesList');
        if (!container) return;

        try {
            var response = await partnerAuthenticatedFetch(PARTNER_API_URL + '/api/partner/quotes');
            if (!response.ok) throw new Error('Erreur ' + response.status);
            allPartnerQuotes = await response.json();
        } catch (error) {
            console.error('[PARTNER-DASH] Erreur chargement devis:', error);
            container.innerHTML = '<div class="section-card text-center py-12">' +
                '<i class="fas fa-inbox text-4xl opacity-30 mb-4"></i>' +
                '<p class="font-bold opacity-50">Erreur de chargement des devis</p>' +
                '<button onclick="loadPartnerQuotes()" class="neo-btn-yellow px-6 py-2 mt-4 text-sm">Réessayer</button>' +
            '</div>';
            return;
        }

        // Mettre a jour les badges
        var pendingCount = allPartnerQuotes.filter(function(q) { return q.status === 'DRAFT_REQUESTED'; }).length;
        var badge = document.getElementById('partnerQuotesBadge');
        var badgeMobile = document.getElementById('partnerQuotesBadgeMobile');
        if (badge) {
            if (pendingCount > 0) { badge.style.display = 'block'; badge.textContent = pendingCount; }
            else { badge.style.display = 'none'; }
        }
        if (badgeMobile) {
            if (pendingCount > 0) { badgeMobile.style.display = 'block'; badgeMobile.textContent = pendingCount; }
            else { badgeMobile.style.display = 'none'; }
        }

        if (allPartnerQuotes.length === 0) {
            container.innerHTML = '<div class="section-card text-center py-12">' +
                '<i class="fas fa-file-invoice text-4xl opacity-30 mb-4"></i>' +
                '<p class="font-bold opacity-50">Aucun devis assigné pour le moment</p>' +
                '<p class="text-sm opacity-40 mt-2">Les demandes de devis vous seront assignées par l\'administrateur</p>' +
            '</div>';
            return;
        }

        var html = '';
        allPartnerQuotes.forEach(function(quote) {
            var date = quote.created_at ? new Date(quote.created_at).toLocaleDateString('fr-FR') : '';
            var statusColor = QUOTE_STATUS_COLORS[quote.status] || '#999';
            var statusLabel = QUOTE_STATUS_LABELS[quote.status] || quote.status;
            var serviceLabel = SERVICE_TYPE_LABELS[quote.service_type] || quote.service_type || '';
            var needsAction = quote.status === 'DRAFT_REQUESTED';

            html += '<div class="partner-card' + (needsAction ? '' : '') + '" onclick="openPartnerQuoteDetail(\'' + quote.id + '\')" style="' +
                (needsAction ? 'border-left:6px solid #ff6b6b;' : '') + '">' +
                '<div class="flex justify-between items-center flex-wrap gap-3">' +
                    '<div class="flex-1 min-w-[200px]">' +
                        '<div class="text-xs font-bold opacity-50">' + (quote.quote_number || quote.id) + '</div>' +
                        '<div class="font-black text-lg">' + serviceLabel + '</div>' +
                        '<div class="text-sm font-bold opacity-60">' + date + '</div>' +
                    '</div>' +
                    '<div>' +
                        '<span style="background:' + statusColor + ';color:' + (quote.status === 'SENT_TO_CLIENT' ? 'white' : 'black') + ';padding:4px 10px;border:2px solid black;font-size:11px;font-weight:900;">' + statusLabel + '</span>' +
                    '</div>' +
                    (needsAction ? '<div><span class="neo-btn-yellow px-4 py-2 text-xs"><i class="fas fa-pen mr-1"></i>PROPOSER</span></div>' : '') +
                '</div>' +
            '</div>';
        });

        container.innerHTML = html;
    }

    function backToQuotes() {
        showSection('quotes');
    }

    async function openPartnerQuoteDetail(quoteId) {
        try {
            var response = await partnerAuthenticatedFetch(PARTNER_API_URL + '/api/partner/quotes/' + quoteId);
            if (!response.ok) throw new Error('Erreur ' + response.status);
            var quote = await response.json();
        } catch (error) {
            console.error('[PARTNER-DASH] Erreur detail devis:', error);
            alert('Erreur de chargement du devis');
            return;
        }

        // Afficher la section detail
        var sections = ['projectsSection', 'projectDetailSection', 'profileSection', 'quotesSection', 'loadingState'];
        sections.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
        var detailSection = document.getElementById('quoteDetailSection');
        if (detailSection) detailSection.style.display = 'block';

        var statusColor = QUOTE_STATUS_COLORS[quote.status] || '#999';
        var statusLabel = QUOTE_STATUS_LABELS[quote.status] || quote.status;
        var serviceLabel = SERVICE_TYPE_LABELS[quote.service_type] || quote.service_type || '';

        var html = '';

        // En-tete
        html += '<div class="section-card neo-shadow mb-6">' +
            '<div class="flex justify-between items-start flex-wrap gap-4 mb-6">' +
                '<div>' +
                    '<h3 class="text-2xl md:text-3xl font-black italic uppercase text-[var(--genesis-yellow)]">' +
                        '<i class="fas fa-file-invoice mr-2"></i>DEVIS ' + (quote.quote_number || '') +
                    '</h3>' +
                    '<div class="mt-2">' +
                        '<span style="background:' + statusColor + ';color:' + (quote.status === 'SENT_TO_CLIENT' ? 'white' : 'black') + ';padding:4px 12px;border:2px solid black;font-size:12px;font-weight:900;">' + statusLabel + '</span>' +
                        ' <span style="background:var(--genesis-yellow);color:black;padding:4px 12px;border:2px solid black;font-size:12px;font-weight:900;margin-left:4px;">' + serviceLabel + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="text-right text-sm font-bold opacity-60">' +
                    '<div>Reçu le ' + (quote.created_at ? new Date(quote.created_at).toLocaleDateString('fr-FR') : 'N/A') + '</div>' +
                '</div>' +
            '</div>' +

            // Brief du client
            '<h4 class="text-lg font-black italic uppercase mb-3"><i class="fas fa-clipboard mr-2"></i>BRIEF DU CLIENT</h4>' +
            '<div style="background:#FFF9E6;border-left:4px solid #FFD700;padding:15px;margin-bottom:10px;">' +
                '<p style="white-space:pre-wrap;">' + (quote.brief || 'Aucun brief fourni') + '</p>' +
            '</div>' +
        '</div>';

        // Si DRAFT_REQUESTED : formulaire de proposition
        if (quote.status === 'DRAFT_REQUESTED') {
            html += '<div class="section-card neo-shadow mb-6" id="proposalForm">' +
                '<h4 class="text-xl font-black italic uppercase mb-6 text-[var(--genesis-yellow)]">' +
                    '<i class="fas fa-lightbulb mr-2"></i>VOTRE PROPOSITION' +
                '</h4>' +
                '<p class="text-sm font-bold opacity-60 mb-6">Détaillez votre proposition de prestation. Elle sera examinée par l\'administrateur avant d\'être envoyée au client.</p>' +

                // Items dynamiques
                '<div id="proposalItemsContainer">' +
                    renderProposalItemRow(0, { label: '', qty: 1, unit_price: 0, description: '' }) +
                '</div>' +

                '<button onclick="addProposalItem()" class="border-3 border-black bg-gray-200 text-black px-4 py-2 text-xs font-black mt-2 mb-6">' +
                    '<i class="fas fa-plus mr-1"></i>AJOUTER UNE LIGNE' +
                '</button>' +

                // Total indicatif
                '<div class="text-right mb-6 p-3 bg-gray-100 border-2 border-black">' +
                    '<span class="text-sm font-bold">Total indicatif : </span>' +
                    '<span id="proposalTotal" class="text-xl font-black text-[var(--genesis-yellow)]">0€</span>' +
                '</div>' +

                // Delai
                '<div class="mb-4">' +
                    '<label class="block font-black mb-1 uppercase text-sm">Délai estimé</label>' +
                    '<input type="text" id="proposalDelay" placeholder="Ex: 2 semaines, 10 jours ouvrés...">' +
                '</div>' +

                // Notes
                '<div class="mb-6">' +
                    '<label class="block font-black mb-1 uppercase text-sm">Notes internes (visibles par l\'admin uniquement)</label>' +
                    '<textarea id="proposalNotes" rows="3" placeholder="Remarques, contraintes, suggestions..."></textarea>' +
                '</div>' +

                // Bouton soumettre
                '<button onclick="submitPartnerProposal(\'' + quote.id + '\')" id="submitProposalBtn" class="neo-btn-yellow px-8 py-4 text-lg font-black">' +
                    '<i class="fas fa-paper-plane mr-2"></i>SOUMETTRE MA PROPOSITION' +
                '</button>' +
            '</div>';
        }

        // Si PARTNER_PROPOSED : proposition en lecture seule
        if (quote.status === 'PARTNER_PROPOSED' && quote.partner_proposal) {
            html += '<div class="section-card neo-shadow mb-6">' +
                '<h4 class="text-xl font-black italic uppercase mb-4"><i class="fas fa-check-circle mr-2 text-[#51cf66]"></i>VOTRE PROPOSITION (envoyée)</h4>' +
                '<p class="text-sm font-bold opacity-60 mb-4"><i class="fas fa-hourglass-half mr-1"></i>En attente de validation par l\'administrateur FA Genesis</p>';

            if (quote.partner_proposal.items && quote.partner_proposal.items.length > 0) {
                html += '<table style="width:100%;border-collapse:collapse;border:2px solid black;">' +
                    '<thead><tr style="background:var(--genesis-yellow);">' +
                        '<th style="padding:8px;border:2px solid black;text-align:left;font-size:12px;">PRESTATION</th>' +
                        '<th style="padding:8px;border:2px solid black;text-align:center;font-size:12px;">QTÉ</th>' +
                        '<th style="padding:8px;border:2px solid black;text-align:right;font-size:12px;">P.U.</th>' +
                        '<th style="padding:8px;border:2px solid black;text-align:right;font-size:12px;">TOTAL</th>' +
                    '</tr></thead><tbody>';

                var propTotal = 0;
                quote.partner_proposal.items.forEach(function(item) {
                    var lineTotal = (item.qty || 1) * (item.unit_price || 0);
                    propTotal += lineTotal;
                    html += '<tr>' +
                        '<td style="padding:8px;border:2px solid black;">' + (item.label || '') +
                            (item.description ? '<br><span style="font-size:12px;opacity:0.6;">' + item.description + '</span>' : '') + '</td>' +
                        '<td style="padding:8px;border:2px solid black;text-align:center;">' + (item.qty || 1) + '</td>' +
                        '<td style="padding:8px;border:2px solid black;text-align:right;">' + (item.unit_price || 0) + '€</td>' +
                        '<td style="padding:8px;border:2px solid black;text-align:right;font-weight:900;">' + lineTotal + '€</td>' +
                    '</tr>';
                });

                html += '</tbody></table>' +
                    '<div class="text-right mt-2 font-black text-lg">Total : ' + propTotal + '€</div>';
            }

            if (quote.partner_proposal.delay) {
                html += '<div class="mt-3 text-sm"><strong>Délai :</strong> ' + quote.partner_proposal.delay + '</div>';
            }
            if (quote.partner_proposal.notes) {
                html += '<div class="mt-2 text-sm"><strong>Notes :</strong> ' + quote.partner_proposal.notes + '</div>';
            }

            html += '</div>';
        }

        // Si ADMIN_REVIEW, SENT_TO_CLIENT ou ACCEPTED : message informatif
        if (quote.status === 'ADMIN_REVIEW') {
            html += '<div class="section-card neo-shadow mb-6">' +
                '<div class="text-center py-8">' +
                    '<i class="fas fa-cog fa-spin text-4xl text-[#4dabf7] mb-4"></i>' +
                    '<p class="font-black text-lg">L\'administrateur prépare le devis final</p>' +
                    '<p class="text-sm opacity-60 mt-2">Votre proposition a été reçue et est en cours de traitement</p>' +
                '</div>' +
            '</div>';
        }

        if (quote.status === 'SENT_TO_CLIENT') {
            html += '<div class="section-card neo-shadow mb-6">' +
                '<div class="text-center py-8">' +
                    '<i class="fas fa-paper-plane text-4xl text-[#845ef7] mb-4"></i>' +
                    '<p class="font-black text-lg">Le devis a été envoyé au client</p>' +
                    '<p class="text-sm opacity-60 mt-2">En attente de la réponse du client</p>' +
                '</div>' +
            '</div>';
        }

        if (quote.status === 'ACCEPTED') {
            html += '<div class="section-card neo-shadow mb-6">' +
                '<div class="text-center py-8">' +
                    '<i class="fas fa-check-circle text-4xl text-[#51cf66] mb-4"></i>' +
                    '<p class="font-black text-lg text-[#51cf66]">Le devis a été accepté par le client !</p>' +
                    '<p class="text-sm opacity-60 mt-2">Le projet sera bientôt visible dans votre onglet Projets</p>' +
                '</div>' +
            '</div>';
        }

        if (quote.status === 'CANCELLED') {
            html += '<div class="section-card neo-shadow mb-6">' +
                '<div class="text-center py-8">' +
                    '<i class="fas fa-times-circle text-4xl text-[#ff6b6b] mb-4"></i>' +
                    '<p class="font-black text-lg">Ce devis a été annulé</p>' +
                '</div>' +
            '</div>';
        }

        var detailEl = document.getElementById('partnerQuoteDetail');
        if (detailEl) detailEl.innerHTML = html;

        // Calculer le total initial si formulaire visible
        recalculateProposalTotal();
    }

    function renderProposalItemRow(index, item) {
        return '<div class="proposal-item-row mb-3 p-3 bg-gray-50 border-2 border-black" data-index="' + index + '">' +
            '<div class="grid grid-cols-1 md:grid-cols-12 gap-2">' +
                '<div class="md:col-span-4">' +
                    '<label class="block text-xs font-black uppercase mb-1">Prestation</label>' +
                    '<input type="text" class="proposal-item-label" placeholder="Ex: Shooting photo corporate" value="' + (item.label || '') + '">' +
                '</div>' +
                '<div class="md:col-span-3">' +
                    '<label class="block text-xs font-black uppercase mb-1">Description</label>' +
                    '<input type="text" class="proposal-item-desc" placeholder="Détails..." value="' + (item.description || '') + '">' +
                '</div>' +
                '<div class="md:col-span-1">' +
                    '<label class="block text-xs font-black uppercase mb-1">Qté</label>' +
                    '<input type="number" class="proposal-item-qty text-center" value="' + (item.qty || 1) + '" min="1" onchange="recalculateProposalTotal()">' +
                '</div>' +
                '<div class="md:col-span-2">' +
                    '<label class="block text-xs font-black uppercase mb-1">Prix unit.</label>' +
                    '<input type="number" class="proposal-item-price text-right" value="' + (item.unit_price || 0) + '" min="0" step="0.01" onchange="recalculateProposalTotal()">' +
                '</div>' +
                '<div class="md:col-span-2 flex items-end gap-2">' +
                    '<span class="proposal-item-total font-black text-lg">0€</span>' +
                    '<button onclick="removeProposalItem(' + index + ')" class="text-red-600 font-black hover:opacity-70" title="Supprimer">' +
                        '<i class="fas fa-trash"></i>' +
                    '</button>' +
                '</div>' +
            '</div>' +
        '</div>';
    }

    function addProposalItem() {
        var container = document.getElementById('proposalItemsContainer');
        if (!container) return;
        var rows = container.querySelectorAll('.proposal-item-row');
        var newIndex = rows.length;
        var wrapper = document.createElement('div');
        wrapper.innerHTML = renderProposalItemRow(newIndex, { label: '', qty: 1, unit_price: 0, description: '' });
        container.appendChild(wrapper.firstChild);
    }

    function removeProposalItem(index) {
        var container = document.getElementById('proposalItemsContainer');
        if (!container) return;
        var rows = container.querySelectorAll('.proposal-item-row');
        if (rows.length <= 1) {
            alert('Au moins une ligne est requise');
            return;
        }
        if (rows[index]) rows[index].remove();
        recalculateProposalTotal();
    }

    function recalculateProposalTotal() {
        var container = document.getElementById('proposalItemsContainer');
        if (!container) return;

        var rows = container.querySelectorAll('.proposal-item-row');
        var total = 0;

        rows.forEach(function(row) {
            var qtyEl = row.querySelector('.proposal-item-qty');
            var priceEl = row.querySelector('.proposal-item-price');
            var totalEl = row.querySelector('.proposal-item-total');
            var qty = parseFloat(qtyEl ? qtyEl.value : 0) || 0;
            var price = parseFloat(priceEl ? priceEl.value : 0) || 0;
            var lineTotal = qty * price;
            total += lineTotal;
            if (totalEl) totalEl.textContent = lineTotal + '€';
        });

        var totalDisplay = document.getElementById('proposalTotal');
        if (totalDisplay) totalDisplay.textContent = total + '€';
    }

    async function submitPartnerProposal(quoteId) {
        var container = document.getElementById('proposalItemsContainer');
        if (!container) return;

        // Collecter les items
        var items = [];
        var rows = container.querySelectorAll('.proposal-item-row');
        rows.forEach(function(row) {
            var label = row.querySelector('.proposal-item-label').value.trim();
            var description = row.querySelector('.proposal-item-desc').value.trim();
            var qty = parseInt(row.querySelector('.proposal-item-qty').value) || 1;
            var unit_price = parseFloat(row.querySelector('.proposal-item-price').value) || 0;

            if (label) {
                items.push({ label: label, description: description, qty: qty, unit_price: unit_price });
            }
        });

        if (items.length === 0) {
            alert('Ajoutez au moins une prestation');
            return;
        }

        var delayEl = document.getElementById('proposalDelay');
        var notesEl = document.getElementById('proposalNotes');
        var delay = delayEl ? delayEl.value.trim() : '';
        var notes = notesEl ? notesEl.value.trim() : '';

        if (!delay) {
            alert('Veuillez indiquer un délai estimé');
            return;
        }

        var btn = document.getElementById('submitProposalBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ENVOI EN COURS...';
        }

        try {
            var response = await partnerAuthenticatedFetch(PARTNER_API_URL + '/api/partner/quotes/' + quoteId + '/propose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: items, delay: delay, notes: notes })
            });

            var result = await response.json();

            if (response.ok && result.success) {
                alert('Proposition envoyée avec succès ! L\'administrateur va l\'examiner.');
                openPartnerQuoteDetail(quoteId);
            } else {
                alert('Erreur: ' + (result.error || 'Erreur inconnue'));
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>SOUMETTRE MA PROPOSITION';
                }
            }
        } catch (error) {
            console.error('[PARTNER-DASH] Erreur soumission proposition:', error);
            alert('Erreur de connexion au serveur');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>SOUMETTRE MA PROPOSITION';
            }
        }
    }

    // Charger le badge devis au demarrage
    (async function loadQuotesBadge() {
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            if (!token) return;
            var response = await fetch(PARTNER_API_URL + '/api/partner/quotes', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (response.ok) {
                var quotes = await response.json();
                var pending = quotes.filter(function(q) { return q.status === 'DRAFT_REQUESTED'; }).length;
                var badge = document.getElementById('partnerQuotesBadge');
                var badgeMobile = document.getElementById('partnerQuotesBadgeMobile');
                if (badge && pending > 0) { badge.style.display = 'block'; badge.textContent = pending; }
                if (badgeMobile && pending > 0) { badgeMobile.style.display = 'block'; badgeMobile.textContent = pending; }
            }
        } catch (e) {}
    })();

    // ============================================================
    // MISSIONS - LIVRABLES ASSIGNES
    // ============================================================

    async function loadMissions() {
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            var response = await fetch(PARTNER_API_URL + '/api/partner/deliverables', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error('Erreur chargement');
            var data = await response.json();
            var deliverables = data.deliverables || [];

            // Badge
            var todoCount = deliverables.filter(function(d) {
                return d.workflow_status !== 'PUBLISHED' && d.workflow_status !== 'APPROVED';
            }).length;
            var badge = document.getElementById('missionsBadge');
            var badgeMobile = document.getElementById('missionsBadgeMobile');
            if (badge) { if (todoCount > 0) { badge.style.display = 'block'; badge.textContent = todoCount; } else { badge.style.display = 'none'; } }
            if (badgeMobile) { if (todoCount > 0) { badgeMobile.style.display = 'block'; badgeMobile.textContent = todoCount; } else { badgeMobile.style.display = 'none'; } }

            var container = document.getElementById('missionsListContainer');
            if (!container) return;

            if (deliverables.length === 0) {
                container.innerHTML = '<p class="text-center py-8 opacity-50 font-bold text-white">Aucune mission assignee pour le moment.</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < deliverables.length; i++) {
                var d = deliverables[i];
                html += renderMissionCard(d);
            }
            container.innerHTML = html;
        } catch (e) {
            console.error('loadMissions:', e);
            var container = document.getElementById('missionsListContainer');
            if (container) container.innerHTML = '<p class="text-red-400 font-bold">Erreur de chargement des missions.</p>';
        }
    }

    function renderMissionCard(d) {
        var statusText = '';
        var statusColor = '';
        if (d.workflow_status === 'DRAFT_AI') { statusText = 'A FAIRE'; statusColor = '#3b82f6'; }
        else if (d.workflow_status === 'PENDING_PARTNER') { statusText = 'EN COURS'; statusColor = '#f59e0b'; }
        else if (d.workflow_status === 'PENDING_ADMIN') { statusText = 'SOUMIS'; statusColor = '#8b5cf6'; }
        else if (d.workflow_status === 'REVISION_REQUESTED') { statusText = 'REVISION DEMANDEE'; statusColor = '#ef4444'; }
        else if (d.workflow_status === 'APPROVED') { statusText = 'APPROUVE'; statusColor = '#10b981'; }
        else if (d.workflow_status === 'PUBLISHED') { statusText = 'PUBLIE'; statusColor = '#059669'; }
        else { statusText = d.workflow_status || 'INCONNU'; statusColor = '#6b7280'; }

        var versionsCount = (d.versions && d.versions.length) || 0;

        // Brief IA (apercu du contenu)
        var briefPreview = '';
        if (d.content_text && d.owner_role === 'ai') {
            var preview = d.content_text.substring(0, 150).replace(/</g, '&lt;');
            briefPreview = '<div class="mt-2 p-2 bg-white bg-opacity-10 text-white text-xs" style="max-height:80px;overflow-y:auto;white-space:pre-wrap;">' +
                '<strong>Brief IA :</strong> ' + preview + '...</div>';
        }

        var canModify = d.workflow_status !== 'PUBLISHED' && d.workflow_status !== 'APPROVED';
        var actions = '';
        if (canModify) {
            actions = '<div class="mt-3 flex gap-2 flex-wrap">' +
                '<button onclick="showMissionDetail(\'' + d.id + '\')" class="border-2 border-white bg-white bg-opacity-20 text-white px-3 py-1 text-xs font-bold hover:bg-opacity-30"><i class="fas fa-edit mr-1"></i>MODIFIER / UPLOADER</button>';
            if (d.workflow_status !== 'PENDING_ADMIN') {
                actions += '<button onclick="submitMission(\'' + d.id + '\')" class="border-2 border-white bg-green-600 text-white px-3 py-1 text-xs font-bold hover:bg-green-700"><i class="fas fa-paper-plane mr-1"></i>SOUMETTRE</button>';
            }
            actions += '</div>';
        }

        return '<div class="p-4 mb-3 bg-white bg-opacity-10 border-2 border-white border-opacity-30" style="backdrop-filter:blur(4px);">' +
            '<div class="flex justify-between items-start">' +
            '<div class="text-white">' +
            '<div class="font-bold">' + (d.name || 'Sans nom') + '</div>' +
            '<div class="text-xs opacity-70">Type: ' + (d.type || '-') + ' | Domaine: ' + (d.domain || '-') + ' | v' + versionsCount + '</div>' +
            '</div>' +
            '<span style="background:' + statusColor + ';color:white;padding:2px 8px;font-size:11px;font-weight:bold;">' + statusText + '</span>' +
            '</div>' +
            briefPreview +
            actions +
            '</div>';
    }

    async function showMissionDetail(deliverableId) {
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            var response = await fetch(PARTNER_API_URL + '/api/partner/deliverables', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error('Erreur');
            var data = await response.json();
            var deliverables = data.deliverables || [];
            var d = null;
            for (var i = 0; i < deliverables.length; i++) {
                if (deliverables[i].id === deliverableId) { d = deliverables[i]; break; }
            }
            if (!d) { alert('Livrable non trouve'); return; }

            document.getElementById('missionsListContainer').style.display = 'none';
            document.getElementById('missionDetailView').style.display = 'block';

            var html = '<div class="p-6 bg-white bg-opacity-10 border-2 border-white border-opacity-30 text-white">';
            html += '<h3 class="text-xl font-black mb-4">' + (d.name || 'Livrable') + '</h3>';

            // Brief IA complet
            if (d.content_text && d.owner_role === 'ai') {
                html += '<div class="mb-4">' +
                    '<h4 class="font-bold mb-2">Brief IA complet :</h4>' +
                    '<div class="p-3 bg-black bg-opacity-30 text-sm" style="white-space:pre-wrap;max-height:300px;overflow-y:auto;">' +
                    d.content_text.replace(/</g, '&lt;') +
                    '</div></div>';
            }

            // Historique des versions
            if (d.versions && d.versions.length > 0) {
                html += '<div class="mb-4">' +
                    '<h4 class="font-bold mb-2">Historique des versions (' + d.versions.length + ') :</h4>';
                for (var v = d.versions.length - 1; v >= 0; v--) {
                    var ver = d.versions[v];
                    html += '<div class="p-2 mb-1 bg-black bg-opacity-20 text-xs">' +
                        '<strong>v' + ver.version_number + '</strong> par ' + (ver.updated_by_role || '-') +
                        ' - ' + (ver.change_note || '') +
                        ' <span class="opacity-50">(' + (ver.created_at ? new Date(ver.created_at).toLocaleString('fr-FR') : '') + ')</span>' +
                        '</div>';
                }
                html += '</div>';
            }

            // Formulaire modification
            var canModify = d.workflow_status !== 'PUBLISHED' && d.workflow_status !== 'APPROVED';
            if (canModify) {
                html += '<div class="mt-6 p-4 bg-black bg-opacity-30 border border-white border-opacity-30">' +
                    '<h4 class="font-bold mb-3">Modifier ce livrable</h4>' +
                    '<div class="mb-3">' +
                    '<label class="block text-sm mb-1">Nouveau titre :</label>' +
                    '<input type="text" id="missionEditName" value="' + (d.name || '').replace(/"/g, '&quot;') + '" class="w-full p-2 text-black text-sm border-2 border-black">' +
                    '</div>' +
                    '<div class="mb-3">' +
                    '<label class="block text-sm mb-1">URL du fichier (Drive, Dropbox, etc.) :</label>' +
                    '<input type="text" id="missionUploadUrl" placeholder="https://..." class="w-full p-2 text-black text-sm border-2 border-black">' +
                    '</div>' +
                    '<div class="mb-3">' +
                    '<label class="block text-sm mb-1">Ou contenu texte :</label>' +
                    '<textarea id="missionUploadContent" rows="4" class="w-full p-2 text-black text-sm border-2 border-black" placeholder="Entrez du contenu texte..."></textarea>' +
                    '</div>' +
                    '<div class="mb-3">' +
                    '<label class="block text-sm mb-1">Note de version :</label>' +
                    '<input type="text" id="missionChangeNote" placeholder="Description des modifications..." class="w-full p-2 text-black text-sm border-2 border-black">' +
                    '</div>' +
                    '<div class="flex gap-3">' +
                    '<button onclick="saveMissionChanges(\'' + d.id + '\')" class="border-2 border-white bg-blue-600 text-white px-4 py-2 text-sm font-bold hover:bg-blue-700"><i class="fas fa-save mr-1"></i>SAUVEGARDER</button>' +
                    '<button onclick="uploadMissionVersion(\'' + d.id + '\')" class="border-2 border-white bg-purple-600 text-white px-4 py-2 text-sm font-bold hover:bg-purple-700"><i class="fas fa-upload mr-1"></i>UPLOADER NOUVELLE VERSION</button>' +
                    '<button onclick="submitMission(\'' + d.id + '\')" class="border-2 border-white bg-green-600 text-white px-4 py-2 text-sm font-bold hover:bg-green-700"><i class="fas fa-paper-plane mr-1"></i>SOUMETTRE POUR VALIDATION</button>' +
                    '</div>' +
                    '</div>';
            }

            html += '</div>';
            document.getElementById('missionDetailContent').innerHTML = html;
        } catch (e) {
            console.error('showMissionDetail:', e);
            alert('Erreur chargement du detail');
        }
    }

    function backToMissions() {
        document.getElementById('missionDetailView').style.display = 'none';
        document.getElementById('missionsListContainer').style.display = 'block';
    }

    async function saveMissionChanges(id) {
        try {
            var name = document.getElementById('missionEditName').value.trim();
            if (!name) { alert('Le titre ne peut pas etre vide'); return; }

            var token = localStorage.getItem('fa_genesis_partner_token');
            var response = await fetch(PARTNER_API_URL + '/api/partner/deliverables/' + id, {
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            });
            var data = await response.json();
            if (data.success) {
                alert('Modifications enregistrees !');
                backToMissions();
                loadMissions();
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        } catch (e) { alert('Erreur: ' + e.message); }
    }

    async function uploadMissionVersion(id) {
        try {
            var fileUrl = document.getElementById('missionUploadUrl').value.trim();
            var contentText = document.getElementById('missionUploadContent').value.trim();
            var changeNote = document.getElementById('missionChangeNote').value.trim() || 'Nouvelle version';

            if (!fileUrl && !contentText) { alert('Veuillez entrer une URL de fichier ou du contenu texte'); return; }

            var token = localStorage.getItem('fa_genesis_partner_token');
            var body = { change_note: changeNote };
            if (fileUrl) body.file_url = fileUrl;
            if (contentText) body.content_text = contentText;

            var response = await fetch(PARTNER_API_URL + '/api/partner/deliverables/' + id + '/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            var data = await response.json();
            if (data.success) {
                alert('Nouvelle version uploadee (v' + data.version.version_number + ') !');
                showMissionDetail(id); // Recharger le detail
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        } catch (e) { alert('Erreur: ' + e.message); }
    }

    async function submitMission(id) {
        if (!confirm('Soumettre ce livrable pour validation par l\'admin ?')) return;
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            var response = await fetch(PARTNER_API_URL + '/api/partner/deliverables/' + id + '/submit', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
            });
            var data = await response.json();
            if (data.success) {
                alert('Livrable soumis pour validation !');
                loadMissions();
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        } catch (e) { alert('Erreur: ' + e.message); }
    }

    // Charger le badge missions au demarrage
    (async function() {
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            if (!token) return;
            var response = await fetch(PARTNER_API_URL + '/api/partner/deliverables', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (response.ok) {
                var data = await response.json();
                var todoCount = (data.deliverables || []).filter(function(d) {
                    return d.workflow_status !== 'PUBLISHED' && d.workflow_status !== 'APPROVED';
                }).length;
                var badge = document.getElementById('missionsBadge');
                var badgeMobile = document.getElementById('missionsBadgeMobile');
                if (badge && todoCount > 0) { badge.style.display = 'block'; badge.textContent = todoCount; }
                if (badgeMobile && todoCount > 0) { badgeMobile.style.display = 'block'; badgeMobile.textContent = todoCount; }
            }
        } catch (e) {}
    })();

    // ==============================================
    // SECTION SÉANCES PARTENAIRE
    // ==============================================

    var partnerSessionsData = [];
    var currentSessionAction = null; // { sessionId, action }

    var SESSION_STATUS_MAP = {
        'REQUESTED': { label: 'Demande', color: '#f59f00', bg: '#fff3cd' },
        'PROPOSED': { label: 'Proposée', color: '#1c7ed6', bg: '#d0ebff' },
        'CONFIRMED': { label: 'Confirmée', color: '#2f9e44', bg: '#d3f9d8' },
        'RESCHEDULE_REQUESTED': { label: 'Reprogrammation', color: '#e67700', bg: '#fff3cd' },
        'COMPLETED': { label: 'Terminée', color: '#868e96', bg: '#e9ecef' },
        'CANCELLED': { label: 'Annulée', color: '#e03131', bg: '#ffe3e3' }
    };

    var SESSION_TYPE_LABELS = {
        'call': 'Appel',
        'shooting': 'Shooting',
        'meeting': 'Réunion'
    };

    function showSeancesTab(tab) {
        var panels = ['seancesDemandesPanel', 'seancesConfirmeesPanel', 'seancesHistoriquePanel'];
        var tabs = ['tabSeanceDemandes', 'tabSeanceConfirmees', 'tabSeanceHistorique'];
        for (var i = 0; i < panels.length; i++) {
            var p = document.getElementById(panels[i]);
            if (p) p.style.display = 'none';
            var t = document.getElementById(tabs[i]);
            if (t) t.classList.remove('active');
        }
        if (tab === 'demandes') {
            var dp = document.getElementById('seancesDemandesPanel');
            var dt = document.getElementById('tabSeanceDemandes');
            if (dp) dp.style.display = 'block';
            if (dt) dt.classList.add('active');
        } else if (tab === 'confirmees') {
            var cp = document.getElementById('seancesConfirmeesPanel');
            var ct = document.getElementById('tabSeanceConfirmees');
            if (cp) cp.style.display = 'block';
            if (ct) ct.classList.add('active');
        } else if (tab === 'historique') {
            var hp = document.getElementById('seancesHistoriquePanel');
            var ht = document.getElementById('tabSeanceHistorique');
            if (hp) hp.style.display = 'block';
            if (ht) ht.classList.add('active');
        }
    }

    async function loadPartnerSessions() {
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            if (!token) return;
            var response = await fetch(PARTNER_API_URL + '/api/partner/sessions', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) {
                var errData = await response.json().catch(function() { return {}; });
                throw new Error(errData.error || 'Erreur serveur');
            }
            var data = await response.json();
            partnerSessionsData = data.sessions || [];
            renderPartnerSessions();
        } catch (e) {
            console.error('[SESSIONS] Erreur chargement:', e);
            var dp = document.getElementById('seancesDemandesPanel');
            if (dp) dp.innerHTML = '<p class="text-center py-8 text-red-400 font-bold">Erreur: ' + e.message + '</p>';
        }
    }

    function renderPartnerSessions() {
        var demandes = [];
        var confirmees = [];
        var historique = [];

        for (var i = 0; i < partnerSessionsData.length; i++) {
            var s = partnerSessionsData[i];
            if (s.status === 'REQUESTED' || s.status === 'RESCHEDULE_REQUESTED') {
                demandes.push(s);
            } else if (s.status === 'PROPOSED' || s.status === 'CONFIRMED') {
                confirmees.push(s);
            } else {
                historique.push(s);
            }
        }

        // Update badge count
        var countEl = document.getElementById('seancesDemandesCount');
        if (countEl) countEl.textContent = demandes.length > 0 ? demandes.length : '';

        // Update nav badges
        updateSeancesBadge(demandes.length);

        renderSessionPanel('seancesDemandesPanel', demandes, 'Aucune demande en attente');
        renderSessionPanel('seancesConfirmeesPanel', confirmees, 'Aucune séance confirmée');
        renderSessionPanel('seancesHistoriquePanel', historique, 'Aucun historique');
    }

    function updateSeancesBadge(count) {
        var badge = document.getElementById('seancesBadge');
        var badgeMobile = document.getElementById('seancesBadgeMobile');
        if (badge) {
            if (count > 0) { badge.style.display = 'block'; badge.textContent = count; }
            else { badge.style.display = 'none'; }
        }
        if (badgeMobile) {
            if (count > 0) { badgeMobile.style.display = 'block'; badgeMobile.textContent = count; }
            else { badgeMobile.style.display = 'none'; }
        }
    }

    function renderSessionPanel(panelId, sessions, emptyMsg) {
        var panel = document.getElementById(panelId);
        if (!panel) return;

        if (sessions.length === 0) {
            panel.innerHTML = '<p class="text-center py-8 opacity-50 font-bold text-white">' + emptyMsg + '</p>';
            return;
        }

        var html = '';
        for (var i = 0; i < sessions.length; i++) {
            html += renderPartnerSessionCard(sessions[i]);
        }
        panel.innerHTML = html;
    }

    function renderPartnerSessionCard(session) {
        var statusInfo = SESSION_STATUS_MAP[session.status] || { label: session.status, color: '#666', bg: '#eee' };
        var typeLabel = SESSION_TYPE_LABELS[session.session_type] || session.session_type || 'Séance';

        // Date formatting
        var dateStr = '—';
        if (session.datetime_start) {
            try {
                var d = new Date(session.datetime_start);
                dateStr = d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' }) + ' à ' + d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) { dateStr = session.datetime_start; }
        }

        var durationStr = session.duration_minutes ? session.duration_minutes + ' min' : '—';
        var clientName = session.client_name || session.client_id || 'Client inconnu';

        var html = '<div class="section-card" style="margin-bottom:1rem;">';
        // Header
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;">';
        html += '<div>';
        html += '<span style="font-weight:900;font-size:1rem;">' + clientName + '</span>';
        html += '<span style="display:inline-block;margin-left:8px;padding:2px 10px;border:2px solid black;font-weight:900;font-size:0.7rem;text-transform:uppercase;background:' + statusInfo.bg + ';color:' + statusInfo.color + ';">' + statusInfo.label + '</span>';
        html += '</div>';
        html += '<span style="font-size:0.75rem;font-weight:900;text-transform:uppercase;color:#666;">' + typeLabel + '</span>';
        html += '</div>';

        // Details
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.85rem;margin-bottom:0.75rem;">';
        html += '<div><i class="fas fa-calendar" style="color:var(--genesis-yellow);margin-right:4px;"></i><strong>Date :</strong> ' + dateStr + '</div>';
        html += '<div><i class="fas fa-clock" style="color:var(--genesis-yellow);margin-right:4px;"></i><strong>Durée :</strong> ' + durationStr + '</div>';
        if (session.location) {
            html += '<div><i class="fas fa-map-marker-alt" style="color:var(--genesis-yellow);margin-right:4px;"></i><strong>Lieu :</strong> ' + session.location + '</div>';
        }
        if (session.meet_url && (session.status === 'CONFIRMED' || session.status === 'PROPOSED')) {
            html += '<div><i class="fas fa-video" style="color:var(--genesis-yellow);margin-right:4px;"></i><strong>Meet :</strong> <a href="' + session.meet_url + '" target="_blank" style="color:#1c7ed6;text-decoration:underline;">Lien</a></div>';
        }
        html += '</div>';

        // Notes client
        if (session.notes_client) {
            html += '<div style="background:#f8f9fa;border:2px solid #dee2e6;padding:0.75rem;margin-bottom:0.75rem;font-size:0.85rem;">';
            html += '<strong style="font-size:0.75rem;text-transform:uppercase;">Notes du client :</strong><br>';
            html += session.notes_client;
            html += '</div>';
        }

        // Proposed slots from client
        if (session.proposed_slots && session.proposed_slots.length > 0 && (session.status === 'REQUESTED' || session.status === 'RESCHEDULE_REQUESTED')) {
            html += '<div style="background:#fff9e6;border:2px solid #ffd43b;padding:0.75rem;margin-bottom:0.75rem;font-size:0.85rem;">';
            html += '<strong style="font-size:0.75rem;text-transform:uppercase;">Créneaux souhaités par le client :</strong><br>';
            for (var j = 0; j < session.proposed_slots.length; j++) {
                try {
                    var slotDate = new Date(session.proposed_slots[j]);
                    html += '• ' + slotDate.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'long' }) + ' à ' + slotDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) + '<br>';
                } catch (e) {
                    html += '• ' + session.proposed_slots[j] + '<br>';
                }
            }
            html += '</div>';
        }

        // Action buttons
        html += '<div style="display:flex;gap:0.5rem;flex-wrap:wrap;">';

        if (session.status === 'REQUESTED' || session.status === 'RESCHEDULE_REQUESTED') {
            html += '<button onclick="openSessionModal(\'' + session.id + '\', \'propose\')" class="neo-btn-yellow" style="padding:0.5rem 1rem;font-size:0.75rem;"><i class="fas fa-calendar-plus mr-1"></i>PROPOSER UN CRÉNEAU</button>';
            html += '<button onclick="openSessionModal(\'' + session.id + '\', \'confirm\')" style="padding:0.5rem 1rem;font-size:0.75rem;border:3px solid #2f9e44;background:#d3f9d8;color:#2f9e44;font-weight:900;cursor:pointer;"><i class="fas fa-check mr-1"></i>CONFIRMER DIRECTEMENT</button>';
            html += '<button onclick="cancelPartnerSession(\'' + session.id + '\')" style="padding:0.5rem 1rem;font-size:0.75rem;border:3px solid #e03131;background:#ffe3e3;color:#e03131;font-weight:900;cursor:pointer;"><i class="fas fa-times mr-1"></i>ANNULER</button>';
        } else if (session.status === 'PROPOSED') {
            html += '<button onclick="openSessionModal(\'' + session.id + '\', \'modify\')" class="neo-btn-yellow" style="padding:0.5rem 1rem;font-size:0.75rem;"><i class="fas fa-edit mr-1"></i>MODIFIER</button>';
            if (!session.meet_url) {
                html += '<button onclick="openSessionModal(\'' + session.id + '\', \'addmeet\')" style="padding:0.5rem 1rem;font-size:0.75rem;border:3px solid #1c7ed6;background:#d0ebff;color:#1c7ed6;font-weight:900;cursor:pointer;"><i class="fas fa-video mr-1"></i>AJOUTER LIEN MEET</button>';
            }
        } else if (session.status === 'CONFIRMED') {
            html += '<button onclick="openSessionModal(\'' + session.id + '\', \'modifymeet\')" class="neo-btn-yellow" style="padding:0.5rem 1rem;font-size:0.75rem;"><i class="fas fa-video mr-1"></i>MODIFIER LIEN MEET</button>';
            html += '<button onclick="completePartnerSession(\'' + session.id + '\')" style="padding:0.5rem 1rem;font-size:0.75rem;border:3px solid #2f9e44;background:#d3f9d8;color:#2f9e44;font-weight:900;cursor:pointer;"><i class="fas fa-check-double mr-1"></i>TERMINÉE</button>';
            html += '<button onclick="cancelPartnerSession(\'' + session.id + '\')" style="padding:0.5rem 1rem;font-size:0.75rem;border:3px solid #e03131;background:#ffe3e3;color:#e03131;font-weight:900;cursor:pointer;"><i class="fas fa-times mr-1"></i>ANNULER</button>';
        }

        html += '</div>';
        html += '</div>';
        return html;
    }

    function openSessionModal(sessionId, action) {
        currentSessionAction = { sessionId: sessionId, action: action };
        var modal = document.getElementById('sessionActionModal');
        var title = document.getElementById('sessionModalTitle');
        var meetField = document.getElementById('sessionModalMeetUrl');
        var dateField = document.getElementById('sessionModalDatetime');
        var durationField = document.getElementById('sessionModalDuration');
        var locationField = document.getElementById('sessionModalLocation');
        var notesField = document.getElementById('sessionModalNotes');

        // Reset
        if (meetField) meetField.value = '';
        if (dateField) dateField.value = '';
        if (durationField) durationField.value = '45';
        if (locationField) locationField.value = '';
        if (notesField) notesField.value = '';

        // Pre-fill from session data
        var session = null;
        for (var i = 0; i < partnerSessionsData.length; i++) {
            if (partnerSessionsData[i].id === sessionId) { session = partnerSessionsData[i]; break; }
        }

        if (action === 'propose') {
            if (title) title.textContent = 'Proposer un créneau';
            // Pre-fill with first client proposed slot if available
            if (session && session.proposed_slots && session.proposed_slots.length > 0 && dateField) {
                try {
                    var slotD = new Date(session.proposed_slots[0]);
                    dateField.value = slotD.toISOString().slice(0, 16);
                } catch (e) {}
            }
        } else if (action === 'confirm') {
            if (title) title.textContent = 'Confirmer directement';
            if (session && session.proposed_slots && session.proposed_slots.length > 0 && dateField) {
                try {
                    var slotD2 = new Date(session.proposed_slots[0]);
                    dateField.value = slotD2.toISOString().slice(0, 16);
                } catch (e) {}
            }
        } else if (action === 'modify') {
            if (title) title.textContent = 'Modifier la séance';
            if (session) {
                if (session.datetime_start && dateField) {
                    try { dateField.value = new Date(session.datetime_start).toISOString().slice(0, 16); } catch (e) {}
                }
                if (session.duration_minutes && durationField) durationField.value = session.duration_minutes;
                if (session.meet_url && meetField) meetField.value = session.meet_url;
                if (session.location && locationField) locationField.value = session.location;
                if (session.notes_partner && notesField) notesField.value = session.notes_partner;
            }
        } else if (action === 'addmeet' || action === 'modifymeet') {
            if (title) title.textContent = action === 'addmeet' ? 'Ajouter un lien Meet' : 'Modifier le lien Meet';
            if (session) {
                if (session.datetime_start && dateField) {
                    try { dateField.value = new Date(session.datetime_start).toISOString().slice(0, 16); } catch (e) {}
                }
                if (session.duration_minutes && durationField) durationField.value = session.duration_minutes;
                if (session.meet_url && meetField) meetField.value = session.meet_url;
                if (session.location && locationField) locationField.value = session.location;
            }
        }

        if (modal) modal.style.display = 'block';
    }

    function closeSessionModal() {
        var modal = document.getElementById('sessionActionModal');
        if (modal) modal.style.display = 'none';
        currentSessionAction = null;
    }

    // Handle form submit
    (function() {
        var form = document.getElementById('sessionActionForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!currentSessionAction) return;

                var sessionId = currentSessionAction.sessionId;
                var action = currentSessionAction.action;
                var token = localStorage.getItem('fa_genesis_partner_token');
                if (!token) { alert('Non authentifié'); return; }

                var datetimeVal = document.getElementById('sessionModalDatetime').value;
                var durationVal = document.getElementById('sessionModalDuration').value;
                var meetVal = document.getElementById('sessionModalMeetUrl').value;
                var locationVal = document.getElementById('sessionModalLocation').value;
                var notesVal = document.getElementById('sessionModalNotes').value;

                var body = {};

                if (action === 'propose') {
                    body.action = 'propose';
                    body.datetime_start = new Date(datetimeVal).toISOString();
                    body.duration_minutes = parseInt(durationVal) || 45;
                    if (meetVal) body.meet_url = meetVal;
                    if (locationVal) body.location = locationVal;
                    if (notesVal) body.notes_partner = notesVal;
                } else if (action === 'confirm') {
                    body.action = 'confirm';
                    body.datetime_start = new Date(datetimeVal).toISOString();
                    body.duration_minutes = parseInt(durationVal) || 45;
                    if (meetVal) body.meet_url = meetVal;
                    if (locationVal) body.location = locationVal;
                    if (notesVal) body.notes_partner = notesVal;
                } else if (action === 'modify') {
                    body.action = 'modify';
                    body.datetime_start = new Date(datetimeVal).toISOString();
                    body.duration_minutes = parseInt(durationVal) || 45;
                    if (meetVal) body.meet_url = meetVal;
                    if (locationVal) body.location = locationVal;
                    if (notesVal) body.notes_partner = notesVal;
                } else if (action === 'addmeet' || action === 'modifymeet') {
                    body.action = 'modify';
                    body.meet_url = meetVal;
                    if (datetimeVal) body.datetime_start = new Date(datetimeVal).toISOString();
                    if (durationVal) body.duration_minutes = parseInt(durationVal) || 45;
                    if (locationVal) body.location = locationVal;
                }

                var submitBtn = document.getElementById('sessionModalSubmitBtn');
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Envoi...'; }

                try {
                    var response = await fetch(PARTNER_API_URL + '/api/partner/sessions/' + sessionId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify(body)
                    });
                    var data = await response.json();
                    if (response.ok) {
                        closeSessionModal();
                        loadPartnerSessions();
                    } else {
                        alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                    }
                } catch (err) {
                    alert('Erreur réseau: ' + err.message);
                } finally {
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-check mr-1"></i>VALIDER'; }
                }
            });
        }
    })();

    async function completePartnerSession(sessionId) {
        if (!confirm('Marquer cette séance comme terminée ?')) return;
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            if (!token) return;
            var response = await fetch(PARTNER_API_URL + '/api/partner/sessions/' + sessionId + '/complete', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            var data = await response.json();
            if (response.ok) {
                loadPartnerSessions();
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        } catch (e) { alert('Erreur: ' + e.message); }
    }

    async function cancelPartnerSession(sessionId) {
        if (!confirm('Annuler cette séance ?')) return;
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            if (!token) return;
            var response = await fetch(PARTNER_API_URL + '/api/partner/sessions/' + sessionId + '/cancel', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            var data = await response.json();
            if (response.ok) {
                loadPartnerSessions();
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        } catch (e) { alert('Erreur: ' + e.message); }
    }

    // Charger le badge séances au démarrage
    (async function() {
        try {
            var token = localStorage.getItem('fa_genesis_partner_token');
            if (!token) return;
            var response = await fetch(PARTNER_API_URL + '/api/partner/sessions', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (response.ok) {
                var data = await response.json();
                var requestedCount = (data.sessions || []).filter(function(s) {
                    return s.status === 'REQUESTED' || s.status === 'RESCHEDULE_REQUESTED';
                }).length;
                updateSeancesBadge(requestedCount);
            }
        } catch (e) {}
    })();

    </script>
    <div id="site-footer"></div>
    <script src="footer.js" defer></script>
    <script src="chatbot.js" defer></script>
</body>
</html>
